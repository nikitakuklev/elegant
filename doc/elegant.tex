% How to create this document on UNIX systems:
%   latex elegant
%   dvi2ps elegant | lpr [-P<postscript-printer-name>]
%
\documentclass[11pt]{article}
\usepackage{hyperref}
\usepackage{longtable}
\usepackage{subfigure} 
\usepackage{amsmath}
\usepackage{breqn}
\usepackage[dvips]{graphicx}
\pagestyle{plain}
%\voffset=-0.75in
\newenvironment{req}{\begin{equation} \rm}{\end{equation}}
\setlength{\topmargin}{0.15 in}
\setlength{\oddsidemargin}{0 in}
\setlength{\evensidemargin}{0 in} % not applicable anyway
\setlength{\textwidth}{6.5 in}
\setlength{\headheight}{-0.5 in} % for 11pt font size
%\setlength{\footheight}{0 in}
\setlength{\textheight}{9 in}
\begin{document}

\title{User's Manual for {\tt elegant}}
\author{Program Version 2021.1\\Advanced Photon Source\\Michael Borland, Tim Berenc\\ \date{\today}}
\maketitle

Note: another source of help for {\tt elegant} is the on-line
\htmladdnormallink{forum}{https://www3.aps.anl.gov/forums/elegant/}.
Users are encouraged to join and participate.  At minimum, users should subscribe to the ``Bugs'' topic,
since this is where bug notifications are posted.

A set of examples and scripts is 
available from the software download page that demonstrates many features of {\tt elegant}.  A \htmladdnormallink{brief
overview}{http://ops.aps.anl.gov/elegant.html} of {\tt elegant} is also available, which introduces the capabilities
at a high level.

\section{Highlights of What's New in Version 2021.1}

Here is a summary of what's changed since release 2020.5.  Historical change logs are collected in Section
\ref{sect:changeLog}.

\subsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|EDRIFT| element was being modeled as a regular \verb|DRIFT| element when the \verb|concat_order| parameter
  of \verb|run_setup| was set to a non-zero value. This was reported by M. Venturini (LBNL).
\item The \verb|STICKY| parameter on the \verb|APCONTOUR| element was ignored and always set to 1.
\end{itemize}

\subsection{Bug Fixes for Commands}
\begin{itemize}
\item A bug was fixed for the \verb|touschek_scatter| command that resulted in a crash when there was a
  \verb|RECIRC| element in the beamline. This was reported by M. Jebramicik (DESY). A. Xiao (ANL) helped
  uncover the cause.
\item The \verb|ramp_elements| and \verb|modulate_elements| commands now work correctly in conjunction
  with \verb|load_parameters| with \verb|change_defined_values=0|.
\item The \verb|final| file, which is requested from \verb|run_setup|, now contains additional parameters giving
  the minimum and maximum values of the particle coordinates at the end of the system; e.g., \verb|xpMaximum| gives
  the maximum x coordinate. These quantities, like (almost) all quantities in the \verb|final| file, are available
  for use in \verb|optimization_term| expressions.
\end{itemize}

\subsection{New and Modified Elements}
\begin{itemize}
\item Several elements have a new parameter,  \verb|N_SLICES|, that replaces the inconsistently-used and misleadingly-named
  \verb|N_KICKS| parameter. The \verb|N_KICKS| parameter is still available for use, but is deprecated.
  \begin{itemize}
  \item \verb|CCBEND|, \verb|CSBEND|, \verb|CSRCSBEND|, \verb|FMULT|, \verb|MULT|: The \verb|N_KICKS| parameter was
    poorly named. It actually gave the desired number of full integrator steps, or ``slices.''
  \item \verb|KQUAD|, \verb|KSEXT|, \verb|KQUSE|: The \verb|N_KICKS| parameter was actually the number of total
    integrator substeps. E.g., for the fourth-order integrator, dividing \verb|N_KICKS| by 4 gave the number of slices.
  \end{itemize}
\item \verb|CSBEND|, \verb|KQUAD|, \verb|KSEXT|,  and \verb|KOCT| have a parameter \verb|MALIGN_METHOD| that permits
  invoking new misalignment methods based on work of M. Venturini \cite{Venturini2021}. Gregg Penn (LBNL) helped
  verify the new methods. Based on the value of this parameter, misalignment   calculations are changed as follows:
  \begin{itemize}
    \item \verb|MALIGN_METHOD=0|: use the existing method.
      The new \verb|YAW| and \verb|PITCH| (or \verb|EYAW| and \verb|EPITCH| for \verb|CSBEND| elements)
      parameters are ignored.
    \item \verb|MALIGN_METHOD=1|: use M. Venturini's method, with misalignment parameters understood to be relative
      to the magnet entrance. The new \verb|YAW| and \verb|PITCH| (or \verb|EYAW| and \verb|EPITCH| for \verb|CSBEND| elements)
      parameters become active. This is presently incompatible with the \verb|moments_output| command.
    \item \verb|MALIGN_METHOD=2|: use M. Venturini's method, with misalignment parameters understood to be relative
      to the magnet center. The new \verb|YAW| and \verb|PITCH| (or \verb|EYAW| and \verb|EPITCH| for \verb|CSBEND| elements)
      parameters become active. This is presently incompatible with the \verb|moments_output| command.
    \end{itemize}
  \item The \verb|HMON|, \verb|VMON|, and \verb|MONI| elements can be used to store turn-by-turn BPM readings by setting
  the \verb|STORE_TURN_BY_TURN| parameter to 1. This can be used, for example, to create position-based triggers using
  \verb|modulate_elements|. 
\item The \verb|GKICKMAP| element was added, which provides a generalized kickmap that is not specific to
  undulators or wigglers (unlike \verb|UKICKMAP|).
\item The \verb|SCATTER| element now supports uniform distributions in addition to the default gaussian distribution
  using the new \verb|DISTRIBUTION| parameter.
\item The \verb|CSBEND| matrix no longer requires use of the relatively slow tracking-based matrix option when
  the steering parameters are used. The element also supports the \verb|XSTEERING| and \verb|YSTEERING| parameters
  to allow individual control of whether the element is used for steering.
\item The individual-element steering parameters for \verb|KSEXT| elements are no longer ignored.
\end{itemize}


\subsection{New and Modified Commands}
\begin{itemize}
\item The \verb|parameters| output of the \verb|run_setup| command now includes string quantities in the
  \verb|ParameterValueString| column. Numerical quantities are stored in the \verb|ParameterValue| column, as before.
\item The \verb|run_setup| command has a new parameter \verb|suppress_parameter_defaults|. If set to a nonzero value,
  the data stored in the \verb|parameters| output file will not contain data that match the default values.
  This can result in much smaller files and faster loading, with the downside that future changes to the
  defaults would impact the ability to reproduce a run using a saved parameter file.
\item The \verb|load_parameters| command now makes consistent use of the \verb|ParameterValueString| column
  in any input files. If the \verb|ParameterValue| column is present, it is used for numerical quantities, 
  while the \verb|ParameterValueString| column is used for string quantities only.
  If only \verb|ParameterValueString| is present, \verb|elegant| will attempt to scan the string values as
  needed for numerical values; this is not the preferred approach as it will degrade performance.
\item The \verb|losses| output of the \verb|run_setup| command now provides the global coordinate angle in
 the horizontal plane when \verb|losses_include_global_coordinates=1|. One can also now control the 
 range of \verb|s| coordinates for recorded particles using the \verb|losses_s_limit| array.
\item The \verb|correct_tunes| and \verb|chromaticity| commands now accept lists giving lower and upper strength limits
  for each family. In addition, the \verb|strength_log| files are now compatible with \verb|load_parameters|.
\item The \verb|closed_orbit| and \verb|correct| commands now have a control that allows accepting a
  closed orbit results that exceeds the accuracy target, rather than considering this an error.
  This will allow correction or other computations to proceed in spite of poor convergence of the 
  closed orbit.
\end{itemize}


\subsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item A problem was fixed with the particle-swarm optimizer that caused it to abort or return invalid results when
  a function evaluation yielded an invalid result. This was in response to issues raised by forum user \verb|marlibgin|.
\end{itemize}

\subsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}  Users are encouraged to check results against
the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsection{Changes to Related Programs and Files}

The {\tt elegant} distribution includes many programs and scripts that perform computations with {\tt elegant}
output data, provide interfaces with other programs, or prepare data for use with {\tt elegant}. These
are listed in Section \ref{sect:tools}. 

Changes to these tools in this release include
\begin{itemize}
\item The program \verb|computeRBGGE|, which allows computation of a generalized gradient
  expansion\cite{Venturini-NIMA427-387} for use with \verb|BGGEXP| based on field data on a rectangular boundary
  \cite{Mitchell-2007}, was improved to support automatic tuning of the number of gradients and multipoles.
  In addition, output of the implied field map is supported.
\item The program \verb|computeCBGGE| was added, which allows computation of a generalized gradient expansion
  based on field data on a circular-cylinder boundary \cite{Venturini-NIMA427-387}. It replaces the script
  \verb|computeGeneralizedGradients|, providing better performance and features.
\item The script \verb|generateBunchTrain| was added. It allows generating particle input files for a fairly
  arbitrary multi-train bunch pattern.
\end{itemize}

\subsection{Known Bugs, Problems, and Limitations}
\begin{itemize}
\item The \verb|centroid| and \verb|sigma| output from \verb|run_setup| is not correct when \verb|BRANCH| elements
  are used.
\item The \verb|REFERENCE_CORRECTION| feature of the \verb|CSBEND| element is ignored while performing calculations related
  to the \verb|moments_output| command.
\item Setting \verb|CHANGE_T=1| on \verb|RFCA| and \verb|RFCW| elements can give invalid results when tracking beams with very 
  large time spread compared to the bunch length.
\item Twiss output contains entries for the higher-order dispersion, tune shifts with amplitude, higher-order chromaticity, and tune spreads
  due to chromaticity and amplitude {\em even when these are not calculated}, which is potentially
  misleading.   The values are zero when the calculation is not requested.
\item Computation of closed orbits and Twiss parameters will not always include the effects of synchrotron
  radiation losses when these are imposed using {\tt SREFFECTS} elements.  See
  the documentation for {\tt SREFFECTS} for details.
\item Computation of beam moments does not include synchrotron radiation effects from \verb|UKICKMAP| elements.
\item The file created with the parameters field of \verb|run_setup| does not contain
  any non-numerical parameters of the lattice.
\item Computation of radiation integrals does not include the effect of steering magnets.
\item There is a bug related to using {\tt ILMATRIX} that will result in a crash
  if one does not request computation of the twiss parameters. If you encounter this
  problem, just add the following statement after the \verb|run_setup| command:
\begin{verbatim}
&twiss_output
        matched = 1
&end
\end{verbatim}
\item The \verb|OUTPUT_FILE| feature of the \verb|TFBDRIVER| will produce a file with missing data at the end of
  the buffer if the \verb|OUTPUT_INTERVAL| parameter is not a divisor of the number of passes.
\item When the \verb|KQUAD| element was split (with the \verb|divide_elements| command or
  \verb|element_divisions|, any edge multipoles get evaluated at the interior boundaries. In addition, the
  \verb|LEFFECTIVE| cannot be used.
\end{itemize}

\section{Credits}

Contributors to {\tt elegant} include M. Borland, M. Carla', N. Carmignani, M. Ehrlichman, L. Emery, W. Guo, R. Lindberg,
V. Sajaev, R. Soliday, Y.-P. Sun, C.-X. Wang, Y. Wang, Y. Wu, and A. Xiao.
Contributors to related programs and scripts include M. Borland, R. Dejus, L. Emery, A. Petrenko, H. Shang, Y. Wang, 
A. Xiao, and B. Yang.
R. Soliday is responsible for multi-platform builds and distribution.
Of course, we also appreciate the many suggestions, comments, and bug reports from users.

If you use {\tt elegant} in your research, we appreciate a citation. For {\tt elegant}, the citation is
\begin{flushleft}
M. Borland, "elegant: A Flexible SDDS-Compliant Code for Accelerator Simulation," Advanced Photon Source LS-287, September 2000.
\end{flushleft}

Additional contributors for the parallel version include Y. Wang and H. Shang.
The additional citation for {\tt Pelegant} is
\begin{flushleft}
Y. Wang and M. Borland, "Pelegant: A Parallel Accelerator Simulation Code for Electron Generation and Tracking", Proceedings of the 12th Advanced Accelerator
Concepts Workshop, AIP Conf. Proc. 877, 241 (2006).
\end{flushleft}

Additional contributors for the GPU version include K. Amyx, J. R. King, and I. V. Pogorelov. 
The additional citation for the GPU version is
\begin{flushleft}
I. V. Pogorelov, J. R. King, K. M. Amyx, M. Borland, and R. Soliday, ``Current status of the GPU-accelerated ELEGANT,''
Proceedings of 2015 International Particle Accelerator Conference, 623 (2015).
\end{flushleft}

\section{Introduction}

{\tt elegant} stands for ``ELEctron Generation ANd Tracking,'' a
somewhat out-of-date description of a fully 6D accelerator program
that now does much more than generate particle distributions and track
them.  {\tt elegant}, written entirely in the C programming
language\cite{Kernighan}, uses a variant of the MAD\cite{MAD} input
format to describe accelerators, which may be either transport lines,
circular machines, or a combination thereof.  Program execution is
driven by commands in a namelist format.

This document describes the features available in {\tt elegant},
listing the commands and their arguments.  The differences between
{\tt elegant} and MAD formats for describing accelerators are listed.
A series of examples of {\tt elegant} input and output are given.
Finally, appendices are included describing the post-processing
programs.

\subsection{Program Philosophy}

For all its complexity, {\tt elegant} is not a stand-alone program.
For example, most of the output is not human-readable, and {\tt
elegant} itself has no graphics capabilities.  These tasks are handled
by a suite of post-processing programs that serve both {\tt elegant}
and other physics programs.  These programs, collectively known as the
SDDS Toolkit\cite{SDDS1,SDDS2}, provide sophisticated data analysis
and display capabilities.  They also serve to prepare input for {\tt
elegant}, supporting multi-stage simulation.

Setting up for an {\tt elegant} run thus involves more than creating
input files for {\tt elegant} per se.  A complicated run will
typically involve creation of a post-processing command file that
processes {\tt elegant} output and puts it in the most useful form,
typically a series of graphs.  Users thus have the full power of the
SDDS Toolkit, the resident command interpreter (e.g., the UNIX shell),
and their favorite scripting language (e.g., Tcl/Tk) at their
disposal. The idea is that instead of continually rewriting the
physics code to, for example, make another type of graph or squeeze
another item into a crowded table, one should allow the user to tailor
the output to his specific needs using a set of generic
post-processing programs.  This approach has been quite successful,
and is believed particularly suited to the constantly changing needs
of research.

Unlike many other programs, {\tt elegant} allows one to make a single
run simulating an arbitrary number of randomizations or variations of
an accelerator.  By using the SDDS toolkit to postprocess the data,
the user's postprocessing time and effort do not depend on how many
random seeds or situations are chosen.  Hence, instead of doing a few
simulations with a few seed numbers or values, the user can simulate
hundreds or even thousands of instances of one accelerator to get an
accurate representation of the statistics or dependence on parameters,
with no more work invested than in doing a few simulations.

In addition, complex simulations such as start-to-end jitter
simulations\cite{S2EJitter} and top-up tracking\cite{TopUpTracking}
can be performed involving hundreds or thousands of runs, with input
created by scripts depending on the SDDS toolkit.  These simulations
make use of concurrent computing on about 20 workstation using the
Distributed Queueing System\cite{DQS}.  Another example is the {\tt elegantRingAnalysis} 
script, which allows using many workstations for simulation of storage ring
dynamic and momentum aperture, frequency maps, and so on.
Clearly, use of automated
postprocessing tools greatly increases the scale and sophistication of
simulations possible.  

In passing, we note another ``philosophical'' point about {\tt
elegant}, namely, the goal of complete backward compatibility.  We
consider it unacceptable if a new version of the program gives
different answers than an old version, unless the old version was
wrong.  Hence, there are sometimes less-than-ideal default settings in
{\tt elegant}, incorrect spelling of parameters, etc., that are never
fixed, because doing so would break old input files.  It helps to read
the manual pages carefully for the more complex features to ensure that
the defaults are understood and appropriate.

\subsection{Capabilities of {\tt elegant}}

{\tt elegant} started as a tracking code, and it is still well-suited
to this task.  {\tt elegant} tracks in the 6-dimensional phase space
${\rm (x, x^\prime, y, y^\prime, s, \delta)}$, where $x$ ($y$) is the
horizontal (vertical) transverse coordinate, primed quantities are
slopes, $s$ is the {\em total, equivalent} distance traveled, and $\delta$ is the
fractional momentum deviation\cite{KLBrown}.  Note that these
quantities are commonly referred to as (x, xp, y, yp, s, dp) in the
namelists, accelerator element parameters, and output files.  (``dp''
is admittedly confusing---it is supposed to remind the user of ${\rm
\Delta P/P_o}$.  Sometimes this quantity is referred to as ``delta.'')

In some elements, {\tt elegant} uses canonical coordinates in place of the
slopes. These are defined as
\begin{equation}
\begin{array}{lcl}
q_x & = & \frac{x^\prime (1 + \delta)}{\sqrt{1 + x^{\prime 2} + y^{\prime 2}}} \\
q_y & = & \frac{y^\prime (1 + \delta)}{\sqrt{1 + x^{\prime 2} + y^{\prime 2}}} 
\end{array}.
\end{equation}
The inverse relationship is
\begin{equation}
\begin{array}{lcl}
x^\prime & = & \frac{q_x}{\sqrt{(1+\delta)^2 - q_x^2 - q_y^2}} \\
y^\prime & = & \frac{q_y}{\sqrt{(1+\delta)^2 - q_x^2 - q_y^2}}
\end{array}.
\end{equation}

Tracking may be performed using matrices (of selectable order),
canonical kick elements, numerically integrated elements, or any
combination thereof.  For most elements, second-order matrices are
available; matrix concatenation can be done to any order up to third.
Canonical kick elements are available for bending magnets,
quadrupoles, sextupoles, and higher-order multipoles; all of these
elements also support optional classical synchrotron radiation losses.
Among the numerically integrated elements available are
extended-fringe-field bending magnets and traveling-wave accelerators.
A number of hybrid elements exist that have first-order transport with
exact time dependence, e.g., RF cavities.    Some of the more unusual
elements available are third-order
alpha-magnets\cite{Enge,Borland_thesis}, time-dependent kicker
magnets, voltage-ramped RF cavities, beam scrapers, and beam-analysis
``screens.''

Several elements support simulation of collective effects, such as
short- and long-range wakefields, resonator impedances, intra-beam scattering,
coherent synchrotron radiation, and the longitudinal space charge
impedance. 

A wide variety of output is available from tracking, including
centroid and sigma-matrix output along the accelerator, phase space
output at arbitrary locations, turn-by-turn moments at arbitrary
locations, histograms of particle coordinates, coordinates of lost
particles, and initial coordinates of transmitted particles.  In
addition to tracking internally generated particle distributions, {\tt
elegant} can track distributions stored in external files, which can
either be generated by other programs or by previous {\tt elegant}
runs.  Because {\tt elegant} uses SDDS format for reading in and
writing out particle coordinates, it is relatively easy to interface
{\tt elegant} to other programs using files that can also be used with
SDDS to do post-processing for the programs.

{\tt elegant} allows the addition of random errors to virtually any
parameter of any accelerator element.  One can correct the orbit (or
trajectory), tunes, and chromaticity after adding errors, then compute
Twiss parameters, track, or perform a number of other operations.
{\tt elegant} makes it easy to evaluate a large number of ensembles (``seeds'')
in a single run.  Alternatively, different ensembles can be readily run
of different CPUs and the SDDS output files combined.

In addition to randomly perturbing accelerator elements, {\tt elegant}
allows one to systematically vary any number of elements in a
multi-dimensional grid.  As before, one can track or do other
computations for each point on the grid.  This is a very useful
feature for the simulation of experiments, e.g., emittance
measurements involving beam-size measurements during variation of one
or more quadrupoles\cite{Borland_PC}.

Like many accelerator codes, {\tt elegant} does accelerator
optimization.  It will optimize a user defined function of the
transfer matrix elements (up to third-order), beta functions, tunes,
chromaticities, radiation integrals, natural emittance, floor
coordinates, beam moments, etc.  It also has the ability to optimize results of
tracking using a user-supplied function of the beam parameters at one
or more locations.  This permits solution of a wide variety of
problems, from matching a kicker bump in the presence of
nonlinearities to optimizing dynamic aperture by adjusting sextupoles.

{\tt elegant} provides several methods for determining accelerator
aperture, whether dynamic or physical.  One may do straightforward
tracking of an ensemble of particles that occupies at uniform grid in
(x, y) space.  One may also invoke a search procedure that finds the
aperture boundary.  A related feature is the ability to determine
the frequency map for an accelerator, to help identify aperture-limiting
resonances.

In addition to using analytical expressions for the transport
matrices, {\tt elegant} supports computation of the first-order matrix
and linear optics properties of a circular machine based on tracking.
A common application of this is to compute the tune and beta-function
variation with momentum offset by single-turn tracking of a series of
particles.  This is much more efficient than, for example, tracking
and performing FFTs (though {\tt elegant} will do this also).  This
both tests analytical expressions for the chromaticity and allows
computations using accelerator elements for which such expressions do
not exist (e.g., a numerically integrated bending magnet with extended
fringe fields).

A common application of random error simulations is to set tolerances
on magnet strength and alignment relative to the correctability of the
closed orbit.  A more efficient way to do these calculations is to use
correct-orbit amplification factors\cite{Borland_PC}.  {\tt elegant}
the computes amplification factors and functions for corrected and
uncorrected orbits and trajectories pertaining to any element that
produces an orbit or trajectory distortion.  It simultaneously
computes the amplification functions for the steering magnets, in
order to determine how strong the steering magnets will need to be.

\section{Digression on the Longitudinal Coordinate Definition\label{sec:longitCoord}}

A word is in order about the definition of $s$, which we've described
as the {\em total, equivalent} distance traveled.  First, by {\em
total} distance we mean that $s$ is {\em not} measured relative to the
bunch center or a fiducial particle.  It is entirely a property of the
individual particle and its path through the accelerator.

To explain what we mean by {\em equivalent} distance, note that the
relationship between $s$ and arrival time $t$ at the observation point
is, for each particle, $s = \beta c t$, where $\beta c$ is the
instantaneous velocity of the particle.  Whenever a particle's
velocity changes, {\tt elegant} recomputes $s$ to ensure that this
relationship holds.  $s$ is thus the ``equivalent'' distance the
particle would have traveled at the present velocity to arrive at the
observation point at the given time.  This book-keeping is required
because {\tt elegant} was originally a matrix-only code using $s$ as
the longitudinal coordinate.

Users should keep the meaning of $s$ in mind when viewing statistics
for $s$, for example, in the {\tt sigma} or watch point output files.
A quantity like {\tt Ss} is literally the rms spread in $s$.  It is
{\em not} defined as $\sigma_t/(\langle \beta \rangle c)$.  A
nonrelativistic beam with velocity spread will show no change in {\tt
Ss} in a drift space, because the distance traveled is the same for
all particles.

\section{Fiducialization in {\tt elegant}}

In some tracking codes, there is a ``fiducial particle'' that is
tracked along with the beam.  This particle follows the ideal trajectory or orbit, with the ideal
momentum, and at the ideal phase.  There is no fiducial particle in {\tt
elegant}.  Instead, fiducialization is typically based on statistical properties of 
the bunch.  This can be performed on a bunch-by-bunch basis, or for the first
bunch seen in a run.  The latter method must be used if one wants to look at the
effects of changing phase, voltage, or magnets relative to some nominal configuration.

Internally, {\tt elegant} fiducializes each element in the beamline.
Fiducializing an element means determining the reference momentum and arrival time
(or phase) for that element.   If the reference momentum does not change along a beamline and no time-dependent elements
are involved, then fiducialization is irrelevant.  All elements are
fiducialized at the central momentum defined in \verb|run_setup|.

A number of commands have parameters for controlling fiducialization:
\begin{itemize}
\item The \verb|always_change_p0| parameter of \verb|run_setup| causes
	\verb|elegant| to re-establish the central momentum after each
	element when fiducializing.  This may be more convenient than
	setting the \verb|CHANGE_P0| parameter on the elements themselves.
	However, it can have unexpected consequences, such as changing the
	central momentum to match changes in beam momentum due to synchrotron
	radiation.
\item \verb|run_control| has four parameters that affect fiducialization,
	which come into play when multi-step runs are made.  Typically, these
	are runs that involve variation of elements, addition of errors,
	or loading of multiple sets of parameters.
	\begin{itemize}
	\item \verb|reset_rf_for_each_step| --- If nonzero, the rf phases are 
	re-established
	for each beam tracked.  If this is 1 (the default), 
	the time reference is discarded after each bunch is tracked.
	This means that bunch-to-bunch phasing errors due to time-of-flight 
	differences would be lost.  
	\item \verb|first_is_fiducial| --- The first bunch seen is taken to
	establish the fiducial phases and momentum profile.  If one is simulating,
	for example, successive beams in a fixed accelerator, this should be set
	to 1.  Otherwise, the momentum reference is discarded after each bunch
	is tracked. N.B.: as of version 27.0.1, setting \verb|first_is_fiducial=1| 
        does not imply \verb|always_change_p0=1|. You must set this separately,
        or use the \verb|CHANGE_P0| parameter on various elements (e.g., \verb|RFCA|)
        to further specify how to set the fiducial momentum profile.
	\item \verb|restrict_fiducialization| --- If nonzero, then momentum profile
	fiducialization occurs only after elements that are known to possibily
	change the momentum. It would not occur, for example, after a scraper that
	changes the average beam momentum by removing a low-momentum tail.
        This is a convenience that, essentially, allows modifying the impact
        of setting \verb|always_change_p0=1|.
        \item \verb|n_passes_fiducial| --- If positive, sets the number  passes used
          for fiducial tracking to be different from the \verb|n_passes| value.
          For ring fiducialization, should probably always be set to 1.
	\end{itemize}
\item The \verb|bunched_beam| command has a \verb|first_is_fiducial| parameter
	that is convenient for use with the \verb|first_is_fiducial| mode
	established by \verb|run_control|.  If nonzero, this parameter causes
	\verb|elegant| to generate a first bunch with only one particle.
	This is very useful if one wants to track with many particles but doesn't
	want to waste time fidicializing with a many-particle bunch.
\end{itemize}

Here are some examples that may be helpful.  
\begin{itemize}
\item {\em Scanning a phase error in a linac with a bunch compressor:}  The scan is performed using
the \verb|vary_element| command.  For this to work properly, it is necessary to fidcualize the system
with zero phase error.  Hence, one must use the enumeration feature of \verb|vary_element| to provide
an input file with the phase errors and the file must be sorted so that the row with zero phase error
is first.  Further, one must set \verb|reset_rf_for_each_step = 0| and \verb|first_is_fiducial = 1|
in \verb|run_control|, and \verb|CHANGE_P0=1| on all rf cavity elements.  (See the \verb|bunchComp/phaseSweep| 
and \verb|bunchComp/dtSweep| examples.)

\item {\em Scanning the voltage of a linac to simulate different operating energy choices at the compressor:}
In this case, one scans the linac voltage, but wants to fiducialize the system for each voltage.
(It's a change in design, not an error or perturbation.)  One again uses \verb|vary_element|, but
nothing special needs to be done about the order of the voltage values.  One must set
\verb|reset_rf_for_each_step = 1| and \verb|first_is_fiducial = 0| in in \verb|run_control|,
and \verb|CHANGE_P0=1| on all rf cavity elements.  (See the \verb|bunchComp/energySweep| example.)

\item {\em Simulation of phase and voltage jitter:}  In this case, one uses the \verb|error_element|
command to impart errors to the \verb|PHASE| and \verb|VOLT| parameters of rf cavity elements.
However, the first beam through the system must not see any errors.  This is accomplished by
setting \verb|no_errors_for_first_step=1| in \verb|error_control|.  One can also (optionally) use
a 1-particle beam for fiducialization by setting \verb|first_is_fiducial=1| in \verb|bunched_beam|.
In addition, one must set  \verb|reset_rf_for_each_step = 0| and \verb|first_is_fiducial = 1|
in \verb|run_control|, and \verb|CHANGE_P0=1| on all rf cavity elements.  (See the \verb|bunchCompJitter/jitter|
example.)

\end{itemize}

\section{Preparing beams for bunch-mode simulations}\label{sect:bunchedBeams}

Certain collective-effects elements in {\tt elegant} can operate under the assumption that the beam is organized into bunches.
This includes the {\tt FRFMODE}, {\tt FTRFMODE}, {\tt LRWAKE}, {\tt RFMODE}, {\tt WAKE}, {\tt TRFMODE}, {\tt TRWAKE}, {\tt ZLONGIT}, and {\tt ZTRANSVERSE} elements.
At present, this behavior is only available when loading a beam from an external file using the \verb|sdds_beam| command.
A typical sequence is to run {\tt elegant} once to generate a beam file using \verb|bunched_beam|, then load that beam into a subsequent run.

This beam file may either contain the entire beam (all the bunches) or it may contain a single bunch.
In the latter case, the single bunch must be duplicated using the \verb|n_duplicates| and \verb|duplicate_stagger| parameters of \verb|sdds_beam|.
Otherwise, in the beam-generation run, 
the \verb|run_control| command must be used to specify both the number of bunches (using \verb|n_steps|) and the bunch frequency (using
\verb|bunch_frequency|).
The beamline for this run would typically consist simply of a zero-length drift space, so that the \verb|output| file from the \verb|run_setup| command
contains the coordinates for each bunch as generated, with no modifications.
Once the beam is generated, it can be used as the input file for \verb|sdds_beam| with \verb|track_pages_separately=0| and \verb|use_bunched_mode=1|.

For those who prepare beams using other programs, it may be helpful to understand how the organization of the beam into bunches is specified.
The relevant data from the beam file are the values in the \verb|IDSlotsPerBunch| parameter and \verb|particleID| column.
The \verb|particleID| is generally a unique positive integer for each particle.
When  $S=$\verb|IDSlotsPerBunch| is non-zero, the bunch index is computed as $\lfloor (I-1)/S\rfloor$, where $I$ is the particle ID.
For example, with \verb|IDSlotsPerBunch|=1000, particle IDs from 1 to 1000 would be in bunch 0, from 2001-3000 would be bunch 1, and so on.
This mechanism allows specifying the bunch structure without adding columns to the beam file, and also handles particle loss automatically.

Note that although in the case of beams generated with \verb|bunched_beam| the individual bunches appear in separate pages of the beam file, this is not
necessary.

\section{Namelist Command Dictionary}

The main input file for an {\tt elegant} run consists of a series of
namelists, which function as commands.  Most of the namelists direct
{\tt elegant} to set up to run in a certain way.  A few are ``action''
commands that begin the actual simulation.  FORTRAN programmers should
note that, unlike FORTRAN namelists, these namelists need not come in
a predefined order; {\tt elegant} is able to detect which namelist is
next in the file and react appropriately.

\subsection{Commandline Syntax}

The commandline syntax for {\tt elegant} is of the form
\begin{flushleft}{\tt
elegant \{{\em inputfile}|-pipe=in\} [-rpnDefns={\em filename}] [-configuration={\em filename}] [-macro={\em tag1}={\em value1}[,{\em
tag2}={\em value2}...] }\end{flushleft} 
{\em inputfile} is the name of the command input file, which is a series of
namelist commands directing the calculations.
Alternatively, one may give the \verb|-pipe=in| option, allowing {\tt elegant } to be
fed a stream of commands by another program or script.
The \verb|-rpnDefns| option allows providing the name of the RPN definitions file as an alternative
to defining the \verb|RPN_DEFNS| environment variable.
The \verb|-configuration| option allows providing the name of an input file to be read prior to {\em inputfile};
this can be used for configuring \verb|elegant| using, e.g., the \verb|global_settings| command; this is
an alternative to using the \verb|ELEGANT_CONFIGURATION| environment variable.
The \verb|-macro| option allows performing text substitutions in the command stream.
Multiple \verb|-macro| options may be given.
Usage is described in more detail below.

\subsection{General Command Syntax}\label{sect:generalCommandSyntax}

Each namelist has a number of variables associated with it, which are
used to control details of the run.  These variables come in three
data types: (1) {\tt long}, for the C long integer type.  (2) {\tt
double}, for the C double-precision floating point type. (3) {\tt
STRING}, for a character string enclosed in double quotation marks.
All variables have default values, which are listed on the following
pages.  {\tt STRING} variables often have a default value listed as
{\tt NULL}, which means no data; this is quite different from the
value ``'', which is a zero-length character string.  {\tt long}
variables are often used as logical flags, with a zero value
indicating false and a non-zero value indicating true.

On the following pages the reader will find individual descriptions of each of the namelist commands and their 
variables.  Each description contains a sequence of the form
\begin{verbatim}
&<namelist-name>
    <variable-type> <variable-name> = <default-value>;
    .
    .
    .
&end
\end{verbatim}
This summarizes the parameters of the namelist.  Note, however, that the namelists are invoked in the form
\begin{verbatim}
&<namelist-name>
    [<variable-name> = <value> ,]
    [<array-name>[<index>] = <value> [,<value> ...] ,]
        .
        .
        .
&end
\end{verbatim}  The square-brackets enclose an optional component.  Not all namelists require variables to 
be given--the defaults may be sufficient.  However, if a variable name
is given, it must have a value.  Values for \verb|STRING| variables
must be enclosed in double quotation marks.  Values for \verb|double|
variables may be in floating-point, exponential, or integer format
(exponential format uses the `e' character to introduce the exponent).

Array variables take a list of values, with the first value being
placed in the slot indicated by the subscript.  As in C, the first
slot of the array has subscript 0, {\em not} 1.  The namelist
processor does not check to ensure that one does not put elements into
nonexistent slots beyond the end of the array; doing so may cause the
processor to hang up or crash.

Wildcards are allowed in a number of places in {\tt elegant} and the SDDS Toolkit.  The wildcard format is
very similar to that used in UNIX:
\begin{itemize}
\item \verb|*| --- stands for any number of characters, including none.
\item \verb|?| --- stands for any single character.
\item \verb|[<list-of-characters>]| --- stands for any single character from the list.  The list may include
ranges, such as \verb|a-z|, which includes all characters between and including `a' and `z' in the ASCII
character table.
\end{itemize}
The special characters \verb|*|, \verb|?|, \verb|[|, and \verb|]| are entered literally by preceeding the character by a
backslash (e.g., \verb|\*|).

In many places where a filename is required in an {\tt elegant}
namelist, the user may supply a so-called ``incomplete'' filename.  An
incomplete filename has the sequence ``\%s'' imbedded in it, for which
is substituted the ``rootname.''  The rootname is by default the
filename (less the extension) of the command (i.e., main input) file.  The most common
use of this feature is to cause {\tt elegant} to create names for all
output files that share a common filename but differ in their
extensions.  Post-processing can be greatly simplified by adopting
this naming convention, particularly if one consistently uses the same
extension for the same type of output.  Recommended filename
extensions are given in the lists below.

Note that this substitution feature is not generally available for
input files, though there are some exceptions (e.g., \verb|load_parameters|).
Another convenience for input file organization is the search-path feature,
which can be set from the \verb|run_setup| command.
By default, \verb|elegant| assumes input filenames give the full pathname.
If the search path is specified, \verb|elegant| will instead look for files in one of
the listed directories.

When {\tt elegant} reads a namelist command, one of its first actions
is to print the namelist back to the standard output.  This printout
includes all the variables in the namelist and their values.
Occasionally, the user may see a variable listed in the printout that
is not in this manual.  These are often obsolete and are retained only
for backward compatibility, or else associated with a feature that is
not fully supported.  Use of such ``undocumented features'' is
discouraged.

{\tt elegant} supports substitution of fields in namelists using the
commandline {\tt macro} option.  This permits making runs with altered
parameters without editing the input file.  Macros inside the input
file have one of two forms: \verb|<tag>| or \verb|\$tag|.  To perform
substitution, use the syntax
\begin{flushleft}{\tt
elegant {{\em inputfile}|-pipe=in} -macro={\em tag1}={\em value1}[,{\em
tag2}={\em value2}...]  }\end{flushleft} 
When using this feature, it
is important to substitute the value of {\tt rootname} (in run\_setup)
so that one can get a new set of output files (assuming use of the
suggested ``\%s'' field in all the output file names).
One may give the {\tt macro} option any number of times, or combine
all substitutions in one option.  The name of the input file is available
using the macro \verb|INPUTFILENAME|.

{\tt elegant} also allows execution of commands in the shell as part of
evaluation of a namelist field.  To invoke this, one encloses the commandline
string in curly braces.  E.g., 
\begin{verbatim}
betax = "{sdds2stream -parameter=betaxFinal data.twi}"
\end{verbatim}
(Note that the quotes are also required.)
In this example, \verb|betax| is assigned the value of the parameter {\tt betaxFinal} from
the file {\tt data.twi}.

It is also possible to perform calculations using {\tt elegant}'s built-in RPN calculator.
(It is identical to the commandline programs {\tt rpn} and {\tt rpnl} supplied with
the SDDS toolkit.)
To do this in the command file, one must use quotation marks and
enclose the expression in parentheses, as in 
\begin{verbatim}
betax = "(8 2 / pi /)"
\end{verbatim}
(Note that this is different from using such expressions in the lattice file; in that
case, one doesn't need the parentheses.)
One can not only make such computations, but also use the stack and variables.
So, for example, one might use
\begin{verbatim}
betax = "(8 2 / pi / sto betax0)"
betay = "(betax0)"
\end{verbatim}
One can also mix subcommands and RPN expressions, as in
\begin{verbatim}
betax = "({sdds2stream -parameter=betaxFinal data.twi} 2 /)"
\end{verbatim}
would assign to {\tt betax} half
the value of the parameter {\tt betaxFinal} from
the file {\tt data.twi}.

\subsection{Setup and Action Commands}
 
A subject of frequent confusion for {\tt elegant} users is the
distinction between setup and action commands.  An ``action'' command
causes {\tt elegant} to immediately perform a specific computation or
set of computations.  In contrast, a ``setup'' command tells {\tt elegant}
how to perform computations when it later encounters a ``major'' action
command (one of \verb|analyze_map|, \verb|find_aperture|, \verb|frequency_map|, \verb|momentum_aperture|, \verb|optimize|, 
or \verb|track|).
(N.B.: After each major action command, the problem space is wiped clear. 
To peform further computations requires introduction of a new \verb|run_setup| command.)

Several commands are switchable between action and setup modes.  These
include the \verb|coupled_| \verb|twiss_output|,
\verb|correction_matrix_output|, \verb|twiss_output|,
\verb|find_aperture|, \verb|matrix_output|, and \verb|sasefel|
commands.  Except for \verb|find_aperture|, all of the commands that
can run in both modes have the \verb|output_at_each_step| parameter,
which is used to switch between the modes.  In the case of
\verb|find_aperture|, the switch is accomplished using the
\verb|optimization_mode| parameter.  Regardless of which parameter is
present, unless the parameter is given a value of 1, the command
operates in action mode.  Further, if the command is used in setup mode
and no relevant action command is present later in the file, then the requested
will not be performed.

Typically one wants to use these switchable commands in setup mode whenever one is
simulating random errors, performing a parameter scan, or performing optimization.
When in setup mode, the indicated computations will be performed repeatedly, e.g.,
for each set of errors, for each step in the parameter scan, or for use in each
evaluation of the optimization penalty function.

%\begin{latexonly}
\newpage
%\end{latexonly}
\subsection{Table of {\tt elegant} commands and their functions}

\begin{longtable}{|p{2.75in}|p{0.75in}|p{2.75in}|}
\hline
Command name & Type & Description \\\hline 
\hyperref[subsec:alterelements]{\tt alter\_elements} & action & Change an element parameter from the command file. \\ \hline
\hyperref[subsec:amplificationfactors]{\tt amplification\_factors} & action & Compute orbit amplification functions. \\ \hline
\hyperref[subsec:analyzemap]{\tt analyze\_map} & major action & Determine first-order matrix from tracking. \\ \hline
\hyperref[subsec:aperturedata]{\tt aperture\_data} & setup & Define aperture using an SDDS file. \\ \hline
\hyperref[subsec:bunchedbeam]{\tt bunched\_beam} & setup & Set up beam generation. \\ \hline
\hyperref[subsec:bunchedbeammoments]{\tt bunched\_beam\_moments} & setup & Set up beam generation. \\ \hline
\hyperref[subsec:changeparticle]{\tt change\_particle} & action & Change the type of particle. Default is electron.\\ \hline
\hyperref[subsec:chaosmap]{\tt chaos\_map} & action & Compute a map of the degree of chaos in particle motion.\\ \hline
\hyperref[subsec:chromaticity]{\tt chromaticity} & setup & Correct the chromaticity. \\ \hline
\hyperref[subsec:closedorbit]{\tt closed\_orbit} & setup & Compute the closed orbit. \\ \hline
\hyperref[subsec:correct]{\tt correct} & setup & Correct the orbit or trajectory. \\ \hline
\hyperref[subsec:correctionmatrixoutput]{\tt correction\_matrix\_output} & action/setup & Obtain orbit/trajectory correction matrix in a file. \\ \hline
\hyperref[subsec:correcttunes]{\tt correct\_tunes} & setup & Correct the tunes. \\ \hline
\hyperref[subsec:coupledtwissoutput]{\tt coupled\_twiss\_output} & setup/action & Compute and output coupled twiss parameters. \\ \hline
\hyperref[subsec:divideelements]{\tt divide\_elements} & setup & Specify division of elements into pieces. \\ \hline
\hyperref[subsec:elasticscattering]{\tt elastic\_scattering} & major action & Use tracking to determine local scattering aperture and loss locations due to elastic gas scattering.\\ \hline
\hyperref[subsec:errorelement]{\tt error\_element} & setup & Define errors for a set of elements. \\ \hline
\hyperref[subsec:errorcontrol]{\tt error\_control} & setup & Set up and control error generation process. \\ \hline
\hyperref[subsec:findaperture]{\tt find\_aperture} & setup/major action & Determine the transverse (e.g., dynamic) aperture. \\ \hline
\hyperref[subsec:floorcoordinates]{\tt floor\_coordinates} & action & Compute and output floor coordinates. \\ \hline
\hyperref[subsec:frequencymap]{\tt frequency\_map} & major action & Compute and output frequency map. \\ \hline
\hyperref[subsec:globalsettings]{\tt global\_settings} & action & Change global settings.\\ \hline
\hyperref[subsec:ignoreelements]{\tt ignore\_elements} & setup & Ignore specified elements during tracking. \\ \hline
\hyperref[subsec:inelasticscattering]{\tt inelastic\_scattering} & major action & Use tracking to determine local scattering aperture and loss locations due to inelastic gas scattering.\\ \hline
\hyperref[subsec:insertelements]{\tt insert\_elements} & action & Insert elements into the lattice at many places. \\ \hline
\hyperref[subsec:insertsceffects]{\tt insert\_sceffects} & action & Insert space charge kick elements. \\ \hline
\hyperref[subsec:linearchromatictrackingsetup]{\tt linear\_chromatic\_tracking\_setup} & setup & Set up for fast tracking with chromatic effects. \\ \hline
\hyperref[subsec:linkcontrol]{\tt link\_control} & setup & Control linking of element parameters. \\ \hline
\hyperref[subsec:linkelements]{\tt link\_elements} & setup & Define link between parameters of two elements. \\ \hline
\hyperref[subsec:loadparameters]{\tt load\_parameters} & setup/action & Load element parameters from SDDS file. \\ \hline
\hyperref[subsec:matrixoutput]{\tt matrix\_output} & setup/action & Output transfer matrix along beamline. \\ \hline
\hyperref[subsec:modulateelements]{\tt modulate\_elements} & setup & Set up time-dependent modulation of elements. \\ \hline

\hyperref[subsec:momentsoutput]{\tt moments\_output} & setup/action & Compute coupled beam moments, with radiation option. \\ \hline
\hyperref[subsec:momentumaperture]{\tt momentum\_aperture} & major action & Determine s-dependent momentum aperture. \\ \hline
\hyperref[subsec:optimize]{\tt optimize} & major action & Execute an optimization. \\ \hline
\hyperref[subsec:optimizationcovariable]{\tt optimization\_covariable} & setup & Define a dependent parameter for optimization. \\ \hline
\hyperref[subsec:optimizationsetup]{\tt optimization\_setup} & setup & Perform initial optimization setup. \\ \hline
\hyperref[subsec:optimizationterm]{\tt optimization\_term} & setup & Define a term of penalty function. \\ \hline
\hyperref[subsec:optimizationvariable]{\tt optimization\_variable} & setup & Define an optimization variable. \\ \hline
\hyperref[subsec:paralleloptimizationsetup]{\tt parallel\_optimization\_setup} & setup & Perform initial parallel optimization setup. \\ \hline
\hyperref[subsec:printdictionary]{\tt print\_dictionary} & action & Print the element dictionary. \\ \hline
\hyperref[subsec:rampelements]{\tt ramp\_elements} & setup & Set up turn-by-turn ramping of elements. \\ \hline
\hyperref[subsec:rfsetup]{\tt rf\_setup} & setup/action & Set up RF cavity elements for storage rings. \\ \hline
\hyperref[subsec:rpnexpression]{\tt rpn\_expression} & action & Execute an expression in the rpn interpreter. \\ \hline
\hyperref[subsec:rpnload]{\tt rpn\_load} & action & Load values from SDDS file into rpn interpreter. \\ \hline
\hyperref[subsec:runcontrol]{\tt run\_control} & setup & Set up simulation steps and passes. \\ \hline
\hyperref[subsec:runsetup]{\tt run\_setup} & setup & Define global simulation parameters and output files. \\ \hline
\hyperref[subsec:sasefel]{\tt sasefel} & setup/action & Evaluate SASE FEL gain etc. \\ \hline
\hyperref[subsec:savelattice]{\tt save\_lattice} & action & Save new lattice file. \\ \hline
\hyperref[subsec:sddsbeam]{\tt sdds\_beam} & setup & Define loading of particles from SDDS file. \\ \hline
\hyperref[subsec:semaphores]{\tt semaphores} & setup & Define file semaphores for start/end of run. \\ \hline
\hyperref[subsec:setreferenceparticleoutput]{\tt set\_reference\_particle\_output} & setup  & Define reference particle distribution for optimization \\ \hline
\hyperref[subsec:sliceanalysis]{\tt slice\_analysis} & setup & Perform slice analysis along beamline. \\ \hline
\hyperref[subsec:subprocess]{\tt subprocess} & action & Execute a command in the shell. \\ \hline
\hyperref[subsec:steeringelement]{\tt steering\_element} & setup & Define element parameters as steering correctors. \\ \hline
\hyperref[subsec:transmuteelements]{\tt transmute\_elements} & setup & Transmute elements from one type to another. \\ \hline
\hyperref[subsec:tunefootprint]{\tt tune\_footprint} & setup/action & Compute and optimize chromatic and amplitude tune footprints. \\ \hline
\hyperref[subsec:twissanalysis]{\tt twiss\_analysis} & setup & Define subset of beamline for twiss parameter analysis. \\ \hline
\hyperref[subsec:twissoutput]{\tt twiss\_output} & setup/action & Set up twiss parameter and related computation. \\ \hline
\hyperref[subsec:track]{\tt track} & major action & Execute tracking of particles and other operations. \\ \hline
\hyperref[subsec:tuneshiftwithamplitude]{\tt tune\_shift\_with\_amplitude} & setup & Compute tune shifts with amplitude. \\ \hline
\hyperref[subsec:varyelement]{\tt vary\_element} & setup & Vary element parameters in loops. \\ \hline
%\end{tabular}
%\end{center}
\caption{Table of {\tt elegant} commands and their functions.}
\end{longtable}

\clearpage

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|alter_elements|}\end{center}
%\end{latexonly}
\subsection{alter\_elements\label{subsec:alterelements}}

\begin{itemize}
\item type: action command.
\item function: modify the value of a parameter for one or more elements
\item sequence: must follow \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&alter_elements
        STRING name = NULL;
        STRING item = NULL;
        STRING type = NULL;
        STRING exclude = NULL;
        double value = 0;
        STRING string_value = NULL;
        long differential = 0;
        long multiplicative = 0;
        long alter_at_each_step = 0;
        long alter_before_load_parameters = 0;
        long verbose = 0;
        long allow_missing_elements = 0;
        long allow_missing_parameters = 0;
        long start_occurence = 0;
        long end_occurence = 0;
        double s_start = -1;
        double s_end = -1;
        STRING before = NULL;
        STRING after = NULL;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- A possibly-wildcard-containing string giving the names of the
        elements to alter.  If not specified, then one must specify \verb|type|.
\item \verb|item| --- The name of the parameter to alter.
\item \verb|type| --- A possibly-wildcard-containing string giving the names of element
        {\em types} to alter.  May be specified with \verb|name| or by itself.
\item \verb|exclude| --- A possibly-wildcard-containing string giving the names of elements
        to excluded from alteration.
\item \verb|value|, \verb|string_value| --- The new value for the parameter.  Use
      \verb|string_value| only if the parameter takes a character string as its value.
\item \verb|differential| --- If nonzero, the new value is 
        the predefined value of the parameter plus the quantity given with \verb|value|.
\item \verb|multiplicative| --- If nonozero, the new given value is the predefined
        value of the parameter times the quantity given with \verb|value|.
\item \verb|alter_at_each_step| --- If nonzero, the changes requested by the command are
  performed at each simulation step. Note that if \verb|differential| or \verb|multiplicative|
  are non-zero, then changes will accumulate. (A more conventional way to perform such variation
  is with \verb|vary_elements|.)
\item \verb|alter_before_load_parameters| --- If \verb|alter_at_each_step|, by default the
  alteration takes place after any \verb|load_parameters| commands are processed. If this control is
  non-zero, the alteration takes place before any \verb|load_parameters| commands are processed.
\item \verb|verbose| --- If nonzero, information is printed to the standard output describing
        what elements are changed.
\item \verb|allow_missing_elements| --- If nonzero, then it is not an error if an
        element matching \verb|name| does not exist.   Normally, such
        an occurence is an error and terminates the program.
\item \verb|allow_missing_parameters| --- If nonzero, then it is not an error if an
        element does not have the parameter named with \verb|item|.  Normally, such
        an occurence is an error and terminates the program.
\item \verb|start_occurence|, \verb|end_occurence| --- If nonzero, these give the starting and
 ending occurence numbers of elements that will be altered.  N.B.: if wildcards are used, occurence
 number counting is for each set of identically-named elements separately, rather than for the sequence
 of matched elements.
\item \verb|s_start|, \verb|s_end| --- If non-negative, these give the starting and ending position
 limits for the end-of-element locations of elements to be altered.
\item \verb|after| --- The name of an element.  If given, the alteration is applied only to elements
 that follow the named element in the beamline.  
\item \verb|before| --- The name of an element.  If given, the alteration is applied only to elements
 that precede the named element in the beamline. 
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|amplification_factors|}\end{center}
%\end{latexonly}
\subsection{amplification\_factors \label{subsec:amplificationfactors}}

\begin{itemize}
\item type: action command.
\item function: compute corrected and uncorrected orbit amplification factors and functions.
\item sequence: must be the last command in a sequence.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&amplification_factors
    STRING output = NULL;
    STRING uncorrected_orbit_function = NULL;
    STRING corrected_orbit_function = NULL;
    STRING kick_function = NULL;
    STRING name = NULL;
    STRING type = NULL;
    STRING item = NULL;
    STRING plane = NULL;
    double change = 1e-3;
    long number_to_do = -1;
    double maximum_z = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|output| ---  The (incomplete) name of a file for text output.   Recommended value: ``\%s.af''.
\item \verb|uncorrected_orbit_function| --- The (incomplete) name of a file for an SDDS-format output of the
    uncorrected-orbit amplification function.  Recommended value: ``\%s.uof''.
\item \verb|corrected_orbit_function| --- The (incomplete) name of a file for an SDDS-format output of the
    corrected-orbit amplification function.  Recommended value: ``\%s.cof''.
\item \verb|kick_function| --- The (incomplete) name of a file for an SDDS-format output of the kick amplification function.
Recommended value: ``\%s.kaf''.
\item \verb|name| --- The optionally wildcarded name of the orbit-perturbing elements.  
\item \verb|type| --- The optional type name of the the orbit-perturbing elements.
\item \verb|item| --- The parameter of the elements producing the orbit.
\item \verb|plane| --- The plane (``h'' or ``v'') to examine.
\item \verb|change| --- The parameter change to use in computing the amplification.  
\item \verb|number_to_do| --- The number of elements to perturb.
\item \verb|maximum_z| --- The maximum z coordinate of the elements to perturb.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|analyze_map|}\end{center}
%\end{latexonly}
\subsection{analyze\_map \label{subsec:analyzemap}}

\begin{itemize}
\item type: major action command.
\item function: find the transport matrix up to third order based on particle tracking, based on method described
  in \cite{Borland_thesis}.
  Also find related quantities, such as chromaticity.
\item sequence: must follow \verb|run_control|.
\item can use parallel resources (\verb|Pelegant|)
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&analyze_map
    STRING output = NULL;
    long output_order = 1;
    STRING printout = NULL;
    STRING printout_format = "%22.15e ";
    long printout_order = 2;
    double delta_x = 5e-5;
    double delta_xp = 5e-5;
    double delta_y = 5e-5;
    double delta_yp = 5e-5;
    double delta_s  = 5e-5;
    double delta_dp = 5e-5;
    double accuracy_factor = 1e-12;
    long center_on_orbit = 0;
    long verbosity = 0;
    long canonical_variables = 0;
    long periodic = 1;
    double beta_x = 1;
    double alpha_x = 0;
    double eta_x = 0;
    double etap_x = 0;
    double beta_y = 1;
    double alpha_y = 0;
    double eta_y = 0;
    double etap_y = 0;
    long n_points = 9;
    long max_fit_order = 8;
&end
\end{verbatim}

\begin{itemize}
\item \verb|output| --- The (incomplete) name of a file for SDDS output.
    \begin{itemize}
    \item Recommended value: ``\%s.ana''.
    \item File contents:  A series of pages, each consisting of a single data point containing
        the centroid offsets for a single turn, the single-turn R matrix, the matched Twiss parameters, tunes, and 
        dispersion functions.
    \end{itemize}
\item \verb|printout| --- The (incomplete) name of a file for text output of the matrix.
\item \verb|printout_format| --- The C-style formatting statement for the matrix elements. A space, comma, or other separator
  should appear at the end of the string.
\item \verb|delta_X| --- The amount by which to change the quantity X in computing the derivatives that give the matrix elements.
\item \verb|accuracy_factor| --- The fraction of the maximum absolute value of the final coordinate that is considered meaningful.
  Used to estimate errors and eliminate spurious matrix elements.
\item \verb|canonical_variables| --- If non-zero, the matrix is expressed in terms of canonical variables $(x, q_x, y, q_y, -s, \delta)$
  instead of the default $(x, x^\prime, y, y^\prime, s, \delta)$.
\item \verb|center_on_orbit| --- A flag directing the expansion to be made about the closed orbit instead of the design orbit.
\item \verb|verbosity| --- The larger this value, the more output is printed during computations.
\item \verb|printout_order| --- Order of the matrix to be printed to the \verb|printout| file.
\item \verb|periodic| --- If non-zero, system is assumed to be periodic and lattice functions, tunes, chromaticities, etc are computed.
\item \verb|beta_x|, \verb|alpha_x|, \verb|eta_x|, \verb|etap_x|, \verb|beta_y|, \verb|alpha_y|, \verb|eta_y|, \verb|etap_y| ---
  If \verb|periodic=0|, these are the starting values for the lattice functions.
\item \verb|n_points| --- Number of points in each phase-space dimension.
\item \verb|max_fit_order| --- Maximum order of fits using in determining the matrix elements.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|aperture_data|}\end{center}
%\end{latexonly}
\subsection{aperture\_data \label{subsec:aperturedata}}

\begin{itemize}
\item type: setup command.
\item function: specify a file from which to take x and y aperture data vs s.
\item note: this command is also available under the name \verb|aperture_input|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&aperture_data
        STRING input = NULL;
        long periodic = 1; 
        long persistent = 0;
        long disable = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|input| --- Name of SDDS file supplying the aperture data.  The following columns are
  all required, in double or float type, with units of \verb|m| (meters).
  \begin{enumerate}
    \item \verb|s| --- Distance along the central trajectory.  
    \item \verb|xHalfAperture| --- Half aperture in the horizontal. 
    \item \verb|yHalfAperture| --- Half aperture in the vertical.
    \item \verb|xCenter| --- Center of the aperture in the horizontal.
    \item \verb|yCenter| --- Center of the aperture in the vertical.
  \end{enumerate}
\item \verb|periodic| --- If non-zero, the aperture is a periodic function of \verb|s|, with period equal
  to the range of the data.
\item \verb|persistent| --- If non-zero, the aperture data persists across subsequent \verb|run_setup| commands.
  By default, the aperture data is forgotten when a new \verb|run_setup| command is seen.
\item \verb|disable| --- If non-zero, the command is ignored.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|bunched_beam|}\end{center}
%\end{latexonly}
\subsection{bunched\_beam \label{subsec:bunchedbeam}}

\begin{itemize}
\item type: setup command.
\item sequence: must follow \verb|run_control|.
\item function: set up for tracking of particle coordinates with various distributions.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item Notes:
  \begin{itemize}
  \item In \verb|Pelegant|, the exact particles generated will change as the number of cores is changed.
  \item This command is used when it is convenient to specify the beam dimensions in terms of lattice functions
    and emittances. The \verb|bunched_beam_moments| command can be used when it is more convenient to specify
    beam sizes, divergences, etc.
  \end{itemize}
\end{itemize}

\begin{verbatim}
&bunched_beam
    STRING bunch = NULL;
    long n_particles_per_bunch = 1;
    double time_start = 0;
    STRING matched_to_cell = NULL;
    double emit_x  = 0;
    double emit_nx  = 0;
    double beta_x  = 1.0;
    double alpha_x = 0.0;
    double eta_x   = 0.0;
    double etap_x  = 0.0;
    double emit_y  = 0;
    double emit_ny  = 0;
    double beta_y  = 1.0;
    double alpha_y = 0.0;
    double eta_y   = 0.0;
    double etap_y  = 0.0;
    long use_twiss_command_values = 0;
    long use_moments_output_values = 0;
    double Po = 0.0;
    double sigma_dp = 0.0;
    double sigma_s = 0.0;
    double dp_s_coupling = 0;
    double emit_z = 0;
    double beta_z = 0;
    double alpha_z = 0;
    double momentum_chirp = 0;
    long one_random_bunch = 1;
    long symmetrize = 0;
    long halton_sequence[3] = {0, 0, 0};
    long halton_radix[6] = {0, 0, 0, 0, 0, 0};
    long optimized_halton = 0;
    long randomize_order[3] = {0, 0, 0};
    long limit_invariants = 0;
    long limit_in_4d = 0;
    long enforce_rms_values[3] = {0, 0, 0};
    double distribution_cutoff[3] = {2, 2, 2};
    STRING distribution_type[3] = {"gaussian","gaussian","gaussian"};
    double centroid[6] = {0.0, 0.0, 0.0, 0.0, 0.0, 0.0};
    long first_is_fiducial = 0;
    long save_initial_coordinates = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|bunch| --- The (incomplete) name of an SDDS file to which the phase-space coordinates
of the bunches are to be written.  Recommended value: ``\%s.bun''.  
\item \verb|n_particles_per_bunch| --- Number of particles in each bunch.
\item \verb|time_start| --- The central value of the time coordinate for the bunch.
\item \verb|matched_to_cell| --- The name of a beamline from which the Twiss parameters of the bunch
are to be computed.
\item \verb|emit_X| --- RMS emittance for the X plane.
\item \verb|emit_nX| --- RMS normalized emittance for the X plane.  Ignored if \verb|emit_X| is nonzero.
\item \verb|beta_X|, \verb|alpha_X|, \verb|eta_X|, \verb|etap_X| --- Twiss parameters for the X plane.
\item \verb|use_twiss_command_values| --- If nonzero, then the values for $\beta$, $\alpha$, 
        $\eta$, and $\eta^\prime$ are taken from the \verb|twiss_output| command.  It is an error if
        no \verb|twiss_output| command has been given.
\item \verb|use_moments_output_values| --- If nonzero, then the beam is generated to match the
  6D matched, equilibrium beam moments computed by the \verb|moments_output| command.
  The distribution type must be gaussian.
  This mode is incompatible with using closed orbit correction with \verb|start_from_centroid=1|
  (the default value).
\item \verb|Po| --- Central momentum of the bunch.
\item \verb|sigma_dp|, \verb|sigma_s| --- Fractional momentum spread, ${\rm \delta}$, and bunch length.
Note that \verb|sigma_s| is actually the length in $\beta_z*c*t$, so that for $\beta_z<<1$ the length of
the bunch in time will be greater than one might expect.
\item \verb|dp_s_coupling| ---  Specifies the coupling between s and ${\rm \delta}$, defined as 
${\rm \langle s \delta \rangle/(\sigma_s\sigma_\delta)}$.
\item \verb|emit_z|, \verb|beta_z|, \verb|alpha_z| --- Provide another way to specify the
 longitudinal phase space, either separately from or in combination with 
 \verb|sigma_dp|, \verb|sigma_s|, and \verb|dp_s_coupling|.  

Basically, which values {\tt elegant} uses depends on what one sets to
nonzero values.  If one sets emit\_z, then sigma\_dp, sigma\_s, and
dp\_s\_coupling are ignored.  If one doesn't set emit\_z, then {\tt
elegant} uses sigma\_dp and sigma\_s; it additionally uses alpha\_z if
it is nonzero, otherwise it uses dp\_s\_coupling.  For reference, the
relationship between them is $ C =
\frac{\Sigma_{56}}{\sqrt{\Sigma_{55}\Sigma_{66}}} =
-\frac{\alpha}{\sqrt{1+\alpha^2}}$.  Note that to impart a chirp that
results in compression for $R_{56}<0$ (e.g., a normal four-dipole
chicane), one must have $\alpha_z<0$ or $C>0$.

\item \verb|momentum_chirp| --- Permits imparting an additional
momentum chirp to the beam, in units of 1/m.  E.g., a value of 1
indicates that a 1mm long bunch has a linear variation in momentum of
0.1\% from end-to-end.  A positive chirp is needed to provide
compression of a bunch with an ordinary $R_{56}<0$ four-dipole
chicane.

\item \verb|one_random_bunch| --- If non-zero, then only one random
particle distribution is generated.  Otherwise, a new distribution
will be generated for every simulation step.

\item \verb|enforce_rms_values[3]| --- Flags, one for each plane,
indicating whether to force the distribution to have the specified RMS
properties.

\item \verb|distribution_cutoff[3]| --- Distribution cutoff parameters
for each plane.  For gaussian distributions, this is the number of
sigmas to use.  For other distributions (except dynamic aperture),
this number simply multiplies the sizes.  This is potentially
confusing and hence it is suggested that the distribution cutoff be
set to 1 for nongaussian beams.

The exception is ``dynamic-aperture'' distribution type.  In this case,
the cutoff value is the number of grid points in the dimension in question.

\item \verb|distribution_type[3]| --- Distribution type for each
plane.  May be ``gaussian'', ``hard-edge'', ``uniform-ellipse'',
``shell'', ``dynamic-aperture'', ``line'', ``halo(gaussian)''.

For the transverse plane, the interpretation of the emittance is
different for the different beam types.  For gaussian beams, the
emittances are rms values.  For all other types, $\sqrt{\epsilon*\beta}$
times the distribution cutoff defines the edge of the beam in position
space, while $\sqrt{\epsilon*(1+\alpha^2)/\beta}$ times the distribution
cutoff defines the edge of the beam in slope space.  

A hard-edge beam is a uniformly-filled parallelogram in phase space.
A uniform-ellipse beam is a uniformly-filled ellipse in phase space.
A shell beam is a hollow ellipse in phase space.  A dynamic aperture
beam has zero slope and uniform spacing in position coordinates.  A
line beam is a line in phase space.  A ``halo(gaussian)'' beam is
the part of the gaussian distribution {\em beyond} the distribution cutoff.

\item \verb|limit_invariants| --- If non-zero, the distribution
cutoffs are applied to the invariants, rather than to the coordinates.
This is useful for gaussian beams when the distribution cutoff is
small.

\item \verb|limit_in_4d| --- If non-zero, then the transverse
distribution is taken to be a 4-d gaussian or uniform distribution.
One of these must be chosen using the \verb|distribution_type|
control.  It must be the same for x and y.  This is useful, for
example, if you want to make a cylindrically symmetric beam.

\item \verb|symmetrize| --- If non-zero, the distribution is symmetric
under changes of sign in the coordinates.  Automatically results in a
zero centroid for all coordinates.

\item \verb|halton_sequence[3]| and \verb|halton_radix[6]| and \verb|optimized_halton|
--- This provides a ``quiet-start'' feature by choosing Halton sequences in
place of random number generation.  There are three new variables that
control this feature.  \verb|halton_sequence| is an array of three
flags that permit turning on Halton sequence generation for the
horizontal, vertical, or longitudinal planes.  For example,
\verb|halton_sequence[0] = 3*1| will turn on Halton sequences for all
three planes, while \verb|halton_sequence[2] = 1|, will turn it on for
the longitudinal plane only.

\verb|halton_radix| is an array of six integers that permit giving the
radix for each sequence (i.e., x, x', y, y', t, p).  Each radix must
be a prime number.  One should never use the same prime for two
sequences, unless one randomizes the order of the sequences relative to
each other (see the next item).  If these are left at zero, then
elegant chooses values that eliminate phase-space banding to some
extent.  The user is cautioned to plot all coordinate combinations for
the initial phase space to ensure that no unacceptable banding is
present.

A suggested way to use Halton sequences is to set
\verb|halton_radix[0] = 2, 3, 2, 3, 2, 3| and
to set 
\verb|randomize_order[0] = 2, 2, 2,|.  This avoids banding that may
result from choosing larger radix values.

\verb|optimized_halton| uses the improved halton sequence \cite{Chi2005}.
(Algorithm 659, Collected Algorithm from ACM. Derandom Algorithm is added
by Hongmei CHI (CS/FSU)). It avoids the banding problem automatically and
the \verb|halton_radix| values are ignored.

\item \verb|randomize_order[3]| --- Allows randomizing the order of
assigned coordinates for the pairs (x, x'), (y, y'), and (t,p).  0
means no randomization; 1 means randomize (x, x', y, y', t, p) values
independently, which destroys any x-x', y-y', and t-p correlations; 2
means randomize (x, x'), (y, y'), and (t, p) in pair-wise fashion.
This is used with Halton sequences to remove banding.  It is suggested
that that the user employ \verb|sddsanalyzebeam| to verify that the
beam properties when randomization is used.

\item \verb|centroid[6]| --- Centroid offsets for each of the six coordinates.

\item \verb|first_is_fiducial| --- Specifies that the first beam
generated shall be a single particle beam, which is suitable for
fiducialization.  See the section on ``Fiducialization in
\verb|elegant|'' for more discussion.

\item \verb|save_initial_coordinates| --- A flag that, if set, results
in saving initial coordinates of tracked particles in memory.  This is
the default behavior.  If unset, the initial coordinates are not
saved, but are regenerated each time they are needed.  This is more
memory efficient and is useful for tracking very large numbers of
particles.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|bunched_beam_moments|}\end{center}
%\end{latexonly}
\subsection{bunched\_beam\_moments \label{subsec:bunchedbeammoments}}

\begin{itemize}
\item type: setup command.
\item sequence: must follow \verb|run_control|.
\item function: set up for tracking of particle coordinates with various distributions.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item Notes:
  \begin{itemize}
  \item In \verb|Pelegant|, the exact particles generated will change as the number of cores is changed.
  \item This command is used when it is convenient to specify the beam dimensions in terms of beam sizes, divergences,
    and other moments. 
    The \verb|bunched_beam| command can be used when it is more convenient to specify lattice functions, emittances, etc.
  \end{itemize}
\end{itemize}

\begin{verbatim}
&bunched_beam_moments
    STRING bunch = NULL;
    long n_particles_per_bunch = 1;
    long use_moments_output_values = 0;
    double S1_beta = 0;
    double S2_beta = 0;
    double S12_beta = 0;
    double S16 = 0;
    double S26 = 0;
    double S3_beta = 0;
    double S4_beta = 0;
    double S34_beta = 0;
    double S36 = 0;
    double S46 = 0;
    double S5 = 0;
    double S6 = 0;
    double S56 = 0;
    double time_start = 0;
    double Po = 0.0;
    long one_random_bunch = 1;
    long save_initial_coordinates = 1;
    long limit_invariants = 0;
    long symmetrize = 0;
    long halton_sequence[3] = {0, 0, 0};
    int32_t halton_radix[6] = {0, 0, 0, 0, 0, 0};
    long optimized_halton = 0;
    long randomize_order[3] = {0, 0, 0};
    long limit_in_4d = 0;
    long enforce_rms_values[3] = {0, 0, 0};
    double distribution_cutoff[3] = {2, 2, 2};
    STRING distribution_type[3] = {"gaussian","gaussian","gaussian"};
    double centroid[6] = {0.0, 0.0, 0.0, 0.0, 0.0, 0.0};
    long first_is_fiducial = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|bunch| --- The (incomplete) name of an SDDS file to which the phase-space coordinates
of the bunches are to be written.  Recommended value: ``\%s.bun''.  
\item \verb|n_particles_per_bunch| --- Number of particles in each bunch.
\item \verb|time_start| --- The central value of the time coordinate for the bunch.
\item \verb|matched_to_cell| --- The name of a beamline from which the Twiss parameters of the bunch
are to be computed.
\item \verb|use_moments_output_values| --- If nonzero, then the beam is generated to match the
  6D matched, equilibrium beam moments computed by the \verb|moments_output| command.
  The distribution type must be gaussian.
  This mode is incompatible with using closed orbit correction with \verb|start_from_centroid=1|
  (the default value).
\item \verb|Po| --- Central momentum of the bunch.

\item \verb|S1_beta|, \verb|S2_beta|, \verb|S3_beta|, \verb|S4_beta| --- Horizontal beam size and divergence, vertical
  beam size and divergence, for betatron coordinates. For example, for the $x$ coordinate, we have
\begin{equation}
x = x_\beta + \delta \eta_x
\end{equation}
where $x_\beta$ is the betatron component, $\delta$ is the fractional momentum deviation, and $\eta_x = \Sigma_{16}/\Sigma_{66}$.
\item \verb|S5| --- Fractional energy spread.
\item \verb|S6| --- Fractional bunch length.
\item \verb|S56| --- $\Sigma_{56}$.
\item \verb|S|{\em i}{\em j}\verb|_beta| --- Element of the beam sigma matrix for betatron coordinates.

\item \verb|one_random_bunch| --- If non-zero, then only one random
particle distribution is generated.  Otherwise, a new distribution
will be generated for every simulation step.

\item \verb|enforce_rms_values[3]| --- Flags, one for each plane,
indicating whether to force the distribution to have the specified RMS
properties.

\item \verb|distribution_cutoff[3]| --- Distribution cutoff parameters
for each plane.  For gaussian distributions, this is the number of
sigmas to use.  For other distributions (except dynamic aperture),
this number simply multiplies the sizes.  This is potentially
confusing and hence it is suggested that the distribution cutoff be
set to 1 for nongaussian beams.

The exception is ``dynamic-aperture'' distribution type.  In this case,
the cutoff value is the number of grid points in the dimension in question.

\item \verb|distribution_type[3]| --- Distribution type for each
plane.  May be ``gaussian'', ``hard-edge'', ``uniform-ellipse'',
``shell'', ``dynamic-aperture'', ``line'', ``halo(gaussian)''.

For the transverse plane, the interpretation of the emittance is
different for the different beam types.  For gaussian beams, the
emittances are rms values.  For all other types, $\sqrt{\epsilon*\beta}$
times the distribution cutoff defines the edge of the beam in position
space, while $\sqrt{\epsilon*(1+\alpha^2)/\beta}$ times the distribution
cutoff defines the edge of the beam in slope space.  

A hard-edge beam is a uniformly-filled parallelogram in phase space.
A uniform-ellipse beam is a uniformly-filled ellipse in phase space.
A shell beam is a hollow ellipse in phase space.  A dynamic aperture
beam has zero slope and uniform spacing in position coordinates.  A
line beam is a line in phase space.  A ``halo(gaussian)'' beam is
the part of the gaussian distribution {\em beyond} the distribution cutoff.

\item \verb|limit_invariants| --- If non-zero, the distribution
cutoffs are applied to the invariants, rather than to the coordinates.
This is useful for gaussian beams when the distribution cutoff is
small.

\item \verb|limit_in_4d| --- If non-zero, then the transverse
distribution is taken to be a 4-d gaussian or uniform distribution.
One of these must be chosen using the \verb|distribution_type|
control.  It must be the same for x and y.  This is useful, for
example, if you want to make a cylindrically symmetric beam.

\item \verb|symmetrize| --- If non-zero, the distribution is symmetric
under changes of sign in the coordinates.  Automatically results in a
zero centroid for all coordinates.

\item \verb|halton_sequence[3]| and \verb|halton_radix[6]| and \verb|optimized_halton|
--- This provides a ``quiet-start'' feature by choosing Halton sequences in
place of random number generation.  There are three new variables that
control this feature.  \verb|halton_sequence| is an array of three
flags that permit turning on Halton sequence generation for the
horizontal, vertical, or longitudinal planes.  For example,
\verb|halton_sequence[0] = 3*1| will turn on Halton sequences for all
three planes, while \verb|halton_sequence[2] = 1|, will turn it on for
the longitudinal plane only.

\verb|halton_radix| is an array of six integers that permit giving the
radix for each sequence (i.e., x, x', y, y', t, p).  Each radix must
be a prime number.  One should never use the same prime for two
sequences, unless one randomizes the order of the sequences relative to
each other (see the next item).  If these are left at zero, then
elegant chooses values that eliminate phase-space banding to some
extent.  The user is cautioned to plot all coordinate combinations for
the initial phase space to ensure that no unacceptable banding is
present.

A suggested way to use Halton sequences is to set
\verb|halton_radix[0] = 2, 3, 2, 3, 2, 3| and
to set 
\verb|randomize_order[0] = 2, 2, 2,|.  This avoids banding that may
result from choosing larger radix values.

\verb|optimized_halton| uses the improved halton sequence \cite{Chi2005}.
(Algorithm 659, Collected Algorithm from ACM. Derandom Algorithm is added
by Hongmei CHI (CS/FSU)). It avoids the banding problem automatically and
the \verb|halton_radix| values are ignored.

\item \verb|randomize_order[3]| --- Allows randomizing the order of
assigned coordinates for the pairs (x, x'), (y, y'), and (t,p).  0
means no randomization; 1 means randomize (x, x', y, y', t, p) values
independently, which destroys any x-x', y-y', and t-p correlations; 2
means randomize (x, x'), (y, y'), and (t, p) in pair-wise fashion.
This is used with Halton sequences to remove banding.  It is suggested
that that the user employ \verb|sddsanalyzebeam| to verify that the
beam properties when randomization is used.

\item \verb|centroid[6]| --- Centroid offsets for each of the six coordinates.

\item \verb|first_is_fiducial| --- Specifies that the first beam
generated shall be a single particle beam, which is suitable for
fiducialization.  See the section on ``Fiducialization in
\verb|elegant|'' for more discussion.

\item \verb|save_initial_coordinates| --- A flag that, if set, results
in saving initial coordinates of tracked particles in memory.  This is
the default behavior.  If unset, the initial coordinates are not
saved, but are regenerated each time they are needed.  This is more
memory efficient and is useful for tracking very large numbers of
particles.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|change_particle|}\end{center}
%\end{latexonly}
\subsection{change\_particle\label{subsec:changeparticle}}

\begin{itemize}
\item type: action command.
\item function: change the particle type from the default value of ``electron.''
\item sequence: must precede \verb|run_setup|.
\item N.B.: this feature has had limited testing, mostly to verify that electron tracking is not
 impacted by the implementation.  Please use with caution and be alert for suspicious results.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&change_particle
    STRING name = "electron";
    double mass_ratio = 0;
    double charge_ratio = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- The name of the particle to use.  Possible values are \verb|electron|, \verb|positron|,
  \verb|proton|, \verb|muon|, and \verb|custom|.
\item \verb|mass_ratio|, \verb|charge_ratio| --- If the particle name is ``custom,'' these parameters specify the
  mass and charge of the particle relative to the electron.  E.g., for an anti-proton, one would use
  a mass ratio of 1836.18 and a charge ratio of 1.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|change_start|}\end{center}
%\end{latexonly}
\subsection{change\_particle\label{subsec:changestart}}

\begin{itemize}
\item type: action command.
\item function: change the starting point in a lattice
\item sequence: must precede \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&change_start
          STRING element_name = NULL;
          long ring_mode = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|element_name| --- Name of the element where the lattice will start, which implies removing all 
  elements upstream of the named element. If the element occurs more than once, the first instance is used.
  The named element will be the first element in the lattice.
\item \verb|ring_mode| --- If nonzero, the ring structure of the lattice is preserved by moving the elements 
  upstream of the named element to the end of the lattice.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|chaos_map|}\end{center}
%\end{latexonly}
\subsection{chaos\_map \label{subsec:chaosmap}}

\begin{itemize}
\item type: major action command.  
\item function: compute chaos map from tracking.
      Note that the number of turns tracked is set by the \verb|run_control| command.
\item can use parallel resources (\verb|Pelegant|)
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item NB: this feature is new in 2019.4 and somewhat experimental. Please report problems on the forum.
\end{itemize}

\begin{verbatim}
&chaos_map
    STRING output = NULL;
    double xmin =  -0.1;
    double xmax =  0.1;
    double ymin =  1e-6;
    double ymax =  0.1;
    double delta_min = 0;
    double delta_max = 0;
    long nx = 20;
    long ny = 21;
    long ndelta = 1;
    long forward_backward = 0;
    double change_x = 1e-6;
    double change_y = 1e-6;
    long verbosity = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|output| --- The (incomplete) name of an SDDS file to send output to.  
 Recommended value: ``\%s.cmap''.  For the parallel version, particles will be listed in essentially
 random order.  If needed, \verb|sddssort| can be used to sort particles by initial coordinates.
\item \verb|xmin|, \verb|xmax| --- Limits of grid of initial x coordinates for tracking.             
\item \verb|ymin|, \verb|ymax| --- Limits of grid of initial y coordinates for tracking.             
 \verb|ymin| should be a small, positive value so that there                               
 is some betatron oscillation from which to get the tune.                      
\item \verb|delta_min|, \verb|delta_max| --- Limits of grid of initial $\delta$ coordinates
for tracking.  Note that particles are not centered around the dispersive closed orbit.  Hence,
the tracking is appropriate to simulation of dynamics from a touschek scattering event.
\item \verb|nx| --- Number of values of x coordinate in the grid.
\item \verb|ny| --- Number of values of y coordinate in the grid.
\item \verb|ndelta| --- Number of values of $\delta$ coordinate in the grid.
\item \verb|forward_backward| --- If non-zero, uses the forward/backward integration technique of Y. Li {\em et al.} 
  \cite{Li-arxiv-1912.00121}. The number of passes tracked is still controlled by the \verb|n_passes| parameter of 
  \verb|run_control|. In addition, the number of iterations of forward and backward tracking is given by the
  value of \verb|forward_backward|.
  If zero, a less interesting technique is used that computes the change in $J_x$ and $J_y$ from tracking with
  small changes in initial conditions.
\item \verb|change_x|, \verb|change_y| --- If  \verb|forward_backward| is zero, gives the perturbation to 
  initial x and y used to assess chaotic motion from divergence of trajectories.
\item \verb|verbosity| --- If nonzero, prints possibly useful information while running.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|chromaticity|}\end{center}
%\end{latexonly}
\subsection{chromaticity \label{subsec:chromaticity}}

\begin{itemize}
\item type: setup command.
\item function: set up for chromaticity correction.
\item sequence: should follow \verb|twiss_output|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&chromaticity
    STRING sextupoles = NULL;
    STRING lower_limits = NULL;
    STRING upper_limits = NULL;
    STRING exclude = NULL;
    double dnux_dp = 0;
    double dnuy_dp = 0;
    double sextupole_tweek = 1e-3;
    double correction_fraction = 0.9;
    long n_iterations = 5;
    double tolerance = 0;
    STRING strength_log = NULL;
    long change_defined_values = 0;
    double strength_limit = 0;
    long use_perturbed_matrix = 0;    
    long exit_on_failure = 0;
    long update_orbit = 0;
    long verbosity = 1;
    double dK2_weight = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|sextupoles| --- List of names of elements to use to correct the chromaticities.  Several names may be given and names may include
  wildcards. If so, then sextupoles in each group are changed by the same amount for each iteration.
  This would typically be used when the sextupoles are nominally identical (though perhaps differing in strength because of
  introduced errors). If that's not the case, the iteration may fail to converge.
\item \verb|lower_limits|, \verb|upper_limits| --- Lists of lower and upper limits for each family. The input style is
  unusual for {\tt elegant}, given that lists of numbers are to be provided in a string. For example
\begin{verbatim}
&chromaticity
 sextupoles = "S1 S2 S3",
 lower_limits = "0 -1.5 0",
 upper_limits = "1.75 0 1.25"
 ...
&end
\end{verbatim}
\item \verb|strength_limit| --- Deprecated. Limit on the absolute value of sextupole strength ($K_2$).
\item \verb|exclude| --- List of names of elements to exclude. This may be used to exclude some sextupoles that are matched by wildcards in
  the \verb|sextupole| list.
\item \verb|dK2_weight| --- Weighting factor that is used to minimize the mean-square changes in $K_2$ values in the
  event that there are more than two families.
\item \verb|dnux_dp|, \verb|dnuy_dp| --- Desired chromaticity values.
\item \verb|sextupole_tweek| --- Amount by which to tweak the sextupoles to compute derivatives of
chromaticities with respect to sextupole strength.  [The word ``tweak'' is misspelled ``tweek'' in the code.]
\item \verb|correction_fraction| --- Fraction of the correction to apply at each iteration.  In some
cases, correction is unstable at this number should be reduced.
\item \verb|n_iterations| --- Number of iterations of the correction to perform.
\item \verb|tolerance| --- Stop iterating when chromaticities are within this value of the
desired values.
\item \verb|strength_log| --- The (incomplete) name of an SDDS file to which the sextupole strengths will
be written.  Recommended value: ``\%s.ssl''. May be used with \verb|load_parameters|.
\item \verb|change_defined_values| --- Changes the defined values of the sextupole strengths.
This means that when the lattice is saved (using \verb|save_lattice|), the sextupoles will
have the corrected values.  This would be used for correcting the chromaticity of a design
lattice, for example, but not for correcting chromaticity of a perturbed lattice.
\item \verb|use_perturbed_matrix| --- If nonzero, requests use of the perturbed correction matrix in
performing correction.  For difficult lattices with large errors, this may be necessary
to obtain correction.  In general, it is not necessary and only slows the simulation.
\item \verb|exit_on_failure| --- If nonzero, then failure to reach the desired chromaticities within the
  tolerance results in the program exiting.
\item \verb|update_orbit| --- If non-zero, the orbit calculation is updated after each $n^{th}$ adjustment of the
  sextupoles.
\item \verb|verbosity| --- Increasing positive values result in increasing amounts of information printed during
  execution.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|closed_orbit|}\end{center}
%\end{latexonly}
\subsection{closed\_orbit \label{subsec:closedorbit}}

\begin{itemize}
\item type: setup command.
\item function: set up for computation of the closed orbit.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&closed_orbit
    STRING output = NULL;
    long output_monitors_only = 0;
    long start_from_centroid = 1;
    long start_from_dp_centroid = 0;
    double closed_orbit_accuracy = 1e-12;
    double closed_orbit_accuracy_requirement = 1e-7;
    long closed_orbit_iterations = 40;
    long fixed_length = 0;
    long start_from_recirc = 0;
    long verbosity = 0;
    double iteration_fraction = 0.9;
    double fraction_multiplier = 1.05;
    double multiplier_interval = 5;
    long output_monitors_only = 0;
    long tracking_turns = 0;
    long disable = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|output| --- The (incomplete) name of an SDDS file to which
the closed orbits will be written.  Recommended value: ``\%s.clo''.
\item \verb|output_monitors_only| --- If non-zero, indicates that the
closed orbit output should include only the data at the locations of
the beam-position monitors.
\item \verb|start_from_centroid| --- A flag indicating whether to
force the computation to start from the centroids of the beam
distribution.
\item \verb|start_from_dp_centroid| --- A flag indicating whether to 
force the computation to use the momentum centroid of the beam 
for the closed orbit.  This can allow computing the closed orbit
for an off-momentum beam, then starting the beam on that orbit
using the \verb|offset_by_orbit| or \verb|center_on_orbit| parameters
of the \verb|track| command.  In contrast to the \verb|start_from_centroid|,
this command doesn't force the algorithm to start from the beam
transverse centroids.
\item \verb|closed_orbit_accuracy| --- The desired accuracy of the
closed orbit, in terms of the difference between the start and end
coordinates, in meters. Iteration will terminate when this value is achieved.
\item \verb|closed_orbit_accuracy_requirement| --- The required accuracy of the
closed orbit. If not achieved, the closed orbit calculation is considered to 
have failed.
\item \verb|closed_orbit_iterations| --- The number of iterations to
take in finding the closed orbit.
\item \verb|iteration_fraction| --- Fraction of computed change that
is used each iteration.  For lattices that are very nonlinear or close
to unstable, a number less than 1 can be helpful.  Otherwise, it only
slows the simulation.
\item \verb|fixed_length| --- A flag indicating whether to find a
closed orbit with the same length as the design orbit by changing the
momentum offset.
\item \verb|start_from_recirc| --- A flag indicating whether to
compute the closed orbit from the recirculation (\verb|recirc|)
element in the beamline.  In general, if one has a recirculation
element, one should give this flag.
\item \verb|verbosity| --- A larger value results in more printouts
during the computations.
\item \verb|iteration_fraction| --- Controls the fraction of the update to apply
  when iterating toward a closed orbit. Smaller numbers give less chance of instability
  at the price of slower convergence.e
\item \verb|fraction_multiplier| --- Multiplier to apply to the iteration fraction if
  iteration is converging.
\item \verb|multiplier_interval| --- Interval in number of iterations at which to adjust
  the iteration fraction.
\item \verb|output_monitors_only|  --- If non-zero, output file contains data only at beam position monitors,
  i.e., at \verb|MONI|, \verb|HMON|, and \verb|VMON| elements.
\item \verb|tracking_turns| --- If non-zero, the number of turns to track for detemination 
  of the closed orbit by averaging. This may be useful if the regular closed orbit algorithm
  complains about convergence issues.
\item \verb|disable| --- If non-zero, disables the command.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|correct|}\end{center}
%\end{latexonly}
\subsection{correct \label{subsec:correct}}

\begin{itemize}
\item type: setup command.
\item sequence: must follow \verb|run_setup| and precede beam definition (\verb|bunched_beam| or \verb|sdds_beam|).
\item function: set up for correction of the trajectory or closed orbit.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&correct
    STRING mode = "trajectory";
    STRING method = "global";
    STRING trajectory_output = NULL;
    STRING corrector_output = NULL;
    STRING statistics = NULL;
    STRING bpm_output = NULL;
    double corrector_tweek[2] = {1e-6, 1e-6};
    double corrector_limit[2] = {0, 0};
    double correction_fraction[2] = {1, 1};
    double correction_accuracy[2] = {1e-6, 1e-6};
    long do_correction[2] = {1, 1};
    long remove_smallest_SVs[2] = {0, 0};
    long keep_largest_SVs[2] = {0, 0};
    double minimum_SV_ratio[2] = {0, 0};
    long auto_limit_SVs[2] = {1, 1};
    long removed_pegged[2] = {0, 0};
    long threading_divisor[2] = {100, 100};
    long threading_correctors[2] = {-1, -1};
    double bpm_noise[2] = {0, 0};
    double bpm_noise_cutoff[2] = {1.0, 1.0};
    STRING bpm_noise_distribution[2] = {"uniform", "uniform"};
    long verbose = 1;
    long fixed_length = 0;
    long fixed_length_matrix = 0;
    long n_xy_cycles = 1;
    long minimum_cycles = 1;
    long force_alternation = 0;
    long n_iterations = 1;
    long prezero_correctors = 1;
    long track_before_and_after = 0;
    long start_from_centroid = 1;
    long use_actual_beam = 0;
    double closed_orbit_accuracy = 1e-12;
    double closed_orbit_accuracy_requirement = 1e-7;
    long closed_orbit_iterations = 40;
    double closed_orbit_iteration_fraction = 0.9;
    double closed_orbit_fraction_multiplier = 1.05;
    double closed_orbit_multiplier_interval = 5;
    double closed_orbit_tracking_turns = 0;
    long use_perturbed_matrix = 0;
    long disable = 0;
    long use_response_from_computed_orbits = 0;
&end
\end{verbatim}

In the case of array variables with dimension 2, the first entry is for the horizontal plane and the second
is for the vertical plane.

\begin{itemize}

\item \verb|mode| --- Either ``trajectory'' or ``orbit'', indicating
correction of a trajectory or a closed orbit.
\item \verb|method| --- For trajectories, may be ``one-to-one'', ``one-to-best'', ``one-to-next'', ``thread'', ``global'',
  or ``coupled''.
``One-to-one'' and ``one-to-next'' are the same: steering is performed by pairing one corrector with the next downstream BPM.
``One-to-best'' attempts to find a BPM with a large response to each corrector.  ``Thread'' does corrector sweeps to work the
beam through a beamline with apertures; it is quite slow.  ``Global'' simply uses the global response matrix; it is the best
choice if the trajectory is not lost on an aperture. ``Coupled'' is like global, but should be used for strongly-coupled
transport lines; in this case, only \verb|HMON| and \verb|VMON| elements are permitted for monitors and only
\verb|EHKICK|, \verb|EVKICK|, \verb|HKICK|, and \verb|VKICK| elements are permitted for correctors.
For closed orbit, must be ``global''.
\item \verb|trajectory_output| --- The (incomplete) name of an SDDS file to which the trajectories or orbits will be written.  Recommended value: ``\%s.traj'' or ``\%s.orb''.  
\item \verb|corrector_output| --- The (incomplete) name of an SDDS file to which information about the final corrector strengths will be written. Recommended value: ``\%s.cor''.  N.B.: although this file looks as if it can be used with the \verb|load_parameters| command, care must be exercised because the data for the
horizontal and vertical planes is on separate pages. Typically, one will need to use \verb|sddscombine -merge=Step ...| in order to place the data from both planes on the same page. Also, be aware that if all correctors have the same name, using \verb|change_defined_values=1| on \verb|load_parameters| will not produce the expected results. See the documentation for \verb|load_parameters| for more details.
\item \verb|statistics| --- The (incomplete) name of an SDDS file to which statistical information about the
trajectories (or orbits) and corrector strengths will be written.  Recommended value: ``\%s.scor''.
\item \verb|bpm_output| --- The (incomplete) name of an SDDS file to which post-correction BPM errors will be written. The
  errors are the residual after correction, and include the effects of offsets (\verb|DX| and \verb|DY|), setpoints
  (\verb|XSETPOINT|, \verb|YSETPOINT|, and \verb|SETPOINT|), and tilts (\verb|TILT|).
  Recommended value: ``\%s.bpm''.
\item \verb|corrector_tweek[2]| --- The amount by which to change the correctors in order to compute correction coefficients for
transport lines.
[The word ``tweak'' is misspelled ``tweek'' in the code.]   The default value, 1 mrad, may be too large for systems with
small apertures.  If you get an error message about ``tracking failed for test particle,'' try decreasing this value.
\item \verb|corrector_limit[2]| --- The maximum strength allowed for a corrector.
\item \verb|correction_fraction[2]| --- The fraction of the computed correction strength to actually use for any one iteration.
\item \verb|correction_accuracy[2]| --- The desired accuracy of the correction in terms of the RMS BPM values.
\item \verb|do_correction[2]| --- Flags to allow disabling correction in one or both planes (if set to zero).
\item \verb|remove_smallest_SVs|, \verb|keep_largest_SVs|, \verb|minimum_SV_ratio|, \verb|auto_limit_SVs| --- These parameters control the elimination of
  singular vectors from the inverse response matrix, which can help deal with degeneracy in the correctors and reduce corrector strength.
  By default, the number of singular vectors is limited to the number of BPMs, which is a basic condition for stability; this can be defeated by
  setting \verb|auto_limit_SVs| to 0 for the desired planes.  Set \verb|remove_smallest_SVs| to require removal of a given number of
  vectors with the smallest singular values; this is ignored if \verb|auto_limit_SVs| is also requested and would remove more SVs. 
  Set \verb|keep_largest_SVs| to require keeping at most a given number of the largest SVs.
  Set \verb|minimum_SV_ratio| to require removal of any vectors with singular values less than a given factor of the largest singular value.
\item \verb|remove_pegged[2]| --- If nonzero, then for the plane in question pegged correctors will be removed from the correction matrix.
  This results in recomputation of the matrix, following which correction continues with the reduced set of correctors.
  The pegged corrector is left at its last value.
\item \verb|threading_divisor| --- In threading mode trajectory correction, each corrector is varied between 0 and $\pm{\theta_{\textrm{max}}}$, 
  where $\theta_{\textrm{max}}$ is the strength limit.
  This parameter sets the number of steps to divide the corrector range into on the positive and negative sides.
  A smaller value results in faster execution but is less reliable.
\item \verb|threading_correctors| --- In threading mode trajectory correction, gives the number of correctors upstream of the loss point to
  use for threading the beam further through the system.
\item \verb|bpm_noise[2]| --- The BPM noise level. 
\item \verb|bpm_noise_cutoff[2]| --- Cutoff values for the random distributions of BPM noise.
\item \verb|bpm_noise_distribution[2]| --- May be either ``gaussian'', ``uniform'', or ``plus\_or\_minus''.
\item \verb|verbose| --- If non-zero, information about the correction is printed during computations.
\item \verb|fixed_length| --- Indicates that the closed orbit length should be kept the same as the design orbit
length by changing the momentum offset of the beam.
\item \verb|fixed_length_matrix| --- Indicates that for fixed-length orbit correction, the fixed-length
matrix should be computed and used.  This will improve convergence but isn't always needed.
\item \verb|n_xy_cycles| --- Number of times to alternate between correcting the x and y planes.
\item \verb|force_alternation| --- Forces alternation between x and y correction even if one plane appears to 
  have converged.
\item \verb|minimum_cycles| --- The minimum number of x-y cycles to perform, even if the correction does not improve.
\item \verb|n_iterations| --- Number of iterations of the correction in each plane for each x/y cycle.
\item \verb|prezero_correctors| --- Flag indicating whether to set the correctors to zero before starting.
\item \verb|track_before_and_after| --- Flag indicating whether tracking should be done both before and after
correction.
\item \verb|start_from_centroid| --- Flag indicating that correction
should start from the beam centroid.  For orbit correction, only the
beam momentum centroid is relevant.
\item \verb|use_actual_beam| --- Flag indicating that correction
should employ tracking of the beam distribution rather than a single
particle.  This is valid for trajectory correction only.
\item \verb|closed_orbit_accuracy| --- Target accuracy of closed orbit computation.
\item \verb|closed_orbit_accuracy_requirement| --- Required accuracy of closed orbit computation.
\item \verb|closed_orbit_iterations| --- Number of iterations of closed orbit computation.
\item \verb|closed_orbit_iteration_fraction| --- Fraction of change in closed orbit to
use at each iteration.
\item \verb|closed_orbit_fraction_multiplier| --- Multiplier to apply to the iteration fraction if
  iteration is converging.
\item \verb|closed_orbit_multiplier_interval| --- Interval in number of iterations at which to adjust
  the iteration fraction.
\item \verb|closed_orbit_tracking_turns| --- If non-zero, the absolute value gives the number of turns to track for detemination 
  of the closed orbit by averaging. This may be useful if the regular closed orbit algorithm
  complains about convergence issues. If less than zero, then {\em only} this method is used. If greater than zero, 
  then regular orbit determination is tried first, and tracking is used as a fallback.
\item \verb|use_perturbed_matrix| --- If nonzero, specifies that prior to each 
	correction \verb|elegant| shall recompute the response matrix.  This
	is useful if the lattice is changing significantly between corrections.
\item \verb|disable| --- If nonzero, the command is ignored.
\item \verb|use_response_from_computed_orbits| --- If nonzero, in-plane response matrices are computed
  using differences of closed orbits, which is slower but may be more accurate. For cross-plane matrices, this is always the case.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|correction_matrix_output|}\end{center}
%\end{latexonly}
\subsection{correction\_matrix\_output \label{subsec:correctionmatrixoutput}}

\begin{itemize}
\item type: setup/action command.
\item function: provide output of the orbit/trajectory correction matrix.
\item sequence: must follow \verb|run_setup| and definition of steering elements (if wanted, with \verb|steering_element|).
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&correction_matrix_output
    STRING response[4] = NULL, NULL;
    STRING inverse[2] = NULL, NULL;
    long KnL_units = 0;
    long BnL_units = 0;
    long output_at_each_step = 0;
    long output_before_tune_correction = 0;
    long fixed_length = 0;
    long coupled = 0;
    long use_response_from_computed_orbits = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|response| --- Array of (incomplete) filenames for SDDS output of the x and y response
matrices, plus the cross-plane response matrices.  Recommended values, in order: ``\%s.hrm'' (horizontal
response to horizontal correctors), ``\%s.vrm'' (vertical response to vertical correctors),
``\%s.vhrm'' (vertical response to horizontal correctors), and 
``\%s.hvrm'' (horizontal response to vertical correctors).
\item \verb|inverse| --- Array of (incomplete) filenames for SDDS output of the x and y 
inverse response matrices. Recommended values: ``\%s.hirm'' and ``\%s.virm''.
\item \verb|KnL_units| --- Flag that, if set, indicates use of ``units'' of m/K0L rather than
m/rad.  This results in a sign change for the horizontal data.
\item \verb|BnL_units| --- Flag that, if set, indicates use of ``units'' of m/(T*m) rather than
m/rad.  This is useful for linac work in that the responses are automatically scaled with 
beam momentum.
\item \verb|output_at_each_step| --- Flag that, if set, specifies output of the data at
each simulation step.  By default, the data is output immediately for the defined lattice.
\item \verb|output_before_tune_correction| --- Flag that, if set, specifies that when 
\verb|output_at_each_step| is set, that output shall occur prior to correcting the tunes.
\item \verb|fixed_length| --- Flag that, if set, specifies output of the fixed-path-length
matrix.
\item \verb|coupled| --- If nonzero, the cross-plane response matrices are computed.
\item \verb|use_response_from_computed_orbits| --- If nonzero, in-plane response matrices are computed
  using differences of closed orbits, which is slower but may be more accurate. For cross-plane matrices, this is always the case.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|correct_tunes|}\end{center}
%\end{latexonly}
\subsection{correct\_tunes \label{subsec:correcttunes}}

\begin{itemize}
\item type: setup command.
\item function: set up for correction of the tunes.
\item sequence: should follow \verb|twiss_output|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}

&correct_tunes
    STRING quadrupoles = NULL;
    STRING lower_limits = NULL;
    STRING upper_limits = NULL;
    STRING exclude = NULL;
    double tune_x = 0;
    double tune_y = 0;
    long n_iterations = 5;
    double correction_fraction = 0.9;
    double tolerance = 0;
    long step_up_interval = 0;
    double max_correction_fraction = 0.9;
    double delta_correction_fraction = 0.1;
    long update_orbit = 0;
    STRING strength_log = NULL;
    long change_defined_values = 0;
    long use_perturbed_matrix = 0;
    double dK1_weight = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|quadrupoles| --- List of names of quadrupoles to be used.  Several names may be given and the names may include
  wildcards. If so, then quadrupoles in each group are changed by the same amount for each iteration.
  This would typically be used when the quadrupoles are nominally identical (though perhaps differing in strength because of
  introduced errors). If that's not the case, the iteration may fail to converge
\item \verb|lower_limits|, \verb|upper_limits| --- Lists of lower and upper limits for each family. The input style is
  unusual for {\tt elegant}, given that lists of numbers are to be provided in a string. For example
\begin{verbatim}
&correct_tunes
 quadrupoles = "Q1 Q2 Q3",
 lower_limits = "0 -1.5 0",
 upper_limits = "1.75 0 1.25"
 ...
&end
\end{verbatim}
\item \verb|exclude| --- List of names of elements to exclude. This may be used to exclude some 
  quadrupoles that are matched by wildcards in the \verb|quadrupoles| list.
\item \verb|dK1_weight| --- Weighting factor that is used to minimize the mean-square changes in $K_1$ values in the
  event that there are more than two families.
\item \verb|tune_x|, \verb|tune_y| --- Desired x and y tune values.  If not given, the desired values are
assumed to be the unperturbed tunes.
\item \verb|n_iterations| --- The number of iterations of the correction to perform.
\item \verb|correction_fraction| --- The fraction of the correction to apply at each iteration.
\item \verb|tolerance| --- When both tunes are within this value of the desired tunes, the
iteration is stopped.
\item \verb|step_up_interval| --- Interval between increases in the correction fraction.
\item \verb|max_correction_fraction| --- Maximum correction fraction to allow.
\item \verb|delta_correction_fraction| --- Change in correction fraction after 
each \verb|step_up_interval| steps.
\item \verb|update_orbit| --- If non-zero, the orbit calculation is updated after each $n^{th}$ adjustment of the
  quadupoles. 
\item \verb|strength_log| --- The (incomplete) name of a SDDS file to which the quadrupole 
strengths will be written as correction proceeds.  Recommended value: ``\%s.qst''.
May be used with \verb|load_parameters|.
\item \verb|change_defined_values| --- Changes the defined values of the quadrupole strengths.
This means that when the lattice is saved (using \verb|save_lattice|), the quadrupoles will
have the corrected values.  This would be used for correcting the tunes of a design
lattice, for example, but not for correcting tunes of a perturbed lattice.
\item \verb|use_perturbed_matrix| --- If nonzero, requests use of the perturbed correction matrix in
performing correction.  For difficult lattices with large errors, this may be necessary
to obtain correction.  In general, it is not necessary and only slows the simulation.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|coupled_twiss_output|}\end{center}
%\end{latexonly}
\subsection{coupled\_twiss\_output \label{subsec:coupledtwissoutput}}

\begin{itemize}
\item type: setup/action command.
\item function: set up or execute computation of coupled twiss parameters and beam sizes
\item sequence: must follow \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&coupled_twiss_output
    STRING filename = NULL;
    long output_at_each_step = 0;
    long emittances_from_twiss_command = 1;
    double emit_x = 0;
    double emittance_ratio = 0.01;
    double sigma_dp = 0;
    long calculate_3d_coupling = 1;
    long verbosity = 0;
    long concat_order = 2;
&end
\end{verbatim}

\begin{itemize}

\item \verb|filename| --- The (incomplete) name of the SDDS file to which coupled twiss parameters and
  beam sizes will be written.  Suggested value: ``\%s.ctwi''.
\item \verb|output_at_each_step| --- If nonzero, then this is a setup
  command and results in computations occurring for each simulation
  step (e.g., for each perturbed machine if errors are included).  If
  zero, then this is an action command and computations are done
  immediately (e.g., for the unperturbed machine). If you wish to compute Twiss parameters on a closed orbit or after other calculations,
  be sure to set this control to a nonzero value.
\item \verb|emittances_from_twiss_command| --- If nonzero, then the values of the horizontal emittance
  and the momentum spread are taken from the uncoupled computation done with the \verb|twiss_output| command.
  In this case, the user must issue a \verb|twiss_output| command prior to the \verb|coupled_twiss_output|.
  If zero, then the values of the horizontal emittance
  and the momentum spread are taken from the parameters \verb|emit_x| and \verb|sigma_dp|, respectively.
\item \verb|emit_x| --- Gives the horizontal emittance, if \verb|emittances_from_twiss_command=0|.
\item \verb|emittance_ratio| --- Gives the ratio of the x and y emittances.  Used to determine the
  vertical emittance from the horizontal emittance.  Note that the computation is not self-consistent.
  I.e., the user is free to enter any emittance ratio desired, whether it is consistent with the
  machine optics or now.
\item \verb|sigma_dp| ---  Gives the momentum spread, if \verb|emittances_from_twiss_command=0|.
\end{itemize}

This feature was added to {\tt elegant} using code supplied by V. Sajaev, based on Ripkin's method.
The code computes the coupled lattice functions, then uses the supplied emittance, emittance ratio,
and momentum spread to compute the beam sizes, bunch length (if rf is included), and beam tilt.

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|divide_elements|}\end{center}
%\end{latexonly}
\subsection{divide\_elements \label{subsec:divideelements}}

\begin{itemize}
\item type: setup command.
\item function: define how to subdivide certain beamline elements.
\item sequence: must precede \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item notes: 
	\begin{itemize}
	\item Any number of these commands may be given.  
	\item Not effective unless given prior to \verb|run_setup|.
	\item The \verb|element_divisions|
 field in \verb|run_setup| provides a simpler, but less flexible, method of performing
 element division.  At present, these element types may be divided: 
\verb|CSBEND|, 
\verb|CSRDRIFT|,
\verb|DRIFT|,
\verb|EDRIFT|,
\verb|KOCT|,
\verb|KQUAD|,
\verb|KQUSE|,
\verb|KSEXT|,
\verb|OCTU|,
\verb|QUAD|,
\verb|RBEND|,
\verb|RFCA|,
\verb|SBEND|,
\verb|SEXT|,
and \verb|SOLE|.
	\item Only effective if given prior to the \verb|run_setup| command.
	\end{itemize}
\item warnings:	
	\begin{itemize}
	\item Using \verb|save_lattice| and element divisions together will
	produce an incorrect lattice file.
	\item Element subdivision may
	produce unexpected results when used with \verb|load_parameters|
	or parameters saved via the \verb|parameter|
	entry of the \verb|run_setup| command.
	If you wish to load parameters while doing element divisions or if
	you wish to load parameters from a run that had element divisions
	in effect, you should not load length data for any elements that
	are (or were) split.  The name and item pattern features of 
	\verb|load_parameters| are helpful in restricting what is loaded.
	\end{itemize}
\end{itemize}

\begin{verbatim}
&divide_elements
    STRING name = NULL;
    STRING type = NULL;
    STRING exclude = NULL;
    long divisions = 0;
    double maximum_length = 0;
    long clear = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- A possibly wildcard-containing string specifying
	the elements to which this specification applies.
\item \verb|type| --- A possibly wildcard-containing string specifying
 	the element types to which this specification applies.
\item \verb|exclude| --- A possibily wildcard-containing string specifying
 	elements to be excluded from the specification.
\item \verb|divisions| --- The number of times to subdivide the specified
	elements.  If zero, then \verb|maximum_length| should be nonzero.
\item \verb|maximum_length| --- The maximum length of a slice.  This is
	usually preferrable to specifying the number of divisions, particularly
	when the elements divided may be of different lengths.  If zero, then
	\verb|divisions| should be nonzero.
\item \verb|clear| --- If nonzero, all prior division specifications are
	deleted.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|elastic_scattering|}\end{center}
%\end{latexonly}
\subsection{elastic\_scattering \label{subsec:elasticscattering}}

\begin{itemize}
\item type: major action command
\item function: perform simulation of elastic scattering at multiple s locations, for
  use in computing elastic gas scattering lifetime and loss distribution
\item sequence: must follow \verb|run_control|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item notes: 
  \begin{itemize} 
    \item Only available in \verb|Pelegant|.
    \item Data may be postprocessed with the command \verb|elasticScatteringAnalysis|.
    \end{itemize}
\end{itemize}

\begin{verbatim}
&elastic_scattering
    STRING losses = NULL;
    STRING output = NULL;
    STRING log_file = NULL;
    double theta_min = 0.001;
    double theta_max = 0.010;
    long n_theta = 11;
    long n_phi = 37;
    long twiss_scaling = 0;
    double s_start = 0;
    double s_end = DBL_MAX;
    STRING include_name_pattern = NULL;
    STRING include_type_pattern = NULL;
    long verbosity = 1;        
&end
\end{verbatim}

\begin{itemize}
\item \verb|losses| --- The (incomplete) name of an SDDS file to which the record of initial scattering location,
  initial scattering angle, and loss coordinates will be written.
\item \verb|output| --- The (incomplete) name of an SDDS file to which the final coordinates of all surviving particles
  will be written.
\item \verb|log_file| --- The (incomplete) name of an SDDS file to which statistical data will be written as the simulations
  run. Users should check the \verb|MinParticles| and \verb|MaxParticles| columns as the simulation runs to ensure
  reasonable load balance (e.g., within 10-20\%). If balance is poor, consider changing the values of \verb|n_phi| and
  \verb|n_theta| slightly. The product of these values should not evenly divide the number of working cores (which is
  one less than the total number of cores).
\item \verb|theta_min| --- Minimum polar scattering angle in radians. Should be small enough that no particle scattered
  by this angle are lost, regardless of the scattering location. See also \verb|twiss_scaling|.
\item \verb|theta_max| --- Maximum polar scattering angle in radians. Should be large enough that no particle scattered
  by this angle survives, regardless of scattering location. 
\item \verb|n_theta| --- Number of polar scattering angle values on the range \verb|theta_min| to \verb|theta_max|.
\item \verb|n_phi| --- Number of azimuthal scattering angles on the range $[0, \pi]$.
\item \verb|twiss_scaling| --- If nonzero, then \verb|theta_min| is scaled by 
  $\min (\sqrt{\beta_x(0)/\beta_x(s)}, \sqrt{\beta_y(0)/\beta_y(s)})$,
  where $s$ is the location of the scattering location and $s=0$ is the start of the lattice.
\item \verb|s_start|, \verb|s_end| --- Range of s location for simulated scattering sites.
\item \verb|include_name_pattern| --- Wildcard-containing string to match to element names in selecting scattering sites.
\item \verb|include_type_pattern| --- Wildcard-containing string to match to element types in selecting scattering sites.
\item \verb|verbosity| --- Higher values may result in more verbose informational output.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|error_element|}\end{center}
%\end{latexonly}
\subsection{error\_element \label{subsec:errorelement}}

\begin{itemize}
\item type: setup command.
\item sequence: must follow \verb|run_control|.
\item function: assert a random error defintion for the accelerator.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&error_element
    STRING name = NULL;
    STRING element_type = NULL;
    STRING item = NULL;
    STRING type = "gaussian";
    double amplitude = 0.0;
    double cutoff = 3.0;
    long bind = 1;
    long bind_number = 0;
    longn bind_across_names = 0;
    long post_correction = 0;
    long fractional = 0;
    long additive = 1;
    long allow_missing_elements = 0;
    STRING after = NULL;
    STRING before = NULL;
    STRING sample_file = NULL;
    STRING sample_file_column = NULL;
    STRING sample_mode = NULL;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- The possibly wildcarded name of the elements for which errors are being specified.
\item \verb|element_type| --- An optional, possibly wildcarded string giving the type of elements to
 which the errors should be applied.  E.g., \verb|element_type=*MON*| would match all beam position monitors.
 If this item is given, then \verb|name| may be left blank.
\item \verb|item| --- The parameter of the elements to which the error pertains.
\item \verb|type| --- The type of random distribution to use.  May be one of ``uniform'', ``gaussian'', ``plus\_or\_minus'',
  or ``sampled''.
  A ``plus\_or\_minus'' error is equal in magnitude to the amplitude given, with the sign randomly chosen.
  A ``sampled'' error is drawn from a set of user-supplied values, as described below.
\item \verb|amplitude| --- The amplitude of the errors.
\item \verb|cutoff| --- The cutoff for the gaussian random distribution in units of the amplitude.  Ignored for other distribution types.
\item \verb|bind|, \verb|bind_number|, \verb|bind_across_names| ---
These parameters control ``binding'' of errors among elements, which
means assigning the same error contribution to several elements.  This
occurs if \verb|bind| is nonzero, {\bf which it is by default}! If \verb|bind| is negative, then the
sign of the error will alternate between successive elements.
\verb|bind_number| can be used to limit the number of elements bound
together. In particular, if \verb|bind_number| is positive, then a
positive value of \verb|bind| indicates that \verb|bind_number|
successive elements having the same name will have the same error
value.  Finally, by default, {\tt elegant} only binds the errors of
objects having the same name, even if they are assigned errors by 
the same \verb|error_element| command (i.e., through a wildcard \verb|name|).
If \verb|bind_across_names| is nonzero, then binding is done even for elements
with different names.

\item \verb|post_correction| --- A flag indicating whether the errors should be added after orbit, tune, and chromaticity correction.
\item \verb|fractional| --- A flag indicating whether the errors are fractional, in which case the amplitude refers to
the amplitude of the fractional error.
\item \verb|additive| --- A flag indicating that the errors should be added to the prior value of the
parameter.  If zero, then the errors replace the prior value of the parameter.
\item \verb|allow_missing_elements| --- A flag indicating that execution may continue even if no matching elements are found.
\item \verb|after| --- The name of an element.  If given, the error is applied only to elements
 that follow the named element in the beamline.
\item \verb|before| --- The name of an element.  If given, the error is applied only to elements
 that precede the named element in the beamline.

\item \verb|sample_file|, \verb|sample_file_column|, \verb|sample_mode|---
  If the error type is ``sampled'', then \verb|sample_file| must contain the name of an SDDS containing the numerical column
  named by \verb|sample_file_column|. The values in this column from the first page of the file are used for assigning
  error values. \verb|sample_mode| may be one of ``random'', ``shuffle'', or ``sequentual'', with the following meanings:
  \begin{itemize}
    \item \verb|random| --- Values are drawn randomly from the list as needed, without regard to reuse of a given value.
    \item \verb|shuffle| --- Values are drawn from the list in a random order until all are used, then a new random order
      is created. This ensures that all values are used with equal probability.
    \item \verb|sequential| --- Values are used in the order given until all are used, repeatedly as needed starting from
      the beginning of the list.
  \end{itemize}
  This feature can be used to assign errors based on a set of measured values or, using \verb|sddssampledist|, an arbitrary
  external distribution.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|error_control|}\end{center}
%\end{latexonly}
\subsection{error\_control \label{subsec:errorcontrol}}

\begin{itemize}
\item type: setup command
\item sequence: must follow \verb|run_control|.
\item function: overall control of random errors.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&error_control
    long clear_error_settings = 1;
    long summarize_error_settings = 0;
    long no_errors_for_first_step = 0;
    STRING error_log = NULL;
    double error_factor = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|clear_error_settings| --- Clear all previous error settings.
\item \verb|summarize_error_settings| --- Summarize current error settings.  {\em If non-zero, then the command has no other function  except
    showing a summary of the current error settings.}
\item \verb|no_errors_for_first_step| --- If non-zero, then there will be no errors for the first step.  This can be useful for
 fiducialization of phase and momentum profiles.
\item \verb|error_log| --- The (incomplete) name of a SDDS file to which error values will be written.  Recommended value: ``\%s.erl''.
\item \verb|error_factor| --- A value by which to multiply the error amplitudes in all \verb|error| commands.
\end{itemize}

The proper use of this command can be confusing.  A typical sequence will be as follows:
\begin{verbatim}
&error_control
 clear_error_settings = 1,
 error_log = %s.erl
&end

&error_element ... &end
&error_element ... &end
.
.
.
&error_element ... &end

&error_control
 summarize_error_settings = 1
&end
\end{verbatim}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|find_aperture|}\end{center}
%\end{latexonly}
\subsection{find\_aperture \label{subsec:findaperture}}

\begin{itemize}
\item type: setup/major action command.
\item function: find the aperture in (x, y) space for an accelerator.
\item N.B.: can use parallel resources (\verb|Pelegant|). Recommend using n-line mode with \verb|nx|*\verb|n_splits|
  greater than the number of cores (e.g., a factor of 10).
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&find_aperture
    STRING output = NULL;
    STRING search_output = NULL;
    STRING boundary = NULL;
    STRING mode = "many-particle";
    double xmin = -0.1;
    double xmax =  0.1;
    double xpmin = 0.0;
    double xpmax = 0.0;
    double ymin =  0.0;
    double ymax =  0.1;
    double ypmin = 0.0;
    double ypmax = 0.0;
    long nx  = 21;
    long ny  = 11;
    long n_splits = 0;
    double split_fraction = 0.5;
    double desired_resolution = 0.01;
    long assume_nonincreasing = 0;
    long verbosity = 0;    
    long offset_by_orbit = 0;
    long n_lines = 11;
    long optimization_mode = 0;
    long full_plane = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|output| --- The (incomplete) name of an SDDS file to send output to.  
 Recommended value: ``\%s.aper''.

\item \verb|mode| --- May be ``many-particle'', ``single-particle'', ``one-line, ``three-lines'', or ``n-lines''.
Many-particle searching is much
faster than single-particle, but does not allow interval splitting to
search for the aperture boundary.  Both ``many-particle'' and
``single-particle'' modes involve searching from the outside inward,
which improves speed but may result in including islands.

The line modes avoid this by searching form the origin
outward.  Of these, the one-line and three-line modes are special:
one-line mode searches the line from the origin to $(x_{max},
y_{max})$.  three-line mode searches this line, plus the lines from
the origin to $(x_{max}, 0)$ and $(0, y_{max})$.  

For n-line mode, the number of lines is set with the \verb|n_lines| parameter.
With $n>3$, $n$ lines are explored from $(0,0)$ to
$(x_{max}*sin(\theta), y_{max}*cos(\theta))$, where $\theta$ takes
values from $-pi/2$ to $\pi/2$.   In these modes, the output file contains
a parameter called ``Area,'' which gives the area of the dynamic aperture.

Also still recognized are other modes, namely, ``five-line'', ``seven-line'', ``nine-line'',
and ``eleven-line''.

\item \verb|search_output| --- The (incomplete) name of an SDDS file for output of detailed
 information on each tracked particle (single-particle mode only).  Recommended value:
 ``\%s.apso''.

\item \verb|boundary| --- The (incomplete) name of an SDDS 
file for the boundary points of the aperture search.  Recommended value: ``\%s.bnd''.
Valid for many- and single-particle modes.

\item \verb|xmin|, \verb|xmax|, \verb|ymin|, \verb|ymax| ---
  Region of the aperture search, in spatial coordinates. The minimum values are relevant only for many- and single-particle modes.

\item \verb|xpmin|, \verb|xpmax|, \verb|ypmin|, \verb|ypmax| ---
  Region of the aperture search, in slope coordinates. The minimum values are relevant only for many- and single-particle modes.
  Ignored unless \verb|xmin=xmax| and \verb|ymin=ymax|.

\item \verb|nx| --- For many- and single-particle modes, the number of x values to take in initial search.
  For line modes, this determines the initial x and y step sizes via $\Delta x = x_{max}/n_x$ and
  $\Delta y = y_{max}/n_x$.
\item \verb|ny| --- For many- and single-particle modes, the number of y values to take in search.
  Ignored for line modes.

\item \verb|n_splits| --- If positive, the number of times to do
interval splitting.  Interval splitting refers to searching between
the original grid points in order to refine the results.  This is done
only for single-particle and line modes.

\item \verb|split_fraction| --- If interval splitting is done, how the interval is split.

\item \verb|desired_resolution| --- If interval splitting is done,
fraction of \verb|xmax-xmin| to which to resolve the aperture.  Ignored for all but single-particle
mode.

\item \verb|assume_nonincreasing| --- If this variable is non-zero, the search assumes that the aperture
at ${\rm y+sign(y)*\Delta y}$ is no larger than that at ${\rm y}$.  This results in tracking of
fewer particles but may give a pessimistic result.    Used only for single- and multi-particle
modes.

\item \verb|offset_by_orbit| --- A flag indicating whether to offset
the transverse beam coordinates by the closed orbit before tracking.  The default value is
zero for backward compatibility, but the recommended value is 1.

\item \verb|verbosity| --- A larger value results in more printouts during computations.

\item \verb|n_lines| --- In ``n-lines'' mode, the number of lines to search.

\item \verb|optimization_mode| --- If non-zero, then \verb|find_aperture| is a setup command and can be used
with {\tt elegant}'s internal optimizer.  The quantity \verb|DaArea| is defined, giving the area of the dynamic
aperture for use in the penalty function.  This is available only for the line search modes.

\item \verb|full_plane| --- If non-zero, then the search covers both positive and negative y values.
  Only available in line-search modes.

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|floor_coordinates|}\end{center}
%\end{latexonly}
\subsection{floor\_coordinates \label{subsec:floorcoordinates}}

\begin{itemize}
\item type: action command.
\item function: compute floor coordinates for an accelerator.
\item sequence: must follow \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&floor_coordinates
    STRING filename = NULL;
    double X0 = 0.0;
    double Z0 = 0.0;
    double theta0 = 0.0;
    long include_vertices = 0;
    long vertices_only = 0;
    long magnet_centers = 0;
    long store_vertices = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|filename| --- The (incomplete) name of an SDDS file to send output to.  
 Recommended value: ``\%s.flr''.
\item \verb|X0|, \verb|Z0|, \verb|theta0| --- Initial X, Z, and angle coordinate of the beamline.
\item \verb|include_vertices| --- Flag that, if set, specifies including  in the output
the coordinates of the vertices of bending magnets. 
\item \verb|vertices_only| --- Flag that, if set, specifies that output will contain only
the coordinates of the vertices of bending magnets. 
\item \verb|magnet_centers| --- Flag that, if set, specifies that output will contain 
the coordinates of the centers of all magnets, where the center is defined as the average of the
entrance and exit points. By default, the coordinates of the downstream
end are given.
\item \verb|store_vertices| --- Flag that, if set, results in storing the floor coordinates for
  dipole magnet vertex points. The coordinates are stored in variables with names of the form
  {\em magnetName}\verb|#|{\em occurrenceNumber}\verb|-VP.|{\em property}, where {\em property}
  is \verb|X|, \verb|Y|, \verb|Z|, \verb|theta|, \verb|phi|, and \verb|psi|.
\end{itemize}

The ``vertex  point'' for a dipole or string of dipoles is defined as the intersection of the
straight lines from the ideal entrance and exit trajectories. 
The \verb|s| quantity for the vertex is defined as the sum of the actual distance traveled to the
start of the dipole or string of dipoles plus the straight-line distance from the entrace to the
vertex. 
Hence, one cannot subtract the \verb|s| values for two successive vertices and expect to get the
distance between the vertices.

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|frequency_map|}\end{center}
%\end{latexonly}
\subsection{frequency\_map \label{subsec:frequencymap}}

\begin{itemize}
\item type: major action command.  
\item function: compute frequency map from tracking
      Note that the number of turns tracked is set by the \verb|run_control| command.
\item can use parallel resources (\verb|Pelegant|)
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&frequency_map
    STRING output = NULL;
    double xmin = -0.1;
    double xmax = 0.1;
    double ymin = 1e-6;
    double ymax = 0.1;
    double delta_min = 0;
    double delta_max = 0;
    long nx = 21;
    long ny = 21;
    long ndelta = 1;
    long verbosity = 1;
    long include_changes = 0;
    long quadratic_spacing = 0;
    long full_grid_output = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|output| --- The (incomplete) name of an SDDS file to send output to.  
 Recommended value: ``\%s.fma''.  For the parallel version, particles will be listed in essentially
 random order.  If needed, \verb|sddssort| can be used to sort particles by initial coordinates.
\item \verb|xmin|, \verb|xmax| --- Limits of grid of initial x coordinates for tracking.             
\item \verb|ymin|, \verb|ymax| --- Limits of grid of initial y coordinates for tracking.             
 \verb|ymin| should be a small, positive value so that there                               
 is some betatron oscillation from which to get the tune.                      
\item \verb|delta_min|, \verb|delta_max| --- Limits of grid of initial $\delta$ coordinates
for tracking.  Note that particles are not centered around the dispersive closed orbit.  Hence,
the tracking is appropriate to simulation of dynamics from a touschek scattering event.
\item \verb|nx| --- Number of values of x coordinate in the grid.
\item \verb|ny| --- Number of values of y coordinate in the grid.
\item \verb|ndelta| --- Number of values of $\delta$ coordinate in the grid.
\item \verb|verbosity| --- If nonzero, prints possibly useful information while running.
\item \verb|include_changes| --- If nonzero, then computes not only the tunes, but also
        the changes in the tunes.  This is expressed in terms of the diffusion, which is defined
        as 
\begin{equation}
  d = \log_{10} \left(\Delta\nu_x^2 + \Delta\nu_y^2\right)
\end{equation}
where $\Delta\nu_x$ and $\Delta\nu_y$ are respectively the differences in x and y tunes
from the first and second half of the tracking (the total number of turns is equal to the
value set in \verb|run_setup|).
The diffusion rate, 
\begin{equation}
  d_r = \log_{10} \left(\frac{\sqrt{\Delta\nu_x^2 + \Delta\nu_y^2}}{N}\right),
\end{equation} is also computed. $d_r$ is the more conventional quantity, computed by
programs such as TRACY and MAD \cite{BuesingPC}.
\item \verb|quadratic_spacing| --- If non-zero, the spacing of points is quadratic rather than linear, thus emphasizing
  the higher amplitude regions.
\item \verb|full_grid_output| --- If non-zero, all grid points are represented in the output file, even if tracking or
  tune determination failed. This makes it possible to plot with programs (e.g., \verb|sddscontour|) that require
  a strictly uniform grid.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|global_settings|}\end{center}
%\end{latexonly}
\subsection{global\_settings \label{subsec:globalsettings}}

\begin{itemize}
\item type: action command.  
\item sequence: should precede \verb|run_setup|.
\item function: change global settings.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
 One way to use the \verb|global_settings| command is in a configuration file, which can be supplied via the 
 \verb|-configuration| option or \verb|ELEGANT_CONFIGURATION| environment variable; an example of using this
 would be to set MPI I/O options an a per-system basis.
 N.B.: unlike other commands, values given for parameters in \verb|global_settings| commands become the
 new default for subsequent invocations of the command during the same run. Hence multiple commands can be used
 to set individual values without overriding previously-given settings.
\end{itemize}

\begin{verbatim}
&global_settings
    long inhibit_fsync = 0;
    long echo_namelists = 1;
    long mpi_randomization_mode = 3;
    long exact_normalized_emittance = 0;
    double SR_gaussian_limit = 3.0;
    long inhibit_seed_permutation = 0;
    STRING log_file = NULL;
    STRING error_log_file = NULL;
    long mpi_io_force_file_sync = 0;
    long usleep_mpi_io_kludge = 0;
    long mpi_io_read_buffer_size = 0;
    long mpi_io_write_buffer_size = 0;
    long parallel_tracking_based_matrices = 1;
    long share_tracking_based_matrices = 1;
    double tracking_matrix_step_factor = 1;
    double tracking_matrix_points = 9;
    double tracking_matrix_step_size[6] = {5e-5, 5e-5, 5e-5, 5e-5, 5e-5, 5e-5};
&end
\end{verbatim}

\begin{itemize}
\item \verb|inhibit_fsync| --- By default, \verb|elegant| forces file synchronization across a network file system
  to ensure that users see up-to-date files as soon as possible.  In cases where a great deal of output is generated,
  this can degrade performance.  Setting this parameter to 1 will turn off synchronization until the end of the run.
\item \verb|echo_namelists| --- By default, \verb|elegant| echoes all namelist input to the terminal.  If this parameter
  is set to 0, this output will be inhibited.
\item \verb|SR_gaussian_limit| --- By default, \verb|elegant| uses a 3-$\sigma$ cutoff for the gaussian random numbers used
  in simulation of synchrotron radiation from \verb|CSBEND|, \verb|CSRCSBEND|, \verb|KQUAD|, \verb|KSEXT|, and \verb|SREFFECTS|.
  This parameter allows changing the cutoff.
\item \verb|inhibit_seed_permutation| --- If nonzero, randomization of the user-supplied random number seed is {\em not} performed.
  This feature is useful in that it provides a higher degree of apparent randomness, in that small changes in the seed result
  in very different random sequences.
\item \verb|log_file| --- By default, \verb|elegant| writes status information to the terminal.  If a filename is supplied
  for this parameter, the output will instead go to the file.  On Linux and Unix, using \verb|/dev/null| will result in 
  the output being discarded.
\item \verb|error_log_file| --- By default, \verb|elegant| writes error messages to the terminal.  If a filename is supplied
  for this parameter, the output will instead go to the file.  On Linux and Unix, using \verb|/dev/null| will result in 
  the output being discarded.
\item \verb|share_tracking_based_matrices| --- If non-zero, then the matrices determined by tracking for various elements
  (e.g., \verb|BRAT|, \verb|BGGEXP|, \verb|CCBEND|) are computed only once for a set of identical elements, then shared.
  This can save considerable computation time.
\item \verb|mpi_randomization_mode| --- Controls how the random numbers are seeded on multiple processors
  \begin{itemize}
    \item 1 --- This is the original default, which showed issues in some simulations. The seed on the $i^{th}$ processor is $s_0+2*i$.
    \item 2 --- The seed on the $i^{th}$ processor is $s_0+2*i^2$.
    \item 3 --- This is the new default. The seed on the $i^{th}$ processor is $s_0+i*(i+1)$.
    \item 4 --- The seed on the $i^{th}$ processor is $s_0+R_i$, where $R_i$ is the $i^{th}$ random integer returned by
      the system rand() function.
    \end{itemize}
\item \verb|exact_normalized_emittance| --- By default, \verb|elegant| uses an approximate computation for the normalized emittance, namely,
$\epsilon_n = \epsilon\langle\beta\gamma\rangle$, where $\epsilon$ is the geometric emittance computed from the trace-space coordinates.
If this variable is set to a non-zero value, \verb|elegant| instead uses a slower but more accurate method, namely, using the momentum coordinates.
\cite{Floettmann-PRSTAB6-034202}. The results will show up in the \verb|sigma| and \verb|final| output files, if these are requested in the \verb|run_setup| command.
\item \verb|mpi_io_force_file_sync|  --- If non-zero, \verb|Pelegant| will perform a file synchronization after writing each row of
  an SDDS file. This can {\em significantly} impact performance, but can solve problems on some filesystems that result in corrupted files
  or files in which zeros appear in place of the expected data.
\item \verb|mpi_io_read_buffer_size|  --- If non-zero, \verb|Pelegant| will change the read buffer size to the given value. 
  May allow improving read performance, but should be used with care.
\item \verb|mpi_io_write_buffer_size|  --- If non-zero, \verb|Pelegant| will change the write buffer size to the given value. 
  May allow improving write performance, but should be used with care.
\item \verb|usleep_mpi_io_kludge|  --- If non-zero, \verb|Pelegant| will sleep for the given number of microseconds after
  writing each row of an SDDS file. This can impact performance, but can solve problems on some filesystems that result in corrupted files
  or files in which zeros appear in place of the expected data.
  It may give better performance than setting \verb|mpi_io_force_file_sync=1|.
  A value of 100 is suggested as a starting point, but this will be highly system-dependent.
\item \verb|parallel_tracking_based_matrices| --- If non-zero, then the matrices determined by tracking for various elements
  (e.g., \verb|BRAT|, \verb|BGGEXP|, \verb|CCBEND|) are computed using parallel resources in \verb|Pelegant|. 
  This can save considerable wall clock time.
  N.B.: This is set to zero when using \verb|parallel_optimization_setup|.
\item \verb|share_tracking_based_matrices| --- If non-zero, then the matrices determined by tracking for various elements
  (e.g., \verb|BRAT|, \verb|BGGEXP|, \verb|CCBEND|) are computed only once for a set of identical elements, then shared.
\item \verb|tracking_matrix_step_factor| --- The default step size for tracking-based matrices is $5 \times 10^{-5}$ 
  (in the appropriate units for each corodinate). This can be increased or decreased by supplying a value for 
  \verb|tracking_matrix_step_factor|.
\item \verb|tracking_matrix_points| --- By default, five grid points are used in each dimension for tracking-based matrix determination.
  This can be increased by setting \verb|tracking_matrix_points| to a larger, odd value, at the expense of longer running time.
  (The run time scales approximately as the sixth power of this value.)
\item \verb|tracking_matrix_step_size| --- Sets the step sizes, in each of the six coordinates,
  used for tracking-based matrix determination
\end{itemize}


%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|ignore_elements|}\end{center}
%\end{latexonly}
\subsection{ignore\_elements \label{subsec:ignoreelements}}

\begin{itemize}
\item type: setup command.
\item function: causes specified elements to be ignored during tracking.
\item Must precede \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item notes: 
	\begin{itemize}
	\item Any number of these commands may be given.
	\item This command can provide improved {\em parallel} performance in cases where large numbers
          of non-transforming elements (e.g., \verb|MARK| or \verb|MONI| elements) exist in a beamline.
          (These elements can impact performance because \verb|elegant| checks particles against aperture
          limits after {\em every} element.)
          Using the \verb|show_element_timing| flag in \verb|run_setup| can help determine if this
          will help.
        \item This command cannot be used if \verb|centroid| or \verb|sigma| output is requested in
          \verb|run_setup|.
	\end{itemize}
\end{itemize}

\begin{verbatim}
&ignore_elements
	STRING name = NULL,
	STRING type = NULL,
	STRING exclude = NULL,
        long disable = 0;
        long clear = 0;
        long completely = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- Possibily wild-card containing string specifying the
	elements to which the operation is to be applied.
\item \verb|type| --- Possibily wild-card containing string specifying the
	element types to which the operation is to be applied.
\item \verb|exclude| --- Possibily wild-card containing string specifying 
	elements to be excluded from the operation. Does not
	affect elements included by other specifications.
\item \verb|disable| --- If nonzero, the command is ignored.
\item \verb|clear| --- If nonzero, all prior specifications are deleted.
\item \verb|completely| --- If nonzero, the element is ignore not only for tracking, but
  for all purposes. (This allows, for example, requesting \verb|sigma| and \verb|centroid| output
  from \verb|run_setup|.)
\end{itemize}


%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|inelastic_scattering|}\end{center}
%\end{latexonly}
\subsection{inelastic\_scattering \label{subsec:inelasticscattering}}

\begin{itemize}
\item type: major action command
\item function: perform simulation of inelastic scattering at multiple s locations, for
  use in computing inelastic gas scattering lifetime and loss distribution
\item sequence: must follow \verb|run_control|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item notes: 
  \begin{itemize} 
    \item Only available in \verb|Pelegant|.
    \item Data may be postprocessed with the command \verb|inelasticScatteringAnalysis|.
    \end{itemize}
\end{itemize}

\begin{verbatim}
&inelastic_scattering
    STRING losses = NULL;
    STRING output = NULL;
    STRING log_file = NULL;
    double k_min = 0.001;
    STRING momentum_aperture = NULL;
    double momentum_aperture_scale = 0.90;
    double momentum_aperture_periodicity = 0;
    long n_k = 101;
    double s_start = 0;
    double s_end = DBL_MAX;
    STRING include_name_pattern = NULL;
    STRING include_type_pattern = NULL;
    long verbosity = 1;        
    long soft_failure = 0;
    long allow_watch_file_output = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|losses| --- The (incomplete) name of an SDDS file to which the record of initial scattering location,
  initial scattering $\delta$, and loss coordinates will be written.
\item \verb|output| --- The (incomplete) name of an SDDS file to which the final coordinates of all surviving particles
  will be written.
\item \verb|log_file| --- The (incomplete) name of an SDDS file to which statistical data will be written as the simulations
  run. Users should check the \verb|MinParticles| and \verb|MaxParticles| columns as the simulation runs to ensure
  reasonable load balance (e.g., within 10-20\%). If balance is poor, consider changing the value of \verb|n_delta|
  slightly. 
\item \verb|k_min| --- Minimum energy $k$ of the brehmsstrahlung photon as a fraction of the beam energy.
  The electron has $\delta = -k$ after scattering.
  \verb|k_min| should be small enough that no electron scattered by -\verb|k_min| is lost, 
  regardless of the scattering location. 
\item \verb|n_k| --- Number of scattering values on the range \verb|k_min| to 1.
\item \verb|momentum_aperture|, \verb|momentum_aperture_scale| --- If given, names a file giving the momentum aperture vs s, which
  is interpolated at the scattering locations to obtain the local momentum aperture.
  Such a file may be obtained from running the \verb|momentum_aperture| command. The absolute values of the 
  values in the \verb|deltaNegative| column will be used in place of \verb|k_min|. 
  The \verb|k_min| values thus obtained are multiplied by \verb|momentum_aperture_scale|, so there is some assurance
  that the minimally-scattered particles will survive. This ensures that the results are valid for computation of 
  loss rates, for example.
\item \verb|momentum_aperture_periodicity| --- If nonzero, the momentum aperture data from \verb|momentum_aperture| is
  periodic with the given periodicity.
\item \verb|s_start|, \verb|s_end| --- Range of s location for simulated scattering sites.
\item \verb|include_name_pattern| --- Wildcard-containing string to match to element names in selecting scattering sites.
\item \verb|include_type_pattern| --- Wildcard-containing string to match to element types in selecting scattering sites.
\item \verb|verbosity| --- Higher values may result in more verbose informational output.
\item \verb|soft_failure| --- If nonzero, failure to kind a loss does not result in aborting the run.
\item \verb|allow_watch_file_output| --- If nonzero, \verb|WATCH| elements provide output during tracking. 
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|insert_elements|}\end{center}
%\end{latexonly}
\subsection{insert\_elements \label{subsec:insertelements}}

\begin{itemize}
\item type: action command.
\item function: Insert elements into a beamline at specified locations. This is a convenient way to
 add elements to a beamline without modifying the lattice file.
\item sequence: must follow \verb|run_setup|.
\item notes: 
	The modified beamline can be saved through \verb|save_lattice|
   command. Be sure to use ``output\_seq = 1'' option in that command.  
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&insert_elements
        STRING name = NULL;
        STRING type = NULL;
        STRING exclude = NULL;
        double s_start = -1;
        double s_end = -1;
        long skip = 1;
        long disable = 0;
        long insert_before = 0;
        long add_at_end = 0;
        long add_at_start = 0;
        STRING element_def = NULL;
        long total_occurrences = 0;
        long occurrence[100]={0};
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- Possibly wild-card containing string specifying the
   names of the elements after which the new element is inserted. A list of comma- or space-separated names may be given.
\item \verb|type| --- Possibly wild-card containing string specifying the
   type of the elements after which the new element is inserted.
\item \verb|exclude| --- Possibly wild-card containing string specifying 
   the names of elements to be excluded from the specification.
\item \verb|skip| --- New elements are inserted at every $n^{th}$ specified location.
\item \verb|s_start|, \verb|s_end| --- If positive, these give the starting and ending s locations for insertion of new elements.
  Note that the s locations are not updated as elements are inserted, but only after completion of all insertions covered by
  a single command.
\item \verb|disable| --- If nonzero, the command is ignored.
\item \verb|insert_before| --- If nonzero, the insertions are before the selected elements. By default, insertion is after
  the selected elements.
\item \verb|add_at_end| --- If nonzero, the element is also inserted to the end of the beamline.
\item \verb|add_at_start| --- If nonzero, the element is also inserted to the start of the beamline, ahead of all other elements.
\item \verb|element_def| --- The definition of the new element should be just as it would be entered in 
the lattice file.
\item \verb|total_occurrences|, \verb|occurrence| --- 
These parameters are used to insert the new elements after specified occurrences of 
the element \verb|name|.  \verb|total_occurrences| specifies how many new elements to add,
up to a maximum of 100, while the entries in the array \verb|occurrence| specify the occurrences
after which to add the new elements. If \verb|total_occurrences| is non-zero, then {\bf skip} must
be set to zero  and the {\bf name} must be the exact name (no wild-card matching). 
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|insert_sceffects|}\end{center}
%\end{latexonly}
\subsection{insert\_sceffects \label{subsec:insertsceffects}}

\begin{itemize}
\item type: setup command.
\item function: set up for transverse space charge calculation.  
\item sequence: must precede \verb|run_setup|.
\item NB: this command is intended only for simulation of space-charge kicks in rings. Please read the manual page
  for \verb|SCMULT| for details on the algorithm.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&insert_sceffects
        STRING name = NULL;
        STRING type = NULL;
        STRING exclude = NULL;
        long disable = 0;
        long clear = 0;
        STRING element_prefix = "MYSC";
        long skip = 0;
        long vertical = 0;
        long horizontal = 0;
        long nonlinear = 0;
	long uniform_distribution = 0;
        long verbosity = 0;
        double averaging_factor = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- Possibily wild-card containing string specifying the
	name of the elements after which to insert the space charge kick element.
\item \verb|type| --- Possibily wild-card containing string specifying the
        type of the elements after which to insert the space charge kick element.
\item \verb|exclude| --- Possibily wild-card containing string specifying 
	the name of elements to be excluded from the insertion of the space charge kick element.
\item \verb|disable| --- If nonzero, the command is ignored.
\item \verb|clear| --- If nonzero, all prior space charge insertions are deleted.
\item \verb|element_prefix| --- Name under which the space charge kick will appear in the beamline.
\item \verb|skip| --- If nonzero, the given number of insertion locations are skipped. 
        If zero, only one space charge kick is inserted at the end of beamline. 
\item \verb|vertical|, \verb|horizontal|, \verb|nonlinear| --- If non-zero, then space charge is
included in the plane in question.
\item \verb|uniform_distribution| --- Used for bi-Gaussian distributed beam (coasting beam), i.e., beam that is
  uniform in z but gaussian in x and y.
\item \verb|verbosity| --- Larger non-zero values request greater amounts of detail in printouts.
\item \verb|averaging_factor| --- For nonlinear space charge mode only, this parameter allows applying an infinite-impulse-response 
  (IIR) filter to the turn-by-turn beam size data in order to reduce the effects of noise. 
  A value of 1 means that only data from the present turn
  is used, while values approaching 0 will tend to use the initial beam sizes only.
  In more detail, the effective rms beam size $\hat{\sigma}$ used in the calculation of the kicks for the $i^{th}$ turn is 
  \begin{equation}
    \hat{\sigma}_i = f\sigma_i + (1-f) \hat{\sigma}_i,
  \end{equation}
  where $\sigma_i$ is the actual rms beam size.
  N.B.: strictly speaking, simulations performed with $f\ne 1$ are invalid, as the effect of strong space charge could
  be understated. However, judicious use of this parameter may allow valid simulations with fewer particles.
  The user should vary the parameter to ensure that results are insenstive to the value.
\end{itemize}

{\bf Important notes:}
\begin{itemize}
\item By default \verb|skip=0|, which results in only one \verb|SCMULT| element at the end of the beamline,
  regardless of whether values are given for the \verb|name| or \verb|type| fields.
\item This element is not designed for space charge calculations in guns or linacs.  It is only intended for
  simulating space charge in rings. 
\item This command can not work with concatenation-based matrix tracking.  
\item Some users use \verb|matched_to_cell| in the \verb|bunched_beam| command. 
  This will erase SCMULT assignments along the beamline. In this case, issue another \verb|twiss_output|
  command just before tracking.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|ion_effects|}\end{center}
%\end{latexonly}
\subsection{ion\_effects \label{subsec:ioneffects}}

\begin{itemize}
\item type: setup command.
\item function: set up for modeling of residual gas ions.
\item sequence: must follow \verb|run_setup|.
\item Notes:
  \begin{enumerate}
  \item This feature is considered experimental and should be used with caution.
    Feedback is welcome. The fitting-based methods, i.e., \verb|bigaussian|, \verb|bilorentzian|, 
    \verb|trigaussian|, and \verb|trilorentzian|, typically show instability when it is not expected and
    may well have noise challenges that have not been resolved.
  \item One or more \verb|IONEFFECTS| elements must be inserted in the lattice. This can be
    done manually, or using the \verb|insert_elements| command.
  \end{enumerate}
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&ion_effects
          STRING pressure_profile = NULL;
	  double pressure_factor = 1.0;
          STRING ion_properties = NULL;
          STRING beam_output = NULL;
          long beam_output_all_locations = 0;
          STRING ion_density_output = NULL;
          long ion_output_all_locations = 1;
          long ion_species_output = 0;
	  long ion_output_interval = 1;	
          STRING field_calculation_method = NULL;
          double gaussian_ion_range = 3;
	  double distribution_fit_target = 0.03;
	  double distribution_fit_tolerance = 1e-5;
	  long distribution_fit_evaluations = 300;
	  long distribution_fit_passes = 3;
	  long distribution_fit_restarts = 10;
	  long hybrid_simplex_comparison_interval = -1;
	  STRING fit_residual_type = NULL;
          long macro_ions = 0;
          long symmetrize = 0;
          long generation_interval = 1;
          long multiple_ionization_interval = 100;
	  double multiple_ionization_energy_peak = 20;
	  double multiple_ionization_energy_rms = 10;
          double ion_span[2] = {0, 0};
	  double ion_bin_divisor[2] = {10.0, 10.0};
	  double ion_range_multiplier[2] = {2.0, 2.0};
	  double ion_sigma_limit_multiplier[2] = {0, 0};
	  long ion_histogram_max_bins = 1000;
	  long ion_histogram_min_per_bin = 5;
	  STRING ion_histogram_output = NULL;
	  double ion_histogram_output_s_start = -1;
	  double ion_histogram_output_s_end = -1;
	  long ion_histogram_output_interval = 1000;
	  long ion_histogram_min_output_bins = 200;
	  long disable_until_pass = 0;
	  long freeze_ions_until_pass = 0;
	  long freeze_electrons_until_pass = 0;
          long verbosity = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|pressure_profile| --- Name of an SDDS file giving the s-dependent gas pressure for
  various gas species. Column names will be matched to the entries in the \verb|SourceName| column of the
  \verb|ion_properties| file.
\item \verb|pressure_factor| --- Factor by which to multiply the pressures given in the \verb|pressure_profile|.
\item \verb|ion_properties| --- Name of an SDDS file giving properties of ions. Column names are
  \begin{itemize}
  \item \verb|IonName| --- String column giving the name of the ion.
  \item \verb|Mass| --- Floating-point column giving the ion mass, in AMU.
  \item \verb|ChargeState| --- Integer column giving the ion charge state (a positive integer).
  \item \verb|SourceName| --- String column giving the name of the source gas for this ion.
    Alternately, for a multiply ionized molecule (e.g. CO++) one can give a source ion (e.g. CO+).  The source ion must also be defined in the \verb|ion_properties| file.
  \item \verb|CrossSection| --- Floating-point column giving the cross section for producing the ion from the source, in $Mb$.
  \end{itemize}
\item \verb|beam_output| --- Possibly incomplete name of an SDDS file to which beam data will be written.
  Asking for this output can significantly reduce performance, so it should generally be used for testing only.
\item \verb|beam_output_all_locations| --- If nonzero, \verb|beam_output| includes data at the location of
  all \verb|IONEFFECTS| elements. By default, only the first element is included.
\item \verb|ion_density_output| --- Possibly incomplete name of an SDDS file to which ion density data will be written.
\item \verb|ion_output_all_locations| --- If nonzero, \verb|ion_density_output| includes data at the location of
  all \verb|IONEFFECTS| elements. By default, only the first element is included.
\item \verb|ion_species_output| --- If nonzero, \verb|ion_density_output| includes data for each ion species.
\item \verb|ion_output_interval| --- The interval in bunches between output of ion data.
\item \verb|field_calculation_method| --- By default, the fields are computed on the
  assumption that the beam and ion distributions are gaussian. This is a good assumption for the beam, but not highly accurate
  for the ions. More accurate, but slower, methods is sums of two or three gaussians, or sums 
  of two or three lorentzians, which can be invoked by setting
  \verb|field_calculation_method| to \verb|"gaussianfit"|, 
  \verb|"bigaussian"|, \verb|"trigaussian"|, \verb|"bilorentzian"|, or \verb|"trilorentzian"|;
  these are collectively referred to as ``histogram fitting methods'' below.
  In the gaussian-fit case, the charge distribution is of the form
  \begin{equation}
    \rho(x, y) = G(x, h_x, \sigma_x, c_x)*G(y, h_y, \sigma_y, c_y),
  \end{equation}
  where $G(q, h, \sigma, c) = h\exp{-(q-c)^2/(2\sigma^2)}$.
  In the bigaussian case, the charge distribution is of the form
  \begin{equation}
    \rho(x, y) = (G(x, h_{x,1}, \sigma_{x,1}, c_{x,1}) + G(x, h_{x,2}, \sigma_{x,2}, c_{x,2}))*
    (G(y, h_{y,1}, \sigma_{y,1}, c_{y,1}) + G(y, h_{y,2}, \sigma_{y,2}, c_{y,2})).
  \end{equation}
  The charge distribution for the bilorentzian is
  \begin{equation}
    \rho(x, y) = (L(x, h_{x,1}, a_{x,1}, c_{x,1}) + L(x, h_{x,2}, a_{x,2}, c_{x,2}))*
    (L(y, h_{y,1}, a_{y,1}, c_{y,1}) + L(y, h_{y,2}, a_{y,2}, c_{y,2})),
  \end{equation}
  where $L(q, h, a, c) = h/(1 + (q-c)^2/a^2)$.
\item \verb|gaussian_ion_range| --- If the default field calculation method is used, gives the range (in beam sigma) over which ions are counted, for calculating the ion-beam kicks.
\item \verb|distribution_fit_target| --- If the distribution field calculation method is selected, gives the target for the
  fractional deviation of the fit. Smaller numbers will result in long run times.
\item \verb|distribution_fit_tolerance| --- If the distribution field calculation method is selected, gives the tolerance for the
  fractional deviation of the fit. Smaller numbers will result in long run times but higher likelihood of reaching the target.
\item \verb|distribution_fit_evaluations|, \verb|distribution_fit_passes|, \verb|distribution_fit_restarts| --- Parameters
  for the simplex optimizer that performs the distribution fit. Note that in \verb|Pelegant|, a hybrid simplex method is
  used, which appears to converge quickly if the default parameters are used.
\item \verb|fit_residual_type| --- Residual type for distribution fitting. The default is \verb|max-ad-plus-ad-charge|, which
  indicates using the sum of the maximum absolute deviation and the normalized absolute deviation of the total charge, where
  the latter is computed from difference of the actual total ion charge and the analytical integral of the charge 
  in the summed distributions; this tends to ensure that there are no hidden spikes in the distribution due to overfitting.
  Other options are \verb|sum-ad| (sum of normalized absolute deviation), \verb|rms-dev| (sum of normalized rms deviation),
  \verb|max-ad| (maximum normalized absolute deviation), \verb|max-ad-plus-rms-dev| (sum of maximum normalized absolute 
  deviation and normalized rms deviation), \verb|sum-ad-plus-rms-dev|, \verb|rms-dev-plus-ad-sum|, \verb|sum-ad-plus-ad-sum|,
  \verb|rms-dev-plus-centroid|, and \verb|rms-dev-plus-ad-charge|.
\item \verb|macro_ions| --- The number of macro ions to generate per bunch on each turn for which generation is done. 
  The macro ion charge is adjusted
  according to the cross section and bunch charge. May be overriden by the \verb|MACRO_IONS| parameter on individual
  \verb|IONEFFECTS| elements.
  If this value is too small, the ion distribution will be noisy, which may result in unreliable results.
  When using the parallel version, setting \verb|macro_ions| to 1,000 or higher is not unreasonable.
\item \verb|symmetrize| --- If nonzero, ions are emitted in symmetric pairs to ensure that the centroids don't deviate
  from the electron beam centroids because of noise. Doubles the number of macro ions that are emitted. Intended primarily for
  testing purposes.
\item \verb|generation_interval| --- The number of bunches between generation of ions. The macro ion charge is adjusted
  to account for this, so the effective ion charge after many turns is the same. May be overridden with the
  \verb|GENERATION_INTERVAL| parameter on individual \verb|IONEFFECTS| elements. The actual condition for generation of
  ions is such that the generating bunches vary on each turn. This can be used to effectively reduce \verb|macro_ions|
  below 1, to prevent generation of too many macro ions.
  This will result in noisy histograms and should be used with caution.
\item \verb|multiple_ionization_interval| --- The number of bunches between multiple ionization calculations.  
      The macro ion charge is adjusted
      to account for this, so the effective ion charge after many turns is the same.
\item \verb|multiple_ionization_energy_peak|, \verb|multiple_ionization_energy_rms| --- Specifies the distribution of
  the energy of multiply-ionized ions in terms of the peak (or centroid) of the distribution and its rms width, in eV.
\item \verb|ion_span| --- The transverse half-extent, in meters, of the region within which ions are modeled.
  Ions moving outside this region are considered lost. May be overriden by the \verb|X_SPAN| and \verb|Y_SPAN| parameters
  on individual \verb|IONEFFECTS| elements.
\item \verb|ion_bin_divisor| --- For histogram fitting methods, the number of ion bins per rms parameter of the electron beam.
\item \verb|ion_range_multiplier| --- For  histogram fitting methods,
  used to determine the full span of the ion binning region bins in units of the rms parameter of the ion distribution.
  The sign of the value determines which algorithm is used.
  For $m<0$, the binning range is $\left|m\right|\sigma_{ion}$.
  For $m=0$, the full span of the ion distribution is included; this may result in a very large number of bins being
  used to cover a few outlying ions, and is not recommended.
  For $m>0$, the code first finds the approximate range containing the central 80\% of the ions, then multiplies by
  $m$ to get the range used.
\item \verb|ion_sigma_limit_multiplier| --- For  histogram fitting methods,
  the minimum value for either of the ion sigmas (for bigaussian) or size parameters (for bilorentizan)
  in units of the bin size. Use to prevent one of the gaussians or lorentzians from being too delta-function-like.
\item \verb|ion_histogram_max_bins| --- Maximum number of ion bins for fitting methods.
  If this limit is reached, the {\em span} of the histograms will  be reduced to ensure that the central portion is
  resolved.
  If the value is  too large, the histograms may
  be noisy, which will make the fits unreliable. Also, a large value will result in reduced parallel efficiency, as
  processors must pass around more data. 
\item \verb|ion_histogram_min_per_bin| --- Minimum number of ions per bin (on average).
\item \verb|ion_histogram_output|, \verb|ion_histogram_output_s_start|, \verb|ion_histogram_output_s_end|, 
      \verb|ion_histogram_output_interval|, \verb|ion_histogram_max_bins| --- Controls for the output of ion histograms when
      using histogram fitting methods.
      \verb|ion_histogram_output| gives the (incomplete) filename.
      \verb|ion_histogram_output_s_start| and \verb|ion_histogram_output_s_end| give limits on the $s$ coordinate of the
      \verb|IONEFFECTS| element. \verb|ion_histogram_output_interval| gives the interval in bunches between output.
\item \verb|verbosity| --- Larger values result in more output during running. Used for debugging only.
\end{itemize}

The user is strongly advised to study the ion histograms by using the \verb|ion_histogram_output| parameter to request
this data.
The histograms should not be excessively noisy.
The data also includes the fits, which should be close to the data.
(For ``gaussian'' mode, this is generally not possible.)
A sample command to examine the histograms and fits for the y plane (generally the most difficult) is
\begin{verbatim}
sddsplot -column=Position,Charge* run.ionHist -split=page 
         -groupby=page -separate=page -graph=line,vary 
\end{verbatim}


%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|linear_chromatic_tracking_setup|}\end{center}
%\end{latexonly}
\subsection{linear\_chromatic\_tracking\_setup \label{subsec:linearchromatictrackingsetup}}

\begin{itemize}
\item type: setup command.
\item function: define chromatic variation of beta functions, tunes, etc. for using in
 fast linear-chromatic tracking
\item sequence: must follow \verb|run_setup|.
\item N.B.: This command is deprecated and no longer maintained. Use a beamline containing one or
  more \verb|ILMATRIX| elements instead. This provides much more functionality.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&linear_chromatic_tracking_setup
    double nux[4] = {-1, 0, 0, 0};
    double betax[2] = {1.0, 0.0};
    double alphax[2] = {0.0, 0.0};
    double etax[2] = {0.0, 0.0};
    double etapx[2] = {0.0, 0.0};
    double nuy[4] = {-1, 0, 0, 0};
    double betay[2] = {1.0, 0.0};
    double alphay[2] = {0.0, 0.0};
    double etay[2] = {0.0, 0.0};
    double etapy[2] = {0.0, 0.0};
    double alphac[2] = {0.0, 0.0};
&end
\end{verbatim}

\begin{itemize}
\item \verb|nux| --- Provide the horizontal tune plus its first three chromatic derivatives, i.e.,
  $\partial \nu_x/\partial\delta$, $\partial^2 \nu_x/\partial\delta^2$, and
  $\partial^3 \nu_x/\partial\delta^3$.
\item \verb|betax| --- Provide the horizontal beta function plus its chromatic derivative.
\item \verb|alphax| --- Provide the horizontal alpha function plus its chromatic derivative.
\item \verb|etax| --- Provide the first- and second-order horizontal dispersion:
  $\eta_x = \eta_x\left[0\right] + \eta_x\left[1\right]\delta$.
\item \verb|etapx| --- Provide the first- and second-order horizontal dispersion slope.
\item \verb|alphac| --- Provide the first and second-order momentum compaction.  N.B: if you are tracking
 with an rf cavity, be sure that your lattice length equal to the actual circumference.  See the example below.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|link_control|}\end{center}
%\end{latexonly}
\subsection{link\_control \label{subsec:linkcontrol}}

\begin{itemize}
\item type: setup command.
\item function: overall control of element parameter links.
\item sequence: must follow \verb|run_control|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&link_control
    long clear_links = 1;
    long summarize_links = 0;
    long verbosity = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|clear_links| --- Clear all previously set links.
\item \verb|summarize_links| --- Summarize all current set links.
\item \verb|verbosity| --- A larger value results in more output
during computations.

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|link_elements|}\end{center}
%\end{latexonly}
\subsection{link\_elements \label{subsec:linkelements}}

\begin{itemize}
\item type: setup command.
\item function: assert a link between parameters of accelerator elements.
\item sequence: must follow \verb|run_control| and \verb|link_control|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&link_elements
    STRING target = NULL;
    STRING exclude = NULL;
    STRING item = NULL;
    STRING source = NULL;
    STRING source_from_target_edit = NULL;
    STRING source_position = "before";
    STRING mode = "dynamic";
    STRING equation = NULL;
    double minimium = -DBL_MAX;
    double maximum = DBL_MAX;
    long exclude_self = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|target| --- The name of the elements to be modified by the link.  May contain
 wild-cards.
\item \verb|exclude| --- Wildcard sequence to match to element names.  If a match is found,
 the element is excluded from the link.
\item \verb|item| --- The parameter that will be modified.
\item \verb|source| --- The name of the elements to be linked to.
\item \verb|source_from_target_edit| --- If given and if \verb|source| is not given, 
  an editing command to create the name of the elements to be linked to from the name of the target.
  Uses the syntax of the {\tt editstring} program.
\item \verb|source_position| --- May be one of ``first'', ``before'', ``after'', 
``adjacent'', ``nearest'', or ``same-occurrence''.
\item \verb|mode| --- May be either ``dynamic'' or ``static''.  A dynamic link
is asserted whenever the source is changed (during correction, for example).  
A static link is asserted only when an error or variation is imparted to
the source, and at the end of correction.
\item \verb|equation| --- An {\tt rpn} equation for the new item value in
terms of the item values for the source.  The prior value of the item is 
on the top of the stack. To refer to the source
parameter values, use the name of the parameters. To refer to the initial source
parameter values, append ``0'' to the parameter name.  These names must appear
in capital letters.  
\item \verb|minimum|, \verb|maximum| --- Minimum and maximum values that will be
assigned to the target parameter.
\item \verb|exclude_self| --- If nonzero, self-links are blocked. It is not recommended to change this.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|load_parameters|}\end{center}
%\end{latexonly}
\subsection{load\_parameters \label{subsec:loadparameters}}

\begin{itemize}
\item type: setup command.
\item function: load parameters for elements from an SDDS file.
\item sequence: must follow \verb|run_setup| and precede \verb|run_control| and \verb|error_control| (if present).
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&load_parameters
        STRING filename = NULL;
        STRING filename_list = NULL;
        STRING include_name_pattern = NULL;
        STRING exclude_name_pattern = NULL;
        STRING include_item_pattern = NULL;
        STRING exclude_item_pattern = NULL;
        STRING include_type_pattern = NULL;
        STRING exclude_type_pattern = NULL;
        STRING edit_name_command = NULL;
        long change_defined_values = 0;
        long clear_settings = 0;
        long allow_missing_elements = 0;
        long allow_missing_parameters = 0;
        long allow_missing_files = 0;
        long force_occurence_data = 0;
        long verbose = 0;
        long skip_pages = 0;
        long use_first = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|filename| --- Name (possibly containing the ``\%s'' field) 
of SDDS file from which to take data.  The file
must contain some of the following columns:
\begin{itemize}
\item ElementName --- Required string column.  The name of the element to change.
\item ElementParameter --- Required string column.  The name of the parameter of the element to change.
\item ParameterValue --- Optional double column.  If given, gives value of the parameter named
 in ElementParameter for element named in ElementName.
\item ParameterValueString --- Optional string column.  If ParameterValue is not present, then
this column must be present.  The string data will be scanned, if necessary,
to obtain a value for the parameter.
\item ParameterMode --- Optional string column.  If given, for each row the value must be
one of ``absolute'', ``differential'', ``ignore'', or ``fractional''.  The meaning of these
modes is as follows: absolute mode means the given value is used as the new value for
the parameter; differential mode means the given value is added to the existing value
for the parameter; ignore mode means the value is ignored; fractional mode means the
existing value is increased by the product of the given value and the existing value 
(i.e., the given value is a fractional change).
\end{itemize}

Unless \verb|change_defined_values| is set, successive pages of the
file are used for successive steps of the simulation.  Several {\tt
elegant} commands generate output that may be used (on a subsequent
run) with \verb|load_parameters|; among these are the tune and
chromaticity correction commands and the \verb|run_setup| command
(parameters output).

\item \verb|filename_list| --- A list of filenames, which may be 
        given in place of \verb|filename|.  If used, each file
        in the list is treated as if it was separately supplied
        with an individual \verb|load_parameters| command.

\item \verb|include_name_pattern|, \verb|exclude_name_pattern| ---
A comma- or space-separated list of wildcard patterns to be used in selecting, respectively, which
elements to include and which to exclude from loading. 
To be used, data must match at least one inclusion pattern and no exclusion patterns.

\item \verb|include_item_pattern|, \verb|exclude_item_pattern| ---
A comma- or space-separated list of wildcard patterns to be used in selecting, respectively, which items
(i.e., which element parameters) to include and which to exclude from
loading.
To be used, data must match at least one inclusion pattern and no exclusion patterns.


\item \verb|include_type_pattern|, \verb|exclude_type_pattern| ---
Wildcard patterns to be used in selecting, respectively, which element
types (e.g., QUAD, DRIFT) to include and which to exclude from
loading.
To be used, data must match at least one inclusion pattern and no exclusion patterns.

\item \verb|edit_name_command| --- A command using the syntax of the {\tt editstring} program, allowing
  the strings in the \verb|ElementName| column to be modified before values are assigned.

\item \verb|change_defined_values| --- Changes the defined values of
the parameters.  This means that when the lattice is saved (using
\verb|save_lattice|), the parameters will have the altered values.
Also, if one wants to alter the values for all steps of the simulation,
one must set this flag. 

Note that the \verb|ElementOccurence| data is normally ignored if
\verb|change_defined_values| is nonzero.  This is because there is
only one definition of each element, even if it is used multiple times.
This behavior can be altered with the next control.

\item \verb|force_occurence_data| --- If set, then occurence data is
used even in \verb|change_defined_values| mode. When loading data for
a highly repetitive system, where many elements have identical names, this can greatly
speed completion of the operation.

\item \verb|use_first| --- It is possible that the input file will contain
multiple lines for any given parameter.  In this case, {\tt elegant} will
by default process all lines.  For example, if the lines give differential values,
then all would be included. However, if the lines give absolute values, then the
last one will overwrite the previous values; this flag allows overriding the
behavior in this case to force {\tt elegant} to use the first value.
This can have speed advantages for cases where there are many identical
occurences of the same element with identical values for the parameters.

\item \verb|clear_settings| --- If set, clear all settings and files
being used for loading parameters.

\item \verb|allow_missing_elements| --- If set, allow elements in the
file that are not in the lattice.  In this case, the nonapplicable
data is simply ignored.

\item \verb|allow_missing_parameters| --- If set, it is not an error
if any element in the lattice lacks a parameter that exists in the file.

\item \verb|allow_missing_files| --- If set, it is not an error
if any listed file is missing.

\item \verb|verbose| --- If set, provide informational printouts about
changes to parameters.

\item \verb|skip_pages| --- Specify the number of pages of input to skip.

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|matrix_output|}\end{center}
%\end{latexonly}
\subsection{matrix\_output \label{subsec:matrixoutput}}

\begin{itemize}
\item type: setup/action command.
\item function: generate matrix output, or set up to do so later.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&matrix_output
    STRING printout = NULL;
    long printout_order = 1;
    STRING printout_format = "%22.15e ";
    long full_matrix_only = 0;
    long print_element_data = 1;
    long mathematica_full_matrix = 0;
    STRING mathematica_matrix_name = "MFull";
    STRING mathematica_matrix_file = NULL;
    STRING SDDS_output = NULL;
    long SDDS_output_order = 1;
    long individual_matrices = 0;
    STRING SDDS_output_match = NULL;
    long output_at_each_step = 0;
    STRING start_from = NULL;
    long start_from_occurence = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|printout| --- The (incomplete) name of a file to which the 
matrix output will be printed (as text).  Recommended value: ``\%s.mpr''.
\item \verb|printout_order| --- The order to which the matrix is printed.
\item \verb|printout_format| --- The C-style formatting statement for the matrix elements. A space, comma, or other separator
  should appear at the end of the string.
\item \verb|full_matrix_only| --- A flag indicating that only the matrix of
the entire accelerator is to be output.
\item \verb|print_element_data| --- A flag indicating whether the element data should be printed out.
\item \verb|mathematica_full_matrix| --- If non-zero, print the full linear matrix in a format that can read by Mathematica.
  \begin{itemize}
  \item \verb|mathematica_matrix_name| --- The name of the Mathematica variable to which the linear matrix will be assigned.
  \item \verb|mathematica_matrix_file| --- The name a file to which the Mathematica-format matrix will be written.
  \end{itemize}
\item \verb|SDDS_output| --- The (incomplete) name of an SDDS 
file to which the matrix will be written.  Recommended value: ``\%s.mat''.
\item \verb|SDDS_output_order| --- The order to which the matrix is output in SDDS format.
\item \verb|individual_matrices| --- If non-zero, the matrices in the SDDS file are the individual
{\em on-trajectory} matrices of the elements, rather than the concatenated matrix of the beamline.
\item \verb|SDDS_output_match| --- A wildcard string which element names must match in
order for data to appear in the SDDS output file.
\item \verb|output_at_each_step| --- A flag indicating whether matrix output
is desired at every simulation step.
\item \verb|start_from| --- The optional name of the accelerator element
from which to begin concatenation and output.
\item \verb|start_from_occurence| --- If \verb|start_from| is not NULL, the
  number of the occurrence of the named element from which to start.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|modulate_elements|}\end{center}
%\end{latexonly}
\subsection{modulate\_elements\label{subsec:modulateelements}}

\begin{itemize}
\item type: setup command.
\item function: define parameters for time-dependent modulation of elements
\item sequence: must follow \verb|run_setup|.
\item N.B.: if the ramped element is modeled with a matrix, a significant performance hit may be seen.
  It is best to use symplectic variants of the elements, since these don't invoke the matrix calculation.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&modulate_elements
    STRING name = NULL;
    STRING item = NULL;
    STRING type = NULL;
    STRING expression = NULL;
    STRING filename = NULL;
    STRING time_column = NULL;
    long convert_pass_to_time;
    STRING amplitude_column = NULL;
    long refresh_matrix = 0;
    long differential = 1;
    long multiplicative = 0;
    long start_occurence = 0;
    long end_occurence = 0;
    double s_start = -1;
    double s_end = -1;
    STRING before = NULL;
    STRING after = NULL;
    long verbose = 0;
    double verbose_threshold = 0;
    STRING record = NULL;
    long flush_record = 1;
&end
\end{verbatim}

N.B.: This command will produce unpredictable results when used with
\verb|error_element|, \verb|alter_elements|, and
\verb|load_parameters| (except when \verb|change_defined_values=1|).
It should work properly with \verb|link_elements| in turn-by-turn mode
when the source element is modulated, but not when the target element
is modulated.

\begin{itemize}
\item \verb|name| --- A possibly-wildcard-containing string giving the names of the
        elements to modulate. If not specified, then one must specify \verb|type|.
\item \verb|item| --- The name of the parameter to modulate.
\item \verb|type| --- A possibly-wildcard-containing string giving the names of element
        {\em types} to modulate.  May be specified with \verb|name| or by itself.
\item \verb|expression| --- RPN expression for the modulation amplitude $A$.  The value
  of the time is on top of the stack. 
\item \verb|filename| --- Name of SDDS file from which to read modulation data, if
  \verb|expression| is not used.
\item \verb|time_column| --- Name of column in \verb|filename| giving time data for the
  modulation table.
\item \verb|convert_pass_to_time| --- By default, the mean arrival time of the beam is used to
  compute the time value for computing the modulation amplitude.
  If the arrival time vales are offset by \verb|CHANGE_T=1| on \verb|RFCA| elements, this won't
  work as desired. In that case, one can compute the time from the pass number and the position
  of the element within the lattice.
\item \verb|amplitude_column| --- Name of column in \verb|filename| giving amplitude data
  for the modulation.  Together, \verb|time_column| and \verb|amplitude_column| define
  a function $A(t)$.
\item \verb|refresh_matrix| --- Frequently there is a matrix associated with an element even
  if tracking through the element does not use the matrix.  In this case, {\tt elegant} doesn't
  normally update the matrix for the element as it modulates the element, since that may involve
  a significant time penalty.  If this parameter is set to a non-zero value, the matrix will
  be updated.  For elements that use a matrix for tracking, the matrix is always updated.
\item \verb|differential|, \verb|multiplicative| --- Determine how the amplitude function
  $A(t)$ is used to obtain the new value of the parameter.  There are four cases
  \begin{itemize}
    \item \verb|differential=1|, \verb|multiplicative=0|: $v(t) = v_0 + A(t)$ (default).
    \item \verb|differential=0|, \verb|multiplicative=0|: $v(t) = A(t)$.  
    \item \verb|differential=1|, \verb|multiplicative=1|: $v(t) = v_0 + v_0 A(t)$.  
    \item \verb|differential=0|, \verb|multiplicative=1|: $v(t) = v_0 A(t)$.  
  \end{itemize}
\item \verb|start_occurence|, \verb|end_occurence| --- If nonzero, these give the starting and
 ending occurrence numbers of elements that will be modulated. N.B.: if wildcards are used, occurrence
 number counting is for each set of identically-named elements separately, rather than for the sequence
 of matched elements.
\item \verb|s_start|, \verb|s_end| --- If non-negative, these give the gaving and ending position
 limits for the end-of-element locations of elements to be modulated.
\item \verb|after| --- The name of an element.  If given, the modulation is applied only to elements
 that follow the named element in the beamline.  
\item \verb|before| --- The name of an element.  If given, the modulation is applied only to elements
 that precede the named element in the beamline. 
\item \verb|verbose| --- If nonzero, information is printed to the standard output as changes are
        made.  Use for debugging only, since otherwise it may slow the simulation.
\item \verb|verbose_threshold| --- If nonzero, verbose information is printed only when the fractional change
   exceeds the given value.
\item \verb|record| --- Gives a possibly incomplete filename to which will be written a record of the values of
  the modulation.
\item \verb|flush_record| --- Gives the interval in steps at which to flush the record file. Higher values result
 in less frequent  updates to the record, but may improve performance.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|moments_output|}\end{center}
%\end{latexonly}
\subsection{moments\_output \label{subsec:momentsoutput}}

\begin{itemize}
\item type: action/setup command.
\item function: compute periodic or propagate non-periodic beam moments without tracking, optionally including radiation.
\item sequence: must follow \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&moments_output
    STRING filename = NULL;
    long output_at_each_step = 0;
    long output_before_tune_correction = 0;
    long final_values_only = 0;
    long verbosity = 0;
    long matched = 1;
    long equilibrium = 1;
    long radiation = 1;
    long n_slices = 10;
    long slice_etilted = 1;
    double emit_x = 0;
    double beta_x = 0;
    double alpha_x = 0;
    double eta_x = 0;
    double etap_x = 0;
    double emit_y = 0;
    double beta_y = 0;
    double alpha_y = 0;
    double eta_y = 0;
    double etap_y = 0;
    double emit_z = 0;
    double beta_z = 0;
    double alpha_z = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|filename| --- The (incomplete) name of a file to which the moments results will be written.
  Recommended value: ``\%s.mom''.
\item \verb|output_at_each_step| --- A flag indicating, if set, that computations and/or output is desired at each step of the simulation.
  If you wish to compute Twiss parameters on a closed orbit or after other calculations, be sure to set this control to a nonzero value.
\item \verb|output_before_tune_correction| --- A flag indicating, if set, that output is desired both before and after
tune correction.
\item \verb|final_values_only| --- A flag indicating, if set, that only the final values of the Twiss parameters should
be output, and not the parameters as a function of s.
\item \verb|verbosity| --- Larger numbers result in an increasing amount of informational output to the standard output stream.
\item \verb|matched| --- A flag indicating, if set, that the periodic or matched moments should be found.
\item \verb|equilibrium| --- A flag indicating, if set, that the equilibrium moments should be found.  If \verb|matched=1| and \verb|equilibrium=0|,
  then the initial twiss parameters are computed from the periodic solution for the beamline.
\item \verb|radiation| --- A flag indicating, if set, that synchrotron radiation effects should be included.
  N.B.: this flag is all that needs to be set if the lattice contains no kick elements. However, if the lattice contains \verb|CSBEND|, \verb|CSRCSBEND|, \verb|KQUAD|, 
  or \verb|KQUAD| elements (or other elements with \verb|SYNCH_RAD| and \verb|ISR| parameters), then the \verb|SYNCH_RAD| and\verb|ISR| must be set to 1 as well.
\item \verb|n_slices| --- The number of slices into which to cut individual dipoles, quadrupoles, and sextuoples for computations.
  10 has been found to work for all rings tested, but users are advised to ensure it is sufficient for their cases.
\item \verb|emit_x|, \verb|beta_x|, \verb|alpha_x|, \verb|eta_x|, \verb|etap_x|, and related quantities for \verb|y| and \verb|z| ---
  If \verb|matched=0|, then these specify the starting beam ellipses in all three planes.
\end{itemize}

This command performs several functions.  In the most basic form, it
propagates beam moments, i.e., the 6x6 sigma matrix, from the
beginning to the end of a transport line, including coupling from
rotated elements or offset sextupoles. This can be performed with or
without synchrotron radiation effects in dipoles, quadrupoles, and sextupoles.
These computations
include the evolution of the trajectory due to errors and (if included)
synchrotron radiation.

If desired, the command will instead compute the periodic beam
moments.  In this case, the user must include an appropriate rf cavity
in the lattice in order to get valid results.  (By ``appropriate rf
cavity'' we mean that it must have the right voltage, frequency, and
phase to support stored beam.)  It is also suggested that the user
compute the closed orbit using \verb|closed_orbit| so that the
computations are performed on the closed orbit.

The results of moments computation may be subjected to optimization
using values at marker elements.  See the documentation for
\verb|MARK| for more details.

{\bf Notes:} 
\begin{itemize}
\item  When using \verb|CSBEND|, \verb|KQUAD|, and \verb|KSEXT| elements, one may find that the 
calculations of \verb|moments_output| do not make sense. This is because, by default, synchrotron
radiation is disabled on these elements. To resolve the issue, set \verb|ISR=1| and \verb|SYNCH_RAD=1|
on  \verb|CSBEND| at a miminum. If a closed orbit is present, making the same setting on 
the  \verb|KQUAD| and \verb|KSEXT| is also suggested. It is essential to do this if there is
an rf frequency offset.
\item When bending magnets are tilted, \verb|elegant| has problems computing the moments and
closed orbit self-consistently when the bending radius is small.  To address this, the \verb|n_slices| parameter is set to 1 for
tilted bending magnets when \verb|slice_etilted=0|. This reduces the accuracy of the calculations.
{\bf Users are strongly advised to check that this is acceptable.} 
\item The program \verb|sddsmatchmoments| is available to transform a particle distribution so that its 6x6 beam moments
  match those given in a \verb|moments_output| output filename. 
  In addition, the \verb|bunched_beam| command provides a similar capability for generating a distribution from computed
  moments.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|momentum_aperture|}\end{center}
%\end{latexonly}
\subsection{momentum\_aperture \label{subsec:momentumaperture}}

\begin{itemize}
\item type: major action command.
\item function: determine momentum aperture as a function of position in the lattice by tracking
\item can use parallel resources (\verb|Pelegant|)
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&momentum_aperture
    STRING output = NULL;
    double x_initial = 0;
    double y_initial = 0;
    double delta_negative_start = 0.0;
    double delta_positive_start = 0.0;
    double delta_negative_limit = -0.10;
    double delta_positive_limit = 0.10;
    double delta_step_size = 0.01;
    long steps_back = 1;
    long splits = 2;
    long split_step_divisor = 10;
    long skip_elements = 0;
    long process_elements = 2147483647;
    double s_start = 0;
    double s_end = DBL_MAX;
    STRING include_name_pattern = NULL;
    STRING include_type_pattern = NULL;
    long fiducialize = 0;
    long verbosity = 1;
    long soft_failure = 0;
    long output_mode = 0;
    long forbid_resonance_crossing = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|output| --- The (incomplete) name of a file to which the momentum aperture results will be written.
  Recommended value: ``\%s.mmap''. The data are related to the momentum aperture at the exit of the named
  elements.
\item \verb|x_initial|, \verb|y_initial| --- The initial x and y coordinate values for tracking. It is essential
 that \verb|y_initial| be nonzero if one wants to see losses due to vertical resonances.  
\item \verb|delta_negative_start|, \verb|delta_positive_start| ---
Starting values of scans in the negative and positive
directions. 
\item \verb|delta_negative_limit|, \verb|delta_positive_limit| ---
Limiting values of scans in the negative and positive
directions. 
\item \verb|delta_step_size| --- Initial size of steps in $\delta$.  This should
 be fairly large in order to save time.

\item \verb|steps_back| --- Number of steps to back up after a particle is lost,
 relative to the last surviving $\delta$, before continuing with a smaller step size.
 If this is set to zero, there is a risk of finding a too-large momentum aperture
 (a stable island).

\item \verb|splits| --- Number of times to split the step size in
 order to refine the location of the maximum surviving momentum
 offsets.  When a particle is lost, the algorithm steps back to a momentum offset
 where a particle survived, subdivides the step size, and continues searching.  

\item \verb|split_step_divisor| --- Factor by which to subdivide the step size
  for each split.

\item \verb|skip_elements| --- Number of elements to skip before starting to
  compute momentum apertures.

\item \verb|process_elements| --- Number of elements for which to compute
  momentum aperture.

\item \verb|s_start|, \verb|s_end| --- Limiting s coordinates of the
 elements from which tracking will start.  The default values will
 exclude no elements.

\item \verb|include_name_pattern| --- If given, tracking will start
only at the entrance to elements that match the given wildcard
pattern.

\item \verb|include_type_pattern| --- If given, tracking will start
only at the entrance to elements whose type matches the given wildcard
pattern.

\item \verb|fiducialize| --- If given, an initially on-energy particle is tracked before
 the momentum aperture search begins, in order to fiducialize the reference momentum.
 This is useful if there are synchrotron radiation losses or energy gain due to cavities
 in the system.

\item \verb|verbosity| --- Larger values result in more detailed
printouts as calculations proceed.  Mostly for debugging.

\item \verb|soft_failure| --- Normally, if {\tt elegant} fails to find the momentum aperture,
it aborts.  If \verb|soft_failure| is non-zero, it instead assigns a momentum aperture equal
to the search limit.

\item \verb|output_mode| --- Normally, {\tt elegant} puts the values for positive and
negative momentum aperture in different columns.  Each element thus has a single row of
data in the output file.  If \verb|output_mode=1|, {\tt elegant} instead puts
the values for positive and negative apertures in successive rows, with a reduced number
of columns.  This is mostly advantageous for the parallel version, since it allows using
twice as many simultaneous processors.
If \verb|output_mode=2|, {\tt elegant} tracks many more probe particles simultaneously, which
is better for massively parallel systems. The number of particles tracked is the number of
elements selected times the number of probe points between  \verb|delta_negative_limit| and \verb|delta_positive_limit|.

\item \verb|forbid_resonance_crossing| --- Normally, {\tt elegant} allows the momentum
aperture search to cross integer and half-integer resonances if no unstable particles are
found.  If this is undesirable, this flag can be set to 1.
\end{itemize}

The idea for this command is from M. Belgroune {\em et al.}, ``Refined
Tracking Procedure for the SOLEIL Energy Acceptance Calculation,''
Proceedings of PAC 2003, p 896, as implemented for TRACYII.  In
particular, the energy aperture as a function of position around the
ring is determined by tracking.  Starting at the beginning of the
lattice and working downstream, particles are tracked starting from
the exit of each selected element.  The betatron coordinates are
initially zero (or very small), while the momentum deviation is
gradually increased until loss of the particle is observed.  This
defines the momentum aperture at that location.

In {\tt elegant} version 19.0 and later, the algorithm is as follows.  For simplicity in
wording, we'll assume the momentum deviations are positive values,
although the method is applied separately for negative values as well:
\begin{enumerate}
\item Start with $\delta=0$, i.e., zero momentum offset.
\item Track a particle to see if it gets lost.  If so, proceed to step 4.
\item Increase $\delta$ by step size $\Delta\delta$ and return to step 2.
\item If no splitting steps remain, proceed to the next step.  Otherwise:
\begin{enumerate}
\item Change $\delta$ to $\delta_s - s_b\Delta\delta$., where $\delta_s$ is
 the largest $\delta$ for which the particle survived, and $s_b$ is the
 \verb|steps_back| parameter.
\item Divide the step size by \verb|split_step_divisor| to get a new step size  $\Delta\delta$.
\item Set $\delta = \delta + \Delta\delta$.
\item Decrement the ``splits remaining'' counter by 1.
\item Continue from step 2.
\end{enumerate}
\item Stop.  The momentum aperture is $\delta_s$
\end{enumerate}

This command can be used for both rings and transport lines.  For
rings it is most appropriate to have an rf cavity (i.e., an {\tt RFCA}
element) in the lattice.  One should also include radiation loss using
either of two methods:
\begin{enumerate}
\item {\tt SREFFECTS} element, with {\tt QEXCITATION=0}.  To set up this element more easily, one
 can include a \verb|twiss_output| command with \verb|radiation_integrals=1|.
\item Use {\tt CSBEND} and {\tt KQUAD} elements with \verb|SYNCH_RAD=1| and \verb|ISR=0|.
\end{enumerate}
When including radiation loss, one must be certain to set the frequency and phase of the rf cavity
correctly.  The \verb|rf_setup| command can be used for this purpose.
It is also a good idea to track for several synchrotron oscillation periods.

{\bf Note for Pelegant:} Unlike for {\tt elegant}, the data in the output file will not be sorted by \verb|s|.
To sort the data, simply use \verb|sddssort| from the commandline, e.g.,
\begin{verbatim}
sddssort -column=s output.mmap
\end{verbatim}
Also, if it is desirable for the output from \verb|Pelegant| to have exactly the same form as that from 
\verb|elegant|, then the script \verb|reorganizeMmap| should be used. This script is provided with 
\verb|elegant| and \verb|Pelegant| distributions.

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|obstruction_data|}\end{center}
%\end{latexonly}
\subsection{obstruction\_data \label{subsec:obstructiondata}}

\begin{itemize}
\item type: setup command
\item function: define obstructions in the global coordinate system $(Z, X)$
\item sequence: must follow \verb|floor_coodinates| and preceed \verb|track|
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&obstruction_data
          STRING input = NULL;
          long periods = 1;
          long disable = 0;
          double y_spacing = 0;
          double y_limit[2] = {-10, 10};
&end
\end{verbatim}

\begin{itemize}

\item \verb|input| --- Name of SDDS file containing obstruction data. The file must contain two columns, \verb|Z| and 
  \verb|X|, giving the global coordinates of points on the obstruction contour in the $Y=0$ plane, in units of meters.
  The file may contain more than one page, with each page giving a closed contour for a separate obstruction.
  At present, obstructions are considered to extend over $Y:[-\infty, \infty]$.
  The file must also contain three parameters: 
  \begin{itemize}
  \item \verb|Superperiodicty| ---- integer parameter giving the number of repetitions of the
    defined obstructions in the full ring. For example, for the 40-sector APS ring, if the obstruction data covered
    a single sector, then the value would be 40.
  \item \verb|XCenter|, \verb|ZCenter| --- floating point parameters giving the position of center of the ring in meters.
    The obstructions are rotated about this center if periodic.
  \end{itemize}
\item \verb|periods| --- Obstructions represented by the provided data are to be repeated in a 
  periodic fashion the number of times given. It is assumed that the system is a storage ring.
\item \verb|disable| --- If nonzero, then the command is ignored.
\item \verb|y_spacing| --- If nonzero, then the input file is expected to have data for multiple vertical planes,
  instead of the default $y=0$ midplane. The plane for each page is identified by the parameter \verb|Y| in the
  input file. The data must be sorted in increasing order of \verb|Y|, which can be accomplished using \verb|sddssort|, e.g.,
\begin{verbatim}
sddssort input.sdds -parameter=Y
\end{verbatim}
\item \verb|y_limit| --- Allows specifying maximum limits on the vertical coordinate, beyond which particles are lost.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|optimize|}\end{center}
%\end{latexonly}
\subsection{optimize \label{subsec:optimize}}

\begin{itemize}
\item type: major action command.
\item function: perform optimization.
\item sequence: must follow \verb|optimization_setup| and beam definition (\verb|bunched_beam| or \verb|sdds_beam|).
\item can use parallel resources (\verb|Pelegant|) for tracking-based optimization.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item note: on UNIX systems, the user may press Control-C to force
\verb|elegant| to terminate optimization and proceed as if
optimization had converged.  (To genuinely terminate the run during
optimization press Control-C twice.) This is very useful if one wants
to get a look at the partially optimized result.  If one uses parameter
saving (\verb|run_setup|) or \verb|save_lattice| one can make a new
run that starts from the optimized result.
\end{itemize}

\begin{verbatim}
&optimize
     long summarize_setup = 0;
&end
\end{verbatim}

\begin{itemize}

\item \verb|summarize_setup| --- A flag indicating, if set, that a
summary of the optimization parameters should be printed.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|optimization_constraint|}\end{center}
%\end{latexonly}
\subsection{optimization\_constraint \label{subsec:optimizationconstraint}}

\begin{itemize}
\item type: setup command.
\item function: define a constraint for optimization.
\item sequence: must follow \verb|optimization_setup| and precede beam definition (\verb|bunched_beam| or \verb|sdds_beam|).
\item N.B.: This command is {\em disparaged}. It is {\em far} better to put constraints
	into the optimization equation (via the \verb|equation| parameter of
	\verb|optimization_setup| or via \verb|optimization_term|).  The reason
	is that the hard constraints imposed by \verb|optimization_constraint|
	may make it more difficult for the optimizer to converge.  See the discussion of the
        \verb|selt| and \verb|segt| macros in the manual entry to \verb|optimization_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&optimization_constraint
    STRING quantity = NULL;
    double lower = 0;
    double upper = 0;
&end
\end{verbatim}

\begin{itemize}

\item \verb|quantity| --- The quantity to be constrained, given as the
name of a quantity from among the optimization variables, optimization
covariables, and the ``final'' parameters (see the entry for
\verb|run_setup| for the last of these).  The optimization
(co)variables are referred to as
\verb|<element-name>.<parameter-name>|, in all capital letters.  Other
quantities, such as Twiss parameters or anything else but what is
listed just above, are not recognized.  Expressions involving multiple
quantities are not supported.

\item \verb|lower|, \verb|upper| --- The lower and upper limits
allowed for the expression.

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|optimization_covariable|}\end{center}
%\end{latexonly}
\subsection{optimization\_covariable \label{subsec:optimizationcovariable}}

\begin{itemize}
\item type: setup command.
\item function: define an element parameter to be varied as a function of optimization parameters.
\item sequence: must follow \verb|optimization_setup| and precede beam definition (\verb|bunched_beam| or \verb|sdds_beam|).
\item N.B.: It is not possible to optimize an element if the element name starts with one of the following
characters: 
\verb|0|, \verb|1|, \verb|2|, \verb|3|, \verb|4|, \verb|5|, \verb|6|, \verb|7|, \verb|8|,
\verb|9|, \verb|.|, \verb|+|, or \verb|-|.  The reason is that {\tt elegant} will attempt to 
make an SDDS parameter name containing the element name, and these characters are disallowed
at the beginning of such a name.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&optimization_covariable
    STRING name = NULL;
    STRING item = NULL;
    STRING equation = NULL;
    long disable = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- The name of the element.
\item \verb|item| --- The parameter of the element to be changed.
\item \verb|equation| --- An {\tt rpn} equation for the value of the parameter in terms of the
values of any parameters of any optimization variable.  These latter appear in the equation in the
form \verb|<element-name>.<parameter-name>|, in all capital letters.  The original values of all
variables and covariable may be accessed via names like \verb|<element-name>.<parameter-name>0|.
\item \verb|disable| --- If nonzero, the covariable is ignored.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|optimization_setup|}\end{center}
%\end{latexonly}
\subsection{optimization\_setup \label{subsec:optimizationsetup}}

\begin{itemize}
\item type: setup command.
\item function: define overall optimization parameters and methods.
\item sequence: must precede beam definition (\verb|bunched_beam| or \verb|sdds_beam|)
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&optimization_setup
    STRING equation = NULL;
    STRING mode = "minimize";
    STRING method = "simplex";
    double tolerance = -0.01;
    double target = 0;
    long center_on_orbit = 0;
    long center_momentum_also = 1;
    long soft_failure = 1;
    long n_passes = 2;
    long n_evaluations = 500; 
    long n_restarts = 0;
    long matrix_order = 1;
    STRING log_file = NULL;
    STRING term_log_file = NULL;
    long output_sparsing_factor = 0;
    long balance_terms = 0;
    double restart_worst_term_factor = 1;
    long restart_worst_terms = 1;
    long verbose = 1;
    long balance_terms = 0;
    double simplex_divisor = 3;
    double simplex_pass_range_factor = 1;
    long include_simplex_1d_scans = 1;
    long start_from_simplex_vertex1 = 0;
    long restart_random_numbers = 0;
    STRING interrupt_file = "%s.interrupt";
    long interrupt_file_check_interval = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|equation| --- An {\tt rpn} equation for the optimization
function, expressed in terms of any parameters of any optimization
variables, the ``final'' parameters of the beam (as recorded in the
\verb|final| output file available in the \verb|run_setup| namelist),
and selected quantities from Twiss parameter, tune shift with amplitude,
closed orbit, beam moments, driving terms, and other computations.
The optimization variables or covariables may appear in the equation
in the form \verb|<element-name>.<parameter-name>|, all in capital
letters.  In addition, initial values of variables and covariables
are available in the form \verb|<element-name>.<parameter-name>0|.

Data from MARK elements with {\tt FITPOINT=1} and from beam position
monitors with {\tt CO\_FITPOINT=1} may be used via symbols of the form
{\tt {\em elementName}\#{\em occurenceNum}.{\em parameterName}}.  See the
documentation for the {\tt MARK}, {\tt MONI}, {\tt HMON}, and {\tt
VMON} elements for detailed discussion and listing.

If response matrix calculation is requested, response matrix values
are available in variables with names {\em Plane}{\tt R\_}{\em
bpmName}\verb|#|{\em occurence}{\tt \_}{\em corrName}\verb|#|{\em occurence}{\tt
.}{\em corrParam}, where {\em Plane} is {\tt H} (horizontal) or {\tt
V} (vertical) and {\em corrParam} is the parameter of the corrector
used for changing the orbit (e.g., {\tt HKICK} or {\tt VKICK} for a
{\tt KICKER} element).

If cross-plane response matrix calculation is requested, response matrix values
are available in variables with names {\em BpmPlane}{\em CorrPlane}{\tt R\_}{\em
bpmName}\verb|#|{\em occurence}{\tt \_}{\em corrName}\verb|#|{\em occurence}{\tt
.}{\em corrParam}, where {\em BpmPlane} and {\em CorrPlane} are  {\tt H} (horizontal) or {\tt
V} (vertical) and {\em corrParam} is the parameter of the corrector
used for changing the orbit (e.g., {\tt HKICK} or {\tt VKICK} for a
{\tt KICKER} element).

Many quantities are made available for optimization if \verb|twiss_output| command is given
with \verb|output_at_each_step=1|:
\begin{itemize} 
\item Final Twiss parameters, e.g., \verb|betax|, \verb|alphax|, \verb|etax|.  The names
are the same as the column names in the twiss output file.
\item Linear acceptances \verb|Ax| and \verb|Ay| for the horizontal and vertical planes, respectively.
\item Statistics of Twiss parameters in the form \verb|<statistic>.<parameter-name>|,
where \verb|<statistic>| is \verb|min|, \verb|max|, \verb|ave|, \verb|p99|, \verb|p98|, or
\verb|p96|.  \verb|p99| is the 99$^{th}$ pencentile value, a similarly for \verb|p98| and \verb|p96|.
\item Tunes and chromaticities via symbols \verb|nux|, \verb|dnux/dp|, (and corresponding
symbols for y).
\item Chromatic derivatives of beta and alpha functions, via symbols
\verb|dbetax/dp|, \verb|dbetay/dp|, \verb|dalphax/dp|, and \verb|dalphay/dp|.
\item First- and second-order momentum compaction factors via symbols \verb|alphac| and \verb|alphac2|.  
\item If radiation integral computation is requested,  one may use \verb|ex0| and \verb|Sdelta0| for
the equilibrium emittance and momentum spread, plus \verb|J<plane>|
and \verb|tau<plane>| for the damping partition and damping time,
where \verb|<plane>| is \verb|x|, \verb|y|, or \verb|delta|.  One may also use
\verb|I1| through \verb|I5| for the individual radiation integrals.
\item If \verb|compute_driving_terms=1|, then the quantities
{\tt h11001}, {\tt h00111}, {\tt h20001}, {\tt h00201}, {\tt h10002}, {\tt h21000}, {\tt h30000}, {\tt h10110}, {\tt h10020},
{\tt h10200}, {\tt h22000}, {\tt h11110}, {\tt h00220}, {\tt h31000}, {\tt h40000}, {\tt h20110}, {\tt h11200}, {\tt h20020},
{\tt h20200}, {\tt h00310}, {\tt h00400}, {\tt dnux/dJx}, {\tt dnux/dJy},  and {\tt dnuy/dJy} 
may be used.  Table \ref{tab:drivingTerms} explains the meaning of the terms.
\item The coupling integral and emittance ratio due to x-y coupling may
be accessed using the symbols \verb|couplingIntegral| and
\verb|emittanceRatio|.  See section 3.1.4.4 of \cite{HAPE}.
\item If higher-order chromaticity is requested, then one may use the
  symbols {\tt dnux/dp2}, {\tt dnux/dp3}, {\tt dnuy/dp2}, {\tt
    dnuy/dp3}, {\tt etax2} , {\tt etax3}, {\tt etay2} , {\tt etay3},
  {\tt nuxChromLower}, {\tt nuxChromUpper}, {\tt nuyChromLower}, and
  {\tt nuyChromUpper}.
\item If the \verb|tune_shift_with_amplitude| command was also given
  and one may use the symbols {\tt dnux/dAx}, {\tt dnux/dAy}, {\tt
    dnuy/dAx}, {\tt dnuy/dAy}, {\tt dnux/dAx2}, {\tt dnux/dAy2}, {\tt
    dnux/dAxAy}, {\tt dnuy/dAx2}, {\tt dnuy/dAy2}, {\tt dnuy/dAxAy},
  {\tt nuxTswaLower}, {\tt nuxTswaUpper}, {\tt nuyTswaLower}, and {\tt
    nuyTswaUpper}.

\end{itemize}

If the \verb|floor_coordinates| command was given, one may use
\verb|X|, \verb|Z|, and \verb|theta| to refer to the final values of
the floor coordinates.

If the \verb|sasefel| command was given, one may use variables of
the form \verb|SASE.<property>|, where \verb|<property>| is one
of \verb|gainLength|, \verb|saturationLength|, 
\verb|saturationPower|, or \verb|lightWavelength|.

Finally, one may use any of the names from the ``final'' output file
(see \verb|run_setup|), e.g., \verb|Sx| (x beamsize) or \verb|eny| (y
normalized emittance).  These refer to tracked properties of the beam.

The equation may be left blank, in which case the user must give one
or more \verb|optimization_term| commands.  These use the same
symbols, of course.

There are several {\tt rpn} functions that are useful in constructing
a good optimization equation.  These are ``soft-edge'' greater-than, less-than,
and not-equal functions, which have the names {\tt segt}, {\tt selt}, and
{\tt sene}, respectively.  The usage is as follows:
\begin{itemize}
\item {\em V1} {\em V2} {\em T} {\tt segt}.  Returns a
 nonzero value if and only if value {\em V1} is greater than {\em V2}.  The 
 returned value is $((V_1-V_2)/T)^2$.  Typically used to constraint a quantity from
 above.  E.g., to limit the maximum horizontal beta function to 10m with
 a tolerance of $T=0.1m$, one would use \verb|max.betax 10 .1 segt|.
\item {\em V1} {\em V2} {\em T} {\tt selt}.  Returns a
 nonzero value if and only if value {\em V1} is less than value {\em V2}.  The 
 returned value is $((V_1-V_2)/T)^2$.    Typically used to constrain a value from
 below.  E.g., to limit a beta function to greater than 3 m with a tolerance of 0.1 m,
 one would use \verb|betax 3 .1 selt|.
\item {\em V1} {\em V2} {\em T} {\tt sene}.  Returns a nonzero value
 if and only if {\em V1} and {\em V2} differ by more than {\em tol}.  If
 $V_1>V_2$, returns $((V_1-(V_2+T))/T)^2$.  If $V_2>V_1$, returns
 $((V_2-(V_1+T))/T)^2$.
\end{itemize}
\item \verb|mode| --- May be either ``minimize'' or ``maximize''.

\item \verb|method| --- May be one of ``simplex'', ``grid'', ``powell'', ``randomwalk'', ``randomsample'', or ``sample''.  Recommended methods are ``simplex'' and ``randomwalk''. The latter is very useful when the lattice is unstable or nearly so.

\item \verb|tolerance| --- The convergence criterion for the optimization, with a negative value indicating
a fractional criterion.
\item \verb|target| --- The value which, if reached, results in immediate termination of the optimization,
whether it has converged or not.

\item \verb|center_on_orbit| --- A flag indicating whether to center the beam transverse coordinates on the closed orbit
  before tracking.

\item \verb|center_momentum_also| --- A flag indicating whether to center the momentum coordinate also.

\item \verb|soft_failure| --- A flag indicating, if set, that failure of an optimization pass should not
result in termination of the optimization.

\item \verb|n_evaluations| --- The number of allowed evaluations of
the optimization function.  If simplex optimization is used, this is
the number of allowed evaluations per pass.

\item \verb|n_passes| --- The number of optimization passes made to
achieve convergence (``simplex'' only).  A pass ends (roughly) when
the number of evaluations is completed or the function doesn't change
within the tolerance.  A new pass involves starting the optimization
again using step sizes determined from the range of the simplex and
the factor \verb|simplex_pass_factor|.

\item \verb|n_restarts| --- The number of complete restarts of the
optimization (simplex only).  This is an additional loop around the
\verb|n_passes| loop.  The difference is that a restart involves using
the optimized result but the original step sizes.  It is highly
recommended that this feature be used if convergence problems are seen.

\item \verb|restart_worst_term_factor|, \verb|restart_worst_terms| --- Often
when there are convergence problems, it is because a few terms are causing 
difficulty.  Convergence can often be obtained by {\em increasing} the weighting
of these terms.  If  \verb|restart_worst_term_factor| is positive, then \verb|elegant|
will multiply the weight of the \verb|restart_worst_terms| largest terms by this
factor at the beginning of a restart.

\item \verb|matrix_order| --- Specifies the highest order of matrix elements that
should be available for fitting.  Elements up to third order are available for
the terminal point of the beamline, and up to secod order for interior fit points.
Names for first-, second-, and third-order elements are of the form
{\tt R}{\em ij}, {\tt T}{\em ijk}, and {\tt U}{\em ijkl}.
\item \verb|log_file| --- A file to which progress reports will be written as optimization proceeds.
For SDDS data, use the \verb|final| output file from the \verb|run_setup| namelist.

\item \verb|term_log_file| --- This names a file to which the
  values of the optimization terms are written at the completion of optimization, which can be convenient when large numbers
  of terms are used.  For example, by using \verb|sddssort| one could find which terms are contributing most to the
  penalty value.

\item \verb|output_sparsing_factor| --- If set to a value larger than 0, results in
sparsing of output to the ``final'' file (see \verb|run_setup|). This can make
a significant difference in the optimization speed.

\item \verb|balance_terms| --- If nonzero, then all terms of the optimization expression have
 their weights adjusted so they make equal contributions to the penalty function.  This can
 help prevent optimization of a single term at the expense of others.  It is performed only 
 for the initial value of the optimization function.

\item \verb|simplex_divisor| --- The factor by which simplex step sizes are changed as the 
 optimization algorithm searches for a valid initial simplex.

\item \verb|simplex_pass_range_factor| --- When starting a new pass, the simplex optimizer takes
 the range over the previous simplex of each variable times this factor
 as the starting step size for that variable.  This can be useful if the optimization brings
 the system close to an instability.  In such a case, the simplex routine may have trouble
 constructing an initial simplex if the range of the variables is large. Setting this control
 to a value less than 1 may help.
 
\item \verb|include_simplex_1d_scans| --- If nonzero, optimizer performs single-variable scans prior to 
 starting simplex optimization.  This is usually a good idea, but in some cases it will cause problems.
 For example, if your design is on the edge of being unstable, you may get some many errors from the
 initial steps that the single-variable optimizer can't continue.  Disabling the
 single-variable scans will sometimes solve this.

\item \verb|start_from_simplex_vertex1| --- If nonzero, optimizer uses the initial simplex vertex as the
 starting point for each new 1d scan.  Otherwise, it uses the result of the previous scan.

\item \verb|restart_random_numbers| --- If nonzero, the random number generators used by {\tt elegant} are
 reset for each evaluation of the optimization function.  This is valuable if one is optimizing tracking
 results that involve random processes (e.g., ISR or scattering).

\item \verb|interrupt_file| --- Gives the name of a file that will be monitored by the program as it runs.
  If the file is created or modified while optimization is running, the optimizer will complete the present
  step and cleanly terminate, allowing subsequent commands, if any, to proceed.
\item \verb|interrupt_file_check_interval| --- If nonzero, then gives the interval in function evaluations between
  checks of the interrupt file. If zero, the interrupt file is only
  checked at the end of a simplex pass.
  N.B.: Depending on the responsiveness of the file system and the time required for a function evaluation, setting
  this to a small value could have a significant adverse impact on the run time. 
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|parallel_optimization_setup|}\end{center}
%\end{latexonly}
\subsection{parallel\_optimization\_setup \label{subsec:paralleloptimizationsetup}}

\begin{itemize}
\item type: setup command (for {\tt Pelegant} only).
\item function: define overall parallel optimization parameters and methods.
\item N.B.: In addition to the optimization parameters used in the optimization\_setup command, 	    
      several new parameters are added for parallel optimization. User should replace 
      optimization\_setup with parallel\_optimization\_setup and append necessary parameters. 
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&parallel_optimization_setup
    STRING method = "simplex";
    double hybrid_simplex_tolerance = -0.01;
    double hybrid_simplex_tolerance_count = 2;
    long hybrid_simplex_comparison_interval = 0;
    double random_factor = 1
    long n_iterations = 10000;
    long max_no_change = 10000;
    long population_size = 100;
    STRING population_log = NULL;
    long print_all_individuals = 0;
    long output_sparsing_factor = 1;
    STRING crossover = "twopoint";
    STRING simplex_log = NULL;
    long simplex_log_interval = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|method| --- May be one of ``genetic'', ``hybridsimplex'' or ``swarm''. If the default ``simplex'' method is chosen, all the processors will do the same optimization as the serial version if there is only one particle for optimization tracking, or do optimization tracking in parallel if the number of particles is larger than the number of CPUs. All algorithms can be used for global optimization. ``swarm'' is recommended when there is sufficient computation resource available, so it can reach the optimization target fast. ``hybridsimplex'' is recommended when the initial point is close to the optimal result. ``genetic'' can be chosen for a global optimizer with a random start point (0 should be avoided for any initial coordinate). 

\item \verb|random_factor| --- The factor to scale the step size for both parallel swarm and genetic methods.

\item \verb|n_restarts| --- For the parallel ``hybridsimplex'' method, this number should be set larger than 1, so the the best result across all processors can be used for the next restart. The parameter is not used for the swarm method.

\item \verb|hybrid_simplex_tolerance| , \verb|hybrid_simplex_tolerance_count| --- For the parallel ``hybridsimplex'' method,
  these set, respectively, the tolerance value for changes between full iterations (restarts). If the result does not improve by
  more than \verb|hybrid_simplex_tolerance| after \verb|hybrid_simplex_tolerance_count| iterations, the optimization terminates.

\item \verb|hybrid_simplex_comparison_interval| --- For the parallel ``hybridsimplex'' method, sets the interval between
  comparisons of progress among the several optimizations, in units of function evaluations. Once any of the optimizations
  is below the \verb|target| value, all optimizations are sent an abort command.
  Ignored if zero or negative, in which case all optimizations run to completion.
  Depending on the time required to perform a single function evaluation, setting this to a small value 
  may {\em increase} the required run time due to the overhead of frequent interprocessor communication.

\item \verb|simplex_log| --- For the parallel ``hybridsimplex'' method, rootname for files to which data from each simplex
  optimization will be written. Intended only for debugging as it will adversely impact performance.
\item \verb|simplex_log_interval| --- Interval at which \verb|simplex_log| files will be updated.

\item \verb|n_iterations| --- The maximal number of generations/iterations for the parallel genetic and particle swarm optimization. 

\item \verb|population_size| --- The number of individuals to be generated for each generation/iteration for the swarm and genetic method. For the hybridsimplex method, the number of individuals is equal to the number of processors used.

\item \verb|max_no_change| --- The maximal number of generations in which no change in the best evaluation is allowed before the genetic method stops (genetic method only).

\item \verb|n_evaluations| --- This is not used as a stop condition in the genetic optimization. The n\_iterations or max\_no\_change can be used instead. For the hybridsimplex method, this is the number of allowed evaluations per restart. 

\item \verb|population_log| --- An SDDS file to which the best individual in a population can be written after each iteration as optimization proceeds. Recommended value: ``\%s.pop''. For the parallel genetic method, user can choose to print out all the individuals (See print\_all\_individuals).

\item \verb|print_all_individuals| --- If nonzero, all the strings in a population will be recorded in the population\_log file. This is supported for the genetic method only.

\item \verb|output_sparsing_factor| --- For genetic optimization, this is used to set the frequency of printing strings in the log file with the number of generations as the interval.

\item \verb|crossover| --- For genetic optimization, it allows the user to choose a crossover type from ``onepoint'', ``twopoint'' and ``uniform''. ``twopoint'' is the default crossover type. If the dimension is 2, it will be set to onepoint crossover.

\end{itemize}

Note:
\begin{itemize}
\item Genetic optimization in {\tt Pelegant} terminates when at least one of the stopping rules specified has been met. 
The two stopping rules are: 

\begin{itemize}
\item generation limit (n\_iterations) exceeded
\item no change in the best solution found in a given number of generations. 
The default is to stop when the generation limit (10000 is the default value) is reached. While the max\_no\_change is more favorite to use, as it will stop until the result can not be improved after a certain number of iterations (10000 is the default value). The n\_iterations can be set 
to a very large number to use this rule as the stop condition alone.
\end{itemize}

\item step size control -- The mutation step size in the genetic optimization is selected from a Gaussian distribution with mean 0 and standard deviation step\_size, where step\_size is provided by user. All the dimensions will use the same standard deviation for an iteration. The step\_size of the first dimension provided by user will be used as the original step size for all the dimensions. The step size will be reduced by the golden ratio (1.618) if the best value is unchanged after every 3000 iterations. After every 3000 iterations since the last time the step size is reduced, the step size will be increased by the golden ratio.

\item As the genetic optimization implementation in {\tt Pelegant} internally updates individuals with a relative change of the current value for a variable, 0 should be avoided to use as an initial value.

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|optimization_term|}\end{center}
%\end{latexonly}
\subsection{optimization\_term \label{subsec:optimizationterm}}

\begin{itemize}
\item type: setup command.
\item function: define optimization equation via individual terms
\item sequence: must follow \verb|optimization_setup| and precede beam definition (\verb|bunched_beam| or \verb|sdds_beam|).
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&optimization_term
    STRING term = NULL;
    double weight = 1.0;
    STRING field_string = NULL;
    long field_initial_value = 0;
    long field_final_value = 0;
    long field_interval = 1;
    STRING input_file = NULL;
    STRING input_column = NULL;
    long verbose = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|term| --- An {\tt rpn} expression giving one term to be optimized.
If more than one \verb|optimization_term| command is given, then the terms are
added.   The advantage of using this command over giving an equation via
\verb|optimization_setup| is that {\tt elegant} will report the value of
each term as it performs the optimization (if a \verb|log_file| is given to
\verb|optimization_setup|).  This permits determination of
which terms are causing problems for the optimization.

Please see the entry for {\tt equation} under {\tt optimization\_setup} for
details on designing optimization terms.

\item \verb|weight| --- The weight to assign to this term.  If zero, the term
        is ignored.


\item \verb|field_string|, \verb|field_initial_value|, \verb|field_final_value|, \verb|field_interval| --- 
  These parameters are used to perform substitution of a series of values into the string given by
  \verb|term|.  This can be used to make an identical constraint at a number of instances
  of the same marker.  For example, to constraint \verb|Cx| to zero at instances 1, 3, 5, ..., 39,
  of marker \verb|M1|, one could use
\begin{verbatim}
&optimization_term
  term = "M1#@.Cx sqr", 
  field_string = @, 
  field_initial_value = 1, field_final_value = 39, field_interval = 2
&end
\end{verbatim}

\item \verb|input_file|, \verb|input_column| --- If given, \verb|input_file| is taken as the name of an SDDS file,
  which is expected to have a string column named by \verb|input_column|.  Each row of the column is taken as
  a separate optimization term.

\item \verb|verbose| --- If nonzero, optimization terms are echoed to the terminal as they are created or read
  from the input file.

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|optimization_variable|}\end{center}
%\end{latexonly}
\subsection{optimization\_variable \label{subsec:optimizationvariable}}

\begin{itemize}
\item type: setup command.
\item function: defines a parameter of an element to be used in optimization.
\item sequence: must follow \verb|optimization_setup| and precede beam definition (\verb|bunched_beam| or \verb|sdds_beam|).
\item N.B.: It is not possible to optimize an element if the element name starts with one of the following
characters: 
\verb|0|, \verb|1|, \verb|2|, \verb|3|, \verb|4|, \verb|5|, \verb|6|, \verb|7|, \verb|8|,
\verb|9|, \verb|.|, \verb|+|, or \verb|-|.  The reason is that {\tt elegant} will attempt to 
make an SDDS parameter name containing the element name, and these characters are disallowed
at the beginning of such a name.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&optimization_variable
    STRING name = NULL;
    STRING item = NULL;
    double lower_limit = 0;
    double upper_limit = 0;
    long differential_limits = 0;
    double step_size = 1;
    long disable = 0;
    long force_inside = 0;
    long no_element = 0;
    double initial_value = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- The name of the element.
\item \verb|item| --- The parameter of the element to be varied.
\item \verb|lower_limit|, \verb|upper_limit| --- The lower and upper limits allowed for the parameter.  If these are
equal, the range of the parameter is unlimited.
\item \verb|differential_limits| --- If nonzero, then the lower and upper limits are being given relative to the initial value,
  rather than in absolute terms.
\item \verb|step_size| --- The initial step size (``simplex'' optimization ) or the grid size in this dimension (``grid'' or ``sample'' optimization).
\item \verb|disable| --- If nonzero, the variable is ignored.
\item \verb|force_inside| --- If nonzero, the initial value is forced inside the allowed range defined by the \verb|lower_limit| and \verb|upper_limit| parameters.
\item \verb|no_element|, \verb|initial_value|  --- Allows defining a variable that is not connected to a beamline element, and giving
  the initial value for the variable. The variable can them be used in other optimization-related commands, e.g., 
  \verb|optimization_covariable|.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|print_dictionary|}\end{center}
%\end{latexonly}
\subsection{print\_dictionary \label{subsec:printdictionary}}

\begin{itemize}
\item type: action command.
\item function: print dictionary of supported accelerator elements.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&print_dictionary
    STRING filename = NULL;
    long SDDS_form = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|filename| --- The name of a file to which the dictionary will be written.  By default, the 
  output is in \LaTeX format.
\item \verb|SDDS_form| --- If non-zero, then the output is in  SDDS format.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|ramp_elements|}\end{center}
%\end{latexonly}
\subsection{ramp\_elements\label{subsec:rampelements}}

\begin{itemize}
\item type: setup command.
\item function: define parameters for time-dependent ramping of elements
\item sequence: must follow \verb|run_setup|.
\item N.B.: if the ramped element is modeled with a matrix, a significant performance hit may be seen.
  It is best to use symplectic variants of the elements, since these don't invoke the matrix calculation.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&ramp_elements
    STRING name = NULL;
    STRING item = NULL;
    STRING type = NULL;
    long start_pass = 0;
    long end_pass = LONG_MAX;
    double start_value = 0;
    double end_value = 0;
    long refresh_matrix = 0;
    long differential = 1;
    long multiplicative = 0;
    long start_occurence = 0;
    long end_occurence = 0;
    double exponent = 1;
    double s_start = -1;
    double s_end = -1;
    STRING before = NULL;
    STRING after = NULL;
    long verbose = 0;
    STRING record = NULL;
&end
\end{verbatim}

N.B.: This command will produce unpredictable results when used with
\verb|error_element|, \verb|alter_elements|, \verb|modulate_elements|, and
\verb|load_parameters| (except when \verb|change_defined_values=1|).
It will also not work well if matrix concatenation is invoked.
It should work properly with \verb|link_elements| in turn-by-turn mode
when the source element is ramped, but not when the target element
is ramped.

\begin{itemize}
\item \verb|name| --- A possibly-wildcard-containing string giving the names of the
        elements to modulate. If not specified, then one must specify \verb|type|.
\item \verb|item| --- The name of the parameter to modulate.
\item \verb|type| --- A possibly-wildcard-containing string giving the names of element
        {\em types} to modulate.  May be specified with \verb|name| or by itself.
\item \verb|start_pass|, \verb|end_pass| --- The starting and ending pass, 
  $i_{\rm start}$ and $i_{\rm end}$ for the ramp.
 For passes less than \verb|start_pass|, the ramp value is \verb|start_value|.
 For passes greater than \verb|end_pass|, the ramp value is \verb|end_value|.
\item \verb|start_value|, \verb|end_value| --- The end-point values $S$ (start) and $E$ (end) of the ramp.
\item \verb|exponent| --- The exponent $p$ for the variation of values between the start and end
  of the ramp.  The ramp function $R(i)$ is 
\begin{equation}
  R(i) = S + (E-S)*\left(\frac{i-i_{\rm start}}{i_{\rm end}-i_{\rm start}}\right)^p.
\end{equation}
Note that $i=0$ on the first pass.
\item \verb|refresh_matrix| --- Frequently there is a matrix associated with an element even
  if tracking through the element does not use the matrix.  In this case, {\tt elegant} doesn't
  normally update the matrix for the element as it modulates the element, since that may involve
  a significant time penalty.  If this parameter is set to a non-zero value, the matrix will
  be updated.  For elements that use a matrix for tracking, the matrix is always updated.
\item \verb|differential|, \verb|multiplicative| --- Determine how the amplitude function
  $A(t)$ is used to obtain the new value of the parameter.  There are four cases
  \begin{itemize}
    \item \verb|differential=1|, \verb|multiplicative=0|: $v(t) = v_0 + R(i)$ (default).
    \item \verb|differential=0|, \verb|multiplicative=0|: $v(t) = R(i)$.  
    \item \verb|differential=1|, \verb|multiplicative=1|: $v(t) = v_0 + v_0 R(i)$.  
    \item \verb|differential=0|, \verb|multiplicative=1|: $v(t) = v_0 R(i)$.  
  \end{itemize}
\item \verb|start_occurence|, \verb|end_occurence| --- If nonzero, these give the starting and
 ending occurrence numbers of elements that will be modulated. N.B.: if wildcards are used, occurrence
 number counting is for each set of identically-named elements separately, rather than for the sequence
 of matched elements.
\item \verb|s_start|, \verb|s_end| --- If non-negative, these give the gaving and ending position
 limits for the end-of-element locations of elements to be modulated.
\item \verb|after| --- The name of an element.  If given, the modulation is applied only to elements
 that follow the named element in the beamline.  
\item \verb|before| --- The name of an element.  If given, the modulation is applied only to elements
 that precede the named element in the beamline. 
\item \verb|verbose| --- If nonzero, information is printed to the standard output as changes are
        made.  Use for debugging only, since otherwise it may slow the simulation.
\item \verb|record| --- Gives a possibly incomplete filename to which will be written a record of the values of
  the ramp.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|rf_setup|}\end{center}
%\end{latexonly}
\subsection{rf\_setup\label{subsec:rfsetup}}

\begin{itemize}
\item type: setup/action command.
\item function: set up rf cavity frequency, phase, and voltage for a storage ring
\item sequence: must follow \verb|run_setup|. In action mode, must follow action-mode instance of \verb|twiss_output|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&rf_setup
    STRING filename = NULL;
    STRING name = NULL;
    long start_occurence = -1;
    long end_occurence = -1;
    double s_start = -1;
    double s_end = -1;
    long set_for_each_step = 0;
    double near_frequency = 0; 
    long harmonic = -1;
    double bucket_half_height = 0;
    double over_voltage = 0;
    double total_voltage = 0;
    long disable = 0;
    long output_only = 0;
    long track_for_frequency = 0;
&end
\end{verbatim}

This command must follow a \verb|twiss_output| command that includes radiation integral computation, since the 
energy loss per turn is needed to set up the rf cavities.
Note that the command includes features to allow selecting a subset of the RFCA elements in the beamline.
The selected subset is assumed to include all of the cavities that will impart net energy to the beam.

This command stores values for bunch length in symbols \verb|Sz0| and \verb|St0|, and also stores the fractional
energy spread in \verb|Sdelta0|, where they can be used in rpn expressions in subsequent  commands, e.g.,
\begin{verbatim}
&bunched_beam
 sigma_dp = "(Sdelta0)",
 sigma_s = "(Sz0)",
 ...
&end
\end{verbatim}

\begin{itemize}
\item \verb|filename| --- Name of a file to which data related to the rf settings will be written.
\item \verb|name| --- A possibly-wildcard-containing string giving the names of the
        elements to set.  If not given, all RFCA elements are selected.
\item \verb|start_occurence|, \verb|end_occurence| --- If nonzero, these give the starting and
 ending occurrence numbers of elements that will be set. 
\item \verb|s_start|, \verb|s_end| --- If non-negative, these give the gaving and ending position
 limits for the end-of-element locations of elements to be set.
\item \verb|set_for_each_step| --- If nonzero, then the setup is repeated at each simulation step.
  In this case, one must also give \verb|output_at_each_step=1| for \verb|twiss_output|.
\item \verb|near_frequency| -- If nonzero, then the rf frequency is chosen to be the closest harmonic
  to the given frequency.
\item \verb|harmonic| --- If nonzero, then the rf frequency is set to the given harmonic of the revolution
  frequency.
\item \verb|bucket_half_height| --- If nonzero, the voltage is computed so as to give the specified bucket
  half height. 
\begin{equation}
\left(\frac{\Delta p}{p}\right)_{\rm bucket} = \sqrt{\frac{U_0}{\pi \alpha h E}}\sqrt{F(q)},
\end{equation} 
where $U_0$ is the energy loss per turn, $\alpha$ is the momentum compaction factor, $h$ is the harmonic, 
$E$ is the beam energy, 
\begin{equation}
F(q) = 2 \left(\sqrt{q^2-1} - \arccos \frac{1}{q}\right),
\end{equation}
and $q$ is the overvoltage factor, related to the rf voltage by $q = V/U_0$. (See Wiedemann, Vol. 1, 8.2.2.)
\item \verb|over_voltage| --- If nonzero, the voltage is set to the given factor relative to the 
energy loss per turn.
\item \verb|total_voltage| --- If nonzero, the total rf voltage is set to the given value. The frequency and
  phase are computed for this voltage.
\item \verb|disable| --- If nonzero, command does nothing.
\item \verb|output_only| --- If nonzero, command generates output file but does not change rf cavity settings.
\item \verb|track_for_frequency| --- If nonzero, particle tracking is used to determine the rf frequency. If zero,
  the ideal length of the lattice is used.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|replace_elements|}\end{center}
%\end{latexonly}
\subsection{replace\_elements \label{subsec:replaceelements}}

\begin{itemize}
\item type: action command.
\item function: Replace old element with a newly defined element, or just 
   remove it from beamline. This is a convenient way to modify lattice in an elegant run.
   See also \verb|transmute_elements|.
\item sequence: must follow \verb|run_setup|.
\item notes: 
	The modified lattice can be saved through \verb|save_lattice|
   command. Be sure to use ``output\_seq = 1'' option in that command.  
\item warning:
   The element's occurrence is re-calculated after each usage of this command. If 
   you need to repeat this command for SAME named element several times, you have to re-calculate 
   it occurrence every time. For example, you want to remove Q1 at occurrence position 
   (1,3,5), and use 
   `replace\_elements'' twice. If in the first command you use ``occurence[0]=1,3'',
   then in the second command you have to use ``occurence[0]=3'', since after remove of
   (1,3) Q1s, the 5th Q1 now becoming 3rd Q1.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&replace_elements
        STRING name = NULL;
        STRING type = NULL;
        STRING exclude = NULL;
        long skip = 1;
        long disable = 0;
        STRING element_def = NULL;
        long total_occurrences = 0;
        long occurrence[100]={0};
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- Possibly wild-card containing string specifying the
	name of the elements to be removed or replaced.
\item \verb|type| --- Possibly wild-card containing string specifying the
   type of the elements to be removed or replaced.
\item \verb|exclude| --- Possibly wild-card containing string specifying 
	the name of elements to be excluded from this command.
\item \verb|skip| --- The element is removed or replaced at every $n^{th}$ 
   specified location.
\item \verb|disable| --- If nonzero, the command is ignored.
\item \verb|element_def| --- If NULL, the specified elements are removed from
   the beamline. If not NULL, the specified elements are replaced with the new element
   defined here. The definition of the element should be just as it would be entered in 
   the lattice file.
\item \verb|total_occurrences|, \verb|occurrence| --- 
These parameters are used to replace or delete specified occurrences of 
the element \verb|name|.  \verb|total_occurrences| specifies how many elements to replace
or delete up to a maximum of 100, while the entries in the array \verb|occurrence| specify the occurrences
to replace or delete. If \verb|total_occurrences| is non-zero, then {\bf skip} must
be set to zero  and the {\bf name} must be the exact name (no wild-card matching). 
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|rpn_expression|}\end{center}
%\end{latexonly}
\subsection{rpn\_expression \label{subsec:rpnexpression}}

\begin{itemize}
\item type: action/setup command.
\item function: pass an expression directly to the rpn submodule for execution.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&rpn_expression
    STRING expression = NULL;
&end
\end{verbatim}

\begin{itemize}
\item \verb|expression| --- An {\tt rpn} expression.  This expression is executed immediately and can be
used, for example, to read in {\tt rpn} commands from a file or store values in {\tt rpn} memories.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|rpn_load|}\end{center}
%\end{latexonly}
\subsection{rpn\_load \label{subsec:rpnload}}

\begin{itemize}
\item type: action/setup command.
\item function: load data from SDDS file into RPN variables.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&rpn_load
    STRING tag = NULL;
    STRING filename = NULL;
    STRING match_column = NULL;
    STRING match_column_value = NULL;
    long matching_row_number = -1;
    STRING match_parameter = NULL;
    STRING match_parameter_value = NULL;
    long use_row = -1;
    long use_page = -1;
    long load_parameters = 0;
&end
\end{verbatim}

This command is used to facilitate multi-stage optimization runs by allowing convenient
loading of data from SDDS files into RPN variables.  For example, one may match the
final Twiss parameters of a lattice to the parameters stored in an SDDS file from
a different run.

\begin{itemize}

\item \verb|tag| --- Option string that will be pre-pended to the names of all the numerical columns 
 in the file in order to create RPN variable names.  E.g., if the input file was from the
 \verb|twiss_output| command and \verb|tag = tw1| was given, then RPN variables 
 \verb|tw1.betax|, \verb|tw1.alphax|, etc. would be used.  {\em N.B.: If the tag is blank, then nothing 
 is appended to the names from the file.  This can be dangerous since the names may conflict with
 the names of other variables!}

\item \verb|filename| --- The (incomplete) name of the SDDS file from which to read data.
    By default, data is taken from all columns from the last row of the last page of the file.
    This default behavior can be altered using one or more of the following parameters:
\begin{itemize}
    
\item \verb|match_column| --- The name of a string column to use in selecting the row from
 which data will be taken.

\item  \verb|match_column_value| --- The value that the column named by \verb|match_column| must
 have to be selected from the file.  By default, the last row with a matching value is used.

\item \verb|matching_row_number| --- If a nonnegative value is given, then the \verb|matching_row_number|$^{th}$
 matching row is selected (0 is the first row, 1 the second, etc).  Otherwise, the last match row is used.  Ignored if \verb|match_column| is not
 given.

\item \verb|match_parameter| --- The name of a string parameter to use in selecting the page
 from which data will be taken.  

\item \verb|match_parameter_value| --- The value that the parameter named by \verb|match_parameter| must
 have to be selected from the file.  By default, the last page with a matching value is used.

\item \verb|use_row| --- If nonnegative, specifies the row number to use, starting at 0 for the first row.
 Ignored if \verb|match_column| is given.

\item \verb|use_page| --- If nonnegative, specifies the page number to use, starting at 1 for the first page.
 Takes precedence over \verb|\match_parameter| if both are given.

\item \verb|load_parameters| --- If nonzero, specifies loading the SDDS parameter data rather than the column data.
\end{itemize}
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|run_control|}\end{center}
%\end{latexonly}
\subsection{run\_control \label{subsec:runcontrol}}

\begin{itemize}
\item type: setup command.
\item function: set up the number of simulation steps and passes.
\item sequence: must follow \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&run_control
    long n_steps = 1;
    double bunch_frequency = 0;
    long n_indices = 0;
    long n_passes = 1;
    long n_passes_fiducial = 0;
    long reset_rf_for_each_step = 1;
    long first_is_fiducial = 0;
    long restrict_fiducialization = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|n_steps| --- The number of separate repetitions of the action implied by the next action command.
If random errors are defined, this is also the number of separate error ensembles.
\item \verb|bunch_frequency| --- The frequency to use in calculating the time delay between repetitions.
\item \verb|n_indices| --- The number of looping indices for which to expect definitions in subsequent \verb|vary_element| commands.  If nonzero, then \verb|n_steps| is ignored.
\item \verb|n_passes| --- The number of passes to make through the beamline per repetition.
\item \verb|n_passes_fiducial| --- The number of passes to make through the beamline per repetition for the fiducial beam. If non-positive, use \verb|n_passes|.
  For ring tracking, should probably always be set to 1.
\item \verb|reset_rf_for_each_step| --- If nonzero, the rf phases are 
established anew for each bunch tracked.  Should be zero to simulate
phase and timing jitter. 
\item \verb|first_is_fiducial| --- If nonzero, the first bunch seen is taken
to establish the reference phases and momentum profile.  If zero, each bunch
is treated as a new fiducializing bunch.
\item \verb|restrict_fiducialization| --- If nonzero, then  momentum profile
fiducialization occurs only after elements that are intended
change the momentum, such as rf cavities.  If zero, then each element is
fiducialized to the average momentum of the beam.
Active only if \verb|first_is_fiducial=1| and overrides the \verb|always_change_p0| setting 
in \verb|run_setup|.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|run_setup|}\end{center}
%\end{latexonly}
\subsection{run\_setup \label{subsec:runsetup}}

\begin{itemize}
\item type: setup command.
\item function: set global parameters of the simulation and define primary input and output files.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&run_setup
    STRING lattice = NULL;
    STRING use_beamline = NULL;
    STRING rootname = NULL;
    STRING output = NULL;
    STRING centroid = NULL;
    STRING sigma = NULL;
    STRING final = NULL;
    STRING acceptance = NULL;
    STRING losses = NULL;
    long losses_include_global_coordinates = 0;
    double losses_s_limit[2] = {-DBL_MAX, DBL_MAX};
    STRING magnets = NULL;
    STRING semaphore_file = NULL;
    STRING parameters = NULL;
    long suppress_parameter_defaults = 0;
    STRING rfc_reference_output = NULL;
    long combine_bunch_statistics = 0;
    long wrap_around = 1;
    long final_pass = 0;
    long default_order = 2;
    long concat_order = 0;
    long print_statistics = 0;
    long show_element_timing = 0;
    long monitor_memory_usage = 0;
    long random_number_seed = 987654321;
    long correction_iterations = 1;
    double p_central = 0.0;
    double p_central_mev = 0.0;
    long always_change_p0 = 0;
    STRING expand_for = NULL; 
    long tracking_updates = 1;
    long echo_lattice = 0;
    STRING search_path = NULL;
    long element_divisions = 0;
    long load_balancing_on = 0;
    long back_tracking = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|lattice| --- Name of the lattice definition file.
\item \verb|echo_lattice| --- If nonzero, the lattice input is echoed to the
        standard output as the lattice is parsed.  This can help detect certain
        problems with the lattice that cause \verb|elegant| to crash.
\item \verb|use_beamline| --- Name of the beamline to use.
\item \verb|rootname| --- Filename fragment used in forming complete names from incomplete filenames.  By default, 
the filename minus extension of the input file is used.
\item \verb|output| --- The (incomplete) name of an SDDS file into which final phase-space coordinates
will be written.  Recommended value: ``\%s.out''.
\item \verb|centroid| --- The (incomplete) name of an SDDS file into which beam centroids as a function
of s will be written.   Recommended value: ``\%s.cen''.
\item \verb|sigma| --- The (incomplete) name of an SDDS file into
which the beam sigma matrix as a function of z will be written.
Recommended value: ``\%s.sig''.  N.B.: confusion sometimes occurs about some of the quantities related to
the {\tt s} coordinate in this file.  Please see Section \ref{sec:longitCoord} above.
\item \verb|final| --- The (incomplete) name of an SDDS file into
which final beam and transport parameters will be written. Recommended
value: ``\%s.fin''.   N.B.: confusion sometimes occurs about some of the quantities related to
the {\tt s} coordinate in this file.  Please see Section \ref{sec:longitCoord} above.
\item \verb|acceptance| --- The (incomplete) name of an SDDS file into
which the initial coordinates of transmitted particles will be
written.  Recommended value: ``\%s.acc''.
\item \verb|losses| --- The (incomplete) name of an SDDS file into
which information on lost particles will be written. Recommended
value: ``\%s.lost''.
\item \verb|losses_include_global_coordinates| --- If nonzero, the losses output file includes the
  global coordinates of lost particles.
\item \verb|losses_s_limit[2]| --- Specifies the minimum and maximum \verb|s| coordinate for
  logging of lost particles.
\item \verb|magnets| --- The (incomplete) name of an SDDS file into
which a magnet layout representation will be written.  Recommended
value: ``\%s.mag''.
\item \verb|semaphore_file| --- The (incomplete) name of file that
will be created just before exit from the program, but only if no
errors occured.  If the file exists, it is deleted.  This file can be
used to record the fact that the run completed without error.
\item \verb|parameters| --- The (incomplete) name of an SDDS file into
which parameters of accelerator elements are written.
\item \verb|suppress_parameter_defaults| --- If non-zero, then the \verb|parameters| output file
  will not contain rows for parameters whose values are identical to the then-current default values.
  This can result in significantly smaller parameter files and faster loading.
  The downside is that future changes to defaults would possible result in difficulty reproducing a
  result from a saved parameter file.
\item \verb|rfc_reference_output| --- The (incomplete) name of an SDDS file into
which the internally-determined reference times for \verb|RFCA| and \verb|RFCW| 
elements are written. This file can be loaded with \verb|load_parameters| to
exactly reproduce cavity phasing, e.g., for backtracking.
\item \verb|combine_bunch_statistics| --- A flag indicating whether to
combine statistical information for all simulation steps.  If
non-zero, then the \verb|sigma| and \verb|centroid| data will be
combined over all simulation steps.
\item \verb|wrap_around| --- A flag indicating whether the s
 coordinate should wrap-around or increase monotonically in multipass
 simulations.  If zero, then the centroid and sigma data is computed for
 each turn with the s coordinate increasing continuously.
\item \verb|final_pass| --- A flag indicating whether the centroid and
 sigma output should be computed only from the data from the final pass.
 By default, the statistics include data from all passes.
\item \verb|default_order| --- The default order of transfer matrices
used for elements having matrices.
\item \verb|concat_order| --- If non-zero, the order of matrix
concatenation used.
\item \verb|print_statistics| --- A flag indicating whether to print
information as each element is tracked. If greater than 0, information is printed after each element from the beginning of tracking.
If equal to $n$ with $n<0$, information is printed only after pass $\left|n\right|$.
\item \verb|show_element_timing| --- A flag indicating whether to collect and report execution time statistics binned by element type.
\item \verb|monitor_memory_usage| --- A flag indicating whether to monitor memory usage during tracking to detect memory leaks.
\item \verb|random_number_seed| --- A seed for the random number generators.  If zero, a seed will be generated from the system clock.
\item \verb|correction_iterations| --- Number of iterations of tune and chromaticity correction.
\item \verb|p_central| --- Central momentum of the beamline, about which expansions are done.
        This is $\beta\gamma$.
\item \verb|p_central_mev| --- Central momentum of the beamline in
MeV/c, about which expansions are done.  Ignored if \verb|p_central| is nonzero.
\item \verb|always_change_p0| --- If nonzero, then {\tt elegant} will match the reference momentum to
  the beam momentum after each element.  For example, in a beamline with radiation losses, one might
  want to adjust downstream magnets to match the energy of the incoming beam.
\item \verb|expand_for| --- Name of an SDDS file containing particle information, from which the central
momentum will be set.  The file contents are the same as required for {\tt elegant} input with the \verb|sdds_beam| namelist.
\item \verb|tracking_updates| --- A flag indicating whether to print summary information about
tracking.
\item \verb|search_path| --- Specify a list of pathnames in which to look for input files,
 including lattice files, wakefield input, particle input, etc.  This allows storing common
 input files in a convenient location without having to put the location into every filename.
\item \verb|element_divisions| --- Specify how many pieces to split elements into.  Only 
 certain elements (basically, those with a matrix) are split.  Results in creation of 
 \verb|element_divisions| new elements having the same name as each split element.
\item \verb|load_balancing_on| --- If 1, load-balancing is performed for parallel mode.
 This can result in non-deterministic results if the load-balancing is different on two
 otherwise identical runs.  Load-balancing variations may occur in heterogeneous clusters,
 clusters with multiple users, or for other reasons.  In such situations, turning off 
 load balancing can be useful if, for example, one is performing parameter scans and
 wishes to eliminate spurious sources of variation.
 If -1, then the load balance is checked and reported, but no rebalancing takes place.
\item \verb|back_tracking| --- If nonzero, then back-tracking is performed. The beamline is reversed in
  order and the beam is propagated backwards through the elements. Only a selection of elements are supported at
  present, including \verb|CHARGE|, \verb|CSBEND|, \verb|DRIF|, \verb|EDRIFT|, \verb|EHCOR|, \verb|EHVCOR|,
  \verb|EVCOR|, \verb|HMON|, \verb|KOCT|, \verb|KQUAD|, \verb|KSEXT|, \verb|MARK|, \verb|MONI|, \verb|QUAD|, \verb|RFCA|, 
  \verb|SBEN|, \verb|SEXT|, \verb|TRWAKE|, \verb|UKICKMAP|, \verb|VMON|, \verb|WAKE|, and \verb|WATCH|.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sasefel|}\end{center}
%\end{latexonly}
\subsection{sasefel \label{subsec:sasefel}}

\begin{itemize}
\item type: setup/action command.
\item function: set parameters for computation of SASE FEL gain and other properties.
\item sequence: must follow \verb|run_setup| and precede beam definition (\verb|bunched_beam| or \verb|sdds_beam|).
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&sasefel
    STRING output = NULL;
    STRING model = "Ming Xie";
    double beta = 0;
    double undulator_K = 3.1;
    double undulator_period = 0.033;
    double slice_fraction = 0.0;
    long n_slices = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|output| --- The (incomplete) filename of an SDDS file to which output will be
written.
\item \verb|model| --- The name of the FEL model used.  At present, only one model is
supported; the ``Ming-Xie'' model is based on the simple parametrization M. Xie\cite{MingXie}.
\item \verb|beta| --- The value of the beta function, in meters.
\item \verb|undulator_K| --- The K parameter of the undulator.
\item \verb|undulator_period| --- The undulator period, in meters.
\item \verb|slice_fraction|, \verb|n_slices| --- The fraction of beam beam contained by each analysis slice
        and the number of such slices.
        By default, no slice analysis is done.  Instead, the beam is analyzed only as a whole.
        If \verb|slice_fraction|*\verb|n_slices| is less than 1, then the slice analysis
        is centered on the median of the time distribution.  E.g., if \verb|n_slices|=1 and
        \verb|slice_fraction|=0.1, then the central 10\% of the beam would be analyzed.
        More typically, one gives values such that \verb|slice_fraction|*\verb|n_slices| is
        equal to 1, so that every part of the beam is analyzed.  There are separate values in
        the output file for each slice, plus the whole-beam and slice-averaged results.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|save_lattice|}\end{center}
%\end{latexonly}
\subsection{save\_lattice \label{subsec:savelattice}}

\begin{itemize}
\item type: action command.
\item function: save the current accelerator element and beamline definitions.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&save_lattice
    STRING filename = NULL;
    long output_seq = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|filename| --- The (incomplete) name of a file to which the element and beamline definitions
will be written.  Recommended value: ``\%s.new''.
\item \verb|output_seq| --- If non-zero, the lattice will be saved as a single beamline sequence.
Elements used for the beamline are re-arranged according to their type. Note: 
sub-beamline definitions in the original lattice file will be destroyed from the output file.
This feature is intended to be used 
together with \verb|insert_elements| and \verb|replace_elements|. 
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sdds_beam|}\end{center}
%\end{latexonly}
\subsection{sdds\_beam \label{subsec:sddsbeam}}

\begin{itemize}
\item type: setup command.
\item function: set up for tracking and histogram analyzing of particle coordinates stored in an SDDS file.
\item sequence: must follow \verb|run_control|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&sdds_beam
    STRING input = NULL;
    STRING input_list = NULL;
    STRING input_type = "elegant";
    long n_particles_per_ring = 0;
    STRING selection_parameter = NULL;
    STRING selection_string = NULL;
    long one_random_bunch = 0;
    long reuse_bunch = 0;
    long prebunched = -1;
    long track_pages_separately = 0;
    long use_bunched_mode = 0;
    long fiducialization_bunch = 0;
    long sample_interval = 1;
    long n_tables_to_skip = 0;
    long center_transversely = 0;
    long center_arrival_time = 0;
    double sample_fraction = 1;
    double p_lower = 0.0;
    double p_upper = 0.0;
    long save_initial_coordinates = 1;
    long reverse_t_sign = 0;
    long n_duplicates = 0;
    double duplicate_stagger[6] = {0, 0, 0, 0, 0, 0};
&end
\end{verbatim}

\begin{itemize}
\item \verb|input| --- Name of an  SDDS file containing coordinates of input particles.
\item \verb|input_type| --- May be ``elegant'' or ``spiffe'', indicating the name of the
program that wrote the input file.  The expected data quantities for the different types are:
\begin{itemize}
\item {\tt elegant}: ${\rm (x, xp, y, yp, t, p)}$, where x and y are
in meters, ${\rm xp=x^\prime}$ and ${\rm xp=y^\prime}$ are
dimensionless, t is in seconds, and ${\rm p=\beta\gamma}$ is the
dimensionless momentum. If this file is to be generated by the user,
the expected units string in the column definitions should be ``m'',
``s'', and ``m\$be\$nc'' for meters, seconds and the dimensionless
momentum, respectively.
The \verb|particleID| column may also be given; it should contain a positive integer that is unique for
each particle.

\item {\tt spiffe}: ${\rm (r, z, pr, pz, pphi, t)}$, where r and z are
in meters, ${\rm pr=\beta_r \gamma}$, ${\rm pz = \beta_z \gamma}$,
${\rm p_\phi = \omega r \gamma/c}$, and t is in seconds. If this file
is to be generated by the user use the units strings described above.
\end{itemize}

\item \verb|n_particles_per_ring| --- For {\tt spiffe} data, gives the number of particles to
generate for each ring of charge.
\item \verb|selection_parameter| --- The name of a parameter in the SDDS file to be used for selection
of pages of data.
\item \verb|selection_string| --- The value of the
\verb|selection_parameter| selection parameter required for a page to
be used.  E.g., if one has a file from the {\tt shower} program
containing positrons, electrons, and photons, one might want to select
only the positrons.
\item \verb|one_random_bunch| --- A flag indicating whether, for {\tt spiffe} data, a new random
distribution should be calculated for each step of the simulation.
\item \verb|reuse_bunch| --- A flag indicating whether to use the bunch again or not.  If set, then the first bunch in the
file is used repeatedly for as many tracking steps as requested.  Otherwise, each bunch is used only once and the number of
steps is limited to the number of bunches (e.g., the number of pages in the file when \verb|prebunched=0|).
\item \verb|prebunched| --- Deprecated. Use \verb|track_pages_separately| instead.
\item \verb|track_pages_separately| --- If non-zero, then separate pages of the input file are tracked separately. Otherwise, the 
  entire file is tracked together.
\item \verb|use_bunched_mode| --- If non-zero, then the \verb|IDSlotsPerBunch| parameter is used to determine the bunch assignment of
  particles in the beam based on values in the \verb|particleID| column. In particular, the bunch number is $\lfloor (I-1)/S \rfloor$, where
  $I$ is the particle ID and $S$=\verb|IDSlotsPerBunch|.
\item \verb|fiducialization_bunch| --- If non-negative, then rf cavities (e.g., RFCA, RFDF, RAMPRF) are phased to the
  indicated bunch (0 is the first bunch). Otherwise, rf cavities are phased to the entire beam (which is probably not what is wanted).
\item \verb|sample_interval| --- If non-zero, only every \verb|sample_interval|$^{\rm th}$ particle is used.
\item \verb|n_tables_to_skip| --- Number of SDDS pages to skip at the beginning of the file.
\item \verb|center_transversely| --- If non-zero, the transverse centroids of the distribution are made to be zero.
\item \verb|center_arrival_time| --- If non-zero, the mean arrival time of particles at the start of the
accelerator is set to zero.
\item \verb|sample_fraction| --- If non-unity, the randomly selected fraction of the distribution to use.
\item \verb|p_lower|, \verb|p_upper| --- If different, the lower and upper limit on ${\rm \beta\gamma}$ of particles to use.
\item \verb|save_initial_coordinates| --- A flag that, if set, results in saving initial coordinates
of tracked particles in memory.  This is the default behavior.  If unset, the initial coordinates
are not saved, but are reread from disk each time they are needed.  This is more memory efficient
and is useful for tracking very large numbers of particles.
\item \verb|n_duplicates| --- This specifies duplicating the particles from the input file to allow tracking more
  particles.   \verb|n_duplicates| specifies the number of duplications, where the default value of 0 indicates no duplication.
  If $n$-fold duplication is invoked, the particle ID of a new particle is equal to the particle ID of its parent particle plus
  $i N_p$, where $i=1,...,n+1$ is the duplication index and $N_p$ is the number of particles in the parent bunch.
  This should be kept in mind when using the particle ID to segregate the beam into bunches.
\item \verb|duplicate_stagger| --- Specifies offsetting of the coordinates $x$, $x^\prime$, $y$, $y^\prime$, $t$, and $\delta$
  for each duplication by the specified amounts.
  One assumes that some stochastic process such as synchrotron radiation will cause further differentiation of duplicate particles.
  One can also use \verb|SCATTER| or \verb|DSCATTER| elements in the beamline for this purpose.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|semaphores|}\end{center}
%\end{latexonly}
\subsection{semaphores \label{subsec:semaphores}}

\begin{itemize}
\item type: setup command.
\item function: set up names for semaphore files, which are used to mark the
        start and end of program execution.
\item sequence: must precede \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&semaphores
        STRING started = ``%s.started'';
        STRING done    = ``%s.done'';
        STRING failed  = ``%s.failed'';
&end
\end{verbatim}

\begin{itemize}
\item {\tt started} --- Gives the (incomplete) filename of a file to create when a valid
        {\tt run\_setup} command is given.
\item {\tt done} --- Gives the (incomplete) filename of a file to create when the program
        exits without error.  If the file exists, it is deleted when a valid {\tt run\_setup}
        command is given.
\item {\tt failed} --- Gives the (incomplete) filename of a file to create when the program
        exits with an error.  If the file exists, it is deleted when a valid {\tt run\_setup}
        command is given.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|set_reference_particle_output|}\end{center}
%\end{latexonly}
\subsection{set\_reference\_particle\_output \label{subsec:setreferenceparticleoutput}}

\begin{itemize}
\item type: setup command.
\item function: Allows defining a reference set of particle coordinates
  to which tracked coordinates will be compared for purposes of optimization.
\item sequence: must follow \verb|optimization_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item Usage notes: The purpose of this command is to allow optimization of a transport system to produce the same
  particle distribution as was obtained by tracking through some other system. For example, one might track a 
  collection of particles through a \verb|CWIGGLER| or \verb|BGGEXP| element, then attempt to match the output 
  particles with a different element or set of elements that offer faster tracking.
  In this case, the optimization run must use the same input distribution as the run that is being matched.
\end{itemize}

\begin{verbatim}
&set_reference_particle_output
          STRING match_to = NULL;
          double weight[6] = {1, 1, 1, 1, 0, 1};
          STRING comparison_mode = NULL;
&end

\end{verbatim}

\begin{itemize}
\item \verb|match_to| --- Name of an SDDS file from which a particle distribution will be read. The coordinates
  of this distribution will be compared to those from tracking to compute a contribution to the optimization
  penalty function.
\item \verb|weight| --- Weight to be assigned to each plane. By default, path-length coordinates are not compared.
\item \verb|comparison_mode| --- May be one of ``max-ad'', ``sum-ad'', and ``sum-sqr'', corresponding to
  maximum absolute deviation, sum of absolute deviations, and sum of squared deviations.
  The default is maximum absolute deviation.
\end{itemize}


%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|slice_analysis|}\end{center}
%\end{latexonly}
\subsection{slice\_analysis \label{subsec:sliceanalysis}}

\begin{itemize}
\item type: setup command.
\item function: set parameters for slice analysis of the beam along a
	beamline.  Also, results in placing the final slice analysis
        (at the end of the beamline) in symbols for use in optimization
        equations.  The names of the symbols are the same as the names
        of the columns in the output file.
\item sequence: must follow \verb|run_setup| and precede beam definition (\verb|bunched_beam| or \verb|sdds_beam|).
\item N.B.: slice analysis uses an approximate computation of the normalized emittance, regardless of the
  setting of the \verb|exact_normalized_emittance| flag in the \verb|global_settings| command.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&slice_analysis
STRING output = NULL;
long n_slices = 0;
double s_start = 0;
double s_end = 1e300;
long final_values_only = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|output| --- The (incomplete) filename of the output file.
	Recommended value is ``\%s.slan''.
\item \verb|n_slices| --- Number of slices to use.
\item \verb|s_start|, \verb|s_end| --- Position in beamline at which to start
        and stop performing slice analysis.
\item \verb|final_values_only| --- If nonzero, then slice quantities are computed
        only at the end of the beamline.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|subprocess|}\end{center}
%\end{latexonly}
\subsection{subprocess \label{subsec:subprocess}}

\begin{itemize}
\item type: action command.
\item function: execute a system command in a shell.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&subprocess 
    STRING command = NULL;
&end
\end{verbatim}

\begin{itemize}
\item \verb|command| --- The text of the command to execute.  The command may
use the sequence ``\%s'' for substitution of the rootname as set by \verb|run_setup|.
A literal ``\%s'' must be entered as ``\%\%s''.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|steering_element|}\end{center}
%\end{latexonly}
\subsection{steering\_element \label{subsec:steeringelement}}

\begin{itemize}
\item type: setup command.
\item function: setup for use of a given parameter of a given element as a steering corrector.
\item sequence: must precede \verb|correct|.
\item N.B.: any use of this command disables the built-in definition of HKICK, VKICK, and HVKICK elements
  as steering elements.
  %For trajectory correction, this facility works without any additional effort by the user.
  %However, it will not work for orbit correction unless the user also sets \verb|use_response_from_computed_orbits=1| in
  %\verb|&correct|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&steering_element
    STRING name = NULL;
    STRING element_type = NULL;
    STRING item = NULL;
    STRING plane = "h";
    double tweek = 1e-3;
    double limit = 0;
    long start_occurence = 0;
    long end_occurence = 0;
    long occurence_step = 1;
    double s_start = -1;
    double s_end = -1;
    STRING after = NULL;
    STRING before = NULL;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- Optional: the (possibly wild-carded) name of the element to add to the steering list.
        If not given, then \verb|element_type| must be given.
\item \verb|element_type| --- Optional: the (possibly wild-carded) name of the element type to add to the
        steering list.  If not given, then \verb|name| must be given.
\item \verb|item| --- The parameter of the element to be varied.
\item \verb|plane| --- May be either ``h'' or ``v'', for horizontal or vertical correction.
\item \verb|tweek| --- The amount by which to change the item to compute the steering strength.
\item \verb|limit| --- The maximum allowed absolute value of the item.
\item \verb|start_occurence|, \verb|end_occurence| --- If nonzero, these give the starting and
 ending occurence numbers of elements that will be included. N.B.: if wildcards are used, occurence
 number counting is for each set of identically-named elements separately, rather than for the sequence
 of matched elements.
\item \verb|s_start|, \verb|s_end| --- If non-negative, these give the gaving and ending position
 limits for the end-of-element locations of elements to be included.
\item \verb|after| --- The name of an element.  If given, only elements
 that follow the named element in the beamline are included.  
\item \verb|before| --- The name of an element. If given, only elements
 that precede the named element in the beamline are included.  
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|touschek_scatter|}\end{center}
%\end{latexonly}
\subsection{touschek\_scatter \label{subsec:touschekscatter}}
\begin{itemize}
\item type: setup/action command.
\item function: Simulate Touschek scattering process at each \verb|TSCATTER| element 
   based on Monte Carlo method. The local scattering rate is
   calculated by using Piwinski's formula and from the Monte Carlo
   simulation. Scattered particles can be tracked through the entire
   beamline (one pass only), and beam loss information is recorded.
\item sequence: must follow \verb|run_setup| and \verb|twiss_output|.
\item can use parallel resources (\verb|Pelegant|)
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item notes: 
	\begin{itemize} 
      \item A momentum aperture file is required previous using this command. It
      should contain momentum aperture at least at each \verb|TSCATTER| element and can be
      obtained by running \verb|momentum_aperture| command. 
      \item The simulation can be done for a Gaussian distributed beam or an arbitrary 
      particle distribution given by histogram file(s) (See \verb|MHISTOGRAM|).  
      \item When using histogram file as input, it should contain data at least at each 
      \verb|TSCATTER| element. This can be done by inserting a \verb|MHISTOGRAM| element 
      following each \verb|TSCATTER| element. With \verb|lumped=1| option, a multi page 
      SDDS file will be output automatically or you can combine individual output file 
      into a multi page SDDS file before using this command.
      \item The input particle distribution can be given in 3 ways: 2D(x-x')+2D(y-y')+2D(dt-dp);
      or 4D(x-x'-y-y')+2D(dt-dp); or 6D(x-x'-y-y'-dt-dp); base on user's choice. We recommend
      to use lower ``order'' histogram table if the original particle number which used to generate
      these table is not large enough.
      \item The \verb|emit_*|, \verb|emit_dp| and \verb|sigma_s| is always required for running
      the simulation (Used for Piwinski's rate). Use closed value when simulate a non-Gaussian 
      distributed bunch. 
	\end{itemize}
\end{itemize}

\begin{verbatim}
&touschek_scatter
        double charge = 0;
        double frequency = 1;
        double emit_x = 0;
        double emit_nx = 0;
        double emit_y = 0;
        double emit_ny = 0;
        double sigma_dp = 0;
        double sigma_s = 0;
        double distribution_cutoff[3] = {3, 3, 3};
        double Momentum_Aperture_scale = 0.85;
        STRING Momentum_Aperture = NULL;
        STRING XDist = NULL;
        STRING YDist = NULL;
        STRING ZDist = NULL;
        STRING TranDist = NULL;
        STRING FullDist = NULL;
        STRING bunch = NULL;
        STRING loss = NULL;
        STRING distribution = NULL;
        STRING initial = NULL;
        STRING output = NULL;
        long nbins = 100;
        double sbin_step = 1;
        long n_simulated = 5000000;
        double ignored_portion = 0.01;
        long i_start = 0;
        long i_end = 1;
        long do_track = 0;
        long match_position_only = 0;
        long overwrite_files = 1;
        long verbosity = 0;
&end
\end{verbatim}

\begin{itemize}
   \item \verb|charge| --- Bunch charge in Coulombs. May  not be zero.
   \item \verb|frequency| --- Bunch repetition frequency in Hz. The product of the \verb|charge| and \verb|frequency| gives
     the average current in Amps.
   \item \verb|emit_x|, \verb|emit_y| --- RMS emittance for the x and y planes.  Ignored 
   if RMS normalized emittance is nonzero.
   \item \verb|emit_nx|, \verb|emit_ny| --- RMS normalized emittance for the x and y planes.
   \item \verb|sigma_dp|, \verb|sigma_s| --- Rms fractional momentum spread, $\sigma_\delta$, and rms bunch length.
   \item \verb|distribution_cutoff| --- The number of sigmas to use in each plane for Gaussian beam.
   \item \verb|Momentum_Aperture| --- Input file containing the estimated momentum aperture at each
   \verb|TSCATTER| element. This can be obtained from the \verb|momentum_aperture| command in a separate run.
   (If using the parallel version to obtain the momentum aperture, it will be necessary to use \verb|output_mode=0|
   or else reorganize the data if \verb|output_mode\neq 0|. Also, it will be necessary to use \verb|sddssort| to
   sort the data by the \verb|s| column.)
   \item \verb|Momentum_Aperture_scale| --- This value times the aperture value from \verb|Momentum_Aperture|
   file sets up the limit on $\delta_m$ in the simulation. Only particles that have $\delta>\delta_m$ 
   will be kept for tracking. 
   % Amin, what does this sentence mean??
   And the scattering rate is calculated at this value.
   \item \verb|XDist|, \verb|YDist|, \verb|ZDist| --- Input filename of 2D histogram table of X, Y, and Z plane. 
   X and Y are ignored when \verb|TranDist| or \verb|FullDist| is present. 
   \item \verb|TranDist| --- Input file name of the 4D histogram table of transverse plane. 
   Has to be used together with \verb|ZDist|.
   \item \verb|FullDist| --- Input file name of the 6D histogram table. If present, all other 
   tables are ignored.
   \item \verb|bunch| --- The (incomplete) name of an SDDS file to which the phase-space coordinates of 
   the simulated scattered particles are to be written. Recommended value: ``\%s-\%03ld.bun''. If ``\%03ld''
   or the equivalent is not provided then only the last simulated bunch is kept (one bunch for one \verb|TSCATTER| element).
   \item \verb|loss| --- The (incomplete) name of an SDDS file to which the original and final 
   phase-space coordinates of the lost simulated scattered particles are to be written. 
   Recommended value: ``\%s-\%03ld.los''. Used together with \verb|do_track = 1|.
   \item \verb|distribution| --- The (incomplete) name of an SDDS file to which the one-dimensional
   histogram of simulated scattered particles are to be written. Recommended value: ``\%s-\%03ld.dis'' 
   \item \verb|initial| --- The (incomplete) name of an SDDS file to which the one dimension 
   histogram of simulated particles before scattering are to be written. Recommended value: ``\%s-\%03ld.ini''
   \item \verb|output| --- The (incomplete) name of an SDDS file. The average loss rate (particles per second) over a step size of 
   \verb|sbin_step| at location \verb|s| is written to this file. Recommended value: ``\%s-\%03ld.out'' 
   \item \verb|sbin_step| --- Bin size for loss rate summary output to the \verb|output| file.
   \item \verb|nbins| --- Number of bins used for the \verb|distribution| and \verb|initial| table.
   \item \verb|n_simulated| --- The total number of simulated scattered particles with $\delta>\delta_m$. Choosing too small
   a value will cause unreliable results. Note: use an integer number here. A number such as 5E6 sometimes will cause you trouble.
   \item \verb|ignored_portion| --- Fraction of the total scattering rate ignored in tracking. Using this parameter will greatly 
   increase the tracking speed. 
   % This number should be much less than the total loss rate. 
   % ?? much less than 1 ?
   For example, if
   the total loss rate is 50\% of the total scattering rate, then ignoring for tracking purposes 5\% (0.05) of the scattered particles
   will cause a $\sim$10\% error, but the simulation is greatly sped up.
   \item \verb|i_start|, \verb|i_end| --- The simulation will be done from the \verb|i_start|$^{th}$ to the \verb|i_end|$^{th}$
   \verb|TSCATTER| element along the beamline.    
   \item \verb|do_track| --- If non-zero, scattered
   particles will be tracked from their generation location for \verb|n_passes| (given by \verb|run_control|). 
   If non-zero, the \verb|run_control| command must proceed the \verb |touschek_scatter| command.
   The loss property can be analysed using \verb|output| or \verb|loss|.
   \item \verb|match_position_only| --- If non-zero, then matching of the momentum aperture data to the lattice
     is done using the position data only (\verb|s| column), rather than the element names.  Can be helpful if
     errors appear about files ending prematurely or data not matching.
   \item \verb|overwrite_files| --- If non-zero, then output files will be overwritten.  If set to zero, then
     when output files are found, the corresponding computations are skipped.  This can be used to restart a
     Touschek scattering run, provided the output filenames are index (e.g., of the form ``\%s-\%03ld.los''
     rather than ``\%s.los''.)
\end{itemize}

{\bf Note:} If using \verb|Pelegant| to compute the momentum aperture with \verb|output_mode=1|, it is necessary to first run the script
  \verb|reorganizeMmap| to put the data into the form needed by \verb|touschekLifetime|.

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|transmute_elements|}\end{center}
%\end{latexonly}
\subsection{transmute\_elements \label{subsec:transmuteelements}}

\begin{itemize}
\item type: setup command.
\item function: Changes the type of selected elements, which may be used to
	turn off unneeded diagnostics and speed up tracking when concatenation
	is being used.
\item Must be preceded by \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item notes: 
	\begin{itemize}
	\item Any number of these commands may be given.
	\item The only property of the original element that is preserved is
	the length.  For example, transmuting a SBEN into a CSBEN will not
	have the expected result.
	\end{itemize}
\end{itemize}

\begin{verbatim}
&transmute_elements
	STRING name = NULL,
	STRING type = NULL,
	STRING exclude = NULL,
        STRING new_type = "DRIF",
        long disable = 0;
        long clear = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|name| --- Possibily wild-card containing string specifying the
	elements to which the transmutation specification is to be applied.
\item \verb|type| --- Possibily wild-card containing string specifying the
	element types to which the transmutation specification is to be applied.
\item \verb|exclude| --- Possibily wild-card containing string specifying 
	elements to be excluded from the specified transmutation.  Does not
	affect elements transmuted due to other specifications.
\item \verb|new_type| --- Type into which specified elements will be transmuted.
\item \verb|disable| --- If nonzero, the command is ignored.
\item \verb|clear| --- If nonzero, all prior transmutation specifications are deleted.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|tune_footprint|}\end{center}
%\end{latexonly}
\subsection{tune\_footprint \label{subsec:tunefootprint}}

\begin{itemize}
\item type: action/setup command.  
\item function: compute frequency map from tracking and use it to determine the 
  chromatic and amplitude tune footprints.
\item sequence: must follow \verb|run_control|.
\item can use parallel resources (\verb|Pelegant|)
\item N.B.: the number of turns tracked is set by the \verb|run_control| command.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&tune_footprint
    STRING delta_output = NULL,
    STRING xy_output = NULL,
    double xmin =  -0.02,
    double xmax =  0.02,
    double ymin =  1e-6,
    double ymax =  0.02,
    double x_for_delta = 1e-6,
    double y_for_delta = 1e-6,
    double delta_min = 0,
    double delta_max = 0,
    long ndelta = 21,
    long separate_xy_for_delta =  0;
    long nx = 20,
    long ny = 21,
    long verbosity = 1,
    long quadratic_spacing = 1,
    long compute_diffusion = 1;
    long diffusion_rate_limit = -5,
    long immediate = 0
    long filtered_output = 1;
    long ignore_half_integer = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|delta_output| --- The optional (incomplete) name of an SDDS file to send tune and diffusion rate vs $\delta$ output to.  
 Recommended value: ``\%s.dtf''.  If optimization is done, this file is written only at the end of optimization.
\item \verb|xy_output| --- The optional (incomplete) name of an SDDS file to send tune and diffusion rate vs (x, y) output to.  
 Recommended value: ``\%s.atf''.  If optimization is done, this file is written only at the end of optimization.
\item \verb|xmin|, \verb|xmax| --- Limits of grid of initial x coordinates for tracking.             
\item \verb|ymin|, \verb|ymax| --- Limits of grid of initial y coordinates for tracking.             
 \verb|ymin| should typically be a small, positive value so that there                               
 is some betatron oscillation from which to get the tune.                      
\item \verb|delta_min|, \verb|delta_max| --- Limits of grid of initial $\delta$ coordinates
for tracking.  Not that particles are not centered around the dispersive closed orbit.
\item \verb|ndelta| --- Number of values of $\delta$ coordinate in the grid. If zero, chromatic footprint is not determined.
\item \verb|separate_xy_for_delta| --- If nonzero, tracking for the x and y momentum-dependent tunes will be done 
  separately, so that when x-plane tracking is performed, $y=0$ initially.
  This might be helpful if nonlinear coupling of y motion into the x plane
  causes the x tune to be poorly determined for small x amplitudes.
  Increase the tracking time by a factor of two.
\item \verb|nx| --- Number of values of x coordinate in the grid. If zero, amplitude footprint is not determined.
\item \verb|ny| --- Number of values of y coordinate in the grid. If zero, amplitude footprint is not determined.
\item \verb|verbosity| --- If nonzero, prints possibly useful information while running.
\item \verb|quadratic_spacing| --- If nonzero, points are spaced ``quadratically,'' which actually means that
  their squares are spaced linearly. It is highly recommended to keep this turned on, since otherwise problems determining the
  tune when $x \approx 0$ may result in invalid results.
\item \verb|compute_diffusion| --- If nonzero, diffusion is computed, which requires tracking twice as many turns.
\item \verb|diffusion_rate_limit| --- Value of the diffusion rate $d_r$ above which the particle is considered unstable,
where
\begin{equation}
  d_r = \log_{10} \left(\frac{\Delta\nu_x^2 + \Delta\nu_y^2}{N}\right),
\end{equation}
where $N$ is the number of turns tracked to determine each tune (equal to half of \verb|n_passes|).
\item \verb|immediate| --- If nonzero, the calculations take place immediately. If zero, then two modes are possible
  \begin{itemize}
    \item If you wish to compute parameters on a closed orbit or after other calculations, be sure to set this control to zero
      and ask for an output file with \verb|xy_output| or \verb|delta_output|.
    \item If you want to use this command to create quantities for optimization (see below), be sure to set this control to zero
      and {\em do not} ask for an output file with \verb|xy_output| or \verb|delta_output|.
  \end{itemize}
\item \verb|filtered_output| --- If nonzero, output is only provided for particles inside the stable footprint.
\item \verb|ignore_half_integer| --- If nonzero, half-integer resonances are ignored in determining the tune footprint.
\item \verb|chromaticity_fit_order| --- Order of polynomial fits used to obtain chromaticities.
\end{itemize}

This command makes available the following quantities for optimization. All quantities are limited by 
particle survival, crossing of integer and half-integer resonances,  and the diffusion rate limit.
\begin{itemize}
\item \verb|FP.nuxSpreadChrom|,\verb|FP.nuySpreadChrom| --- Spread in tunes due to chromaticity.
\item \verb|FP.nuxChromMin|, \verb|FP.nuxChromMax|, \verb|FP.nuyChromMin|, \verb|FP.nuyChromMax| --- Minimum and maximum
  values of the x and y tunes from chromatic tune footprint.
\item \verb|FP.deltaLimit| --- Minimum of absolute values of positive and negative $\delta$ limits. 
\item \verb|FP.nuxSpreadAmp|, \verb|FP.nuySpreadAmp| --- Spread in tunes due to amplitude.
\item \verb|FP.nuxAmpMin|, \verb|FP.nuxAmpMax|, \verb|FP.nuyAmpMin|, \verb|FP.nuyAmpMax| --- Minimum and maximum
  values of the x and y tunes from amplitude tune footprint.
\item \verb|FP.xSpread|, \verb|FP.ySpread| --- Spread in x and y values.
\item \verb|FP.xyArea| --- Area of the limited x-y region, comparable to a dynamic acceptance. However, this area is determined from a
fixed grid and is not suitabl to optimization by itself.
\item \verb|FP.diffusionRateMaxChrom|, \verb|FP.diffusionRateMaxAmp| --- Maximum diffusion rates in chromatic and amplitude scans.
\item \verb|FP.chromx1|, \verb|FP.chromy1| --- Linear chromaticities from fits to data.
\end{itemize}
Typically, one strives to minimize \verb|FP.nuxSpreadChrom|,\verb|FP.nuySpreadChrom|, 
\verb|FP.nuxSpreadAmp|, \verb|FP.nuySpreadAmp|, \verb|FP.diffusionRateMaxChrom|, 
and/or \verb|FP.diffusionRateMaxAmp| 
while maximizing \verb|FP.deltaLimit|, \verb|FP.xSpread|, and/or \verb|FP.ySpread|,  and
ensuring that \verb|FP.xyArea|, at minimum, doesn't decrease.
I.e., one wants the maximum stable region for momentum and position deviations with the minimum spread in tunes and minimum diffusion.

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|twiss_analysis|}\end{center}
%\end{latexonly}
\subsection{twiss\_analysis \label{subsec:twissanalysis}}

\begin{itemize}
\item type: setup command.
\item function: analyze Twiss parameters within a user-defined region for purposes of
        optimization.
\item sequence: must precede \verb|twiss_output|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&twiss_analysis
        STRING match_name = NULL;
        STRING start_name = NULL;
        STRING end_name = NULL;
        double s_start = -1;
        double s_end = -1;
        STRING tag = NULL;
        long verbosity = 0;
        long clear = 0;
&end
\end{verbatim}

\begin{itemize}
\item \verb|match_name| --- Optional wildcard string to match to element names for selection
  of elements to inculde in the analysis.
\item \verb|start_name| --- Name of the element at which to start analysis.  If the
        element occurs more than once, the first occurrence is used.
\item \verb|end_name| --- Name of the element at which to end analysis.  If the
        element occurs more than once, the first occurrence is used.
\item \verb|s_start| --- Position (in meters) at which to start analysis.
\item \verb|s_end| --- Position (in meters) at which to end analysis.
\item \verb|tag| --- Name prefix for quantities computed by the analysis.  The quantity
        names will have the form {\em tag}.{\em statistic}.{\em quantity}, where {\em statistic}
        is one of \verb|min|, \verb|max|, and \verb|ave|, and {\em quantity} is one of
        \verb|betax|, \verb|betay|, \verb|etax|, \verb|etay|, \verb|alphax|, \verb|alphay|, 
        \verb|etaxp|, and \verb|etayp|. E.g., if {\em tag} is \verb|region1|,
        then one could use expressions like \verb|region1.max.betax| in optimization.
\item \verb|clear| --- If nonzero, all previously defined analysis regions are deleted.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|twiss_output|}\end{center}
%\end{latexonly}
\subsection{twiss\_output \label{subsec:twissoutput}}

\begin{itemize}
\item type: action/setup command.
\item function: compute and output uncoupled Twiss parameters, or set up to do so.
\item sequence: must follow \verb|run_setup|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item N.B.: the output of this command is strictly correct only when the beamline has vanishingly small x-y coupling.
  For rings, use of \verb|coupled_twiss_output| is an option when that requirement is not sufficiently well satisfied.
\end{itemize}

\begin{verbatim}
&twiss_output
    STRING filename = NULL;
    long matched = 1;
    long output_at_each_step = 0;
    long output_before_tune_correction = 0;
    long final_values_only = 0;
    long statistics = 0;
    long radiation_integrals = 0;
    long concat_order = 3;
    long higher_order_chromaticity = 0;
    long higher_order_chromaticity_points = 5;
    double higher_order_chromaticity_range = 4e-4;
    double chromatic_tune_spread_half_range = 0;
    long quick_higher_order_chromaticity = 0;
    double beta_x = 1;
    double alpha_x = 0;
    double eta_x = 0;
    double etap_x = 0;
    double beta_y = 1;
    double alpha_y = 0;
    double eta_y = 0;
    double etap_y = 0;
    STRING reference_file = NULL;
    STRING reference_element = NULL;
    long reference_element_occurrence = 0;
    long reflect_reference_values = 0;
    long cavities_are_drifts_if_matched = 1;
    long compute_driving_terms = 0;
    long leading_order_driving_terms_only = 0;
    STRING s_dependent_driving_terms_file = NULL;
    long local_dispersion = 1;
&end
\end{verbatim}

\begin{itemize}
\item \verb|filename| --- The (incomplete) name of an SDDS file to which the Twiss parameters will be written.
 Recommended value: ``\%s.twi''.
\item \verb|matched| --- A flag indicating, if set, that the periodic or matched Twiss parameters should be found.
  If zero, calculations are performed in transport line mode starting from the given initial values of \verb|betax|, \verb|alphax|,
  etc. 
  As a special case, if \verb|matched=-1| the solution is for a half periodic cell, with mirror symmetry; this will probably
  cause problems for higher-order calculations.

  N.B.: This may give different values for the chromaticity even if the initial values are identical to those for a periodic solution.
  The reason has to do with different assumptions about the initial conditions for particles in a transport line vs a ring.
\item \verb|output_at_each_step| --- A flag indicating, if set, that output is desired at each step of the simulation.
  If you wish to compute Twiss parameters on a closed orbit or after other calculations, be sure to set this control to a nonzero value.
\item \verb|output_before_tune_correction| --- A flag indicating, if set, that output is desired both before and after
tune correction.
\item \verb|final_values_only| --- A flag indicating, if set, that only the final values of the Twiss parameters should
be output, and not the parameters as a function of s.
\item \verb|statistics| --- A flag indicating, if set, that minimum, maximum, and average values of
Twiss parameters should be computed and included in output.
\item \verb|radiation_integrals| --- A flag indicating, if set, that radiation integrals should be computed
and included in output. {\em N.B.: Radiation integral computation is not correct for systems with vertical
bending, nor does it take into account coupling.  See the \verb|moments_output| command if you need such
computations.}
\item \verb|beta_X|, \verb|alpha_X|, \verb|eta_X|, \verb|etap_X| --- If \verb|matched| is zero, the initial values for
the X plane.

\item \verb|concat_order| --- Order of matrix concatenation to use for
determining matrix for computation of Twiss parameters.  Using a lower
order will result in inaccuracy for nonlinear lattices with orbits
and/or momentum errors.  However, for on-momentum conditions with zero
orbit, it is much faster to use \verb|concat_order=1|.

\item \verb|higher_order_chromaticity| --- If nonzero, requests
computation of the second- and third-order chromaticity.  To obtain
reliable values, the user should use \verb|concat_order=3| in this
namelist and the highest available order for all beamline elements.
{\tt elegant} computes the higher-order chromaticity by finding the
trace of off-momentum matrices obtained by concantenation of the
matrix for \verb|higher_order_chromaticity_points| values of $\delta$
over the full range \verb|higher_order_chromaticity_range|.
If \verb|quick_higher_order_chromaticity| is nonzero, then a quicker concatenation method is
used that gives the second-order chromaticity only.

\item \verb|chromatic_tune_spread_half_range| --- Half range of $\delta$ for which the
        chromatic tune spread is computed.  The results are available in for optimization  and
        in the twiss output file under the names \verb|nuxChromUpper|, \verb|nuxChromLower|, 
        and similarly for the y plane.  This computation uses the chromaticities.

\item \verb|reference_file| --- If given, the name of a file from which twiss parameter data will
        be taken to give the starting values.  Ignored if \verb|matched| is nonzero.  The file
        should have the beta and alpha functions with the same names as the file created by
        this command.
\item \verb|reference_element| --- Element in \verb|reference_file| at which to take the
        twiss parameter values.  If not given, the values at the last element in \verb|reference_file|
        are used.
\item \verb|reference_element_occurrence| --- Ignored if \verb|reference_element| is not given.
        Otherwise, the occurence number of \verb|reference_element| to use.  If 0, the last
        occurence is used.
\item \verb|reflect_reference_values| --- If nonzero, reference values of $\alpha_{x,y}$ and $\eta^\prime_{x,y}$ are
  multiplied by -1.  This permits matching backwards from the reference point.
\item \verb|cavities_are_drifts_if_matched| --- By default,  if \verb|matched=1|, {\tt elegant} treats rf cavities
  as drift spaces, allowing the user to have a cavity in the ring definition without it affecting the lattice functions.
  By setting \verb|cavities_are_drifts_if_matched=0|, one can force {\tt elegant} to use the actual matrix for the
  rf cavity.  The differences between the 
  results are generally small, but the default behavior disagrees with the results of \verb|moments_output|.
  This feature is not available for cavities that change the beam energy (\verb|CHANGE_P0=1| in element definition 
  or \verb|always_change_p0=1| on \verb|run_setup|).
\item \verb|compute_driving_terms| --- If nonzero, then resonance driving terms \cite{Bengtsson, WangCXDrivingTerms, Bengtsson-SSC232} and
 tune shifts with amplitude are computed by summing over dipole, quadrupole, sextupole, and octupole elements.  For dipoles, only the effects of gradients and
 sextupole terms are included; curvature effects are not present in the theory.   In addition, these quantities may be optimized 
 by using those names in optimization terms (see list below).
\item \verb|leading_order_driving_terms_only| --- If nonzero, only the leading order driving terms are computed. I.e., terms involving double sums
  over sextupole and quadrupole strengths are not computed. However, leading-order octupole terms are computed, even though they affect the same
  terms as the second-order sextupole and quadrupole terms. This option is provided because computing the higher-order terms is time-consuming and
  not always worthwhile.
\item \verb|s_dependent_driving_terms_file| --- The (incomplete) name of a SDDS file to which magnitude, real and imaginary parts of s-dependent driving terms will be written.
If you wish to compute s-dependent driving terms, be sure to set this parameter.
The following first order resonant driving terms are implemented as defined in \cite{sRDT}: {\tt f10010}, {\tt f10100}, 
{\tt f30000}, {\tt f12000}, {\tt f10200}, {\tt f01200}, {\tt f01110}, 
{\tt f00300}, {\tt f00120}, {\tt f20100}, {\tt f20010} and {\tt f11010}.
Please note that the notation and meaning of the driving terms differs from those computed when \verb|compute_driving_terms=1|!
\item \verb|local_dispersion| ---  Normally, {\tt elegant} will ignore acceleration in computing the
  dispersion.  That is, the dispersion would be the ``local'' dispersion $\frac{\partial x}{\partial \delta}$, where $\delta$
  was the local fractional momentum deviation.  In a linear system, the local dispersion is related to the
  beam moments by $\eta_x = \langle x \delta \rangle/\langle \delta^2 \rangle$.
  In a linac or other systems with rf elements, one might also be interested 
  in the ``global'' dispersion
  $\frac{\partial x}{\partial \delta_0}$, where $\delta_0$ is the energy deviation at the beginning of the system.
  In this case, set \verb|local_dispersion=0|.  Alternatively, one may look at the $R_{i6}$ elements of the matrix from 
  \verb|matrix_output|.
\end{itemize}

The output file from this command contains the following columns, giving values of quantities at the
exit of each element, unless otherwise noted.
\begin{itemize}
\item {\tt s} --- The arc length.
\item {\tt ElementName} --- The name of the element.
\item {\tt ElementType} --- The type name of the element.
\item {\tt betax} and {\tt betay} --- The horizontal and vertical beta functions.
\item {\tt alphax} and {\tt alphay} --- The horizontal and vertical alpha functions, where $\alpha = -\frac{d \beta}{2 ds}$.
\item {\tt psix} and {\tt psiy} --- The horizontal and vertical betatron phase advance in radians.
\item {\tt etax} and {\tt etay} --- The horizontal and vertical dispersion functions.
\item {\tt etaxp} and {\tt etayp} --- The slopes of the horizontal and vertical dispersion functions.
\item {\tt xAperture} and {\tt yAperture} --- The horizontal and vertical apertures.  If undefined, will have a 
 value of 10m.  If the beam trajectory is non-zero, then the aperture will be changed (usually reduced) accordingly.  Hence, these
 are best understood as the {\tt effective} apertures.  They are used in determining the horizontal and vertical acceptance
 parameters, {\tt Ax} and {\tt Ay}.
\item {\tt pCentral0} --- The central momentum ($\beta\gamma$) at the {\bf entrance} to the element.
\item {\tt dI}{\em n} --- Contribution to radiation integral {\tt I}{\em n}.  Radiation integrals take account of
  horizontal bending only.
\end{itemize}

The output file contains the following parameters.  Note that chromatic quantities depend on the order 
settings of the individual elements, the default order (in \verb|run_setup|), and the concatenation order
given in the \verb|twiss_output| command.  These quantities pertain to the end of the lattice or to the
lattice as a whole.
\begin{itemize}
\item {\tt nux} and {\tt nuy} --- The horizontal and vertical tunes.
\item {\tt dnux/dp} and {\tt dnuy/dp} --- The horizontal and vertical chromaticities, defined as $d\nu/d\delta$.
\item {\tt dnux/dp2} and {\tt dnuy/dp2} --- The horizontal and vertical 2nd-order chromaticities, 
  defined as $d^2\nu/d\delta^2$.  Will be zero if \verb|higher_order_chromaticity| is zero.
\item {\tt dnux/dp3} and {\tt dnuy/dp3} --- The horizontal and vertical 3rd-order chromaticities, 
  defined as $d^3\nu/d\delta^3$.  Will be zero if \verb|higher_order_chromaticity| is zero.
\item {\tt dbetax/dp} and {\tt dbetay/dp} --- Chromatic derivatives of the horizontal and vertical beta functions,
defined as $\frac{d\beta}{d\delta}$.
\item {\tt dalphax/dp} and {\tt dalphay/dp} --- Chromatic derivatives of the horizontal and vertical alpha functions,
defined as $\frac{d\alpha}{d\delta}$.
\item {\tt etax2}, {\tt etax3}, {\tt etay2}, {\tt etay3} --- Higher order dispersion in the horizontal and
  vertical planes.  For example, for the horizontal plane, the closed orbit at the end of the lattice 
  depends on $\delta$ according to
  $x = \eta_x\delta + \eta_{x2} \delta^2 + \eta_{x3}\delta^3$.  This differs from the chromaticity expansion,
  which is given in terms of successive derivatives of $\nu(\delta)$.
\item {\tt dnux/dAx}, {\tt dnux/dAy}, {\tt dnuy/dAx}, {\tt dnuy/dAy} --- Tune shifts with amplitude, where amplitude
  is defined as $A_q = (1 + \alpha_q) q^2/\beta_q$, with $q=x$ or $q=y$.  These will
  be zero unless the \verb|tune_shift_with_amplitude| command is given.
\item {\tt h11001}, {\tt h00111}, {\tt h20001}, {\tt h00201}, {\tt h10002}, {\tt h21000}, {\tt h30000}, {\tt h10110}, {\tt h10020},
{\tt h10200}, {\tt h22000}, {\tt h11110}, {\tt h00220}, {\tt h31000}, {\tt h40000}, {\tt h20110}, {\tt h11200}, {\tt h20020},
{\tt h20200}, {\tt h00310}, {\tt h00400}--- Resonance driving terms\cite{Bengtsson}.  These will be
 zero unless \verb|compute_driving_terms| is nonzero.  See table \ref{tab:drivingTerms} for an explanation of each term.
\item {\tt dnux/dJx}, {\tt dnux/dJy},  and {\tt dnuy/dJy} --- Tune shifts with amplitude from Bengtsson's theory \cite{Bengtsson}.
  Note that $J_q = \frac{A_q}{2}$, where $q$ is $x$ or $y$.
 See documentation for \verb|tune_shift_with_amplitude| for discussion and comparison with {\tt dnux/dAx} etc.
 These will be zero unless \verb|compute_driving_terms| is nonzero.
\item {\tt Ax} and {\tt Ay} --- The horizontal and vertical acceptance.  These will be zero if no apertures are
  defined.
\item {\tt alphac}, {\tt alphac2} --- First- and second-order momentum compaction.  The path length is 
  $s = s_o + \alpha_c L \delta + \alpha_{c2} L \delta^2$.
\item {\tt couplingIntegral}, {\tt couplingDelta}, and {\tt emittanceRatio} --- These quantities are defined
  in section 3.1.4.4 of \cite{HAPE}.  The computations include tilted quadrupoles, vertical orbit in sextupoles,
  vertical sextupole displacement, and solenoids.  Note that the emittance ratio {\em does not} include 
  the effect of vertical dispersion.
\item {\tt I}{\em n} --- The $n^{\rm th}$ radiation integral.
\item {\tt taux}, {\tt tauy}, {\tt taudelta} --- Radiation damping times for x, y, and $\delta$.
\item {\tt Jx}, {\tt Jy}, {\tt Jdelta} --- Damping partition factors for  x, y, and $\delta$.
\item {\tt ex0}, {\tt enx0} --- Horizontal equilibrium geometric and normalized emittances.
\item {\tt Sdelta0} --- Equilibrium fractional rms energy spread.
\item {\tt U0} --- Energy loss per turn.
\end{itemize}

N.B.: the higher-order dispersion and higher-order chromaticity are
computed using the concatenated third-order matrix.  However, {\tt
elegant} only has third-order matrices for three elements:
alpha magnets, quadrupoles, and sextupoles.  This may be acceptable if
any dipoles (for example) have large bending radius.  Users who are
concerned about these effects should perform off-energy tracking using
canonical elements (i.e., CSBEND, KQUAD, KSEXT, and MULT), which
include energy dependence to all orders.

Also, note that by default all elements are computed to second order
only.  You must change the \verb|default\_order| parameter on
\verb|run\_setup| to \verb|3| in order to use the third-order matrices
for alpha magnets, quadrupoles, and sextupoles.  You may also use the
{\tt ORDER} parameter on individual element definitions.

\begin{table}[htb]\caption{Meaning of the various driving terms\cite{Bengtsson}.}
\begin{center}
\begin{tabular}{|c|c|}\hline
Term Name & Explanation \\  \hline \hline
h11001 & drives x chromaticity \\ \hline
h00111 & drives y chromaticity \\ \hline
h20001 & drives synchro-betatron resonances \\ \hline
h00201 & drives momentum-dependence of beta functions \\ \hline
h10002 & drives second order dispersion \\ \hline
h21000 & drives $\nu_x$ \\ \hline
h30000 & drives $3 \nu_x$ \\ \hline
h10110 & drives $\nu_x$ \\ \hline
h10020 & drives $\nu_x - 2 \nu_y$ \\ \hline
h10200 & drives $\nu_x + 2 \nu_y$ \\ \hline
h22000 & drives $d\nu_x/dJ_x$\\ \hline
h11110 & drives $d\nu_x/dJ_y$ \\ \hline
h00220 & drives $d\nu_y/dJ_y$ \\ \hline
h31000 & drives $2 \nu_x$ \\ \hline
h40000 & drives $4 \nu_x$ \\ \hline
h20110 & drives $2 \nu_x$ \\ \hline
h11200 & drives $2 \nu_y$ \\ \hline
h20020 & drives $2 \nu_x - 2 \nu_y$ \\ \hline
h20200 & drives $2 \nu_x + 2 \nu_y$ \\ \hline
h00310 & drives $2 \nu_y$ \\ \hline
h00400 & drives $4 \nu_y$ \\ \hline
\end{tabular}
\end{center}
\label{tab:drivingTerms}
\end{table}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|track|}\end{center}
%\end{latexonly}
\subsection{track \label{subsec:track}}

\begin{itemize}
\item type: major action command.
\item function: track particles.
\item sequence: must follow \verb|run_setup|, \verb|run_control|, and beam definition with \verb|bunched_beam| or \verb|sdds_beam|.
\item can use parallel resources (\verb|Pelegant|)
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&track
    long center_on_orbit = 0;
    long center_momentum_also = 1;
    long offset_by_orbit = 0;
    long offset_momentum_also = 1;
    long soft_failure = 1;
    long stop_tracking_particle_limit = -1;
    long check_beam_structure = 0;
    STRING interrupt_file = "%s.interrupt";
&end
\end{verbatim}

\begin{itemize}
\item \verb|center_on_orbit| --- A flag indicating whether to center
the beam transverse coordinates on the closed orbit before tracking.
\item \verb|center_momentum_also| --- A flag indicating whether to
center the momentum coordinate also.
\item \verb|offset_by_orbit| --- A flag indicating whether to offset
the transverse beam coordinates by the closed orbit before tracking.
Similar to \verb|center_on_orbit|, but the initial centroids of the
beam are preserved.  The beam is simply displaced by the closed orbit
rather than being centered on it.
\item \verb|offset_momentum_also| --- A flag indicating whether to also
offset the beam momentum to the momentum of the closed orbit.  If the
\verb|start_from_centroid| or \verb|start_from_dp_centroid| parameters are 
used on the \verb|closed_orbit| command, this flag should be set to
0; otherwise, one will offset the beam central momentum by its own value.
\item \verb|soft_failure| --- If there is an error during tracking (e.g.,
a failure of orbit correction), continue to produce file output.  This
creates essentially empty slots in the files corresponding to the failed
steps.
\item \verb|stop_tracking_particle_limit| --- If a non-negative is given, then
{\tt elegant} will stop tracking when the number of particles falls below the
given value.  It will be as if all the particles were lost.
\item \verb|check_beam_structure| --- For debugging use only.
\item \verb|interrupt_file| --- Gives the (possibly incomplete) name of a file to monitor
  as a semaphore to interrupt the tracking. If the file is created or updated during tracking, 
  then tracking will terminate on completion of the next pass.
  Output already written to \verb|WATCH| files is preserved, but unwritten data
  (e.g., buffered, but not written to disk) is lost.
\end{itemize}

There are also several deprecated parameters:
\begin{itemize}
\item \verb|use_linear_chromatic_matrix| --- For each particle, a first-order
matrix is computed for the particular momentum offset 
of the particle using the linear chromaticity and linear dependence of 
the beta functions on momentum. Use \verb|ILMATRIX| elements instead.
\item \verb|longitudinal_ring_only| --- Tracks longitudinal coordinates only
for a ring.  Use \verb|ILMATRIX| elements instead.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|tune_shift_with_amplitude|}\end{center}
%\end{latexonly}
\subsection{tune\_shift\_with\_amplitude \label{subsec:tuneshiftwithamplitude}}

\begin{itemize}
\item N.B.: this command is deprecated, because it is too difficult to tune it to get
  reliable answers. The use of driving term computation in \verb|twiss_output| is recommended instead, even though it 
  doesn't include all possibly relevant effects. For tune-spread calculations, the \verb|tune_footprint| command provides
  more versatility.
\item type: setup command.
\item function: prepare for computation of tune shifts with amplitude.
\item sequence: must follow \verb|twiss_output|.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\item methods: 
\begin{itemize}
 \item[Method 1]: tune shifts with amplitude are computed via tracking a series of
  particles at different amplitudes or by a matrix method.  NAFF is used to 
  determine the tunes from the tracking data.  It is the user's responsbility to optimize the
  parameters to ensure that results are reasonable.  
 \item[Method 2]: tune shifts are computed using a concatenated multi-turn third-order matrix.
 This appears to be reliable for many cases we've tested.
 \item[Method 3]: tune shifts can be computed quickly using Bengtsson's formulae \cite{Bengtsson} by
 setting \verb|compute_driving_terms=1| in \verb|twiss_output|.  For cases where all methods are
 valid, the results will be larger by a factor of 2 than the results obtained with this command, 
 since $J_q = \frac{A_q}{2}$, where $q$ is $x$ or $y$.
 Note that the present command has more general validity because it includes dipole curvature effects.
\end{itemize}

The quantities computed are $\frac{\partial}{\partial A_x^n \partial A_y^m}\nu_p$, where $n\geq 0$ and $m \geq 0$ are
integers and $p$ is $x$ or $y$.  $A_q = (1 + \alpha_q) q^2/\beta_q$, with $q=x$ or $q=y$.

\end{itemize}

\begin{verbatim}
&tune_shift_with_amplitude
    long turns = 2048;
    double x0 = 1e-6;
    double y0 = 1e-6;
    double x1 = 3e-4;
    double y1 = 3e-4;
    long grid_size = 6;
    long lines_only = 0;
    long spread_only = 0;
    double nux_roi_width = 0.02;
    double nuy_roi_width = 0.02;
    double scale_down_factor = 2;
    double scale_up_factor = 1.05;
    double scale_down_limit = 0.01;
    double scale_up_limit = 1e-4;
    long scaling_iterations = 10;
    long use_concatenation = 0;
    long verbose = 0;
    long order = 2;
    STRING tune_output = NULL;
&end
\end{verbatim}

\begin{itemize}
\item \verb|turns| --- The number of turns to track.  If zero, then the concatenated matrix
        is used instead of tracking, and all other parameters of this command are irrelevant.  
        The matrix method doesn't work well with all lattices.  The order
        of the concatenated matrix is given by the \verb|concat_order| control in 
        \verb|twiss_output|.
\item \verb|x0|, \verb|y0| --- The initial x and y amplitudes to use for determining the
        small-amplitude tunes.
\item \verb|x1|, \verb|y1| --- The initial x and y amplitudes to user for determining the
        tune shifts.  These values should be small enough to ensure linearity in the tune
        shift.  
\item \verb|grid_size| --- Size of the grid of points in x and y.  
\item \verb|lines_only| --- If nonzero, then instead of a full set of \verb|grid_size|$^2$
  particles, only two lines of particles with $x=0$ and/or $y=0$ are tracked.  In this
  case, no $A_x^i*A_y^j$ terms are computed (except for $i=0$ or $j=0$).  However, in addition
  to being faster, the results may be more reliable, e.g., $\partial \nu_x/\partial A_y = 
  \partial \nu_y/\partial A_x$ may be more closely satisfied.
\item \verb|sparse_grid| --- Deprecated. If nonzero, then instead of a full set of \verb|grid_size|$^2$
        particles, a sparse grid of particles is tracked.  Will save time at the expense of
        inaccurate higher-order terms. Not recommended.
\item \verb|spread_only| --- Compute the tune spread only and don't bother with the
        tune shift coefficients.  These tune spreads can be optimized and appear in the
        twiss output file under the names \verb|nuxTswaLower|, \verb|nuxTswaUpper|, and
        similarly for the y plane.  This is the recommended way to reduce tune shift
        with amplitude, as the tune spread is more reliable than the coefficients of 
        the expansion.  (Particles that get lost are automatically ignored in both
        types of computations.)
\item \verb|nux_roi_width|, \verb|nuy_roi_width| --- Widths of the region of interest for
        x and y tunes.  As the grid is filled in, {\tt elegant} finds the tune for each
        tracked particle on the grid.  Successive tune values are looked for in the
        region of the given width around the previous tune value.  This prevents jumping
        from the main tune peak to another peak, which can happen when the tune spectrum
        has many lines.
\item \verb|scale_down_factor|, \verb|scale_up_factor|, \verb|scale_down_limit|, 
        \verb|scale_up_limit|, \verb|scaling_iterations| --- These control automatic scaling
        of the amplitudes.  If {\tt elegant} sees a tune shift larger than \verb|scale_down_limit|
        it will decrease \verb|x0| (or \verb|y0|) by the factor \verb|scale_down_factor|. 
        If  {\tt elegant} sees a tune shift smaller than \verb|scale_up_limit|
        it will increase \verb|x0| (or \verb|y0|) by the factor \verb|scale_up_factor|. 
        Suggestion: if you find yourself playing with these values and the initial amplitudes
        in order to get reliable TSWA coefficients, try just using the tune spread.
\item \verb|verbose| --- If nonzero, information about the progress of the algorithm is 
        printed to the screen.
\item \verb|use_concatenation| --- If nonzero, then tracks with the concatenated matrix instead
        of element-by-element.  The order
        of the concatenated matrix is given by the \verb|concat_order| control in
        \verb|twiss_output|. The user should experiment with this option to see if the
        results are reliable for a particular lattice.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|vary_element|}\end{center}
%\end{latexonly}
\subsection{vary\_element \label{subsec:varyelement}}

\begin{itemize}
\item type: setup command.
\item function: define an index and/or tie a parameter of an element to it.
\item sequence: must follow \verb|run_control|
\item N.B.: It is not possible to vary an element if the element name starts with one of the following
characters: 
\verb|0|, \verb|1|, \verb|2|, \verb|3|, \verb|4|, \verb|5|, \verb|6|, \verb|7|, \verb|8|,
\verb|9|, \verb|.|, \verb|+|, or \verb|-|.  The reason is that {\tt elegant} will attempt to 
make an SDDS parameter name containing the element name, and these characters are disallowed
at the beginning of such a name.
\item Command syntax, including use of equations and subcommands, is discussed in \ref{sect:generalCommandSyntax}.
\end{itemize}

\begin{verbatim}
&vary_element
    long index_number = 0;
    long index_limit = 0;
    STRING name = NULL;
    STRING item = NULL;
    double initial = 0;
    double final = 0;
    long differential = 0;
    long multiplicative = 0;
    long geometric = 0;
    STRING enumeration_file = NULL;
    STRING enumeration_column = NULL;
&end
\end{verbatim}

\begin{itemize}
\item \verb|index_number| --- A non-negative integer giving the number of the index.
\item \verb|index_limit| --- A positive integer giving the number of values the index will take.
 Must be given if this \verb|index_number| has not been listed in a previous \verb|vary_element|
command, unless \verb|enumeration_file| is given.
\item \verb|name| --- The name of an element.
\item \verb|item| --- The parameter of the element to vary.
\item \verb|initial|, \verb|final| --- The initial and final values of the parameter.
\item \verb|enumeration_file| --- Name of an SDDS file giving values for the item.
\item \verb|enumeration_column| --- Column of the SDDS file giving the values.
\item \verb|differential| --- If nonzero, the initial and final values are taken as
offsets from the predefined value of the parameter.
\item \verb|multiplicative| --- If nonzero, the initial and final values are taken as 
multipliers to be applied to the predefined value of the parameter in order to obtain
the actual initial and final values.
\item \verb|geometric| --- If nonzero, then variation is geometric rather than 
arithmetic.
\end{itemize}

\newpage
\section{Specialized Tools for Use with {\tt elegant}\label{sect:tools}}

A number of specialized programs are available that work with {\tt
elegant}. Most are SDDS-compliant, so they will also work with any
program that reads or writes appropriate SDDS data.  The following is
a brief description of each program.  Full descriptions for many programs are available
on subsequent pages.  Most programs will return a help message if the program name is
given with no arguments, which should be sufficient documentation and may be more
up-to-date than these manual pages.
\begin{itemize}
\item {\tt abrat} --- A program to integrate particles through a 3D magnetic field map. The name 
 stands for Asymmetric Bend RAy trace. This program uses the same method as the \verb|BRAT|
 element in {\tt elegant}.
\item {\tt analyzeMagnets} --- Generates SDDS and latex files giving magnet parameters.
  (Program by M. Borland.)
\item {\tt astra2elegant} --- Converts ASCII particle output from ASTRA \cite{ASTRA} to a binary
  SDDS file suitable for use with {\tt elegant}.  This program is recommended over
  the astra2sdds program on the ASTRA website, because the latter produces ASCII SDDS
  files that are quite slow to read and does not perform the correct computations
  for low-energy beams.
  (Program by M. Borland.)
\item {\tt bremsstrahlungLifetime} --- Computes gas bremsstrahlung lifetime from local momentum acceptance and Twiss parameter output,
  assuming a constant gas pressure.
  (Program by M. Borland.)
\item {\tt bremsstrahlungLifetimeDetailed} --- Computes gas bremsstrahlung lifetime from local momentum acceptance and Twiss 
  parameter output, using a user-supplied, s-dependent gas pressure.
  (Program by M. Borland.)
\item {\tt computeCoherentFraction} --- Computes the coherent fraction for undulator radiation.
\item {\tt computeCBGGE} --- Computes generalized gradients from data on a circular cylinder
  for use with the \verb|BGGEXP| element. 
\item {\tt computeGeneralizedGradients} --- Deprecated.  Use \verb|computeCBGGE|.
\item {\tt computeRBGGE} --- Computes generalized gradients from data on a rectangular boundary 
  for use with the \verb|BGGEXP| element.
\item {\tt computeSCTuneSpread} --- Compute space charge tune spread.
\item {\tt coreEmittance} --- Computes the slice emittance for the beam core (e.g., 80\% of the beam).
  (Program by X. Dong.)
\item {\tt csrImpedance} --- Computes the shielded steady-state CSR impedance for a dipole magnet.
 The output can be used immediately with {\tt elegant}'s \verb|ZLONGIT| element.
 (Program by Y. Wang, H. Shang, and M. Borland.)
 See also the {\tt makeSummedCsrZ} script.
\item {\tt doubleDist6} --- Increases the number of particles in a particle input file by
 successively doubling the number.  Intended to be used to increase the number of particles
 produced by a photoinjector simulation to improve stability of CSR and LSC simulations.
 See also {\tt smoothDist6}.
  (Program by M. Borland.)
\item {\tt elasticScatteringAnalysis} --- Computes elastic gas scattering lifetime and loss distribution from
  multi-location tracking data, Twiss parameter output, and gas pressure distribution. Use with output of the
  \verb|elastic_scattering| command in \verb|Pelegant|.
  (Program by M. Borland.)
\item {\tt elasticScatteringLifetime} --- Computes elastic gas scattering lifetime from single-location 
  dynamic acceptance and Twiss parameter output, assuming a constant gas pressure.
  (Program by M. Borland.)
\item {\tt elasticScatteringLifetimeDetailed} --- Computes elastic gas scattering lifetime from single-location 
  dynamic acceptance and Twiss parameter output, using a user-supplied, s-dependent gas pressure.
  (Program by M. Borland.)
\item {\tt elegant2astra} --- This program translates {\tt elegant} phase space files into ASTRA \cite{ASTRA} format.
  (Program by M. Borland.)
\item {\tt elegant2track} --- This program translates {\tt elegant} phase space files into TRACK \cite{TRACK} format.
  The ASCII version of TRACK is assumed.
  (Program by M. Borland.)
\item {\tt elegant2genesis} --- This program performs
        slice analysis of particle output files, which are suitable for use with
        the SDDS-compliant APS version of GENESIS\cite{GENESIS}.  This program is
        part of the SDDS toolkit.  See the SDDS toolkit
        manual for documentation. (Program by R. Soliday and M. Borland.)
\item {\tt elegantto} --- Translates an {\tt elegant}-style lattice file (or a MAD file, with
        some restrictions) into formats accepted by other programs, such as COSY, PARMELA, 
        PATPET, PATRICIA, TRANSPORT, XORBIT, and MAD8.  Will also generate an SDDS file containing lattice
        data.  (Program by M. Borland.)
\item {\tt generateBunch} --- Generates a gaussian-distributed bunch.
\item {\tt generateBunchTrain} --- Generates a very flexible multi-train bunch file.
\item {\tt haissinski} --- Computes the steady-state longitudinal distribution in
        an electron storage ring.  Requires as input a file containing the Twiss
        parameters around the ring, such as that provided by the \verb|twiss_output| command.
        Wakes can be specified with either a L, R model, a BBR resonator model or a wake function.
        Other inputs are external rf system parameters, with possibility of a harmonic
        cavity. Output is a charge or current profile with longitudinal time coordinate (front
        of bunch is at positive times). 
        (Program by L. Emery and M. Borland.)
\item {\tt ibsEmittance} --- Computes local intra-beam scattering rates for both storage ring
        and linac. Also computes the equlibrium transverse and longitudinal emittances of a 
        beam in an electron storage ring, resulting from the combination of quantum excitation,
        damping, and intra-beam scattering.  Requires as input a file containing the
        Twiss parameters, such as that provided by the \verb|twiss_output| command.
        (Program by L. Emery, M. Borland, and A. Xiao)
\item {\tt impact2elegant} --- Tranlates IMPACT-T \cite{IMPACT} output into {\tt elegant} conventions.
  (Program by M. Borland.)
\item {\tt impact2sdds} --- Translates IMPACT-T output files into SDDS for easier postprocessing.
  (Program by M. Borland.)
\item {\tt ionTrapping} --- Uses lattice function data from {\tt elegant} to compute ion trapping condition in
  a ring. (Program by M. Borland.)
\item {\tt LFBFirSetup} --- This script prepares data that can be used to configure turn-by-turn longitudinal feedback using
  \verb|TFBDRIVER| and \verb|TFBPICKUP| elements.
  (Program by M. Borland.)
\item {\tt longitCalcs} --- Performs calculations of longitudinal dynamics parameters in storage rings,
  using output from \verb|elegant|'s \verb|twiss_output| command. Can also compute voltages for
  bunch lengthening and output these to a file that can be use with \verb|load_parameters|.
  (Program by M. Borland.)
\item {\tt makeSummedCsrZ} --- Computes the shielded or free-space steady-state CSR impedance for a ring
  composed of one or more types of dipole magnet.
 The output can be used immediately with {\tt elegant}'s \verb|ZLONGIT| element.
  (Program by M. Borland.)
\item {\tt plotTwiss} -- Plots the twiss parameters using data from the \verb|twiss_output| command.
  (Program by L. Emery and M. Borland.)
\item {\tt plotTwissBeamsize} -- Plots the beam sizes using data from the \verb|twiss_output| command.
\item {\tt prepareTAPAs} --- Allows processing files from \verb|twiss_output| into a form
  that is accepted by the Android App TAPAs \cite{TAPAs}. The resultant files can be copied to, e.g., 
  the downloads area on the Android device, from which they can be read by TAPAs for configuration of
  the Storage Ring Scaling activity.
  (Program by M. Borland.)
\item {\tt radiationEnvelope} --- A tool for use with the output of {\tt sddsbrightness} and {\tt sddsfluxcurve}.
  It analyzes data for many harmonics and produces a single curve that shows the envelope of maximum
  brightness or flux over all harmonics.
  (Program by M. Borland.)
\item {\tt removeBackDrifts} --- Allows post-processing s-dependent files to remove negative drifts, which
  improves the appearance of plots and is needed for certain types of analysis.
  (Program by M. Borland.)
\item {\tt sddsanalyzebeam} --- Analyzes a beam of macro-particles and produces an SDDS file
        containing beam moments, emittances, equivalent beta functions, etc.  The beam file
        is of the type written by {\tt elegant} using the {\tt output} field of the {\tt run\_setup}
        command, or the WATCH element.  (Program by M. Borland.)
\item {\tt sddsbrightness} --- Uses twiss parameter output or data from {\tt sddsanalyzebeam} to
  compute undulator brightness curves.  (Program by H. Shang, R. Dejus, M. Borland, X. Jiao.)
\item {\tt sddsbs} --- Computes bending magnet spectra.
  (Program by H. Shang and M. Borland.)
\item {\tt sddsbunchingfactor} --- Computes bunching factor vs frequency from phase space data.
  (Program by M. Borland.)
\item {\tt sddsemitproc} --- Analyzes quadrupole scan emittance measurement data.  Accepts a
        file containing the transport matrix for each point and measured beam sizes.  
        The file may, for example, be the file produced
        by the {\tt final} field of the {\tt run\_setup} command.  The quadrupole scan can be
        executed inside of {\tt elegant} using {\tt vary\_elements}. (Program by M. Borland.)
\item {\tt sdds4x4sigmaproc} --- Analyzes quadrupole scan beam moment measurement data to determine
  the initial 4x4 sigma matrix of the beam.  Accepts a
  file containing the transport matrix for each point and measured beam sizes.  
  The file may, for example, be the file produced
  by the {\tt final} field of the {\tt run\_setup} command.  The quadrupole scan can be
  executed inside of {\tt elegant} using {\tt vary\_elements}. (Program by M. Borland.)
\item {\tt sdds5x5sigmaproc} --- Analyzes quadrupole scan beam moment measurement data to determine
  the initial 5x5 sigma matrix of the beam.  Accepts a
  file containing the transport matrix for each point and measured beam sizes.  
  The file may, for example, be the file produced
  by the {\tt final} field of the {\tt run\_setup} command.  The quadrupole scan can be
  executed inside of {\tt elegant} using {\tt vary\_elements}. To work, requires a horizontal bending magnet
  in the beamline and variation quadrupoles before and after the bending magnet. (Program by M. Borland.)
\item {\tt sddsfindresonances} --- Uses output from frequency map analysis to find and identify resonance lines.
 (Program by H. Shang, M. Borland.)
\item {\tt sddsfluxcurve} --- Uses twiss parameter output or data from {\tt sddsanalyzebeam} to
  compute undulator flux tuning curves.  (Program by M. Borland, H. Shang, R. Dejus.)
\item {\tt sddsmatchmoments} --- Transforms a beam of macro-particles to match a given set of 
  6x6 beam moments, where the moments are stored in an output file from \verb|moments_output|.
\item {\tt sddsmatchtwiss} --- Transforms a beam of macro-particles to match to given beta
        functions and dispersion.    The beam file
        is of the type written by {\tt elegant} using the {\tt output} field of the {\tt run\_setup}
        command, or the WATCH element. (Program by M. Borland.)
\item {\tt sddsws} --- Computes wiggler spectra, using code from WS (by R. Dejus).
  (Program by H. Shang.)
\item {\tt sddsurgent} --- Uses algorithms from the programs US (by R. Dejus) and URGENT (by R. Walker) for computation of undulator
  radiation properties, including power density and intensity distributions.  (Program by H. Shang, R. Dejus, M. Borland, X. Jiao.)
\item {\tt sddsrandmult} --- Simulates the effect of random mechanical errors in a quadrupole or sextupole,
  generating multipole error data that can be used with {\tt elegant}'s {\tt KQUAD} and {\tt KSEXT}
  elements. (Program by M. Borland.)
\item {\tt sddssampledist} --- This program allows creating particle
        distributions from user-designed distribution functions.  It is thus a more flexible alternative
        to \verb|bunched_beam|.  This program is part of the SDDS toolkit.  See the SDDS toolkit
        manual for documentation.  (Program by M. Borland and H. Shang.)
\item {\tt smoothDist6s} --- Increases the number of particles in an input particle distribution.  At the same
 time, smooths the distribution and adds optional energy and density modulation.   Intended to be used to increase the number of particles
 produced by a photoinjector simulation to improve stability of CSR and LSC simulations.  Also useful in studying 
 the growth rate for energy and density modulations.  See also {\tt doubleDist6}.
  (Program by M. Borland.)
\item The script \verb|spiffe2elegant| allows converting the output of the PIC code \verb|spiffe| to the same form
  as output by \verb|elegant|.  Note that \verb|elegant| will read \verb|spiffe| output directly. This script just allows converting the
  data for use with related programs, such as \verb|sddsanalyzebeam|.
  (Program by M. Borland.)
\item {\tt TFBFirSetup} --- This script prepares data that can be used to configure turn-by-turn transverse feedback using
  \verb|TFBDRIVER| and \verb|TFBPICKUP| elements.
  (Program by M. Borland.)
\item {\tt touschekLifetime} --- This program calculates Touschek lifetime using A. Piwinski's formula.
        Input files are generated from ``twiss\_output'' and ``momentum\_aperture''.  (Program by A. Xiao and M. Borland.)
\item {\tt track2sdds} --- Translates output files, including phase space files, from version 39 of TRACK (with ASCII output \cite{TRACK})
  into SDDS. 
  (Program by M. Borland.)
\item {\tt track2mag} --- Uses TRACK output files to create a file similar to the magnets outupt file from {\tt elegant}.
  This gives a profile of the beamline that can be plotted with other data.
  (Program by M. Borland.)
\item {\tt trwake2impedance} --- Translates a transverse wake (e.g., used for \verb|TRWAKE|) into an impedance usable with
  \verb|ZTRANSVERSE|. (Script by M. Borland.)
\item {\tt view3dGeometry} --- Uses freewrl viewer to display 3D geometry of a lattice. 
  (Program by A. Petrenko and M. Borland.)
\item {\tt wake2impedance} --- Translates a longitudinal wake (e.g., used for \verb|WAKE|) into an impedance usable with
  \verb|ZLONGIT|. (Script by M. Borland.)
\item The scripts \verb|makeSkewResponseCP| and \verb|correctCoupling| can be used to compute the cross-plane response
  matrices for skew quadrupoles and to perform coupling correction using those matrices.
  (Program by M. Borland.)
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|abrat|}\end{center}
%\end{latexonly}
\subsection{abrat}

\begin{itemize}
\item {\bf description:}  Integrates particle trajectories through an symmetric or asymmetric bending magnet.
The name stands for "Asymmetric Bend RAy Tracing."
Features include the ability to optimize the magnet strength and position to ensure, if possible, that the
magnet joins two user-defined trajectories.
The results of these optimizations can be used in {\tt elegant} with the \verb|BRAT| element.

\item {\bf synopsis:}
\begin{flushleft}{\tt
abrat {\em field-file} [-3dFieldFile] [-interpolateField={\em parameterName},[,order={\em n}][,extrapolate][,permissive]] 
 [{-scan={x | xp | y | yp | delta},lower,upper,number | -beamFiles={\em input},{\em output} }]
 -vertex={\em x-in-meters},{\em z-in-meters} -nominalEntrance={\em x},{\em y} -nominalExit={\em x},{\em y}
 -theta={\em targetInDegrees} -rigidity={\em Tesla-meters}
 [-output=filename] [-fsc={\em value}] [-dxDipole={\em m}] [-dzDipole={\em m}] [-yawDipole={\em value}]
 {[-optimize[=verbose][{fse,dx,dz,yaw}]]
  -fseLimit={\em min},{\em max} -dxLimit={\em min},{\em max} -dzLimit={\em min},{\em max} -yawLimit={\em min},{\em max}}
 [-fieldmapOutput={\em filename},{\em zmin},{\em zmax},{\em nz},{\em xmin},{\em xmax},{\em nx}]
 [-tolerance=integration-tolerance]
 [-quiet]
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\em field-file} --- Field map file. Normally, needs to contain columns \verb|x|, \verb|z|, and \verb|B|, giving the 
field in the midplane. In 3D mode, when the \verb|-3dFieldFile| option is given, then the file should contain
\verb|x|, \verb|y|, \verb|z|, \verb|Bx|, \verb|By|, and \verb|Bz|. 
In all cases, the beam is assumed to move from left ($z<0$) to right ($z>0$) with the field bending counter clockwise.
Positive \verb|x| is away from the center of curvature.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt -3dFieldFile} --- If given, then {\em field-file} is expected to contain a 3D field map. See above for details.
\item {\tt -interpolate} --- If given, then {\em field-file} is expected to contain at least two 2D field maps on separate
  pages of the file.
  These field maps could be, for example, from measurements with different excitation currents, with the excitation current
  for each case being stored in a named parameter; the pages must be arranged so that the parameter values increase monotonically.
  {\t abrat} will then automatically interpolate among the field maps to determine the required excitation current (for example);
  this overrides the \verb|fse| parameter of the \verb|-optimize| option.
  By default, linear interpolation is used (\verb|order=1|).
  By default, the search will not go outside the range of the parameter values in the data; if \verb|extrapolate| is given, however,
  extrapolation outside this range is performed.
  By default, the grid parameters of the several pages must match exactly; if \verb|permissive| is given, however, this requirement
  is not enforced.
\item {\tt -scan} --- If given, then the value of the named accelerator coordinate is scanned to create a bundle of incoming rays. Output is provided for each  ray.
\item {\tt -beamFiles } --- If given, then an {\tt elegant}-style beam is read and the particles therein are tracked through the dipole.
A simular file is created for the output coordinates. Coordinates are defined at the nominal entrance and exit planes. Back-drifts are used to ensure that
integration begins and ends outside the magnetic field region (i.e., all of the defined field is included).
\item {\tt -output} --- If given, particle trajectories are written to the named file.
\item {\tt -fsc} --- If given, the fractional strength change to apply to the field. Typically taken from a previous optimization run.
\item {\tt -dxDipole} --- If given, the x positional change to apply to the field. A positive value moves the field away from the center of curvature.
  Typically taken from a previous optimization run.
\item {\tt -dzDipole} --- If given, the z positional change to apply to the field. A positive value moves the field further from the incoming beam.
Typically taken from a previous optimization run.
\item {\tt -yawDipole} --- If given, the yaw to apply to the field. A positive value rotates the magnet in the direction of bending.
Typically taken from a previous optimization run.
\item {\tt -optimize}, {\tt -fseLimit}, {\tt dxLimit}, {\tt dzLimit}, {\tt yawLimit} --- Invokes optimization of the various strength and alignment
parameters and specifies the allow range of variation.
\item {\tt -fieldMapOutput} --- Requests output of a field map, allowing confirmation of the input data.
\item {\tt -tolerance} --- Integration tolerance.
\item N.B.: The usage message describes additional switches that have had limited testing. Use with caution.
\end{itemize}

\item {\bf authors:} M. Borland (ANL/APS).

\end{itemize}


%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|astra2elegant|}\end{center}
%\end{latexonly}
\subsection{astra2elegant}

\begin{itemize}
\item {\bf description:}   Converts ASCII particle output from ASTRA to a binary
SDDS file suitable for use with {\tt elegant}.  This program is recommended over
the astra2sdds program on the ASTRA website, because the latter produces ASCII SDDS
files that are quite slow to read.

\item {\bf synopsis:}
\begin{flushleft}{\tt
astra2elegant [{\em inputFile}] [{\em outputFile}] [-centerReference] [-pipe=[input][,output]]
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\tt inputFile} --- ASCII particle output file from ASTRA.
\item {\tt outputFile} --- SDDS file containing phase space data. May be used directly with 
{\tt elegant}.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt -centerReference} --- Normally, {\tt astra2elegant} offsets the arrival time of all particles
  by the arrival time of the reference particle.  This behavior can be suppressed by giving the
  {\tt -centerReference} option.  In that case, the arrival time of the reference particle is defined
  as 0.
\item {\tt -pipe[=input][,output]} --- Standard SDDS toolkit pipe option.
\end{itemize}

\item {\bf authors:} M. Borland (ANL/APS).

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|computeCBGGE|}\end{center}
%\end{latexonly}
\subsection{computeCBGGE\label{computeCBGGE}}

\begin{itemize}
\item {\bf description:}  Compute generalized gradients \cite{Venturini-NIMA427-387} from data on a circular-cylinder
boundary for use with {\tt elegant}'s \verb|BGGEXP| element.

\item {\bf synopsis:}
\begin{flushleft}{\tt
computeCBGGE -input=<filename>[,z=<colName>][,phi=<colName>][,Brho=<colName>][,rho=<paramName>]
              -normal=<output> [-skew=<output>]
              [-derivatives=<integer>] [-multipoles=<integer>] [-fundamental=<integer>]
              [-evaluate=<filename>[,nrho=<integer>][,nphi=<integer>]
              [-autotune=[,significance=<fieldValue>][,minimize={rms|mav|maximum}]
                         [,increaseOnly][,verbose][,log=<filename>]]
}\end{flushleft}

\item {\bf switches:}
\begin{itemize}
\item {\tt input} --- Specify name of the input file, which by default contains three columns giving \verb|z|, \verb|phi|, and
  \verb|Brho|, which specify $B_\rho$ as a function of longitudinal coordinate $z$ and azimuthal angle $\phi$.  The \verb|z|,
  \verb|phi|, and \verb|Brho| options may be used to give different names for these columns.  The file by default also
  contains a parameter \verb|rho| giving the radius of the cylinder. The \verb|rho| option may be used to give a
  different name for the parameter.  The data must form a uniform grid in $z$ and $\phi$. The $N_\phi$ values of $\phi$
  should range from $0$ to $\Delta \phi (N_\phi-1)$ where $\Delta \phi = 2\pi/N_\phi$
\item {\tt normal} ---  Output file for normal-component generalized gradients. Supply to \verb|NORMAL_FILENAME|
  parameter of \verb|BGGEXP|.
\item {\tt skew} ---  Output file for skew-component generalized gradients. Supply to \verb|SKEW_FILENAME|
  parameter of \verb|BGGEXP|.
\item {\tt derivatives} --- Number of derivatives vs z desired in output. Default: 7
\item {\tt multipoles} ---  Number of multipoles desired in output. Default: 8
\item {\tt fundamental} --- Fundamental multipole of sequence. 0=none (default), 1=dipole, 2=quadrupole, etc.
\item {\tt evaluate} --- Asks to evaluate the GGE and place the results in a file. By default, this is done
  for the cylinder radius and with the same spacing of $\phi$ values. This can be changed with the \verb|nrho|
  and \verb|nphi| parameters.
\item {\tt autotune} --- Optimizes the number of derivaties and multipoles up the to values given with the
  \verb|-derivatives| and \verb|-multipoles| options, in order to minimize the deviation of the GGE-derived
  fields from the values given in the 3D field map file. The region of evaluation is automatically limited by
  the bounding planes, even if the 3D field map has a larger extent. By default, minimizes the maximum deviation, but user can
  ask to minimize the rms or mean-absolute-value deviation. Differences below the \verb|significance| value are
  ignored. The user may request verbose output to see results printed to the terminal, and also a log file
  for a detailed record.
  The \verb|increaseOnly| qualifier specifies that the scan over multipoles $m$ and derivatives $d$
  is restricted to never be less than the previous optimal values; for example, if the best value
  so far was obtained with $m=4$ and $d=3$, the remainder of the scan would be restricted to $m\ge 4$ and $d\ge 3$;
  this can save considerable run time.
\end{itemize}

\item {\bf authors:} M. Borland, R. Soliday, R. Lindberg, (ANL/APS).
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|computeRBGGE|}\end{center}
%\end{latexonly}
\subsection{computeRBGGE\label{computeRBGGE}}

\begin{itemize}
\item {\bf description:}  Compute generalized gradients \cite{Venturini-NIMA427-387} from data on a rectangular
boundary \cite{Mitchell-2007} for use with {\tt elegant}'s \verb|BGGEXP| element.

\item {\bf synopsis:}
\begin{flushleft}{\tt
computeRBGGE -yminus=<filename> -yplus=<filename> -xminus=<filename> -xplus=<filename>
   -normal=<output> [-skew=<output>] [-derivatives=<number>] [-multipoles=<number>] 
   [-fundamental=<number>] [-evaluate=<filename>]
   [-autotune=<3dMapFile>[,significance=<fieldValue>][,minimize={rms|mav|maximum}]
               [,radiusLimit=<meters>][,increaseOnly][,verbose][,log=<filename>]]
}\end{flushleft}

\item {\bf switches:}
\begin{itemize}
\item {\tt yplus} --- SDDS file containing \verb|x|, \verb|y|, \verb|z|, and \verb|By|, 
  map stored in columns for positive-y plane. If skew components are desired, file must also supply \verb|Bz|.
  Units are meter and Tesla.
\item {\tt yminus} --- SDDS file containing \verb|x|, \verb|y|, \verb|z|, and \verb|By|, 
  map stored in columns for negative-y plane. If skew components are desired, file must also supply \verb|Bz|.
\item {\tt xplus} ---  SDDS file containing \verb|x|, \verb|y|, \verb|z|, and \verb|Bx|, 
  map stored in columns for positive-x plane. If skew components are desired, file must also supply \verb|Bz|.
\item {\tt xminus} ---  SDDS file containing \verb|x|, \verb|y|, \verb|z|, and \verb|Bx|, 
  map stored in columns for negative-x plane. If skew components are desired, file must also supply \verb|Bz|.
\item {\tt normal} ---  Output file for normal-component generalized gradients. Supply to \verb|NORMAL_FILENAME|
  parameter of \verb|BGGEXP|.
\item {\tt skew} ---  Output file for skew-component generalized gradients. Supply to \verb|SKEW_FILENAME|
  parameter of \verb|BGGEXP|.
\item {\tt derivatives} --- Number of derivatives vs z desired in output. Default: 7
\item {\tt multipoles} ---  Number of multipoles desired in output. Default: 8
\item {\tt fundamental} --- Fundamental multipole of sequence. 0=none (default), 1=dipole, 2=quadrupole, etc.
\item {\tt evaluate} --- Asks to evaluate the GGE and place the results in a file. The GGE is evaluted over
  the region bounded by the four planes, using the same coordinate intervals.
\item {\tt autotune} --- Optimizes the number of derivaties and multipoles up the to values given with the
  \verb|-derivatives| and \verb|-multipoles| options, in order to minimize the deviation of the GGE-derived
  fields from the values given in the 3D field map file. The region of evaluation is automatically limited by
  the bounding planes, even if the 3D field map has a larger extent. By default, minimizes the maximum deviation, but user can
  ask to minimize the rms or mean-absolute-value deviation. Differences below the \verb|significance| value are
  ignored. The user may request verbose output to see results printed to the terminal, and also a log file
  for a detailed record.
  The \verb|increaseOnly| qualifier specifies that the scan over multipoles $m$ and derivatives $d$
  is restricted to never be less than the previous optimal values; for example, if the best value
  so far was obtained with $m=4$ and $d=3$, the remainder of the scan would be restricted to $m\ge 4$ and $d\ge 3$;
  this can save considerable run time.
\end{itemize}

\item {\bf authors:} R. Lindberg, R. Soliday, M. Borland (ANL/APS).
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|coreEmittance|}\end{center}
%\end{latexonly}
\subsection{coreEmittance}

\begin{itemize}
\item {\bf description:} Computes the slice emittance for 80\%, 85\%, 90\%, 95\%, and 100\% fractions of the beam.

\item {\bf synopsis:}
\begin{flushleft}{\tt 
coreEmittance -input {\em inputFilename} [-nSlices {\em numberOfSlices}] [-pngRoot <string>] [-pngThickness <integer>(2)]
}
\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item The input file is a particle output file from {\tt elegant} or a compatible program.
\end{itemize}

\item {\bf switches}
\begin{itemize}
\item \verb|-input| --- Specify the name of the input file.
\item \verb|-nSlices| --- Optionally specify the number of longitudinal slices. The default is 100.
\item \verb|-pngRoot| --- Optionally specify the file rootname for PNG graphics files. If omitted, no PNG files are created.
\item \verb|-pngThickness| --- Optionally change the thickness of lines for PNG graphics.  The default is 2.
\end{itemize}

\item {\bf author:} X. Dong.

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|csrImpedance|}\end{center}
%\end{latexonly}
\subsection{csrImpedance}

\begin{itemize}
\item {\bf description:}  Computes the steady-state CSR impedance with shielding by parallel plates.
By default, the computed impedance is for a dipole magnet that bends the beam in a complete circle.

\item {\bf synopsis:}
\begin{flushleft}{\tt
csrImpedance {{\em outputFile}  | -pipe[=out]} -height={\em valueInMeters} -radius={\em valueInMeters}
-frequencyLimit=maximum={\em valueInHz}[,minimum={\em valueInHz}] -n={\em integer} [-filter={\em cutoff1},{\em cutoff2}]
[-angle={\em radians}]
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\tt outputFile} --- SDDS file containing computed impedance.  May be used directly with 
{\tt elegant}'s \verb|ZLONGIT| element.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt -height} --- The full height of the vacuum chamber, in meters.
\item {\tt -radius} --- The radius of the bending magnet, in meters.
\item {\tt -angle} --- The angle of the bending magnet, in radians.  The default is $2\pi$.
\item {\tt frequencyLimit} --- Allows specifying the upper frequency limit (required), as well as the
 lower frequency limit, for the computed impedance.  {\tt elegant} will not accept the data if the lower
 limit is not 0.  If the rms bunch length is $\sigma_t$, then it is suggested to have the maximum frequency 
 much greater than $1/sigma_t$.
\item {\tt -n} --- Allows specifying the number of data points to be computed. The number of points computed
 is $2^n+1$, which is required by {\tt elegant}.  A reasonable value is $n=10$ to $n=14$.
\item {\tt -filter} --- Allows specifying the starting and ending frequency for a simple low-pass filter.
 The frequencies are given as fractions of the maximum frequency.  The filter ramps linearly from 1 to 0
 between the two cutoff values.  If, for example, the cutoff is 0.2, then the highest frequency for which the
 impedance is unmodified corresponds to a wavelength of 10 bins ($2/0.2$) in {\tt elegant}. The intention of
 this feature is to provide a way to taper the impedance down to reduce high-frequency noise; another option
 is to apply a gaussian filter externally, e.g., using \verb|sddsprocess|.
\end{itemize}

\item {\bf authors:} Y. Wang, H. Shang, ANL/APS.
Based on a simplified form\cite{Agoh} of Warnock's \cite{Warnock} formula.

\item {\bf Note:} The script \verb|makeSummedCsrZ| is more convenient for computing the CSR impedance of
  rings with several types of dipoles, and also handles the free-space case.

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|doubleDist6|}\end{center}
%\end{latexonly}
\subsection{doubleDist6}

\begin{itemize}
\item {\bf description:} Increases the number of particles in a particle input file by
 successively doubling the number.  Intended to be used to increase the number of particles
 produced by a photoinjector simulation to improve stability of CSR and LSC simulations.

The algorithm is as follows:
\begin{itemize}
\item For each doubling, insert a new particle ``near'' every pair of existing particles in time.
    The particle has a new t value, but the same (x, xp, y, yp, p) as one of the original particles.
\item Bin the beam according to t into a large number of bins.  Randomize the assignment of p values
    relative to other coordinates across particles in the same bin, while additionally adding a 
    small random value to each p value.
\end{itemize}

\item {\bf synopsis:}
\begin{flushleft}{\tt
doubleDist6 -input {\em name} -output {\em name} -doublings {\em number} -nt {\em bins}
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\tt input} --- A particle distribution file, such as might be used with \verb|sdds_beam|.
\item {\tt output} --- A particle distribution file, such as might be used with \verb|sdds_beam|.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt -doublings {\em n}} --- The number of times to double the size of the distribution.
 The number of particles in the output file is $2^n$ times the number in the input file.
\item {\tt -nt {\em bins}} --- The number of time bins to use for momentum randomization. This
 helps to avoid having many particles with exactly same momentum.
\end{itemize}

\item {\bf author:} M. Borland, ANL/APS.

\item {\bf see also:} {\tt smoothDist6s}
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|haissinski|}\end{center}
%\end{latexonly}
\subsection{haissinski}

\begin{itemize}
\item {\bf description:}  {\tt haissinski} solves the Haissinski equation for the bunch
 steady-state longitudinal distribution in the presence of various impedances.

\item {\bf synopsis:}
\begin{flushleft}{\tt
haissinski {\em twissFile} {\em resultsFile}
 {-wakeFunction={\em file},tColumn={\em name},wColumn={\em name} |
  -model=[L={\em Henry}|Zn={\em Ohms}],R={\em Ohm}} 
 {-charge={\em C} | -particles={\em value} | -bunchCurrent={\em A}}
 {-steps={\em numberOfChargeSteps}}
 {-outputLastStepOnly}
 {-RF=Voltage={\em V},harmonic={\em value}[,phase={\em offsetInRadians}] | -length={\em s}}
 {-harmonicCavity=Voltage={\em V},factor={\em harmonicFactor}[,phase={\em radians}]}
 {-superPeriods={\em number}}
 {-energy={\em GeV}} 
 -integrationParameters=deltaTime={\em s},points={\em number},startTime={\em s},
iterations={\em number},fraction={\em value},tolerance={\em value} 
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\em twissFile} --- Twiss output file from {\tt elegant}, including radiation
 integral calculations.
\item {\tt resultsFile} --- SDDS file containing computed bunch longitudinal distributions
 as columns, along with analysis and conditions as parameters.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt -wakeFunction={\em file},tColumn={\em name},wColumn={\em name}} --- Optionally
 specifies the impedance as a Greens function using values in an SDDS file.  The time points
 must be equi-spaced.
\item {\tt -model=[L={\em Henry}|Zn={\em Ohms}],R={\em Ohm}} --- Optionally specifies the
 impedance as an inductor {\tt L} or broad-band value {\tt  Zn}, along with  a resistance {\tt R}.
\item {\tt -charge={\em C} | -particles={\em value} | -bunchCurrent={\em A}} --- Various 
 ways to specify the charge in each bunch.
\item {\tt -steps={\em numberOfChargeSteps}} --- Number of values of bunch charge to compute 
 up to the value specified with on the just-described options.  Using more values can help
 convergence, as the result of each prior step is used as the starting point for the new step.
\item {\tt -outputLastStepOnly}  --- Requests output for the last charge step (full charge) only.
\item {\tt -RF=Voltage={\em V},harmonic={\em value}[,phase={\em offset}] | -length={\em s}} --- Two ways to specify 
 the nominal bunch length. The phase value is an offset from the synchronous phase, in radians, and is
 used only when a harmonic cavity is included.
\item {\tt -harmonicCavity=Voltage={\em V},factor={\em harmonicFactor}[,phase={\em radians}]} --- Specifies a harmonic
 cavity voltage, phase, and the ratio of the harmonic cavity frequency to the main frequency.
\item {\tt -superPeriods={\em number}} --- Number of superiods of the lattice specified in
 {\em twissfile} to simulate.  If one has an N cell ring but only gives 1 cell in the input,
 this value should be N.  If one gives the whole ring, this value should be 1.
\item {\tt -energy={\em GeV}} --- Beam energy. If not given, the value in the {\em twissfile} 
 is used.
\item {\tt -integrationParameters=deltaTime={\em s},points={\em number},startTime={\em s},}\\
 {\tt iterations={\em number},fraction={\em value},tolerance={\em value} } --- Integration 
 parameters, which must be set.  {\tt deltaTime} is the time interval for wake function and
 charge density evaluation.  {\tt points} is the number of time points, while {\tt startTime}
 is the time (relative to synchronous phase) at which the time region starts.  These values
 must be set by the user based on knowledge of the likely bunch length.  For the others, 
 we suggest 1000 iterations, a fraction of 0.01, and a tolerance of $10^{-4}$. 
\end{itemize}

\item {\bf authors:} L. Emery, M. Borland, ANL/APS.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|ibsEmittance|}\end{center}
%\end{latexonly}
\subsection{ibsEmittance}

\begin{itemize}
\item {\bf description:} \verb|ibsEmittance| computes growth rates and
equilibrium emittances for electron rings due to intrabeam scattering
(IBS).  It will also integrate the growth rates to show the time
evolution of the emittances.  The IBS algorithm is based on the
Bjorken and Mtingwa's~\cite{BM} formula, and with an extension of including vertical
dispersion. The program can also estimate IBS growth rates
for and transport line or linac beam, provided special attention paid to the beam's energy
change (splitting RF cavities as needed). 

\item {\bf examples:}
This example computes the IBS equilibrium parameters and the contributions to the
growth rates (at equilibrium) vs position in the APS lattice.
\begin{flushleft}{\tt 
ibsEmittance aps.twi aps.ibs -charge=5 -coupling=0.02 -rf=voltage=9,harmonic=1296
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt 
ibsEmittance {\em twissFile} {\em resultsFile}
 {-charge={\em nC}|-particles={\em value} } {-coupling={\em value}|-emityInput={\em value}}
 [-emitInput={\em value}] [-deltaInput={\em value}]
 [-emit0={\em value}] [-delta0={\em value}]
 [-superperiods={\em value}] [-isRing=1|0]
 {-RF=Voltage={\em MV},harmonic={\em value}|-length={\em mm}}
 [-energy={\em MeV}] 
 [{-growthRatesOnly | -integrate=turns={\em number}[,stepSize={\em number}]}]
 [-noWarning] 
}\end{flushleft}

\item {\bf files:}
{\em twissFile} is a twiss parameter file from the \verb|twiss_output| command of
{\tt elegant}.    You must use the \verb|radiation_integrals| flag in \verb|twiss_output|.

\item {\bf switches:}
\begin{itemize}
\item {\bf -charge}, {\bf -particles} --- Give the charge (in nanocoulombs) or the
 number of electrons.
\item {\bf -coupling} --- Give the emittance or ``coupling'' ratio, $\epsilon_y/\epsilon_x$.
\item {\tt -emityInput} --- Give the initial vertical emittance in meters.
\item {\bf -emitInput} --- Give the initial total emittance in meters.  If not specified,
the value from the parameter \verb|ex0| in {\em twissFile} is used.
\item {\bf -deltaInput} --- Give the initial rms fractional momentum spread.  If not
specified, the value from the parameter \verb|Sdelta0| in {\em twissFile} is used.
\item {\bf -emit0}, {\bf -delta0}  --- Redefine the equilibrium emittance and rms energy spread, if
  different from what is given in the twiss input file. Can be used, e.g., to include additional source
  of energy spread, such as microwave instability, from an external calculation.
\item {\bf -superperiods={\em value}} --- If given, the number of superperiods in the 
lattice.  {\em twissFile} is taken to pertain to a single sector.
\item {\bf -isRing} --- Specify the calculation is done for stored beam 
(isRing=1, default) or transport line/linac beam (isRing=0). When isRing is set to 0, the energy scaling
and integration calculation will be disabled.  
\item {\bf -RF=Voltage={\em MV},harmonic={\em value}} --- Specify rf voltage and harmonic number.
\item {\bf -length={\em mm}} --- Specify the rms bunch length.
\item {\bf -energy={\em MeV}} --- Specify the beam energy.  By default, this is taken from
 the {\tt pCentral} parameter in {\em twissFile}.
\item {\bf -growthRatesOnly} --- If given, only the initial growth rates are computed.  Equilibrium
emittance values are not computed. {\em resultsFile} will contain columns of initial growth rate
contributions from individual elements. Without this option, {\em resultsFile}
would normally contain columns of growth rate contributions at equilibrium.
\item {\bf -integrate=turns={\em number}[,stepSize={\em number}]} --- 
  If given, then {\em resultsFile}
 contains the result of integrating the differential equations for the emittances for 
 the given number of turns and not the contributions 
 of individual elements of growth rates.  
 The step size is the number of turns for each integration step,
 and can be adjusted to get faster results.
 The options -growthRatesOnly and -integrate are not compatible.
\item {\bf -noWarning} --- Removes warning messages.
\end{itemize}

\item {\bf author:} A. Xiao, L. Emery, M. Borland, ANL/APS.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|ionTrapping|}\end{center}
%\end{latexonly}
\subsection{ionTrapping}

\begin{itemize}
\item {\bf description:}   Computes ion trapping conditions using {\tt elegant} twiss parameter
output as input.

\item {\bf synopsis:}
\begin{flushleft}{\tt
ionTrapping -twiss {\em filename} -superPeriods {\em number} -kappa {\em ratio} 
-output {\em filename} -current {\em mA} -bunches {\em number}
}\end{flushleft}

\item {\bf switches:}
\begin{itemize}
\item {\tt twiss} --- Give the name of a Twiss output file from {\tt elegant}. It is advisable to subdivide the
elements finely enough to get smooth representations of the lattice functions. The file should be computed the
radiation integrals turned on, since the natural emittance and energy spread are needed.
\item {\tt superPeriods} --- Give the number of superperiods of the basic cell described by the Twiss output file.
\item {\tt kappa} --- Give the ratio $\epsilon_y/\epsilon_x$. The emittances are computed from $\epsilon_0$ using
$\epsilon_x = \frac{\epsilon_0}{1 + \frac{J_y}{J_x}\kappa}$ and $\epsilon_y = \kappa \epsilon_x$. 
\item {\tt output} --- Give the name of the output file. The file contains the information in the input file, with
the following added elements, among others:
\begin{itemize}
\item Column {\tt Acrit} --- $A_{crit}(s)$ is defined as\cite{Bacconier-SPS80-2}
\begin{equation}
A_{crit}(s) = \frac{N_e r_p S_b}{2 \min (\sigma_x(s), \sigma_y(s)) (\sigma_x(s) + \sigma_y(s))},
\end{equation}
where $N_e$ number of electrons per bunch, $r_p$ is the classical proton radius, $S_b$ is the bunch separation in meters, 
$\sigma_x(s)$ is the local horizontal rms beam size, and $\sigma_y(s)$ is the local vertical rms beam size.
Any singly-ionized species with atomic mass greater than $A_{crit}$ will be trapped.
\item Parameters {\tt ex}, {\tt ey} --- The horizontal and vertical emittances.
\item Parameter {\tt AcritMin} --- Minimum value of $A_{crit}(s)$.
\item Parameters {\em species}\verb|TrappedFraction|, where {\em species} is \verb|H2|,
\verb|H2O|, \verb|CH4|, \verb|CO|, and \verb|CO2|. These give
the fraction of the circumference over which ${\rm H_2}$, ${\rm H_2 O}$, ${\rm CH_4}$, ${\rm CO}$, and ${\rm CO_2}$, respectively, are
trapped. 
\end{itemize}
\item {\tt current} --- Give the total beam current milliAmps.
\item {\tt bunches} --- Give the number of bunches.
\end{itemize}

\item {\bf authors:} M. Borland (ANL/APS).

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|elegantto|}\end{center}
%\end{latexonly}
\subsection{elegantto}
\label{elegantto}

\begin{itemize}
\item {\bf description:} 
\verb|elegantto| translates an {\tt elegant}-style (or a MAD file, with
some restrictions) into formats accepted by other programs, such as COSY,
PARMELA, PATPET, PATRICIA, TRANSPORT, and XORBIT.  Will also generate
an SDDS file containing lattice data.

\item {\bf examples:}
The following command would translate the {\tt elegant} lattice file 
\verb|lattice.lte| into a TRANSPORT lattice file with 10mm quadrupole
aperture and 5mm sextupole aperture, at an energy of 1.5 GeV.
\begin{flushleft}{\tt
elegantto lattice.lte lattice.trin -transport=10,5,1.5
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
elegantto {\em inputfile} {\em outputfile}
 \{-patricia | -patpet | -transport[={\em quadAper(mm)},{\em sextAper(mm)},{\em p(GeV/c)}]
            | -parmela[={\em quadAper(mm)},{\em sextAper(mm)},{\em p(GeV/c)}]
            | -sdds[={\em p(GeV/c)}] \
            | -cosy={\em quadAper(mm)},{\em sextAper(mm)},{\em p(MeV/c)} \
            | -xorbit | -mad8 \}
 [-angle\_tolerance={\em value}] [-flip\_k\_signs] [-magnets={\em filename}]
 [-header={\em filename}] [-ender={\em filename}]
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\em inputfile} --- An {\tt elegant}-style lattice file.
\item {\em outputfile} --- A file containing lattice data in the chosen format.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\bf -cosy} --- Provide data for the program COSY INFINITY.  This can take a little while
  as the program must figure out the Enge coefficients that correspond to the {\tt FINT} and
  {\tt HGAP} values for all the dipoles.  The user should test the output carefully.
\item {\bf -mad8} --- Provide data for the program MAD8.
\item {\bf -patricia} --- Provide data for the program PATRICIA.
\item {\bf -patpet} --- Provide data for the program PATPET, a merging of the programs
        PATRICIA and PETROS.
\item {\bf -transport[={\em quadAper(mm)},{\em sextAper(mm)},{\em p(GeV/c)}]} --- 
        Provide data for the program TRANSPORT (original style). 
	One may give apertures for
        the quadrupoles and sextupoles, as well as the beam momentum in GeV/c.
\item {\bf -parmela[={\em quadAper(mm)},{\em sextAper(mm)},{\em p(GeV/c)}]} --- 
        Provide data for the program PARMELA. One may give apertures for
        the quadrupoles and sextupoles, as well as the beam momentum in GeV/c.
\item {\bf -sdds[={\em p(GeV/c)}]} --- Provide data in SDDS form.  One may give the beam momentum in GeV/c.
\item {\bf -angle\_tolerance={\em value}}  --- PATPET and PATRICIA only allow sector and rectangular bends.
        This tolerance, in radians, determines how far from sector or rectangular a bend 
        definition may be and still get processed.
\item {\bf -flip\_k\_signs} --- Changes the signs of all quadrupoles.
\item {\bf -magnets={\em filename}} --- Results in output of an additional SDDS file with the magnet layout.
        This is the same file that would be generated by the {\tt magnets} field of the 
        {\tt run\_setup} command in {\tt elegant}.
\item {\bf -header={\em filename}}, {\bf -ender={\em filename}} --- 
        Allow specification of files to be prepended and appended to
        the lattice output.  For example, if additional commands are required prior to the
        lattice definition to set up the run, they would be put in the {\bf header} file.
        If additional commands are needed after the lattice definition to initiate processing, they 
        would be put in the {\tt ender} file.
\end{itemize}

\item {\bf author:} M. Borland, ANL/APS.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sddsanalyzebeam|}\end{center}
%\end{latexonly}
\subsection{sddsanalyzebeam}
\label{sddsanalyzebeam}

\begin{itemize}
\item {\bf description:} 
{\tt sddsanalyzebeam} analyzes a beam of macro-particles and produces an SDDS file
containing beam moments, emittances, equivalent beta functions, etc.  The beam file
is of the type written by {\tt elegant} using the {\tt output} field of the {\tt run\_setup}
command, or the WATCH element.

\item {\bf examples:}
\begin{flushleft}{\tt
sddsanalyzebeam run.out run.analysis 
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
sddsanalyzebeam [-pipe=[input][,output]] [{\em inputfile}] [{\em outputfile}]
[-nowarnings] [-correctedOnly] [-canonical]
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\em inputfile} --- An SDDS file containing the columns {\tt x}, {\tt xp}, {\tt y},
{\tt yp}, {\tt t}, and {\tt p}, giving the six phase-space coordinates for a set of macroparticles.
This file can be produced from {\tt elegant}, for example, using the {\tt output} field of the {\tt run\_setup} 
command, the {\tt bunch} field of the {\tt bunched\_beam} command, or the WATCH element in
coordinate mode.

\item {\em outputfile} --- An SDDS file containing columns giving
moments, emittances, equivalent Twiss parameters, and so on, for the
macro-particles.  Each row of this file corresponds to a page of the
input file.  The names and meanings of the columns are identical to
what is used for {\tt elegant}'s {\tt final} output file from the {\tt
run\_setup} command.  The file from {\tt elegant}, however, stores the
results as parameters instead of columns; to convert {\tt outputfile}
to that convention, use the SDDS toolkit program {\tt sddsexpand}.

\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt pipe} --- The standard SDDS Toolkit pipe option.
\item {\tt nowarnings} --- Suppressses warning messages.
\item {\tt correctedOnly} --- If given, only the ``corrected'' twiss parameters and emittances are computed and
 output.  The corrected twiss parameters have the dispersive component subtracted.  Normally, these are
computed but given names like \verb|betacx|, \verb|ecx|, etc. whereas the uncorrected values are 
\verb|betax|, \verb|ex|, etc. The corrected parameters are the correct ones to match a beamline to, since they have the
 dispersive and mono-energetic terms properly separated.  The uncorrected values are more relevant if the dispersion
is spurious (i.e., uncorrected or due to something like CSR that doesn't admit of correction).
\item {\tt -canonical} --- If given, all computations are performed using canonical momenta 
  $q_x = p_x/p_0 = x^\prime (1 + \delta)/\sqrt{1 + x^{\prime 2} + y^{\prime 2}}$ etc.
\end{itemize}

\item {\bf author:} M. Borland, ANL/APS.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sddsbrightness|}\end{center}
%\end{latexonly}
\subsection{sddsbrightness}

\begin{itemize}
\item {\bf description:} {\tt sddsbrightness} computes undulator brightness curves using
Twiss parameter data from {\tt elegant} or {\tt sddsanalyzebeam}. Several calculation
methods are available.

\item {\bf examples:}
\begin{flushleft}{\tt
sddsbrightness run.twi run.bri -harmonics=3 -Krange=start=0.2,end=2.2,points=100 \\
  -current=0.1 -totalLength=2.4 -periodLength=0.027 -coupling=0.01

sddsanalyzebeam run.out -pipe=out -correctedOnly \\ 
 | sddsbrightness -pipe=in run.bri -harmonics=3 -Krange=start=0.2,end=2.2,points=100 \\
  -current=0.1 -totalLength=2.4 -periodLength=0.027 -coupling=0.01
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
sddsbrightness [-pipe=[input][,output]] [{\em twissFile}] [{\em SDDSoutputfile}]
 -harmonics={\em integer} -Krange=start={\em value},end={\em value},points={\em integer}
 -current={\em Amps} -totalLength={\em meters} -periodLength={\em meters}
 [-emittanceRatio={\em value} | -coupling={\em value}] [-noSpectralBroadening]
 [-method={\em string},device={\em string},neks={\em value}]] 
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\em twissFile} --- A Twiss output file from {\tt elegant}, with radiation integral 
calculations included, or an output from {\tt sddsanalyzebeam}. In the latter case, the
{\tt -correctedOnly} option should be used.
\item {\em SDDSoutputFile} --- Contains the brightness data in column form.  For each 
requested harmonic {\em i}, there are columns {\tt photonEnergy{\em i}}, {\tt wavelength{\em i}},
and {\tt Brightness{\em i}}.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt pipe} --- The standard SDDS Toolkit pipe option.
\item {\tt harmonics} --- The number of harmonics to compute.
\item {\tt Krange=start={\em value},end={\em value},points={\em integer}} --- The range of the
 K parameter for the undulator and the number of points to compute on that range.
\item {\tt -current={\em Amps}} --- The current in amperes.  If one gives the average current,
 one gets the average brightness.  
\item {\tt -totalLength={\em meters}} --- The total length of the undulator, in meters.
\item {\tt -periodLength={\em meters}} ---  The period length of the undulator, in meters.
\item {\tt -emittanceRatio={\em value}  | -coupling={\em value}} --- In the case of a twiss
 output file from {\tt elegant}, which does not contain the vertical emittance, one must
 supply one of these options.  If {\tt -emittanceRatio={\em R}} is given, $\epsilon_y = \epsilon_0*R$ 
 and $\epsilon_x = \epsilon_0$; this isn't how things work physically, but is provided for historical
 reasons.
 If {\tt -coupling={\em k}} is given, $\epsilon_x = \epsilon_0/(1+Jy*k/Jx)$
 and $\epsilon_y = k*\epsilon_x$.  $\epsilon_0$ is the equilibrium emittance from the twiss output
 of {\tt elegant}.  

 In the case of twiss output from {\tt sddsanalyzebeam}, both emittances are present and these options
 are ignored.
\item {\tt -method={\em string},device={\em string},neks={\em value}]} --- Choose which method to
 use for brightness calculations.  Options are
 \begin{itemize} 
 \item {\tt borland} --- M. Borland's approximation method. Fast, but not as reliable as others.
 \item {\tt dejus} --- R. Dejus' non-zero emittance, infinite-N+convolution method.  This is the
   default.
 \item {\tt walkerinfinite} --- R. Walker's method.  Dejus' method is derived from this method.
 \item {\tt walkerfinite} --- R. Walker's method using finite N without convolution.  This is 
   quite slow.
 \end{itemize}
 The {\tt device} qualifier may be {\tt planar} or {\tt helical}.  {\tt neks} is used to 
 change the number of points used for finding the peak of the distribution.
\end{itemize}

\item {\bf authors:} M. Borland, H. Shang, R. Dejus (ANL).
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sddsbunchingfactor|}\end{center}
%\end{latexonly}
\subsection{sddsbunchingfactor}

\begin{itemize}
\item {\bf description:} {\tt sddsbunchingfactor} computes bunching factors for 
beams from {\tt elegant}, e.g., from \verb|WATCH| elements in coordinate mode or
the \verb|output| file from \verb|run_setup|.

The bunching factor $B(\omega)$ is defined as
\begin{equation}
B(\omega) = \frac{1}{N}\sqrt{\left(\sum_{i=1}^N \cos \omega t_i\right)^2 + \left(\sum_{i=1}^N \sin\omega t_i\right)^2},
\end{equation}
where $\omega$ is the angular frequency and $t_i$ is the time coordinate of the $i^{th}$ of $N$ particles.

\item {\bf examples:}
\begin{flushleft}{\tt
sddsbunchingfactor run.out run.bfac -omegaRange=1e9,1e12 -points=300 -mode=log
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
sddsbunchingfactor [-pipe=[input][,output]] [{\em SDDSinputfile}] [{\em SDDSoutputfile>}]
  [-omegaRange={\em lowerHz},{\em upperHz}] [-points={\em number}] [-mode=\{linear|logarithmic\}] 
  [-combinePages]
}\end{flushleft}

\item {\bf switches:}
\begin{itemize}
\item {\tt pipe} --- The standard SDDS Toolkit pipe option.
\item {\tt omegaRange} --- Give the range of $\omega$ values, in Hz.
\item {\tt points} --- Give the number of points over the range of $\omega$ values.
\item {\tt mode} --- Choose linear or logarithmic spacing of $\omega$ values.
\item {\tt combinePages} --- Pages of the input file are combined, i.e., treated as a single bunch.
\end{itemize}

\item {\bf authors:} M. Borland (ANL).
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sddsemitproc|}\end{center}
%\end{latexonly}
\subsection{sddsemitproc}
\label{sddsemitproc}

\begin{itemize}

\item {\bf description:} 

{\tt sddsemitproc} analyzes quadrupole scan emittance measurement
data.  It accepts a file containing the transport matrix for each data
point and measured beam sizes.  Because {\tt sddsemitproc} uses the
matrix rather than a thin-lens model, it can analyze data from
arbitrarily complex scans, involving, for example, multiple thick-lens
quadrupoles.

The matrix data can be prepared using {\tt elegant}.  For example, the
{\tt vary\_element} command can be used to vary one or more
quadrupoles.  In addition, the beam size data may be prepared using
{\tt elegant}, to allow simulation of emittance measurements.

{\tt sddsemitproc} will perform error analysis using a Monte Carlo
technique.  A user-specified number of random error sets are generated
and added to all measurements.  Analysis is performed for each error
set.  Statistics over all the error sets provide most likely values
and error bars.

The beam parameters computed by {\tt sddsemitproc} pertain to the
beginning of whatever system is simulated in {\tt elegant}.

\item {\bf examples:}
\begin{flushleft}{\tt
elegant quadScan.ele
sddscollapse quadScan.fin -pipe=out \\
| sddsxref -pipe=in quadScan.data -take=SigmaX,SigmaY \\
| sddsemitproc -pipe=in emitResults.sdds
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
sddsemitproc [{\em inputfile}] [{\em outputfile}] [-pipe=[input][,output]]
 [-sigmaData={\em xName},{\em yName}]
 [-variableName={\em columnName}]
 [-errorData={\em xName},{\em yName} | 
  -errorLevel={\em valueInm},[\{gaussian,{\em nSigmas} | uniform\}]]
 [-nErrorSets={\em number}] [-seed=integer]
 [-limitMode={resolution | zero}[{,reject}]
 [-deviationLimit={\em xLevelm},{\em yLevelm}]
 [-resolution={\em xResolutionm},{\em yResolutionm}]
 [-verbosity={\em level}]
}\end{flushleft}

\item {\bf files:}
\begin{itemize}

\item {\em inputfile} --- An SDDS file containing one or more pages
with columns named \verb|R|{\em ij}, where {\em ij} is 11, 12, 33, and
34.  These give elements of the horizontal and vertical transport
matrices from the beginning of a system to the observation point.  The
sigma matrix inferred will be that for the beginning of the system.
Typically, one starts with the {\tt final} file from the {\tt
run\_setup} command in {\tt elegant}, and collapses it using {\tt
sddscollapse}.  Each page of {\em inputfile} corresponds to a different
emittance measurement.

In addition to this data, {\em inputfile} must also contain columns
giving the rms beam sizes in x and y.  The user supplies the names of
the columns using the \verb|-sigmaData| option; otherwise, they
default to \verb|Sx| and \verb|Sy|.  These columns may be from {\tt
elegant} (e.g., \verb|Sx| and \verb|Sy|), if one wants to simulate an
emittance measurement.  Note that the theory behind the emittance
measurement is strictly correct only for true RMS beamsize
measurements.  Use of FWHM or some other measure will give unreliable
results.
 
\item {\em outputfile} --- A file containing one page for each page of
{\em inputfile}.  The parameters of {\em outputfile} give the measured
geometric rms emittance, sigma matrix, and Twiss parameters of the 
beam in the horizontal and vertical planes.  If error sets were requested
(using \verb|-nErrorSets|), then there are also parameters giving the
error bars (``sigma's'') of the measured values.

\end{itemize}

\item {\bf switches:}
\begin{itemize}

\item {\tt -variableName={\em columnName}} --- Supplies the name of
 a column in {\em inputFile} that will be copied into {\em outputFile}
 for use in plotting. Does not affect any results.

\item {\tt -sigmaData={\em xName},{\em yName}} --- Supplies the names
of the columns in {\em inputfile} from which the x and y rms beam
sizes are to be taken.  Default values are {\tt Sx} and {\tt Sy},
which are the data provided by {\tt elegant}.

\item {\tt -errorLevel={\em valueInm},[{gaussian,{\em nSigmas} |
uniform}]} --- Supplies the standard deviation of random errors to be
added to the measured beam sizes for Monte Carlo error analysis.

\item {\tt -errorData={\em xName},{\em yName}} --- May be used to
supply the names of columns in the input file that contain the 
error level for each measurement.  This is an option instead of
using {\tt -errorLevel}, which allows varying the measurement
error for each point.

\item {\tt -nErrorSets={\em number}} --- The number of sets of random
errors to generate and add to the measurements.  Each error set is
used to perturb the original measurement data.  The results are
analyzed separately for each error set, then combined to give means
and error bars.

\item {\tt -seed=integer} --- Seed for the random number generator.
Recommend a large, positive, odd integer less than $2^31$.  If no seed
is given or if the given seed is negative, then a seed is generated
from the system clock.

\item {\tt -resolution={\em xResolutionm},{\em yResolutionm}} --- The
resolution of the beam size measurements, in meters.  These values are
subtracted in quadrature from the measured beam sizes to obtain the
true beam sizes.

\item {\tt -limitMode={resolution | zero}[,reject]} --- If measured or
perturbed beam sizes are less than the resolution or less than zero,
then errors will result.  One can use this option to limit minimum
beam size values or reject points.  In general, if one has to do this
the measurement is probably bad.

\item {\tt -deviationLimit={\em xLevelm},{\em yLevelm}} --- Specifies
the maximum deviation, in meters, from the fit that data points may
have and still be included.  An initial fit is performed for each
randomized set or the raw data, as appropriate.  Outliers are then
removed and the fit is repeated.

\item {\tt -verbosity={\em level}} --- Higher values of {\em level} result in more informational
        printouts as the program runs.
\end{itemize}

\item {\bf author:} M. Borland, ANL/APS.

\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sddsfindresonances|}\end{center}
%\end{latexonly}
\subsection{sddsfindresonances}

\begin{itemize}
\item {\bf description:} {\tt sddsfindresonances} scans frequency map analysis data and
identifies resonances.

\item {\bf examples:}
\begin{flushleft}{\tt
sddsfindresonances run.fma run.res -multipoles=dipole,quad,sext,oct -type=skew
sddsfindresonances run.fma run.res -multipoles=sext,oct -type=skew,norm
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
sddsfindresonances [-pipe=[input][,output]] [{\em inputFile}] [{\em outputfile}]
 -multipoles=[all={\em integer}]|[dipole,][quadrupole,][sextupole,][octupole,]
 [-type=[normal,][skew]] [-variables={\em firstColumn},{\em secondColumn}]
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\em inputFile} --- By default, frequency map analysis output file from {\tt elegant}'s {\tt frequency\_map} command
or equivalent, containing at minimum the columns {\tt x}, {\tt y}, {\tt nux}, and {\tt nuy}.  Each page of the file is
treated separately.
\item {\em outputFile} --- Contains the identified resonance lines, one resonance line per page.  The file contains
the columns {\tt x}, {\tt y}, {\tt nux}, and {\tt nuy}, along with parameters that identify the resonance.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt pipe} --- The standard SDDS Toolkit pipe option.
\item {\tt multipoles=[all={\em integer}]|[dipole,][quadrupole,][sextupole,][octupole,]} --- Choose what order of resonances to 
  search for by naming the type of magnet that nominally drives it, or by giving the maximum order to search ({\tt all} option).
\item {\tt -type=[normal,][skew]} --- Specify normal- or skew-driven resonances.  Default is both.
\item {\tt -variables={\em firstColumn},{\em secondColumn}} --- Use to change the default names for the coordinate variables.
\end{itemize}

\item {\bf authors:} H. Shang, M. Borland. (ANL).
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sddsfluxcurve|}\end{center}
%\end{latexonly}
\subsection{sddsfluxcurve}

\begin{itemize}
\item {\bf description:} {\tt sddsfluxcurve} computes undulator fluxcurve curves using
Twiss parameter data from {\tt elegant} or {\tt sddsanalyzebeam}. Several calculation
methods are available.

\item {\bf examples:}
\begin{flushleft}{\tt
sddsfluxcurve run.twi run.bri -harmonics=3 \
  -electronBeam=current=0.1,coupling=0.01 \
  -undulator=period=0.033,numberOfPeriods=70,kmin=0.01,kmax=2.7,points=100 \
  -pinhole=distance=30,xsize=0.0025,ysize=0.001 
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
sddsfluxcurve [-pipe=[input][,output]] [{\em twissFile}] [{\em SDDSoutputfile}]
    [-harmonics={\em integer}] [-method={\em methodName}[,neks={\em integer}]]
    [-mode={pinhole|density|total}]
    -undulator=period={\em meters},numberOfPeriods={\em integer},kmin={\em value},kmax={\em value}[,points={\em number}]
    [-electronBeam=current={\em amps},[,{coupling={\em value} | emittanceRatio={\em value}}]]
    [-pinhole=distance={\em meters},xsize={\em meters},ysize={\em meters}
    [,xnumber={\em integer}][,ynumber={\em integer}][,xposition={\em meters}][,yposition={\em meters}]]
    [-nowarnings]
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\em twissFile} --- A Twiss output file from {\tt elegant}, with radiation integral 
calculations included, or an output from {\tt sddsanalyzebeam}. In the latter case, the
{\tt -correctedOnly} option should be used.
\item {\em SDDSoutputFile} --- Contains the flux data in column form.  For each 
requested harmonic {\em i}, there are columns {\tt photonEnergy{\em i}} and {\tt wavelength{\em i}},
plus a column for the flux ({\tt TotalFlux{\em i}}, {\tt PinholeFlux{\em i}}, or {\tt FluxDensity{\em i}}).
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt pipe} --- The standard SDDS Toolkit pipe option.
\item {\tt harmonics} --- The number of harmonics to compute.
\item {\tt -method={\em string},neks={\em value}]} --- Choose which method to
 use for calculations.   Options are
 \begin{itemize} 
 \item {\tt dejus} --- R. Dejus' non-zero emittance, infinite-N+convolution method.  This is the
   default.
 \item {\tt walkerinfinite} --- R. Walker's method.  Dejus' method is derived from this method.
 \end{itemize}
 {\tt neks} is used to  change the number of points used for finding the peak of the distribution.
\end{itemize}
\item {\tt mode={pinhole|density|total}} --- Specify whether to compute the flux through a pinhole, the flux density,
  or the total flux.
\item {\tt -undulator=period={\em meters},numberOfPeriods={\em integer},kmin={\em value},kmax={\em value}[,points={\em number}]} ---
  Specify undulator parameters.  {\tt points} is the number of K values to use on the interval $[K_{min}, K_{max}]$.
\item {\tt electronBeam=current={\em amps},[,{coupling={\em value} | emittanceRatio={\em value}}]} --- Specify parameters of the
  electron beam.  The current defaults to 0.1 A.  Either the coupling or emittance ratio must be given, unless the input file
  contains the parameter {\tt ey0} or the column {\tt ey}.
\item {\tt -pinhole=distance={\em meters},xsize={\em meters},ysize={\em meters}}{\tt [,xnumber={\em integer}]}\\
  {\tt [,ynumber={\em integer}]}{\tt [,xposition={\em meters}]}{\tt [,yposition={\em meters}]} ---
  Specify the parameters of the pinhole.  Required for {\tt -mode=pinhole}.  By default {\tt xnumber}=20, {\tt ynumber}=20, 
  {\tt xposition=0}, and {\tt yposition=0}.
\item {\bf authors:} M. Borland, H. Shang, R. Dejus (ANL).
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sddsmatchtwiss|}\end{center}
%\end{latexonly}
\subsection{sddsmatchtwiss}
\label{sddsmatchtwiss}

\begin{itemize}
\item {\bf description:} 
{\tt sddsmatchtwiss} transforms a beam of macro-particles to match to given beta
functions and dispersion.   This can be useful in taking macro-particle data from
one simulation and using it in another.  For example, a beam file from PARMELA
could be given the right beta functions for use with a specific lattice in an
{\tt elegant} run, saving the trouble of rematching to join the two simulations.
Similarly, a beam from {\tt elegant} could be matched into an FEL simulation.

\item {\bf examples:}
\begin{flushleft}{\tt
sddsmatchtwiss elegantBeam.out FELBeam.in -xPlane=beta=1.0,alpha=-0.2 -yPlane=beta=0.5,alpha=0.2
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
sddsmatchtwiss [-pipe=[input][,output]] {\em inputfile} {\em outputfile}
[-saveMatrices={\em filename}] [-loadMatrices={\em filename}]
[-xPlane=[beta={\em meters},alpha={\em value}][,etaValue={\em meters}][,etaSlope={\em value}]]
[-yPlane=[beta={\em meters},alpha={\em value}][,etaValue={\em meters}][,etaSlope={\em value}]]
[-zPlane=[deltaStDev={\em value}][,tStDev={\em value}]
\hspace*{4mm}[{,correlation={\em seconds}|alpha={\em value}}][,chirp={\em 1/seconds}][,betaGamma={\em value}]]
[-nowarnings]
}\end{flushleft}

\item {\bf files:}

{\em inputfile} is an SDDS file containing one or more pages of data
giving the phase-space coordinates of macro particles.  The macro
particle data is stored in columns named \verb|x|, \verb|xp|,
\verb|y|, \verb|yp|, and \verb|p|.  The units are those used by {\tt
elegant} for the {\tt output} file from {\tt run\_setup}, the {\tt
bunch} file from {\tt bunched\_beam}, and the coordinate-mode output
from the {\tt WATCH} element. The data from these columns is used
together with the commandline arguments to produce new values for
these columns; the new values are delivered to {\tt outputfile}.
Other columns may be present in {\tt inputfile}; if so, they are
passed to {\em outputfile} unchanged.

\item {\bf switches:}
\begin{itemize}
\item {\tt -xPlane=[beta={\em meters},alpha={\em value}][,etaValue={\em meters}][,etaSlope={\em value}]} ---
        Specifies the desired parameters for the beam in the horizontal plane.  {\tt beta} and {\tt alpha} give
        $\beta$ and $\alpha = -\frac{1}{2}\frac{\partial \beta}{\partial s}$; they must both be given
        or both be omitted.  {\tt etaValue} and {\tt etaSlope} give the dispersion, $\eta$, and 
        its slope, $\frac{\partial \eta}{\partial s}$.
\item {\tt -yPlane=[beta={\em meters},alpha={\em value}][,etaValue={\em meters}][,etaSlope={\em value}]} ---
        Same as {\tt -xPlane}, except for the vertical plane.
\item {\tt -zPlane=[deltaStDev={\em value}][,tStDev={\em value}]}
  {\tt [,\{correlation={\em seconds}|alpha={\em value}\}][,chirp={\em seconds}][,betaGamma={\em value}]} ---
  {\tt deltaStDev} is $\sigma_\delta = \langle \sqrt{(\delta - \langle \delta \rangle)^2}$, 
  {\tt tStDev} is $\sigma_t = \langle \sqrt{(t - \langle t \rangle)^2}$,  and
  {\tt correlation} is $\sigma_{t,\delta} = \langle (\delta - \langle \delta \rangle)((t - \langle t \rangle)\rangle$, in terms of which
  the longitudinal emittance is $\epsilon = \sqrt{\sigma_t^2*\sigma_\delta^2 - \sigma_{t,\delta}^2}$.
  {\tt alpha} is $-\sigma_{t,\delta}/\epsilon$.
  The {\tt chirp}, if requested, is added after generation of the beam according to the other parameters.
  If {\tt betaGamma} is given, the beam is ``accelerated'' to the given average value of $\beta\gamma$ 
  in a idealized sense, preserving the momentum spread and transforming the transverse coordinates
  by the factor $\sqrt{\langle \beta\gamma\rangle_0/(\beta\gamma)_{\rm desired}}$.
\item {\tt -saveMatrices={\em filename}} --- Requests saving the transformation matrices to a file.
\item {\tt -loadMatrices={\em filename}} --- Requests loading the transformation matrices from a file.
\item {\tt -nowarnings} --- Suppresses warning messages.
\end{itemize}

\item {\bf authors:} M. Borland, H. Shang, ANL/APS.
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sddsrandmult|}\end{center}
%\end{latexonly}
\subsection{sddsrandmult}
\label{sddsrandmult}

\begin{itemize}
\item {\bf description:} {\tt sddsrandmult} computes the multipole
errors in a quadrupole or sextupole due to various construction
errors.  The program is based on the analysis of
Halbach\cite{Halbach_69a}, with which I'll assume the reader is
familiar.  Instead of separately evaluating the effect of certain
types of mechanical errors, it allows one to simulate several types of
errors in order to get statistical distributions for the multipole
perturbations.

\item {\bf examples:}
\begin{flushleft}{\tt
sddsrandmult quadpert.in
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
sddsrandmult {\em inputFile}
}\end{flushleft}

\item {\bf usage:}

{\em inputFile} is a text file containing a series of namelist commands specifying
the parameters of a quadrupole or sextupole, the type and amplitude of the errors
to include, and the filenames for output.  Each namelist command results in a
complete computation and generation of output files.

The namelist command is {\tt perturbations}.  It has the following fields:
\begin{itemize}
\item {\tt type} --- A string value, either ``quadrupole'' (default) or ``sextupole''.
\item {\tt name} --- An optional string value giving the name of the element.  This is
  used in preparing data for {\tt elegant}.
\item {\tt SDDS\_output} --- An required string value giving the name of an SDDS file to which
  data for each seed will be written.  This file can be used to compute statistics or perform
  histograms.
\item {\tt elegant\_output} --- An optional string value giving the name of a text file to which
  {\tt elegant} commands and element definitions will be written.  Note that this file is a mixture
  of commands and element definitions.  As such, the user must manually edit the file and place the
  appropriate parts in the lattice file and the command file.
\item {\tt kmult\_output} --- An optional string value giving the name of an SDDS file to which
  data will be written in the format accepted by the {\tt RANDOM\_MULTIPOLES} feature of the {\tt KQUAD}
  and {\tt KSEXT} elements.  {\em This is the recommended data to use with {\tt elegant}}.
\item {\tt effective\_length} --- The effective length of the magnet, in meters.
\item {\tt bore\_radius} --- The bore radius of the magnet, in meters.
\item {\tt reference\_radius} --- The reference radius for the multipole output, in meters.
\item {\tt dx\_pole} --- The rms error, in meters, to be imparted to the horizontal position of each pole.
\item {\tt dy\_pole} --- The rms error, in meters, to be imparted to the vertical position of each pole.
\item {\tt dradius} --- The rms error, in meters, in the bore radius.
\item {\tt dx\_split} --- The rms error, in meters, to be imparted to the horizontal distance between the
  left and right sides of the magnet.
\item {\tt dy\_split} --- The rms error, in meters, to be imparted to the vertical distance between the
  top and bottom halves of the magnet.
\item {\tt dphi\_halves} --- The rms error, in radians, to be imparted to the relative rotation of the top
  and bottom halves of the magnet.
\item {\tt n\_cases} --- The number of cases to simulate (default is 1000).
\item {\tt n\_harm} --- The number of harmonics to simulate.  The default is 0, which results in computing
 all the harmonics for which Halbach indicates his treatment applies.
\item {\tt random\_number\_seed} --- The initial seed for the random number generator.  Should be a large integer.
\item {\tt long suppress\_main\_error} --- If non-zero, harmonics for the main multipole and lower orders are
  suppressed. It is implicitly assumed that these are correctable through alignment and calibration.
\end{itemize}

\item {\bf author:} M. Borland, ANL/APS.
\end{itemize}

\newpage
%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|sddsurgent|}\end{center}
%\end{latexonly}
\subsection{sddsurgent}

\begin{itemize}
\item {\bf description:} {\tt sddsurgent} uses algorithms from the program
US (by R. Dejus) and URGENT (by R. Walker) for computation of undulator
radiation properties, including power density and intensity distributions.

\item {\bf examples:}
Take particle data from a tracking run and compute the power density using a 1 mm by 1 mm pinhole
for a 72-period, 3.3-cm-period undulator set for a 5 keV first harmonic.
\begin{flushleft}{\tt
sddsanalyzebeam run.out -pipe=out -correctedOnly \\ 
 | sddsurgent -pipe=in power.sdds -electronbeam=current=0.025 \\
 -calc=method=dejus,mode=powerDensity -us \\
 -pinhole=dist=30,xsize=1,ysize=1,xnum=100,ynum=100 \\
 -undulator=period=0.033,number=72,energy=5e3
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt
sddsurgent {\em inputFile} {\em outputFile}
    [-calculation=mode={\em modeString},method={\em methodString},harmonics={\em integer}] 
    [-undulator=period={\em meters},numberOfPeriods={\em integer},
      kx={\em value},ky={\em value},phase={\em value},energy={\em eV}] 
    [-electronBeam=current={\em Amp},energy={\em GeV},spread={\em fraction},
      xsigma={\em mm},ysigma={\em mm},xprime={\em mrad},yprime={\em mrad},nsigma={\em number}] 
    [-pinhole=distance={\em m},xposition={\em value},yposition={\em value},
      xsize={\em value},ysize={\em value},xnumber={\em integer},ynumber={\em integer}]
    [-alpha=steps={\em integer},delta={\em value}] 
    [-omega=steps={\em integer},delta={\em value}] [-nphi={\em integer}] 
    [-us] [-photonEnergy=maximum={\em eV},minimum={\em eV},points={\em number}]
    [-nowarnings] [-coupling={\em value} | -emittanceRatio={\em value}] 
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\em inputFile} --- A Twiss output file from {\tt elegant}, with radiation integral 
calculations included, or an output from {\tt sddsanalyzebeam}. In the latter case, the
{\tt -correctedOnly} option should be used with {\tt sddsanalyzebeam}.
\item {\em outputFile} --- Contains the output data, which varies depending on the calculation mode.
 Use {\tt sddsquery} to view the file contents.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt pipe} --- The standard SDDS Toolkit pipe option.
\item {\tt -calculation=mode={\em modeString},method={\em methodString},harmonics={\em integer}} ---
 Choose which calculation to perform and what method to us, as well as the number of undulator harmonics to
  compute.  Values for {\em modeString} are
  \begin{itemize}
    \item {\tt 1 | fluxDistribution}:        Angular/spatial flux density distribution.
    \item {\tt 2 | fluxSpectrum}:            Angular/spatial flux density spectrum
    \item {\tt 3 | brightness | brilliance}: On-axis brilliance spectrum
    \item {\tt 4 | pinholeSpectrum}:         Flux spectrum through a pinhole
    \item {\tt 5 | integratedSpectrum}:      Flux spectrum integrated over all angles
    \item {\tt 6 | powerDensity}:            Power density and integrated power
  \end{itemize}
  Values for {\em methodString} are
  \begin{itemize}
    \item 1:                    Non-zero emittance; finite-N.
    \item 2:                    Non-zero emittance; infinite-N.
    \item {\tt 3 | WalkerFinite}:   Zero emittance;     finite-N.
    \item {\tt 4  | Dejus}:           Non-zero emittance; infinite-N + convolution (Dejus, with {\tt -us} only).
    \item {\tt 14 | WalkerInfinite}:    Non-zero emittance; infinite-N + convolution (Walker, with {-tt us} only).
  \end{itemize}
\item {\tt -emittanceRatio={\em value} | -coupling={\em value}} --- In the case of a twiss
 output file from {\tt elegant}, which does not contain the vertical emittance, one must
 supply one of these options.  If {\tt -emittanceRatio={\em R}} is given, $\epsilon_y = \epsilon_0*R$ 
 and $\epsilon_x = \epsilon_0$. If {\tt -coupling={\em k}} is given, $\epsilon_x = \epsilon_0/(1+k)$
 and $\epsilon_y = k*\epsilon_x$.  $\epsilon_0$ is the equilibrium emittance from the twiss output
 of {\tt elegant}.  

 In the case of twiss output from {\tt sddsanalyzebeam}, both emittances are present and these options
 are ignored.
\item {\tt undulator=period={\em meters},numberOfPeriods={\em integer},}\\ {\tt kx={\em value},ky={\em value},phase={\em value},energy={\em eV}]} --- 
 Specify undulator parameters.  If energy (of first-harmonic photons) is given, {\tt kx=0} and {\tt ky} is computed,
 corresponding to a horizontally deflecting undulator.
 {\tt phase} specifies the phase difference in degrees for a canted undulator.  
\item {\tt -electronBeam=current={\em Amps},energy={\em GeV},spread={\em fraction},}\\ {\tt xsigma={\em mm},ysigma={\em mm},xprime={\em mrad},yprime={\em mrad},nsigma={\em number}} specifies electron beam parameters.  Only the current is needed, as other data will be drawn from the input file.
 \begin{itemize}
   \item {\tt current} ---  electron beam current in A. (default is 0.1A).
   \item {\tt energy} ---   electron energy in Gev. (default is 7.0Gev).
   \item {\tt spread} ---   electron energy spread.
   \item {\tt xsigma} ---   horizontal RMS beam size (mm)
   \item {\tt ysigma} ---   vertical RMS beam size (mm)
   \item {\tt xprime} ---   horizontal RMS divergence (mrad)
   \item {\tt yprime} ---   vertical RMS divergence (mrad)
   \item {\tt nsigma} ---   no. of standard deviations of electron beam dimensions
     (size and divergence) to be included.
 \end{itemize}
\item {\tt -pinhole=distance={\em m},xposition={\em value},yposition={\em value},}\\ {\tt xsize={\em value},ysize={\em value},xnumber={\em integer},ynumber={\em integer}} --- Specifies pinhole parameters.
  Pinhole parameters are not needed for computing on-axis brilliance (i.e., mode=3). 
  \begin{itemize}
    \item {\tt distance} ---   distance from the source (m)  (distance=0.0 gives angular flux).
    \item {\tt xposition} ---  X-coordinate for center of pinhole (mm) or (mrad for distance=0) 
    \item {\tt yposition} ---  Y-coordinate for center of pinhole (mm) or (mrad for distance=0) 
    \item {\tt xsize} ---      X-size of pinhole (full width)	(mm) or (mrad for distance=0) 
    \item {\tt ysize} ---      y-size of pinhole (full width)	(mm) or (mrad for distance=0) 
    \item {\tt xnumber} ---    Number of subdivisions of pinhole in X (max 500) 
    \item {\tt ynumber} ---    Number of subdivisions of pinhole in Y (max 500) 
  \end{itemize}
\item {\tt nphi={\em number}} --- Specifies number of steps in phi between 0 and $\pi/2$. Must be less than 100.
  used in (calculation mode=1,2,3,4,5 calculation method=1,2).
\item {\tt alpha=steps={\em integer},delta={\em value}} --- Specifies the number of steps in angle alpha (gamma*theta) (<100). 
            Delta specifies range of angles in alpha$^2$ to be used, in units of 
            the angular equivalent to 1/N. Used in  (mode=1, method=1) and method=3.
\item {\tt omegasteps={\em integer},delta={\em value}} ---   Specifies the number of steps in 
            photon energy for the natural lineshape (<5000). 
            delta specifies range of photon energies to be included in the natural lineshape 
            in units (energy of fundamental/N).  The default value covers the range $\pm 2/N$
            of the natural lineshape. 
            Used in mode=2,3,4,5 method=1. 
\item {\tt photonEnergy=maximum={\em eV},minimum={\em eV},points={\em number}} --- 
  Specifies the maximum and minimum photon energy in eV, 
  and the number of energy points to be computed.
\end{itemize}

\item {\bf authors:} H. Shang, R. Dejus, M. Borland, X. Jiao (ANL).
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|smoothDist6|}\end{center}
%\end{latexonly}
\subsection{smoothDist6}

\begin{itemize}
\item {\bf description:} Increases the number of particles in a particle input file by
 sampling a simplified distribution based the input file.  Intended to be used to increase the number of particles
 produced by a photoinjector simulation to improve stability of CSR and LSC simulations.
 Can also add energy and density modulations for performing gain studies.

The algorithm is as follows:
\begin{enumerate}
\item Fit a 12$^{th}$-order polynomial to $p$ as a function of $t$.  Evaluate
 the polynomial at 10,000 equispaced points to generate a lookup table for the momentum
 variation with time.
\item Compute the standard deviation of the momentum $p_{sd}$ for blocks of 2,000 successive
 particles.  Fit this data with a 12$^{th}$-order polynomial and evaluate 
 it a 10,000 equispaced points to generate a lookup table for $p_{sd}$ as a function of $t$.
\item Create a histogram of $t$ and smooth it with a low-pass filter having a cutoff at
 0.1 THz.  This may resulting in ringing at the ends of the histogram, which is clipped off
 by masking with the original histogram. 
\item Optionally modulate the histogram H(t) with a sinusoid, by
 multiplying the histogram by $(1 + d_m) \cos 2\pi c t/\lambda_m$, where $d_m$
 is the modulation depth and $\lambda_m$ is the modulation wavelength. For non-zero $d_m$,
 this will result in a longitudinal-density-modulated distribution when the histogram is
 used as a probability distribution and sampled to create time coordinates.
\item Sample the time histogram $N$ times using a ``quiet start'' Halton sequence with
 radix 2, where $N$ is the number of desired particles.  The sampling
 operation is performed by first numerically computing the cumulative
 distribution function $C(t)=\int_{-\infty}^t H(t^\prime)
 dt^\prime/\int_{-\infty}^\infty H(t^\prime) dt^\prime$.  Inverting
 this to obtain $t(C)$, we generate each sample from $H(t)$ by
 evaluating $t(U)$, where $U$ is a quantity on the interval [0, 1] generated
 from the Halton sequence.
\item Create samples for other coordinates by quiet-sampling of gaussian distributions:
 \begin{enumerate}
 \item Scaled transverse coordinates $\hat{x}$, $\hat{x^\prime}$,
 $\hat{y}$, and $\hat{y^\prime}$ using Halton radices 3, 5, 7, and 11,
 respectively.  For convenience in scaling (step 9), these are defined such that the standard deviation of
 each coordinate is $10^{-4}$ and all coordinates are uncorrelated.
 \item Scaled fractional momentum deviation $\delta_1$ using Halton radix 13, with
 unit standard deviation.
 \end{enumerate}
\item Interpolate the look-up tables to determine the mean $p_{mean}$ and standard 
 deviation $p_{sd}$ of the momentum at each particle's time coordinate. Use these
 to compute the individual particle momenta using $p = p_{mean} + \delta_1 p_{sd}$.
\item Compute the projected transverse rms emittances and Twiss parameters for the original beam.
\item Transform the scaled transverse phase-space coordinates to give the desired 
 projected Twiss parameters in the x and y planes.  The x and y planes are assumed to be uncorrelated.
\end{enumerate}

\item {\bf synopsis:}
\begin{flushleft}{\tt
smoothDist6 -input {\em name} -output {\em name} -factor {\em number} -rippleAmplitude {\em \%} -rippleWavelength {\em microns} \
 -smoothPasses {\em num(500)} -energyMod {\em \%} -betaSlices {\em n}
}\end{flushleft}

\item {\bf files:}
\begin{itemize}
\item {\tt input} --- A particle distribution file, such as might be used with \verb|sdds_beam|.
\item {\tt output} --- A particle distribution file, such as might be used with \verb|sdds_beam|.
\end{itemize}

\item {\bf switches:}
\begin{itemize}
\item {\tt -factor {\em number}} --- Factor by which to multiply the number of particles.
\item {\tt -rippleAmplitude {\em value}} --- Density ripple amplitude, in percent.
\item {\tt -energyMod {\em value}} --- Energy modulation amplitude, in percent.  The wavelength is fixed at 1 $\mu$m.
\item {\tt -rippleWavelength {\em value}} --- Density ripple and energy modulation wavelength, in microns.
\item {\tt -betaSlices {\em n}} --- Number of longitudinal slices to use for analysis of twiss parameters.  The twiss parameters of 
the beam will vary step-wise from slice to slice.  This discontinuous variation may cause problems (e.g., unstable behavior).
\item {\tt -smoothPases {\em num}} --- Presently ignored.
\end{itemize}

\item {\bf author:} M. Borland, ANL/APS.

\item {\bf see also:} {\tt doubleDist6}
\end{itemize}

%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|TFBFirSetup|}\end{center}
%\end{latexonly}
\subsection{TFBFirSetup}

\begin{itemize}

\item {\bf description:} \verb|TFBFirSetup| computes FIR (Finite Impulse Response) filter
  coefficients for use with \verb|TFBDRIVER| elements to perform turn-by-turn transverse
  feedback. The method uses time-domain least-squares fitting \cite{Nakamura2004}.
  
\item {\bf examples:}
\begin{flushleft}{\tt
TFBSetup -twiss Basic.twi -pickup XPICKUP -driver XDRIVER -plane x -output xfb.param -terms 6
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt 
TFBFirSetup -twiss {\em twissFile} -pickup {\em elementName} -driver {\em elementName} -plane \{x|y\} 
-output {\em filename} -terms {\em numberOfTerms}
}\end{flushleft}

\item {\bf switches:}
\begin{itemize}
\item {\tt -twiss} --- A twiss parameter file from {\tt elegant}. 
The beamline used for the computations must include a \verb|TFBDRIVER| and
\verb|TFBFEEDBACK| element for the plane in question.
\item {\tt -pickup} --- Specifies the name of the pickup element in the lattice.
  One and only one occurrence of the element is required in the {\em twissFile}.
  Note that generally the name of the pickup should be all uppercase.
\item {\tt -driver} --- Specifies the name of the driver element in the lattice.
  One and only one occurrence of the element is required in the {\em twissFile}.
  Note that generally the name of the driver should be all uppercase.
\item {\tt -plane} --- Specifies the plane of the feedback.
\item {\tt -output} --- Specifies output filename to which FIR configuration is written.
  The file should be loaded with \verb|load_parameters|, e.g.,
\begin{verbatim}
&load_parameters
    filename = xfb.param,
    change_defined_values = 1
&end
\end{verbatim}
\item {\tt -terms } --- Number of terms in the filter, between 1 and 30, inclusive.
\end{itemize}

\item {\bf author:} M. Borland, ANL/APS.

\item {\bf acknowledgments:} H. Shang, C.-Y. Yao.

\end{itemize}


%\begin{latexonly}
\newpage
\begin{center}{\Large\verb|touschekLifetime|}\end{center}
%\end{latexonly}
\subsection{touschekLifetime}

\begin{itemize}

\item {\bf description:} \verb|touschekLifetime| computes Touschek
  lifetime using A. Piwinski's formula \cite{Piwinski, Xiao2007a}. A
  longitudinally non-Gaussian distributed bunch lifetime (such as ring
  with harmonic cavity) can be computed if the bunch profile is
  inputed through beam option.

\item {\bf examples:}
\begin{flushleft}{\tt
touschekLifetime aps.life -twiss=aps.twi -aper=aps.aper -part=2e10 -coupling=0.01 -length=6
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt 
touschekLifetime {\em outputFile}
 -twiss={\em twissFile} -aperture={\em momentumApertureFile} [-beam={\em beamProfile} | -sliceAnalysis={\em filename}] 
 {-charge={\em nC}|-particles={\em value}} \{-coupling={\em value}|-emityInput={\em value}\}
 {-RF=Voltage={\em MV},harmonic={\em value}[,limit] | -length={\em mm}} 
 [-emitInput={\em valueInMeters}] [-deltaInput={\em value}] [-verbosity={\em value}]
 [-ignoreMismatch] [-deltaLimit={\em valueInPercent}] [-method={\em 0|1}]
}\end{flushleft}

\item {\bf files:}
{\em outputFile} --- Contains resulting Touschek lifetime.

\item {\bf switches:}
\begin{itemize}
\item {\tt -twiss} --- A twiss parameter file from {\tt elegant}. 
You must use the \verb|radiation_integrals| flag in \verb|twiss_output|.
\item {\tt -aperture} --- A momentum aperture file from {\tt elegant}.
This file can contain a subset of elements of twissFile (for example:
only Quadrupole elements).  However, the Twiss and momentum aperture
files {\em must} cover the same beamline. Having one file for a part
of beamline (e.g., a few sectors) and one for the entire ring will
yield incorrect results.
\item {\tt -beam} --- Give beam profile file from elegant2genesis. If
  this option is given, other input beam parameters are ignored. You
  can use this option to compute touschek lifetime for a non-Gaussian
  longitudinally distributed bunch.
\item {\tt -sliceAnalysis} --- Give slice analysis file from the \verb|SLICE| element in \verb|elegant|.
 If this option is given, other input beam parameters are ignored. You
 can use this option to compute touschek lifetime for a non-Gaussian
 longitudinally distributed bunch.
\item {\tt -charge}, {\tt -particles} --- Give the charge (in nanocoulombs) or the
 number of electrons.
\item {\tt -emitInput} --- Give the initial total emittance in meters (if {\tt -coupling} is used) or
  the initial x emittance in meters (if {\tt -emityInput} is used)..  If not specified,
the value from the parameter \verb|ex0| in {\em twissFile} is used.
\item {\tt -coupling} --- Give the emittance coupling ratio, $\epsilon_y/\epsilon_x$.  This is
 used to compute the horizontal and vertical emittance from the natural emittance.
\item {\tt -emityInput} --- Give the vertical emittance in meters.
\item {\tt -deltaInput} --- Give the initial rms fractional momentum spread.  If not
specified, the value from the parameter \verb|Sdelta0| in {\em twissFile} is used.
\item {\tt -RF=Voltage={\em MV},harmonic={\em value}[,limit]} --- Specify rf voltage and harmonic number.
 The {\tt limit} qualifier, if given means that the momentum acceptance is limited by the bucket
 half-height.
 N.B.: If the data files cover only a portion of the ring, using this option will give incorrect results!
\item {\tt -length={\em mm}} --- Specify the rms bunch length.  This is an alternative to giving rf parameters.
\item {\tt -verbosity} --- If nonzero, program execution information is printed to the standard output.
\item {\tt -ignoreMismatch} --- If given, then mismatch of element names between the twiss and momentum
  aperture files is ignored.  May be useful if there are zero-length elements.
\item {\tt -deltaLimit} --- Give the maximum value for the momentum aperture, in percent.  If not specified,
  the values in the momentum aperture input file are used, possibly altered by the use of the
  {\tt -RF} option with the {\tt limit} qualifier.  If both {\tt -deltaLimit} and {\tt -RF=limit...} are
  given, the smaller is enforced.
\item {\tt -method} --- The integral of Piwinski's formula can be done
  in two ways. ``0'' - direct integral of parameter {\em $\tau$}, this
  method is also used in {\tt elegant}. 1 - substitute variable {\em
    $\tau$} with variable {\em k}, with $\tau=\tan^2(k)$. These two
  methods give you same results.
\end{itemize}

\item {\bf Note:} If using \verb|Pelegant| to compute the momentum aperture with \verb|output_mode=1|, it is necessary to first run the script
  \verb|reorganizeMmap| to put the data into the form needed by \verb|touschekLifetime|.

\item {\bf author:} A. Xiao, ANL/APS.

\end{itemize}

%\begin{latexonly}

\newpage
\begin{center}{\Large\verb|view3dGeometry|}\end{center}
%\end{latexonly}
\subsection{view3dGeometry}

\begin{itemize}

\item {\bf description:} Allows viewing the 3D geometry of a beamline using the freewrl viewer.

\item {\bf examples:}
To generate 3d data and view:
\begin{flushleft}{\tt
view3dGeometry -rootname aps -showNames ``*QUAD* *BEN*'' -showCoordinates ``*MON*''
}\end{flushleft}
To view again:
\begin{flushleft}{\tt
freewrl aps.x3d
}\end{flushleft}

\item {\bf synopsis:}
\begin{flushleft}{\tt 
view3dGeometry -rootname {\em string} -showNames {\em listOfElementTypes} -showCoordinates {\em listOfElementTypes} [-nviewpoints {\em number(10)}]
}\end{flushleft}

\item {\bf input files:}
  \begin{itemize}
  \item {\em rootname}.flr --- Contains floor coordinate output from {\tt elegant} (\verb|floor_coodinates| command).
  \item {\em rootname}.param --- Contains parameter output from {\tt elegant} (\verb|run_setup| command).
  \end{itemize}

\item {\bf output files:}
{\em rootname}.x3d --- Input data to freewrl.

\item {\bf switches:}
\begin{itemize}
\item {\tt -rootname} --- Gives the rootname of the run, used to identify the input and output files.
\item {\tt -showNames} --- Gives list of element types, with optional wildcards, for which the element name will be shown 
  in the viewer.  Default: ``*SBEN*''.
\item {\tt -showCoordinates} --- Gives list of element types, with optional wildcards, for which the local coordinate system will be
  shown in the viewer.  Default: ``MARK* WATCH*''.
\item {\tt nviewpoints} --- Number of viewpoints to generate and embed in file. Moving between viewpoints using keystroke commands
  is easier than ``flying'' using the keypad.
\end{itemize}

\item {\bf author:} A. Petrenko, BINP. (Modified by M. Borland.)

\end{itemize}

\newpage 

\section{Accelerator and Element Description}

As mentioned in the introduction, {\tt elegant} uses a variant of the
MAD input format for describing accelerators.  With some exceptions,
the accelerator description for one program can be read by the other
with no modification.  Among the differences:
\begin{itemize}
\item {\tt elegant} does not support the use of MAD-style equations to compute
the value of a quantity.  The \verb|link_elements| namelist command
can be used for this purpose, and is actually more flexible than the
method used by MAD.  Also, \verb|rpn|-style equations may be given
in double-quotes; these are evaluated once only when the lattice
is parsed.
\item {\tt elegant} does not support substitution of parameters in
beamline definitions.
\item {\tt elegant} contains many elements that MAD does not have, such
as kick elements, wake fields, and numerically integrated elements.
\item The length of an input line is not limited to 80 characters in 
{\tt elegant}, as it is in MAD.  However, for compatibility, any lattice
created by {\tt elegant} will conform to this limit.
\item The maximum length of the name of an element or beamline is 100 characters.
\end{itemize}

{\tt elegant}'s lattice parser translates all input into upper case,
except where the input is protected by double quotes.  However,
various commands (such as {\tt vary\_element} or {\tt link\_elements})
that accept element names as input do not perform any translation.
Hence, when referring to element names in commands, the user must
enter the names in upper case unless they are protected by double
quotes in the lattice file.  

When the lattice file is very complex, it is sometimes convenient to 
separate it into several files. These can then be imported into a main lattice file
using the \verb|#INCLUDE| directive, as in
\begin{verbatim}
#INCLUDE: part1.lte
#INCLUDE: part2.lte
\end{verbatim}

The rules for naming elements and beamlines are as follows:
\begin{itemize}
\item The name should start with an alphabetic character (i.e., a-z A-Z).
\item The name may contain any of the following characters in addition to
alphabetic characters and numbers: 
\verb#~ @ $ % ^ & - _ + = { } [ ] \ | / ? < > . : |\verb#
\item The name should not contain any of the following: \verb|# * ! `` ' `|
\item The name should not contain spaces, tabs, or non-printing characters.
\end{itemize}
If using unusual characters in a name, it is a good idea to enclose the name
in double quotes.   This is required if \verb|:| is in the name.

{\tt elegant}'s \verb|print_dictionary| command allows the user to
obtain a list of names and short descriptions of all accelerator
elements recognized by the program, along with the names, units,
types, and default values of all parameters of each element. 
The present output of this command is listed in the next section.
The reader is referred to the MAD manual\cite{MAD} for details on sign
conventions for angles, focusing strength, and so forth.  

Comments may be embedded in the lattice file by {\em starting} a line with 
an exclamation point (``!'').
Rpn expressions may be embedded separately
from an element definition by starting a line with a percent sign (``\%'').
For example
\begin{verbatim}
! Define Pi (actually "pi" is already defined, but this is just an example)
% 1 atan 4 * sto Pi
% Pi 40 / sto myAngle
! Define a rectangular bend for a ring with 80 equal bends
B1: SBEN,L=1.0,ANGLE="myAngle",E1="myAngle 2 /",E2="myAngle 2 /"
\end{verbatim}
Note that to use an RPN expression the value of a parameter, one must enclose the
expression in double quotes.

\subsection{Magnet Strength}

There are many conventions for specifying magnetic fields in terms of a multipole, polynomial, or Taylor expansion, which leads to
potential confusion.
In elegant (as in MAD\cite{MAD}), magnet strengths are specified in terms of Taylor series.
For normal multipoles and $y=0$, the expansion is
\begin{equation}
B_y(x,0)= \sum_{n=0}^\infty \frac{B_n x^n}{n!},
\end{equation}
where $B_0$ is the dipole, $B_1$ is the quadrupole, etc.
In general,
\begin{equation}
B_n = \left(\frac{\partial^n B_y}{\partial x^n}\right)_{x=y=0}.
\end{equation}
{\tt elegant} follows MAD \cite{MAD} in using a right-handed coordinate system $(x, y, z)$ 
in which $z$ is along the beam direction, $x$ is to the left, and $y$ is up.

This expansion for the normal multipole terms can be related to a multipole expansion that includes both normal and skew components.
In this convention, positive normal multipole coefficients give positive $B_y$
for $x>0$ and $y=0$. 
Rotating a positive normal multipole with $N$ poles $\pi/N$ clockwise about the vector along
the beam direction will convert it into a positive skew multipole.
As a result, for a positive skew multipole, $B_y$ will be non-negative and $B_x$ will be negative 
for $x>0$ along the line $\phi=\pi/N$.

We can satisfy these conventions if we write the scalar potential as
\begin{equation}\label{equ:potential}
V = \sum_{n=1}^{\infty} \frac{i A_{n-1} - B_{n-1}}{n!} (x + i y)^n e^{-in\Delta\phi},
\end{equation}
where, as we'll see, $A_m$ are skew components and $B_m$ are normal components for
a $2(m+1)$-pole.
The coordinates $(x, y)$ are in a right-handed system with the longitudinal coordinate $z$.
$\Delta\phi$ is the rotation angle of the magnet, where a clockwise rotation 
about the nominal trajectory corresponds to $\Delta\phi>0$.
The minus sign in $e^{-in\Delta\phi}$ is because we rotate the magnet while keeping the
coordinate system fixed.

The magnetic fields are 
\begin{equation} \label{equ:ByFull}
B_y = -\Im \frac{\partial V}{\partial y} =\Im \sum_{n=0}^\infty \frac{A_n + i B_n}{n!}(x+iy)^n e^{-i(n+1)\Delta\phi},
\end{equation}
and
\begin{equation} \label{equ:BxFull}
B_x = -\Im \frac{\partial V}{\partial x} =\Im \sum_{n=0}^\infty \frac{-iA_n + B_n}{n!}(x+iy)^n e^{-i(n+1)\Delta\phi},
\end{equation}

We can relate the coefficients to the $B_m$ quantities used in {\tt MAD} and {\tt elegant} by noting that
for $\Delta\phi=0$
\begin{equation}
B_m = \left(\frac{\partial^m B_y}{\partial x^m}\right)_{x=y=0} 
\end{equation}
and
\begin{equation}\label{equ:oddSign}
A_m = -\left(\frac{\partial^m B_x}{\partial x^m}\right)_{x=y=0}
\end{equation}
Note the minus sign in the last equation, which differs from commonly asserted conventions.

Multipole errors are typically specified as fractions of the main field harmonic at a reference radius $R$,
e.g., 
\begin{equation}
F_n  = \frac{K_n R^n / n!}{K_m R^m / m!},
\end{equation}
where $m$ is the main harmonic and $n$ is the error harmonic.

For electrons, the deflection from a thin element is
\begin{equation}
\theta(x,y=0) = \frac{1}{H} \int B(x,y=0) dl,
\end{equation}
where $H = B\rho = -p/e$ is the beam rigidity and $p=m_e c \beta\gamma$ is the momentum.
The geometric strengths $K_n$ are defined as
\begin{equation}
K_n = \frac{B_n}{H}.
\end{equation}
By convention in {\tt elegant}, a positive $K_n$ value deflects a particle at $x>0$ toward $x=0$.
E.g., a positive $K_1$ value indicates a horizontally focusing quadrupole.

\newpage
\section{Element Dictionary}

\include{dictionary}

%\newpage
%\include{ioneffects.tex}

\newpage
\section{Examples}

Example runs and post-processing files are available in a separate tar file.
The examples are intended to
demonstrate program capabilities with minimal work on the user's part.
However, they don't pretend to cover all the capabilities.

Each demo is (typically) invoked using a command (usually a C-shell
script) that can both run {\tt elegant} and post-process the output.
The post-processing is often handled by a lower-level script that is
called from the demo script.  These lower-level scripts are good
models for the creation of customized scripts for user applications.

The examples are organized into a number of directories and subdirectories.
In each area, the user will find a ``Notebook'' file (a simple ASCII file) that describes 
the example and how to run it.

Many examples for storage ring simulations reside in the {\tt PAR} subdirectory.
The PAR (Particle Accumulator Ring) is a small storage ring in the APS injector
that is good for quick examples because of its size.

Here's a helpful tip in searching the examples on UNIX/LINUX systems: suppose one wants
to find an example of the \verb|frequency_map| command.  One can search all the elegant
command files very quickly with this command:
\begin{verbatim}
find . -name '*.ele' | xargs fgrep frequency_map
\end{verbatim}
Similarly, to find all examples that use \verb|CSBEND| elements, one could use
\begin{verbatim}
find . -name '*.lte' | xargs fgrep -i csbend
\end{verbatim}

\include{examples}

\newpage
\section{The {\tt rpn} Calculator}

The program {\tt rpn} is a Reverse Polish Notation programmable
scientific calculator written in C.  It is incorporated as a
subprogram into {\tt elegant}, and a number of the SDDS programs.  It
also exists as a command-line program, {\tt rpnl}, which executes its
command-line arguments as {\tt rpn} operations and prints the result
before exiting.  Use of {\tt rpn} in any of these modes is extremely
straightforward.  Use of the program in its stand-alone form is the
best way to gain familiarity with it.  Once one has entered {\tt rpn},
entering ``help'' will produce a list of the available operators with
brief summaries of their function.  Also, the {\tt rpn} definitions
file \verb|rpn.defns|, distributed with {\tt elegant}, gives examples
of most {\tt rpn} operation types.

Like all RPN calculators, {\tt rpn} uses stacks.  In particular, it
has a numeric stack, a logical stack, and a string stack.  Items are
pushed onto the numeric stack whenever a number-token is entered, or
whenever an operation concludes that has a number as its result; items
are popped from this stack by operations that require numeric
arguments.  Items are pushed onto the logical stack whenever a logical
expression is evaluated; they are popped from this stack by use of
logical operations that require logical arguments (e.g., logical
ANDing), or by conditional branch instructions.  Items enclosed in
double quotes are pushed onto the string stack; items are popped from
this stack by use of operations that require string arguments (e.g.,
formatted printing).

{\tt rpn} supports user-defined memories and functions.  To create a
user-defined memory, one simply stores a value into the name, as in
``1 sto unity''; the memory is created automatically when {\tt rpn}
detects that it does not already exist.  To create a user-defined
function, enter the ``udf'' command; {\tt rpn} will prompt for the
function name and the text that forms the function body.  To invoke a
UDF, simply type the name.

A file containing {\tt rpn} commands can be executed by pushing the
filename onto the string stack and invoking the ``@'' operator.  {\tt
rpn} supports more general file I/O through the use of functions that
mimic the standard C I/O routines.  Files are identified by integer
unit numbers, with units 0 and 1 being permanently assigned to the
terminal input and terminal output, respectively.

\newpage

\section{Change Log\label{sect:changeLog}}

\subsection{Highlights of What's New in Version 2020.5}

Here is a summary of what's changed since release 2020.4.  Historical change logs are collected in Section
\ref{sect:changeLog}.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|SCATTER| element had a bug in the implementation of the \verb|ENDONPASS| parameter, which was being
  ignored if the value was \verb|0|.
\item The \verb|CCBEND| element had several misalignment-related issues. Most significantly, the \verb|ETILT| parameter was ignored.
  In addition, the sense of \verb|DX| and \verb|DY| was inverted when when the \verb|ANGLE| was negative. 
  As a result of these fixes, misalignment effects from \verb|CCBEND| will change. Setting \verb|ETILT=0| and
  \verb|DX_DY_SIGN=-1| will cause the code to revert to the old behavior.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item Frequency map analysis would crash in some circumstances when there was a \verb|CHARGE| in the beamline.
  This bug was reported by G. Penn (LBNL).
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|BGGEXP| element now supports both normal and skew components. R. Lindberg (APS) implemented the
  symplectic integrator option for this.
\item The \verb|BMAPXYZ| element now has a \verb|FSE| (Fractional Strength Error) parameter.
\item The \verb|RADIAL_ORDER| parameter of \verb|RFTMEZ0| can now be set to 0 to turn off radial dependence of
  fields.
\item The \verb|POLYSERIES| element was released, which allows transforming the beam using a set of arbitrary polynomials
  in the canonical coordinates.  This existed in the code but was not documented.
  It was developed by L. Emery (APS) and inspired by work of Y. P. Sun (APS).
\item The \verb|ETILT_SIGN| parameter for \verb|CSBEND|, \verb|CSRCSBEND|, \verb|RBEN|, and \verb|SBEN| now defaults
  to \verb|1|. The previous default of \verb|-1|, for backward compatibility, was potentially confusing.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item Added the \verb|change_start| command, which permits changing the starting location in a lattice.
  This was inspired by a request from Duan Zhe (IHEP).
\item The \verb|obstruction_data| command now supports multiple vertical planes of data.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}  Users are encouraged to check results against
the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The \verb|computeRBGGE| program was added, allowing computation of a generalized gradient expansion\cite{Venturini-NIMA427-387} for
  use with \verb|BGGEXP| based on field data on a rectangular boundary \cite{Mitchell-2007}. The code was developed by R. Lindberg (APS)
  with help from R. Soliday (APS) and M. Borland (APS).
\end{itemize}

\subsection{Highlights of What's New in Version 2020.4}

Here is a summary of what's changed since release 2020.3.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|TAPERAPC| element would mark all particles as lost when the \verb|RSTART| and \verb|REND| parameters
  had the same value. This was reported by forum user \verb|Cai_Meng|.
\item The \verb|FMULT| element had a bug that produced {\em very} invalid results with the \verb|FSE| parameter was non-zero,
  as reported by A. Xiao (APS). Also, the \verb|FSE| and other parameters were not influencing matrix-related computations
  if changed during a run.
\item Use of the \verb|XREADOUT| and \verb|YREADOUT| features of the \verb|MONI| element resulted in a message about
  undefined \verb|rpn| variables.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|load_parameters| command produced incorrect results in multi-step runs (i.e., \verb|n_steps|>1 in
\verb|run_control|) when a multi-page parameter file was used with multiple differential-mode load instructions
for the same element. This was reported by V. Sajaev (APS).
\item The \verb|HKICK|, \verb|VKICK|, and \verb|HVKICK| elements were not responding properly to the \verb|ramp_elements|
  and \verb|modulate_elements| commands. This was reported by V. Sajaev (APS).
\item A bug was fixed in \verb|ion_effects| that sometimes caused unphysical sigma values in the bi- and tri-gaussian
  fits. The bug was found and fixed by J. Calvey (APS).
\item A bug was fixed that resulted in a crash when \verb|coupled=1| was set for trajectory response matrix output
  from \verb|correction_matrix_output|.
\item A bug was fixed that resulted in a crash if a beamline definition contained unbalanced quotation marks.
  This was reported by X. Huang (APS).
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|CCBEND|, \verb|CSBEND|, \verb|FMULT|, \verb|KOCT|, \verb|KSEXT|, and \verb|KQUAD| now support 
  sixth-order symplectic integrators. The coefficients were provided by Y.P. Sun (APS), who also assisted in testing.
  The value of the \verb|N_KICKS| parameter may be reduced by a factor of $\sim$5 if the sixth-order integrator
  is used in place of the fourth-order integrator, with essentially identical results but a $\sim$30\% reduction
  in run time.
\item The \verb|APCONTOUR| element has two new parameters: \verb|STICKY| and \verb|CANCEL|. The \verb|STICKY|
  parameter results in the aperture contour being applied inside subsequent \verb|CCBEND|, \verb|CSBEND|, \verb|CSRCSBEND|,
  \verb|KQUAD|, \verb|KSEXT|, verb|KOCT|, and \verb|KQUSE| elements, as well as at the end of other downstream
  elements. This continues until another \verb|APCONTOUR| element asserts a new contour, or uses \verb|CANCEL=1|
  to cancel the feature.
  This improvement was inspired by forum user \verb|dondreka|.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item Added \verb|bpm_centroid| parameter to the \verb|run_setup| command. This provides a facility similar to the 
  \verb|centroid| parameter, but instead of giving the centroids at all elements, it gives them at the BPMs only.
  This was requested by X. Huang (APS).
\item The \verb|moments_output| command now provides additional quantities for optimization at \verb|MARK| locations.
  See the documentation for the \verb|MARK| element.
\item The \verb|modulate_elements| command now provides the ability to use the pass number to compute the time,
  which is helpful in simulations where the time is offset by \verb|CHANGE_T=1| on \verb|RFCA| elements.
\item Several improvements were made to the \verb|ion_effects| command by J. Calvey (APS).  The \verb|gaussianfit| option was added
  for the \verb|field_calculation_method| parameter; this provides a gaussian fit to model the ion fields, as an
  alternative to using gaussian statistics or more complex fitting functions. Also, a new parameter, \verb|ion_output_interval|,
  was added that allows increasing the interval between logging of ion data.
\item The \verb|correct| command accepts a new value, \verb|coupled|, for the \verb|method| parameter when 
  \verb|mode| is \verb|trajectory|. This allows trajectory correction in strongly-coupled transport lines.
\item The \verb|bunched_beam_moments| command was added. This command is virtually identical to the venerable
  \verb|bunched_beam| command, but instead of specifying the beam dimensions in terms of emittances, beta functions, etc.,
  the user provides beam moments (e.g., beam size, divergence, etc.).
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item The \verb|population_log| file produced by \verb|parallel_optimization_setup| erroneously recorded the
  values of the optimization variables in the wrong in an offset fashion. 
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}  Users are encouraged to check results against
the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item None.
\end{itemize}

\subsection{Highlights of What's New in Version 2020.3}

Here is a summary of what's changed since release 2020.2.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|KQUAD| and \verb|KSEXT| elements had a bug when computing beam moments with \verb|moments_output|
  if the \verb|XKICK| or \verb|YKICK| values were nonzero. This was reported by G. Penn (LBNL).
\item The \verb|MALIGN| was affecting floor coordinates, which actually doesn't make much sense. This was changed, but
  the prior behavior can be restored by setting \verb|FLOOR=1|.
\item Lost particle coordinates inside \verb|CSBEND| elements were recording the wrong value of the longitudinal coordinate.
  The reported coordinate was a mixture of the central path length and the individual particle's path length, whereas the
  correct coordinate should be just the central path length.
\item The \verb|FRFMODE| and \verb|TFRFMODE| elements had a bug that caused them to use up all the available
  file descriptors on a system when many such elements were inserted. This was reported by J. England (SLAC).
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item Issues were resolved with the computation of the \verb|s| coordinate for \verb|sigma| and \verb|centroid|
  output files when invoking backtracking mode from \verb|run_setup|.
\item The \verb|ion_effects| command had a bug in the automatic bin size selection code that could result in pathological changes in the
  bin size over several bunches. This was found and fixed by J. Calvey (APS).
\item When saving a lattice with \verb|output_seq=1|, \verb|RFCA| and other elements with the \verb|PHASE_REFERENCE| parameter
  would have this parameter set to very large values. This bug was reported by Z. Duan (IHEP).
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|SCRIPT| element can now be used in backtracking mode. See the manual page for details. This was requested
  by Y. Park (UCLA).
\item The \verb|MATTER| element now accepts \verb|PRESSURE| and \verb|TEMPERATURE| values, which are used to
  compute the density according to the ideal gas law, allowing easier simulation of scattering from gasses.
\item The \verb|CSBEND| element now supports steering fields via the \verb|XKICK| and \verb|YKICK| parameters.
  The \verb|FSE| and \verb|FSE_DIPOLE| parameters can also be used for horizontal steering.
\item The \verb|CCBEND| element now supports horizontal steering via the \verb|XKICK| parameter. One can also
  use the \verb|FSE| and \verb|FSE_DIPOLE| parameters.
\item The \verb|CSBEND| element now supports a new symplectic nonlinear edge model, developed by R. Lindberg (APS).
\item The \verb|BRAT| and \verb|BMXYZ| elements, which propagate particles through 3D field maps for
  bending and non-bending elements, respectively, now offer higher-order 2D interpolation as an alternative to the
  detail multi-linear interpolation. The also support storing the field data in single-precision arrays to reduce memory
  requirements.
\item The \verb|BRAT| and \verb|BMXYZ| elements now supports testing of particle locations against the global-coordinate obstruction
  contours specified by the \verb|obstruction_data| command.
\item The \verb|BRAT| element now supports floor coordinate transformations.
\item The \verb|TFBDRIVER| element now supports individual gain factors for each bunch. This was requested by
  M. Venturini (LBNL).
\item The \verb|BOFFAXE| element now supports a high-order off-axis expansion for $z$-dependent sextupole fields.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|twiss_output| command can now compute lattice functions for a half periodic cell, i.e., a 
  cell with mirror symmetry, by setting \verb|matched=-1|. This was inspired by a forum question from \verb|mcarla|.
\item The \verb|obstruction_data|  command now supports periodic replication of the obstructions for rings, as well
  as a global cap on the minimum and maximum vertical coordinates.
\item The \verb|tune_shift_with_amplitude| command now uses an improved 2D polynomial fitting routine in all the
  tracking-based modes. Discussions with Y.P. Sun (APS) motivated this change.
\item The corrector-pegging feature of the trajectory/orbit correction command \verb|correct| now works better.
  In particular, when a corrector is pegged, the iteration stops until the response matrix can be recomputed.
  Printouts and other output now reflect this.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}  Users are encouraged to check results against
the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item None.
\end{itemize}

\subsection{Highlights of What's New in Version 2020.2}

Here is a summary of what's changed since release 2020.1.  Historical change logs are collected in Section
\ref{sect:changeLog}.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|CSRDRIFT| element was not including longitudinal space charge as requested when CSR effects were turned
off.  This was reported by Y. Park (UCLA).
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The parameters file created by the \verb|run_setup| command had negative values for certain drift lengths when
backtracking was used.  This was reported by Y. Park (UCLA).
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item Added \verb|MIN_NORMAL_ORDER|, \verb|MAX_NORMAL_ORDER|, \verb|MIN_SKEW_ORDER|, and \verb|MAX_SKEW_ORDER| to the
\verb|KQUAD|, \verb|KSEXT|, and \verb|CCBEND| elements.  This allows easily restricting which systematic and random
multipole orders are included without changing the data files.
\item Added the \verb|T_REFERENCE| parameter to \verb|RFCW|, which is useful in backtracking in linacs.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item Added the \verb|obstruction_data| command, which permits specifying obstructions in global coordinates.  At
present, this is experimental and only enforced inside \verb|CSBEND|, \verb|KQUAD|, \verb|KSEXT|, \verb|KOCT|, and
\verb|KQUSE| elements, and at the end of elements.
\item Added the \verb|losses_include_global_coordinates| to the \verb|run_setup| command, which allows requesting that
the losses file contains global coordinates of lost particles (as opposed to only Frenet-Serret coordinates).
\item The \verb|closed_orbit| command now includes a parameter in the output file that indicates if the orbit
determination has failed.
\item Added the \verb|rfc_reference_output| parameter to the \verb|run_setup| command, which allows recording the
internally-determined reference times for \verb|RFCA| and \verb|RFCW| elements. This can be useful in improving
backtracking in linacs.
\item The \verb|error_element| command now supports using sampled values in an external files as the source for
perturbation values.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}  Users are encouraged to check results against
the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item \verb|sddsbrightness| now computes the undulator linewidth (FWHM).
\end{itemize}


\subsection{Highlights of What's New in Version 2020.1.1}

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item Edge effects are now correctly handled for the \verb|KQUAD| element in backtracking.
\item Improved backtracking for the \verb|CCBEND| element (Cartesian Canonically-integrated Bend). Backtracking
  for this element is still doubtful for large-angle dipoles with significant gradients.
\item The \verb|CCBEND| element now incorporates a path-length correction to ensure that the central path length
  in tracking is the same as the user-defined arc length. This prevents issues with rf cavity setup and closed orbit
  determination. V. Sajaev (APS) reported this bug.
\item The \verb|ETILT| parameter of the \verb|CSBEND|, \verb|CSRCSBEND|, \verb|SBEN|, and \verb|RBEN| elements was not
  implemented correctly. Although the magnitude of the trajectory error was correct, it had the wrong sign compared to the
  dynamic effects (e.g., vertical dispersion). This bug was reported by G. Penn (LBNL), who also reported an error in
  adjustment of the path-length when \verb|ETILT| was nonzero (no adjustment was made).
  A new parameter \verb|ETILT_SIGN| allows changing the sign convention to match that of \verb|TILT|.
\item The \verb|FSE_DIPOLE| and \verb|FSE_QUADRUPOLE| values were being left at the user-defined values when determining
  the reference trajectory when \verb|REFERENCE_CORRECTION=1|. This bug was reported by G. Penn (LBNL), and has been fixed.
\item The handling of the DC term in \verb|ZTRANSVERSE| was corrected. The code was ignoring the real part of the impedance
  at DC. The issue was pointed out by R. Lindberg (APS).
  The new script \verb|trwake2impedance| illustrates how to create a transverse impedance from a wake function using \verb|sddsfft|.
\item The handling of the DC term in \verb|ZLONGIT| was corrected.  In particular, the term needed to be multipled by 
  two internally.  The new script \verb|wake2impedance| illustrates how to create a longitudinal impedance from a wake 
  function using \verb|sddsfft|.
\item The matrix for the \verb|MULT| element, used in computation of twiss parameters and beam moments, was not being updated
  when parameters were changed during a run (e.g., with \verb|vary_element| or \verb|error_element|).
\item Synchrotron radiation was computed incorrectly for \verb|KQUAD| and \verb|KSEXT| elements when the \verb|HKICK| or
  \verb|VKICK| steering parameters were non-zero, as reported by G. Penn (LBNL).
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The namelist parser was improved so that it now detects a common error, namely, a missing (or incorrectly typed)
  \verb|&end| token.
\item The \verb|bunched_beam| command was giving inconsistent particle ID values between the serial and parallel versions
  when \verb|first_is_fiducial=1|, as reported by Duan Zhe (IHEP).
\item The \verb|twiss_output| command would fail to deliver data to the s-dependent driving terms output file if
  no file was giving for twiss parameters, as reported by forum user \verb|felix_armborst|. This is now flagged as an 
  error.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item Backtracking is now available for the \verb|RFCW| and \verb|LSCDRIFT| elements, as well as for \verb|CSRCSBEND| with
  \verb|STEADY_STATE=1|. The \verb|ENERGY| element can also be used in backtracking, and is essential in some cases to
  ensure matching reference energy profiles between forward and backward tracking; an example is provided in the
  examples collection.  Y. Park (UCLA) motivated the work and helped with testing.
\item Work began on a mechanism for summarizing warnings at the end of a run. At present, the summary is incomplete.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item Added more controls for mathematica-compatible output from the \verb|matrix_output|. In particular, it is now possible to
  put the output in separately-named files, which makes importation into mathematica much simpler.
\item Work began on a mechanism for summarizing warnings at the end of a run. At present, the summary is incomplete.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item Added the scripts \verb|wake2impedance| and \verb|trwake2impedance| to translate wake function data into a
  form accepted by the \verb|ZLONGIT| and \verb|ZTRANSVERSE| elements, respectively.
\end{itemize}

\subsection{Highlights of What's New in Version 2019.4.0}

Here is a summary of what's changed since release 2019.3.0.
Historical change logs are collected in Section \ref{sect:changeLog}.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|ILMATRIX| element lacked path-length terms related to the betatron amplitude, and 
  also did not properly handle non-zero $\alpha_{x,y}$ and $\eta_{x,y}^\prime$, as pointed out
  by forum user Teresia.
\item A bug was fixed in back-tracking for \verb|SBEN| elements with nonzero values for \verb|HGAP| and \verb|FINT|.
  This was reported by Y. Park (UCLA).
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|bunched_beam| command was not generating particle ID values when \verb|use_moments_output_values=1|,
  as reported by Z. Duan (IHEP). 
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item Added \verb|SPARSE_INTERVAL| parameter to the \verb|WATCH| element, to allow sparsing coordinate output
  with regular spacing.  This supplements the \verb|FRACTION| parameter, which provides random sampling, and the
  \verb|START_PID| and \verb|END_PID| parameters, which provide sampling of a subset defined by particle ID.
\item Added \verb|RPN_PARAMETERS| parameter to the \verb|SCRIPT| element, which directs the program to load
  SDDS parameter values from the script output file into \verb|rpn| variables, where they may be used for
  optimization. This provides the user the ability to perform script-based analysis of particle distributions and
  then optimize the results of that analysis.
\item The \verb|N_BINS| parameter of the \verb|WAKE| and \verb|TRWAKE| elements now defaults to zero, which
  prevents some undesirable behavior when warnings are overlooked. This was requested by R. Lindberg (ANL).
\item The \verb|EDRIFT|, \verb|EHVCOR|, \verb|EHCOR|, \verb|EVCOR|, \verb|CSBEND|, \verb|KQUAD|, \verb|KSEXT|, 
  \verb|KOCT|, and \verb|UKICKMAP| elements can now be used with back-tracking (see \verb|run_setup|).
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|chaos_map| command is now available. As the name suggests, it is similar to
  a frequency map, but provides other measures of chaotic motion. This includes a promising new
  approach outlined by Y. Li {\em et al.} \cite{Li-arxiv-1912.00121}.
\item The \verb|optimization_variable| command has a new parameter \verb|differential_limits|, which 
  permits specifying that the lower and upper limits are being given relative to the initial value,
  rather than in absolute terms.
\item The \verb|tune_footprint| command has a new parameter \verb|separate_xy_for_delta|, which permits
  specifying that tracking for the x and y momentum-dependent tunes should be done either in a combined 
  fashion (default) or separately. The latter might be helpful if nonlinear coupling of y motion into the x plane
  causes the x tune to be poorly determined for small x amplitudes.
\item Added \verb|egaussian| mode to the \verb|ion_effects| command. This mode results in computation of the fields
  from the electrons assuming a gaussian distribution, as normal, but determines the kick to the ions based purely on
  momentum conservation. This was inspired by the work of M. Blasciewicz (BNL) and implemented with J. Calvey (ANL).
\item Added \verb|multiple_ionization_energy_peak| and \verb|multiple_ionization_energy_rms| parameters to 
  the \verb|ion_effects| command, allowing control of the peak and rms energy of ions produced by multiple ionization.
  This was done by J. Calvey (ANL).
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item None.
\end{itemize}


\subsection{Highlights of What's New in Version 2019.3.0}

Here is a summary of what's changed since release 2019.2.1.
Historical change logs are collected in Section \ref{sect:changeLog}.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The matrix for the \verb|SBEN| element was incorrect when the length was negative (which is needed for
  back-tracking). A. Zholents (ANL) and Y. Park (UCLA) helped identify the problem.
\item The integrator used for the \verb|CSBEND| element with the expanded Hamiltonian (\verb|EXPAND_HAMILTONIAN=1|)
  was very inaccurate and yieled poor results unless \verb|N_KICKS| was large. This problem, pointed out by Z. Duan (IHEP),
  was fixed.
\item The interpolation used for \verb|UKICKMAP| would previously produce invalid values for particles near the upper ($y>0$) and
  left ($x>0$) edges of the grid. In essence, the interpolation assumed the kickmap was periodic in x and y.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item DA trimming (to make the \verb|xClipped| and \verb|yClipped| columns, as well as the \verb|Area| parameter)
  was not working properly in the parallel version for full-plane runs. This was fixed. In addition, the algorithm was improved for
  both the serial and parallel versions to iterate the trimming until it converges.
\item The multi-gaussian and multi-lorentzian feature of the \verb|ion_effects| command, added in the last release, proved unreliable, 
  as reported by B. Podobedov (BNL). Several improvements and bug fixes were implemented that should improve
  matters.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|SHRFDF| element was added, which models a deflecting rf cavity using a space harmonic expansion.
  This was implemented by Y.P. Sun (APS). See \cite{Sun-NAPAC19} for details.
\item The \verb|LSCDRIFT| element, which models longitudinal space charge, can now have its effective length
  set automatically to correspond to the length of the upstream element.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|run_setup| command has a new parameter, \verb|back_tracking|, which allows invoking a limited
  back-tracking capability. See the entry for \verb|run_setup| for more details.
  This is an experimental feature and users are encouraged to report problems to the forum.
\item The \verb|ion_effects| command was improved in several ways: 
  \begin{itemize}
  \item The default distribution fitting parameters were modified to give improved convergence
  \item The default distribution fitting criterion is now the sum of the maximum fractional absolute deviation over the histogram
    and the absolute fractional deviation of the ion charge. This makes it less likely that overfitting will result 
    in large spikes in the distribution.
  \item The new \verb|ion_histogram_max_bins| parameter allows restricting the maximum number of bins.
  \item The new \verb|ion_histogram_min_per_bin| parameter allows setting a requirement on the minimum number of 
    macro ions per bin.
  \item The new \verb|freeze_ions_until_pass| and \verb|freeze_electrons_until_pass| parameters allow ``freezing'' the motion of the
    ions and electrons until a specified pass number. This is useful for diagnostic purposes.
  \item The new \verb|pressure_factor| parameter allows multiplying all the pressure profiles by a common factor.
  \end{itemize}
\item The \verb|matrix_output| command can now print the full matrix in a form accepted by Mathematica.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item Some apparent MPI-related issues were resolved for the \verb|ion_effects| command.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The \verb|touschekLifetime| program now reports the value of \verb|deltaLimit| in the output file, whether that
  value is given explicitly or computed via the rf voltage.
\item Added the program \verb|sdds5x5sigmaproc|, which computes the 5x5 sigma matrix (i.e., all elements except those
  related to the time coordinates) from a quadrupole scan.
\end{itemize}

\subsection{Highlights of What's New in Version 2019.2.1}

Here is a summary of what's changed since release 2019.1.1.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item Fixed a bug in tracking-based matrix computation for \verb|CCBEND| that would result in the program hanging under
  some circumstances.
\item Fixed a bug in the implementation of the expanded Hamiltonian for \verb|MULT| elements.
\item Fixed a bug in the \verb|BMXYZ| element that caused a crash when multiple such elements were used.
\item If \verb|COUPLING| and \verb|EYREF| were both non-zero for an \verb|SREFFECTS| element, the \verb|EYREF|
  value would be ignored, which is potentially confusing. This issue is now flagged as an error.
  B. Podobodov (BNL) brought the issue to our attention.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|correct| command, which performs trajectory or orbit correction, would fail to output corrector
  data for both planes in some cases. This was fixed.
\item The \verb|correct| command, also had a bug in reporting the ``uncorrected'' trajectory in the trajectory output file.
  Instead of giving the uncorrected trajectory, it was giving the trajectory after the penultimate correction iteration.
  This was reported by forum user shancai.
\item The memory-efficiency of bucket assignments, invoked when using \verb|use_bunched_mode| in \verb|sdds_beam|,
  was improved, preventing crashes in some extreme cases for the serial version.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item Added the \verb|APCONTOUR| element, which provides an aperture or obstruction defined by an $(x, y)$ contour in an SDDS file.
\item Added the \verb|TAPERAPC| element, which provides a tapered circular aperture.
\item Added the \verb|TAPERAPE| element, which provides a tapered elliptical aperture.
\item Added the \verb|TAPERAPR| element, which provides a tapered rectangular aperture.
\item \verb|RFMODE| now allows ignoring particles that are outside the binning region, using the \verb|ALLOW_UNBINNED_PARTICLES|
  parameter.
\item The required format for \verb|MATR| (matrix from a text file) has changed slightly, as described on the manual page.
  The element also has a new parameter, \verb|FRACTION| that allows interpolating the matrix elements with the identity
  matrix as one endpoint.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|ion_effects| command now supports calculation of ion fields using a bi-gaussian distribution (sum of two
  gaussians) or bi-lorentzian distribution (sum of two lorentzians), as well as tri-gaussian and tri-lorentzian
  distributions. This which allows modeling the core and tails of the distribution more accurately. A number of parameters
  were added for control of fitting and output. J. Calvey (ANL) and R. Lindberg (ANL) co-developed this improvement.
\item The \verb|sdds_beam| command now offers control of which bunch is used for fiducialization of rf systems.
  It defaults to the first bunch (\#0), which is a change from the previous (and frequently confusing) behavior
  of fiducializing to the entire beam.
\item The \verb|aperture_search| command now allows full-plane computations, i.e., computations covering both $y\geq 0$ and
  $y<0$.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item None
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The \verb|touschekLifetime| program now reports the value of \verb|deltaLimit| in the output file, whether that
  value is given explicitly or computed via the rf voltage.
\item Added the program \verb|sdds5x5sigmaproc|, which computes the 5x5 sigma matrix (i.e., all elements except those
  related to the time coordinates) from a quadrupole scan.
\end{itemize}


\subsection{Highlights of What's New in Version 2019.1.1}

Note that following release 35.1.0, version numbers changed to the form {\em year}.{\em release}.{\em minor},
where {\em year} is the four-digit year, {\em release} is the consecutive release number for the year,
and {\em minor} is for internal APS use.

Here is a summary of what's changed since release 35.1.0.
Historical change logs are collected in Section \ref{sect:changeLog}.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|BMXYZ| element previously would inject particles at $z=0$ by default, which is usually not
  the desired behavior. Now, it injects at the start of the field map by default. The new \verb|INJECT_AT_Z0|
  parameter can be used to recover the old behavior. In addition, drift spaces are now automatically included
  to compensate for differences between the length of the field map and the user-defined insertion length.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|load_parameters| command with \verb|change_defined_values=0| 
  did not work correctly when combined with \verb|insert_elements| or \verb|replace_elements|.
  This was reported by G. Penn (LBNL).
\item The \verb|insert_elements| command would sometimes fail to insert all the intended elements when 
  \verb|insert_before=1| when insertion between consecutive elements was required.
  This was reported by G. Penn (LBNL).
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|BOFFAXE| element was added. It allows integrating through a magnetic field defined by an off-axis
  expansion from on-axis gradients. 
\item Transfer matrices are now automatically computed for \verb|BMXYZ| and \verb|BGGEXP| elements.
\item The \verb|CSBEND|, \verb|SBEND|, and \verb|CCBEND| elements now support separate fractional strength errors (FSE) for
  the dipole and quadrupole terms.
\item The \verb|HKPOLY| element now supports and alternative, more general form for the drift Hamiltonian.
\item The \verb|UKICKMAP| element now has a flag to indicate that the kickmap is for a single period of an insertion
  device, which makes it easier to configure. It also has a new parameter, \verb|KACTUAL|, for giving the $K$ value
  independent of the field factor (which is applied to the kickmap).
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|global_settings| command now allows setting the default step sizes for tracking-based determination
  of element-by-element matrices using the new \verb|tracking_matrix_step_size| parameter. The default values are
  the same as those used by the \verb|analyze_map| command.
\item The \verb|analyze_map| command now allows changing the number of points in each dimension and the maximum fit order.
\item the \verb|correct_tunes| command now allows specifying a list of quadrupoles to be excluded from the tune knob.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item Fixed a bug that resulted in crashing of tracking-based matrix computation for certain numbers of processors.
\item Fixed a bug in parallel hybrid simplex optimization, which would cause optimization to terminate prematurely if
  one processor encountered an invalid condition (e.g., undefined tunes).
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item None.
\end{itemize}

\subsection{Highlights of What's New in Version 35.1.0}

Here is a summary of what's changed since release 35.0.1.
Historical change logs are collected in Section \ref{sect:changeLog}.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The matrix for misaligned \verb|FMULT| elements was incorrect. The misalignment was applied twice.
\item The edge effects for \verb|KQUAD| were broken for tracking only in version 35.0.1. This was fixed.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The filter parameters (\verb|start_occurence|, \verb|end_occurence|, \verb|s_start|, \verb|s_end|, 
  \verb|after|, and \verb|before|)  of the \verb|steering_element| command now work better when multiple
  such commands are given. In particular, overlapping intervals are detected and non-overlapping intervals
  are correctly implemented.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|HKPOLY| element was added. It allows imparting kicks to the beam according to 
  a Hamiltonians that are polynomial functions of $(x, y)$ and $(qx, qy)$. R. Lindberg (APS) helped develop the
  concept for this element.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|correct| command has a new parameter, \verb|force_alternation| that forces orbit or trajectory correction
  to continue with x/y alternation regardless of whether one plane appears to have converged.
\item The \verb|set_reference_particle_output| command was added. It allows defining a reference set of particle coordinates
  to which tracked coordinates will be compared for purposes of optimization.
\item The \verb|optimization_setup| command now allows setting the interval (in terms of function evaluations) 
  between checks of the interrupt semaphore file. Previously, the file was checked only at the end of a simplex pass.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item None.
\end{itemize}

\subsection{Highlights of What's New in Version 35.0.1}

Here is a summary of what's changed since release 34.4.0.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The order of edge transformations for the \verb|CCBEND| element was revised to make more physical sense.
\item A bug was fixed in the expressions for integral-based fringe field effects in \verb|QUAD| and \verb|KQUAD|.
  The bug resulted in very small inconsistencies between the matrices when $K_1 \rightarrow -K_1$.
\item Some small errors were found and fixed in the linear fringe treatment for the \verb|KQUAD| and \verb|QUAD| elements.
  Thanks to X. Huang (SLAC) for pointing out the problem.
\item A bug was fixed in the \verb|NIBEND| element that resulted in incorrect edge effects for \verb|ANGLE<0|.
  This bug was apparently introduced in release 33.0.
\item The \verb|SCRAPER| element was not respecting changes to the \verb|DIRECTION| or \verb|INSERT_FROM| parameters 
  made outside the lattice definition (e.g., using \verb|alter_elements| or \verb|load_parameters|). In addition,
  the interpretation of the \verb|INSERT_FROM=''x''| and \verb|INSERT_FROM=''y''| was incorrect, since these were
  supposed to correspond to a scraper inserted from both sides. Both problems were reported by forum user 
  \verb|Youssef|.
\item The \verb|SPEEDBUMP| element was not respecting changes to the \verb|DIRECTION| or \verb|INSERT_FROM| parameters 
  made outside the lattice definition (e.g., using \verb|alter_elements| or \verb|load_parameters|).
\item The \verb|RFCA| element would bomb if no particles per present on a processor and \verb|CHANGE_T=1|. This
  was found upon investigating a problem reported by G. Penn (ALS).
\item The transport matrix for \verb|BGGEXP| was being computed only to first order, which resulted in erroneous
  values for chromaticity, for example. This was reported by R. Linbdberg (APS).
\item When \verb|CSRDRIFT| elements were divided using the \verb|divide_elements| command or \verb|element_divisions|
  parameter of the \verb|run_setup| command, the length was saved incorrectly to the \verb|parameters| file (requested
  from \verb|run_setup|). This was reported by Pau Gonzalez.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item None.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|CCBEND| element now was a \verb|YAW| parameter that permits changing the entrance and exit
  angles in a coordinated fashion. It also supports the \verb|FINT1|, \verb|FINT2|, and \verb|HGAP| parameters
  for soft-fringe effects, as well as explicit multipoles from octupole to 18-pole (in addition to the
  existing support for systematic multipole errors). The multipoles at the entrance and exit can now be
  specified separately, using the \verb|EDGE1_MULTIPOLES| and \verb|EDGE2_MULTIPOLES| parameters.
\item The \verb|FMULT| element, which provides a general multipole with content specified by an SDDS file, now
  affects matrix-based computations (e.g., twiss parameters, chromaticities, and transfer matrix).
\item The \verb|KSEXT| element now provides a parameter for a normal quadrupole error, in addition to the existing
  skew quadrupole error. The utility of this was pointed out by Y.-P. Sun (APS) and X. Huang (SLAC).
\item The \verb|BRANCH| element now provides periodic branching, which permits modeling a periodic bypass, for
  example. This improvement was triggered by a question from forum user \verb|simone.dimitri|.
\item The \verb|global_settings| command now has user overriding of default values, which means that whenever the user
  changes a value, it becomes the new default for any subsequent instances of the command in that run.
\item The \verb|RFMODE| element has additional features that help refine the agreement between the voltage obtained by 
  rf feedback and the effective voltage seen by the beam.
\item The \verb|WAKE| and \verb|TRWAKE| elements now accept acausal wakes, provided the user explicitly allows it with the 
  \verb|ACAUSAL_ALLOWED| parameter. This feature will be requested by R. Lindberg (APS).
\item The \verb|LSRMDLTR| and \verb|CWIGGLER| elements now include {\em experimental} capabilities providing a
  transverse gradient in undulators or wigglers. In both cases, hard-to-correct residual trajectory and dispersion 
  effects are seen, which are not yet understood. For this reason, these features are considered experimental.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|matrix_output| command has two new parameters
  \begin{itemize}
    \item \verb|print_element_data| controls whether the element data is printed in addition to the matrices. 
    \item \verb|printout_format| allows controlling the format of the printed elements.
    \end{itemize}
\item The \verb|analyze_map| command has a new parameter, \verb|printout_format|, allows controlling the format of the printed elements.
\item The \verb|correct_tunes| command has a new parameter, \verb|update_orbit|, which allows controlling whether the orbit
  is updated during correction. The need for this arose from a problem encountered by I. Agapov (DESY).
\item The \verb|chromaticity| command has a new parameter, \verb|update_orbit|, which allows controlling whether the orbit
  is updated during correction.
\item The tracking used for matrix determination for elements, such as \verb|CCBEND|, \verb|BGGEXP|, and others, that rely on this,
  now takes advantage of parallel resources if \verb|Pelegant| is used. This feature can be controlled using the newly-added
  \verb|parallel_tracking_based_matrices| control in \verb|global_settings|. The \verb|global_settings| command also
  now offers the ability to control the number of points per phase space dimension that are used in matrix fitting, 
  via the \verb|tracking_matrix_points| parameter. The default value of this parameter has been set to 9---an increase from
  the minimalist value of 5 used in previous versions---in order to improve accuracy. Forum posts
  by J. Bj{\"o}rklund Svensson (MAX-Lab) helped spur work on these features.
\item The \verb|insert_sceffects| command now supports averaging of beam size data turn-by-turn to reduce noise in 
  transverse space charge simulation in rings, via the new \verb|averaging_factor| parameter.  This was suggested by 
  V. Kornilov (GSI).
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The \verb|FTABLE| method for integration through 3D magnetic field maps now works in the \verb|abrat|
  program via the \verb|-ftable| commandline option. Previously, the control existed but resulted in no transformation
  of particles taking place.
\item The program \verb|abrat| now supports interpolation among multiple 2D field maps, which
  can be used, for example, to find the operating point in a magnet for which the field scales differently with
  current in different regions.
\item For the \verb|longitCalcs| script, the calculation of rf bucket height sometimes failed when a harmonic voltage
  was present; this was fixed. Also, the option to run without the GUI and put all results in a file was added.
\item The \verb|makeWigglerFromBends| script now includes the ability to add a gradient and specify the beam energy.
\item A new program, \verb|sdds4x4sigmaproc| is included that allows processing beam moments measurements from a
  quadrupole scan in a transport line to determine the 4x4 sigma matrix. 
\end{itemize}


\subsection{Highlights of What's New in Version 34.4.0}

Here is a summary of what's changed since release 34.3.0.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|FTABLE| method for integration through 3D magnetic field maps now works in the \verb|BRAT|
  element via the \verb|USE_FTABLE| control. Previously, the control existed but resulted in no transformation
  of particles taking place.
\item The \verb|YAW| and \verb|PITCH| parameters of the \verb|LTHINLENS| and \verb|LMIRROR| elements were overwriting
  the \verb|TILT| parameters of the same elements. 
\item The \verb|B7| and \verb|B8| parameters of the \verb|CSRCSBEND| elements were overwriting the \verb|B6| parameter
  of the same element.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|share_tracking_based_matrices| feature, controlled by the \verb|global_settings| command, now
  works correctly. This can provide a considerable increase in performance when tracking-based matrices are
  required for many beamline elements.
\item The \verb|insert_sceffects| command  and \verb|SCMULT| element, used for space-charge simulation in rings,
  had a bug that caused the sign of the tune shift to be wrong for protons and positrons. This was reported by
  forum user \verb|hongjin|.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item \verb|MARK| elements with \verb|FITPOINT=1| now create \verb|psix| and \verb|psiy| symbols for use in
  optimization, in addition to \verb|nux| and \verb|nuy|. This may be more intuitive for some users, as pointed
  out by forum user \verb|jgarland|.
\item When used for longitudinal feedback, the \verb|TFBDRIVER| element now includes simulation of the 
  feedback cavity resonance and driving circuit, using a circuit model developed by T. Berenc (APS).
\item When K. Hwang's fringe model is used for the \verb|CSBEND| element, automatic adjustment of the \verb|FSE|
  value can optionally be invoked in order to null out trajectory errors that result from the fringe fields extending outside
  the magnet. This is obtained by setting \verb|FSE_CORRECTION=1|.
\item The \verb|TRACKING_MATRIX| parameter of \verb|CSBEND| can now be used to control the order of the tracking-based
  matrix, with a limit of third order. This provides an alternative to the 2nd-order analytical matrix.
\item The \verb|CSBEND| element now supports separate edge integral values for the entrance and exit fringes, using the
  \verb|FINT1| and \verb|FINT2| parameters. If not given, the \verb|FINT| parameter is used as before.
\item The \verb|CSBEND| and \verb|CSRCSBEND| elements now support a new symplectic edge effects mode, based on 
  the linear approach of K. L. Brown. It is similar to the existing, non-symplectic default mode, but in most cases
  users won't see a difference.
\item The \verb|CSBEND|, \verb|KQUAD|, \verb|KSEXT|, \verb|KOCT|, \verb|KQUSE|, and \verb|MULT| elements now support use
  of the expanded (to leading order) Hamiltonian by setting the \verb|EXPAND_HAMILTONIAN| flag to 1. Note that no significant
  reduction in run time is observed with the expanded Hamiltonian.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The \verb|FTABLE| method for integration through 3D magnetic field maps now works in the \verb|abrat|
  program via the \verb|-ftable| commandline option. Previously, the control existed but resulted in no transformation
  of particles taking place.
\item The program \verb|abrat| now places the vertex, entry, and exit points (which are provided by the user)
  in the trajectory output file.
\end{itemize}


\subsection{Highlights of What's New in Version 34.3.0, June 14, 2018}

Here is a summary of what's changed since release 34.2.0.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|CCBEND| element had incorrect signs for the odd-order systematic multipoles when the bending
  angle was negative. There was also an issue with incorrect ordering of edge effects and coordinate transformations.
  R. Lindberg (APS) helped identify these problems.
\item The \verb|KQUAD| element had an issue with the order of the submatrices used for linear edge effects when
  tracking. This would cause small tune errors in tracking compared to the results of \verb|twiss_output|.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The beta-function scaling resulting from the \verb|twiss_scaling=1| setting
  for the \verb|elastic_scattering| command was incorrect. Although the tracking results would be correct,
  this made it more difficult to optimize run time.
\item The \verb|rf_setup| command now handles $\alpha_c<0$, a deficiency that was reported by P. Piot (NIU/FNAL).
  It also now uses $\eta = \alpha_c - 1/\gamma^2$ instead of $\alpha_c$, though this rarely makes a significant
  difference.
\item The computation of exact normalized emittances, requested with the \verb|global_settings| command,
  had several issues that were fixed. First, the values assigned to the horizontal and vertical corrected and
  uncorrected emittances were permuted. Second, in the serial version, the corrected emittances (with dispersive
  terms removed) were computed incorrectly. This would impact the \verb|sigma| and \verb|final| files from
  the \verb|run_setup| command. J. Bj{\"o}rklund Svensson (MAX-Lab) reported problems that helped find these
  bugs.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item \verb|CCBEND| has a new parameter, \verb|EDGE_ORDER|, that allows controlling the order of edge kicks.
\item \verb|BRANCH| has a new parameter, \verb|DEFAULT_TO_ELSE|, which allows determining how the element
  behaves when tracking for closed orbits and the like. 
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|configuration| command-line argument was added, which allows specifying a configuration file
  to be read before processing the input file. This file can also be specified with the \verb|ELEGANT_CONFIGURATION|
  environment variable.
\item The \verb|floor_coordinates| command now creates additional columns in the output file, giving data on
  the next element in the lattice. Given that data is only provided at the end of elements, this provides
  an easier way to determine information at the start of elements.
\item The \verb|insert_elements| command now has a parameter, \verb|insert_before|, that allows controlling whether
  elements are inserted before or after (default) the specified locations.
\item The \verb|elastic_scattering| command now includes data that indicates warning conditions in the file
  specified by \verb|log_file|.
\end{itemize}

\subsubsection{Changes Specific to the MPI Parallel Version}

\begin{itemize}
\item Read buffering was re-enabled for parallel I/O to avoid performance problems on GPFS file systems.
  Write buffering is still disabled, since this seems to prevent data corruption on some file systems.
  Users may wish to configure this for their file system using the new \verb|ELEGANT_CONFIGURATION| 
  environment variable.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The scripts \verb|elasticScatteringAnalysis| and \verb|inelasticScatteringAnalysis|---which are used to
  analyze data from the \verb|elastic_scattering| and \verb|inelastic_scattering| commands---were replaced with
  compiled programs of the same name, giving a large reduction in run time.
\item The script \verb|longitCalcs|, which does rf calculations using an output file from \verb|twiss_output|, 
  now supports a commandline mode that is convenient for use in other scripts.
\item The script \verb|computeQuadFringeIntegrals| was added. It computes the fringe integrals and effective
  length for a quadrupole from gradient vs z data, producing a file suitable for configuring \verb|KQUAD| elements.
\item A bug was fixed in \verb|elegant2astra| that would affect results for particles that are not
   highly relativistic. Forum user Biaobin reported the bug and provided the fix.
\item A bug was fixed in \verb|smoothDist6s| that resulted in strange longitudinal phase space when the 
  average value of \verb|t| was very large compared to the spread in \verb|t|. Forum user \verb|Marcello| reported
  the bug.
\end{itemize}

\subsection{Highlights of What's New in Version 34.2.0, March 22, 2018}

Here is a summary of what's changed since release 34.1.
Historical change logs are collected in Section \ref{sect:changeLog}.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|frequency_map| command was incorrectly computing the diffusion rate as 
\begin{equation}
  d_r = \frac{\log_{10} \left(\Delta\nu_x^2 + \Delta\nu_y^2\right)}{N},
\end{equation}
instead of
\begin{equation}
  d_r = \log_{10} \left(\frac{\Delta\nu_x^2 + \Delta\nu_y^2}{N}\right),
\end{equation}
\item The \verb|coupled_twiss_output| command would sometimes crash when \verb|calculate_3d_coupling=0|. 
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item None.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|global_settings| command has two new fields, \verb|mpi_io_force_file_sync| and \verb|usleep_mpi_io_kludge|,
  which can be used to solved MPI I/O problems that appear on some file systems. Z. Pan (LBNL) brought the problems to our
  attention.
\item The \verb|floor_coodinates| command now ignores \verb|MAXAMP| elements when computing combined vertex points
  of strings of dipoles.
\item The \verb|coupled_twiss_output| command did not compute the tunes of the two modes, as pointed out by
  G. Wei (TJNAF). This was addressed with assistance from V. Sajaev (APS).
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The program \verb|sddsbrightness| now correctly includes the effect of $J_x$ and $J_y$ on the x and y emittances
  when the \verb|-coupling| option is used.
\item Added the script \verb|parmela2elegant|, to convert PARMELA beam data (ASCII format) to a form
  acceptable by \verb|elegant|.
\item Fixed error in the atomic mass of CO$_2$ in the script \verb|ionTrapping|.
\end{itemize}


\subsection{Highlights of What's New in Version 34.1.0, 27 February 2018}

Here is a summary of what's changed since release 34.0.
Historical change logs are collected in Section \ref{sect:changeLog}.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item Restored the long-deprecated \verb|DIRECTION| parameter for the \verb|SCRAPER| element, as a convenience.
\item Fixed a problem that caused the \verb|SCRIPT| element to sometimes hang up in \verb|Pelegant| if some processors 
  did not have any particles after loading data from the script output file.
\item The \verb|UKICKMAP| element would sometimes fail to add synchrotron radiation effects during tracking even if asked; this would
  happen, for example, if there was no \verb|twiss_output| or \verb|matrix_output| command.
\item The \verb|WIGGLER|, \verb|UKICKMAP|, \verb|CWIGGLER|, and \verb|GFWIGGLER| elements had an inconsistency in radiation
  integral computations, in that in some cases $gamma$ was used when $\beta\gamma$ was intended. The differences were very
  small for any practical case.
\item The \verb|BRAT| element and the \verb|abrat| commandline program for tracking particles through 3D field distributions
  had an error in the initial coordinate transformation, discovered by R. Lindberg (APS). In practical use, the error seems
  to have had a negligible effect on results.
  Also, the element was treated as a drift for matrix computations; now, the matrix is determined by tracking (which can
  be time-consuming).
\item Synchrotron radiation calculations for \verb|KQUAD|, \verb|KSEXT|, and \verb|KOCT| had a bug that resulted in only
  the last component being computed. For example, if steering or higher multipoles were included, those would override 
  the effect of the main field.
\item Previously, when the \verb|KQUAD| element was split (with the \verb|divide_elements| command or
  \verb|element_divisions| in the \verb|run_setup| command), soft-edge effects would be replicated at the
  interior boundaries. This was fixed.
\item Soft-edge effects on the \verb|KQUAD| element were not exactly symmetric. This would, e.g., introduce a slight
  asymmetry into an otherwise symmetric lattice. This has been fixed.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|rf_setup| command could not handle $\alpha_c<0$, as discovered using files provided by P. Piot (NIU/FNAL).
  This was fixed.
\item The \verb|analyze_map| command would crash if SDDS output was not requested. This was fixed.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|CCBEND| element, which integrates symplectically in Cartesian coordinates
  through a straight-pole combined-function bending magnet, was added.
\item The \verb|BMXYZ| element, which integrates particles through straight-element 
  3D magnetic field maps, now includes misalignment parameters.
  Multiple \verb|BMXYZ| elements that use the same field map will share the data internally to reduce I/O and memory requirements.
\item The \verb|EHKICK|, \verb|EVKICK|, and \verb|EHVKICK| elements now include the \verb|RANDOM_MULTIPOLE_FACTOR| and 
  \verb|SYSTEMATIC_MULTIPOLE_FACTOR| parameters.
\item The \verb|BGGEXP| element can now handle bending magnets. The non-symplectic integrator was replaced with 
  a new method that is more accurate. R. Lindberg (APS) did most of the work on this.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item During tracking, particles are no long checked against apertures after transitioning through zero-length elements that
  don't modify the aperture. This improves performance in lattices with many \verb|MONI|, \verb|MARK|, and similar elements.
\item The \verb|analyze_map| command can now output the matrix in SDDS format to second or third order, on request.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The program \verb|sddsbrightness| now correctly includes the effect of $J_x$ and $J_y$ on the x and y emittances
  when the \verb|-coupling| option is used.
\item Added the script \verb|parmela2elegant|, to convert PARMELA beam data (ASCII format) to a form
  acceptable by \verb|elegant|.
\item Fixed error in the atomic mass of CO$_2$ in the script \verb|ionTrapping|.
\end{itemize}

\subsection{Highlights of What's New in Version 34.0, 31 October 2017}

Here is a summary of what's changed since release 33.1.1.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item A bug in the \verb|IONEFFECTS| element was reported by J. Cavley (APS): when only one bunch was present,
  the electron beam coordinates were zeroed out.  
\item A bug in the \verb|WATCH| element caused \verb|elegant| to crash in \verb|centroid| and \verb|parameter|
  mode when the \verb|WATCH| element was in a beamline branch that did not get executed on the first pass.
\item In multi-step runs, the \verb|STEERING_MULTIPOLES| input for the \verb|EKICK|, \verb|EHKICK|, and \verb|EVKICK| elements
  was ignored except on the first step.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item A bug in the \verb|ion_effects| command was reported by J. Cavley (APS): when only one bunch was present,
  the electron beam coordinates were zeroed out. 
\item The \verb|center_arrival_time| feature of \verb|sdds_beam| did not work correctly for the parallel version, as
  reported by Jonas Bj{\"o}rklund. 
\item The \verb|use_moments_output_values| qualifier of the \verb|bunched_beam| command did not work for the parallel
  version. 
\item The \verb|full_grid_output| mode of the \verb|frequency_map| command provided incorrect results for the
  diffusion for particles that got lost.
\item The \verb|parameters| output file from the \verb|run_setup| command incorrectly reported the length and angle
  of \verb|CSBEND| elements when element division was invoked. This was reported by V. Sajaev (APS).
\item The \verb|amplification_factors| command now respects \verb|link_elements| commands.
\item The \verb|tune_footprint| command now optionally runs in major action command mode. The inability to do so
  was pointed out by Y.-P. Sun (APS).
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The long-deprecated \verb|DIRECTION| parameter of the \verb|SCRAPER| element has been removed; input files using the
  \verb|SCRAPER| element will  need to be updated to remove this parameter and replace it with
  equivalent \verb|INSERT_FROM| parameter.
  One result is that the \verb|SCRAPER| element can now support two-sided scrapers.
\item Added the \verb|SYSTEMATIC_MULTIPOLE_FACTOR|, \verb|RANDOM_MULTIPOLE_FACTOR|, and \verb|STEERING_MULTIPOLE_FACTOR|
  parameters to the \verb|KQUAD|, \verb|KSEXT|, and \verb|KOCT| elements. These allow multiplying each of the indicated 
  higher multipole contributions by a factor.
\item Added \verb|YAW| and \verb|YAW_END| parameters to \verb|UKICKMAP| element. It's useful in simulating canted insertion
  devices.
\item Added the \verb|SPEEDBUMP| element, which provides a new kind of aperture formed by a semi-circular bump 
  protruding from one or both sides of the chamber.
\item Added the \verb|DX|, \verb|DY|, and \verb|DZ| misalignment parameters to the \verb|EHKICK|, \verb|EVKICK|, and \verb|EKICK|
  elements. Also added \verb|RANDOM_MULTIPOLES| parameter.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item Added the \verb|inelastic_scattering| command, which assists in computation of the inelastic gas scattering
  lifetime and the distribution of lost particles. This is only available in the parallel version.
\item Added the \verb|generation_interval| parameter to the \verb|ion_effects| command to permit generation of
  ions only at every n$^{th}$ bunch. This was suggested by J. Calvey (APS).
\item Added the \verb|ignore_elements| command, which allows instructing \verb|elegant| to ignore specified elements
  in tracking. This can reduce overhead from ``do-nothing'' elements like markers and monitors.
\item The \verb|link_elements| command can now create the source element name by editing the target name.
\item The \verb|momentum_aperture| command now uses resources more efficiently for the parallel version when 
  \verb|output_mode=2|. In particular, it honors the user-provided minimum $\delta$ values.
  In addition, the domain decomposition was revised to better equalize the workload of the processors.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to check results against the serial or parallel versions and report issues to the developers.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item Added the \verb|inelasticScatteringAnalysis| script, a companion to the \verb|inelastic_scattering| command in
  \verb|Pelegant|. It allows computing the lifetime and local loss rates from inelastic gas scattering.
\end{itemize}


\subsection{Highlights of What's New in Version 33.1.1, 25 July 2017}

Here is a summary of what's changed since release 33.0.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|BGGEXP| element had a bug that prevented it from working when two elements
  used the same data file. This was fixed.
\item The \verb|BGGEXP| element refused to run if $m=1$ (dipole) was the main multipole, which
  prevented modeling wigglers. This was reported by forum user \verb|Ji_Li| and was fixed.
\item The \verb|RFDF| element had a bug in computing the energy-dependence of the time of flight,
  as reported by Daniel Marx. This was fixed. The missing phase reference feature was also implemented.
\item Using the third-order matrix of the \verb|QUAD| element with \verb|RADIAL=1| would result in a crash.
  This was fixed. Forum user \verb|meisal| reported the bug.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item Fixed a bug in \verb|load_parameters| related to the \verb|allow_missing_elements| and \\ \verb|allow_missing_parameters|
  qualifiers. In runs with multiple \verb|load_parameters| commands, only the last values of these parameters were used.
\item Fixed a bug in saving parameters when elements are subdivided: the lengths of certain elements were incorrect in
  the saved file.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|IONEFFECTS| element and the companion \verb|ion_effects| command were added. These allow simulation
  of the interaction of the beam with residual gas ions. J. Calvey (ANL) did much of the work on these new features.
\item Added \verb|SLICE| element to provide turn-by-turn slice analysis.
\item The \verb|CSBEND| element now includes skew multipole errors up to eighth order. This involves newly-computed expressions for the
  fields in curvilinear coordinates, so slight numerical changes may be seen.
\item The \verb|KSEXT| and \verb|SEXT| elements now support a skew-quad correction term. This was suggested by Z. Duan (IHEP).
\item Synchrotron radiation effects were added to the \verb|BGGEXP| element, so that radiation effects from essentially 
  arbitrary fields can be included in both tracking and \verb|moments_output| calculations. There are limitations as
  described in the manual page.
\item Improvements were made to memory management for numerous elements, chiefly \verb|CSBEND|, \verb|CSRCSBEND|,
  \verb|CWIGGLER|, \verb|FRFMODE|, \verb|FTRFMODE|, \verb|RFMODE|, \verb|SLICE|, \verb|TFBDRIVER|, \verb|TRFMODE|,
  \verb|ZTRANSVERSE|, and \verb|ZLONGIT|. This can dramatically decrease memory usage in some cases.
\item The \verb|TFBPICKUP| and \verb|TFBDRIVER| elements (used for turn-by-turn feedback) now have start- and end-pass controls.
\item The \verb|MATTER| element now has start- and end-pass controls.
\item To improve performance and simplify the code, the \verb|SQRT_ORDER| parameter on the \verb|CSBEND|, 
  \verb|FMULT|, \verb|KOCT|, \verb|KQUAD|, \verb|KQUSE|, and \verb|KSEXT| elements is now nonfunctional.
  The default behavior (exact square roots) is unchanged.
\item The \verb|BMXYZ| element now has the option for classical synchrotron radiation. It can also check the
  divergence and curl of the fields to assess the quality of the field solution.
\item Added the \verb|BX| and \verb|BY| parameters to the \verb|BGGEXP| element, to allow imposing a uniform ``external''
  magnetic field. 
\item It is now possible to interleave zero-length \verb|LSCDRIFT| elements with \verb|CSRCSBEND| elements with
  CSR fields building up through the successive \verb|CSRCSBEND| elements. This was added following a related
  forum post by Aaron Fetterman.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item Added the \verb|elastic_scattering| command, which assists in computation of the elastic gas scattering
  lifetime and the distribution of lost particles. This is only available in the parallel version.
\item Added \verb|bpm_output| option to the \verb|correct| command, which provides optional output of beam position monitor
  readings after orbit or trajectory correction. This was suggested by V. Sajaev (APS).
\item The \verb|twiss_output| command now records the location of the acceptance-limiting apertures in parameters
  \verb|AxLocation| and \verb|AyLocation|.
\item The \verb|track| command has a new field, \verb|interrupt_file|, which gives the name of a file to monitor
  as a semaphore to interrupt the tracking. If the file is created or updated during tracking, then tracking will
  terminate on completion of the next pass.
\end{itemize}

\subsubsection{Changes Specific to Parallel Version}

\begin{itemize}
\item The \verb|elastic_scattering| command was added. It performs parallel tracking to determine the angular
  acceptance at a series of s locations. The data is intended for use with the script {\tt elasticScatteringAnalysis},
  which allows determination of the elastic gas scattering lifetime and loss distribution.
  This command is presently only available in \verb|Pelegant|, due to the long runtime required.
\end{itemize}

\subsubsection{Changes Specific to the GPU Version}

{\bf The GPU version continues to be an alpha release and contains bugs.}
Users are encouraged to test results against the serial or parallel versions.

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The \verb|computeGeneralizedGradients| script (used to prepare data for the \verb|BGGEXP| element) did not work
  for odd multipole orders (e.g., dipole, sextupole, ...) or fields that are odd functions of z. 
  This was reported by forum user Ji\_Li and has been fixed, with the assistance of R. Lindberg (APS).
\item The program \verb|sddsmatchmoments| was added. It allows generating a particle distribution to match the
  moments from the \verb|moments_output| command.
\item The \verb|LFBFirSetup| script was added. It helps set up FIR filters for longitudinal turn-by-turn feedback.
\item \verb|touschekLifetime| can now use data from the \verb|SLICE| element in {\tt elegant} for slice-based lifetime computations.
\item The script \verb|removeBackDrifts| was added. It allows post-processing s-dependent files to remove negative drifts, which
  improves the appearance of plots and is needed for certain types of analysis.
\item The program \verb|sddsemitproc| now has the ability to specify the independent variable on the commandline. This was
  suggested by forum user \verb|jan|.
\item The \verb|TFBFirSetup| script, which helps set up FIR filters for transverse turn-by-turn feedback, can now
  support filters with up to 30 terms.
\end{itemize}

\subsection{Highlights of What's New in Version 33.0, March 3, 2017}

Here is a summary of what's changed since release 32.0.
Historical change logs are appended to the end of this manual.

This version includes an alpha release of GPU-enabled code. The original GPU code was developed by 
Tech-X corporation \cite{GPU1}, with further work by R. Soliday (APS).

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|SREFFECTS| element now correctly computes the equilibrium horizontal and vertical emittances when
  $J_x \neq 1$. Previously, the computation used an equation that implicitly assumes $J_x = 1$.
\item The \verb|MALIGN| element could cause spurious integer changes in the reported tunes if the \verb|DZ| parameter
  was negative. This problem, reported by V. Sajaev (APS), was fixed.
\item A memory management bug related to the systematic and random multipole data store was fixed. This in principle
  affected \verb|KQUAD|, \verb|KSEXT|, and other elements using the \verb|SYSTEMATIC_MULTIPOLES| and \verb|RANDOM_MULTIPOLES|
  features. In testing, no effect was in fact observed.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|correction_matrix_output| command command were ignoring the monitor calibrations
  (\verb|MONI|, \verb|HMON|, and \verb|VMON|) values when \verb|use_response_from_computed_orbits = 1|.
  This was reported by V. Sajaev (APS).
\item The \verb|steering_element| command no longer aborts even if the declared steering corrector appears 
  not to kick the beam. This allows using unusual controls such as path length to steer the beam. This
  issue was pointed out by V. Sajaev (APS).
\item The \verb|load_parameters| and \verb|save_lattice| commands incorrectedly saved the edge angles and other edge-related
  quantities for bending magnets that were reflected. This issue was fixed. {\em Previously-saved parameter files should be modified
  (e.g., remove the edge parameters)} unless the magnets had the same parameters for the entrance and exit. 
  This problem was reported by Y. Li (BNL).
\item The \verb|rf_setup| and \verb|moments_output| commands will now run in a loop with \verb|find_aperture|,
  \verb|momentum_aperture|, and \verb|frequency_map| operations, if set for per-step execution. Previously,
  this would only happen for the \verb|track|, \verb|analyze_map|, and \verb|touschek_scatter| commands.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|EKICK|, \verb|EHKICK|, and \verb|EVKICK| elements now support inclusion of multipole errors linked to the
  correction strength.
\item The steering kicks and steering multipoles in the \verb|KQUAD| element are now implemented in the body of the element,
  rather than at the ends.
\item The \verb|WATCH| element was improved so that the \verb|dt| column in coordinate-logging mode and the \verb|dCt| column in
  parameter- and centroid-logging modes are more useful. In particular, in normal cases these will now more reliably be centered
  on zero. One can also provide a reference frequency relative to which the reference time is defined. This improvement grew out of
  discussions with J. Calvey and T. Berenc (APS).
\item The reported phases of the beam- and generator-induced parts of the voltage for the \verb|RFMODE| element \verb|RECORD| file
  are now computed using a method that should be more reliable. This improvement grew out of
  discussions with J. Calvey and T. Berenc (APS).
\item The \verb|RECORD| output from the \verb|RFMODE| element now includes the phase of the net cavity voltage. This was requested
  by M. Venturini (LBNL).
\item The \verb|RFMODE| element now supports injection of noise into the rf source and low-level rf system. This is based on discussions
  with T. Berenc (APS).
\item The \verb|SCRIPT| element can now import \verb|particleID| data from the script without attempting to use this information
  for lost-particle accounting. This provides better functionality when the \verb|particleID| is used for other purposes, such as
  bunch membership.
\item The \verb|TFBPICKUP| and \verb|TFBDRIVER| elements, used for bunch-by-bunch feedback, now allow 30-term FIR filters, up from
  15 turns in earlier versions.
\item The \verb|TFBDRIVER| element now accepts specification of the frequency and phase of the driver cavity.
\item Aperture enforcement inside \verb|KQUAD|, \verb|KSEXT|, \verb|KOCT|, \verb|KQUSE|, \verb|CSBEND|, and \verb|CSRCSBEND| elements
  has been improved. In particular, the \verb|ELLIPTICAL|, \verb|EXPONENT|, \verb|YEXPONENT|, and \verb|OPEN_SIDE| parameters of
  \verb|MAXAMP| are now implemented. In addition, for the fourth-order integrator, the apertures are no longer asserted at
  each integration step, but only after each slice (or ``kick'', to use the misleading terminology of the element parameters).
\item Added the \verb|ALLOW_LONG_BEAM| parameter to the \verb|ZLONGIT| and \verb|ZTRANSVERSE| elements.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|bunched_beam| command can now be set to take the fully-coupled 6D bunch parameters from the calculations of the
  \verb|moments_output| command, provided the latter is used to compute matched, equilibrium parameters.
  This was requested by forum user \verb|duanz|.
\item Added occurrence and positional filters for the \verb|steering_element| command. This was requested by V. Sajaev (ANL).
\item Several informational printouts for the \verb|touschekScatter| command are no longer shown by default, but only if the 
  \verb|verbosity| control is set to a non-zero value. This makes short runs more efficient.
\item Compared to previous versions, the lost-particle data file (\verb|losses| file requested by the \verb|run_setup|
  command) will exhibit changes in the order in which particles are recorded. This was a result of reworking the code for
  lost particle management.
\end{itemize}

\subsubsection{Changes Specific to Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The program \verb|madto| was renamed \verb|elegantto|, to more accurately reflect what it does.
  It will now translate \verb|elegant| lattice files into MAD8 format.
\end{itemize}

\subsection{Highlights of What's New in Version 32.0, 5 Jan. 2017}

Here is a summary of what's changed since release 31.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item A bug was fixed in the \verb|amplification_factors| command that resulted in a crash when the corrected amplification
  factors were requested. This was reported by S. DiMitri (ELETTRA).
\item A bug was fixed for \verb|twiss_output|, which was incorrectly reporting the quantities $\frac{\partial \alpha_{x,y}}{\partial \delta}$
 (parameters \verb|dalphax/dp| and \verb|dalphay/dp| in the output file) in some cases.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item Added the \verb|BRANCH| element, which permits branching between parts of a beamline based on the number of passes executed.
\item Apertures specified using \verb|MAXAMP| or an external aperture file (using the \verb|aperture_data| command) are now
  enforced inside \verb|CSBEND| and \verb|CSRCSBEND| elements.
  There may be small changes in, for example, momentum acceptance as a result of this, particularly when gradient dipoles are involved. 
\item The longitudinal location of losses inside \verb|KQUAD| and \verb|KSEXT| elements is now computed more accurately. Previously,
  it was simply the start of the element.
\item Removed the non-functional \verb|FRINGE| parameter of the \verb|CSBEND| element.
\item The \verb|BGGEXP| (B-field Generalized Gradient Expansion) element now supports symplectic integration using an
  implicit method, implemented by R. Lindberg (APS).
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item Added \verb|exclude| parameter to \verb|chromaticity| command, allowing exclusion of some sextupoles that may 
  match the list in the \verb|sextupole| parameter.
\item Added \verb|alter_at_each_step| and \verb|alter_before_load_parameters| parameters to the \verb|alter_elements| command,
  allowing better control of potential conflicts with \verb|load_parameters|.
\item The random number generator seed is now permuted bitwise in order to add a greater level of apparent randomness.
  Thus, changing the seed by a small amount will now have a bigger effect on the sequences generated, making it easier to
  deliberately perform several runs with very distinct random values.
  This can be defeated using the \verb|global_settings| command by setting \verb|inhibit_seed_permutation=1|.
  This issue was pointed out by V. Sajaev (APS).
\end{itemize}

\subsubsection{Changes Specific to Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item \verb|ionTrapping| --- Added computation of the single-ion oscillation frequency.
\end{itemize}

\subsection{Highlights of What's New in Version 31.0, 1 Oct. 2016}

Here is a summary of what's changed since release 30.1.

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|touschek_scatter| command had a bug when random multipoles where used on \verb|KQUAD| and \verb|KSEXT| elements. In particular,
  these multipoles components were re-randomized for each \verb|TSCATTER| element. This was discovered and fixed by A. Xiao (ANL).
\item The implementation of edge effects in the \verb|KQUAD| element was using $x^\prime$ and $y^\prime$ in place of $q_x$ and $q_y$, and so
  was not symplectic. It also did not have the correct dependence on $\delta$. 
  These issues were reported by R. Lindberg (ANL).  A similar error was fixed in the implementation of edge effects for \verb|CSBEND|;
  this was fixed by Y.P. Sun (ANL). Practically speaking, we haven't noticed any significant change in results.
\item There was a bug in the evaluation of systematic multipoles when using the second-order integrator for \verb|KQUAD| and \verb|KSEXT|.
  The default fourth-order integrator did not have this issue.
\item Higher-order path-length issues were fixed for the \verb|BRAT| element. This issue was reported by R. Lindberg (ANL).
\item The steering kick calibration factors are no longer ignored on the \verb|KQUAD| element.
\item The \verb|BMXYZ| and \verb|BMAPXY| elements lacked dependence on the momentum deviation $\delta$. This issue was reported by R. Lindberg (ANL).
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item None
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item Added the \verb|BGGEXP| element, which performs tracking through magnetic fields constructed from a generalized
  gradient expansion \cite{Venturini-NIMA427-387}. Although the integration is not symplectic, the fields satisfy Maxwell's equations exactly.
  A script, \verb|computeGeneralizedGradients|, is provided to assist in preparing input for this element.
  Advice from M. Venturini (LBNL) was helpful in performing this work.
\item Added separate specification of edge and body multipoles to the \verb|KQUAD| and \verb|KSEXT| elements.
\item Added steering and steering multipoles to the \verb|KSEXT| element.
\item The \verb|BMXYZ| element now allows independent specification of the insertion length and field map length.
\item The code for the \verb|KQUAD|, \verb|KSEXT|, \verb|MULT|, and \verb|FMULT| was improved to prevent underflows that might occur in some
  odd cases, which would negatively affect accuracy.
\item The \verb|LSRMDLR| element now includes an option for a helical device. This was requested by forum user \verb|zzhang| and implemented by
  Y.-P. Sun (ANL).
\item Two additional parameters, \verb|SampledParticles| and \verb|SampledCharge| were added to \verb|WATCH| files in coordinate mode. 
  These are identical to \verb|Particles| and \verb|Charge|, respectively, except when the \verb|FRACTION| parameter is $<1$.
  In that case, the latter parameters give the values prior to sampling, while the new parameters give the parameters of the
  sampled fraction of the bunch. Previously,  \verb|Particles| and \verb|Charge| changed as \verb|FRACTION| was changed. 
  {\em Note that scripts that use the  \verb|Particles| and \verb|Charge| may need modification since the meaning has changed.}
  Y. Ding (SLAC) pointed out this issue.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|analyze_map| command can now report the map using canonical variables. It also has a user-controlled accuracy
  parameter that can be used to eliminate spurious matrix elements. R. Lindberg (ANL) helped with the development and testing.
\item The  \verb|touschek_scatter| command  now uses averaging of the loss rate over the interval between two \verb|TSCATTER| elements
  instead of the local value at the element, which gives more accurate estimates of the distribution of scattered particles.
  This change requires that \verb|TSCATTER| elements be inserted at the beginning and end of the beamline, which can be
  done using \verb|add_at_end=1| and \verb|add_at_start=1| in the \verb|insert_elements| command.
  This was implemented by A. Xiao (ANL).
\item The \verb|modulate_elements| command now offers more control over verbose printouts, to help reduce the volume of
  uninformative printouts. It also provides user control of the buffer flushing interval for the \verb|record| output file.
\item The \verb|insert_elements| command now has the option to insert an element at the beginning of the beamline.
\end{itemize}

\subsubsection{Changes Specific to Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The script \verb|computeGeneralizedGradients| was added to assist in preparing input for the \verb|BGGEXP| element.
\item The scripts \verb|elasticScatteringLifetime| and \verb|bremsstrahlungLifetime| now support user-specified gas composition.
The Z values for carbon and oxygen were mixed up in some places in these and related scripts, as pointed out by S. Tian (IHEP);
this was fixed.
\item The \verb|ionTrapping| script now supports user-provided factors for inflating the emittance and energy spread.
\end{itemize}

\subsection{Highlights of What's New in Version 30.1, 3 Aug. 2016}

Here is a summary of what's changed since release 30.0

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item Fixed a bug in Touschek scattering simulation (\verb|TSCATTER| element and \verb|touschek_scatter| command) that resulted
  in the random multipole components of \verb|KQUAD| and \verb|KSEXT| elements being re-randomized for each \verb|TSCATTER| element.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item Fixed a bug introduced in \verb|moments_output| computations when \verb|CSBEND| elements were present 
  with non-zero values of \verb|ETILT|. Reported by V. Sajaev (ANL).
\item Fixed a bug in Touschek scattering simulation (\verb|TSCATTER| element and \verb|touschek_scatter| command) that resulted
  in the random multipole components of \verb|KQUAD| and \verb|KSEXT| elements being re-randomized for each \verb|TSCATTER| element.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item Added edge multipoles to \verb|KQUAD| element. This necessitated some rearrangement of the code, so results might be
  slightly different even if this feature is not invoked.
\item Added I/Q mode feedback to the \verb|RFMODE| element.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes Specific to Parallel Version}

\begin{itemize}
\item Implemented exact normalized emittance calculations for the \verb|sigma| output file of the \verb|run_setup| command and in \verb|WATCH|
  output in \verb|parameter| mode. J. Bjorklund pointed out the lack of calculations in the parallel version.
\item Fixed bug in assignment of particle ID values when using Halton sequences in the \verb|bunched_beam| command.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The program \verb|abrat| (``Asymmetric Bend RAy tracing'') was added. It allows tracking electrons through 2- and 3-D magnetic field maps.
  It is a commandline version of the \verb|BRAT| element.
\item The script \verb|ionTrapping| was added, providing simple ion trapping calculations for uniform bunch trains. J. Calvey (APS) helped with
  debugging.
\item The script \verb|computeSCTuneSpread| was added to allow computation of space-charge tune spread.
\item The script \verb|radiationEnvelope| now computes envelopes for central cone flux.
\end{itemize}

\subsection{Highlights of What's New in Version 30.0, 5 July 2016}

Here is a summary of what's changed since release 29.1:

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item Fixed a memory leak in the \verb|FTABLE| element.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item Fixed calculations of exact normalized emittance (error in equations) and implemented in parallel version.
  This bug impacted results in the \verb|sigma| output file of the \verb|run_setup| command and in \verb|WATCH|
  output in \verb|parameter| mode. J. Bjorklund pointed out the lack of calculations in the parallel version and
  provided an example run that helped discover the problem with the serial version. 
\item The \verb|diffusionRate| output from the \verb|frequency_map| command is now computed as 
$\log_{10} ((\Delta\nu_x^2+\Delta\nu_y^2)/n)$ instead of $(\log_{10} (\Delta\nu_x^2+\Delta\nu_y^2))/n$.
\item Fixed a bug in \verb|bunched_beam| whereby the centroids for a shell-type beam were offset from zero.
  Reported by L. Emery (ANL).
\item Fixed bug in \verb|moments_output| when bending magnts with non-zero \verb|ETILT| are present. When this occurs,
the number of slices for moments calculation is set to 1 for those elements, to avoid numerical problems with the
vertical orbit.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item Added the \verb|LEFFECTIVE| parameter for \verb|QUAD| and \verb|KQUAD|, which provides a convenient way
  to change the effective length without changing the adjacent drift spaces. Also added the ability to turn off
  the linear fringe field effects while keeping the nonlinear part, and to multiply the nonlinear effects by
  a numerical factor.
\item Added the \verb|BMXYZ| element for straightforward integration through 3D field maps for straight elements.
\item Added the \verb|BRAT| element, which is similar to \verb|BMXYZ| but accommodates curved elements. Elements may
  be asymmetric, e.g., longitudinal gradient dipoles.
\item Added the \verb|FACTOR| and \verb|THRESHOLD| options to \verb|FTABLE|. The former allows multiplying the fields
  by a user-defined factor. The latter allows specifying the magnitude of the field below which it is considered
  zero, which can help ensure numerical stability.
\item The \verb|FTABLE| element can accept the simple-to-create input files used by the \verb|BMXYZ| element in addition
  to the original input format.
\item Results that depend on the transport matrix will show small changes for elements for which the matrix is determined by tracking.
  The tracking-based method was modified to use a larger number of sample points, increasing the accuracy.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item Added the \verb|full_grid_output| parameter to the \verb|frequency_map| command, making it possible to display 
  frequency maps using \verb|sddscontour|.
\end{itemize}

\subsubsection{Changes Specific to Parallel Version}

\begin{itemize}
\item Implemented exact normalized emittance calculations for the \verb|sigma| output file of the \verb|run_setup| command and in \verb|WATCH|
  output in \verb|parameter| mode. J. Bjorklund pointed out the lack of calculations in the parallel version.
\item Fixed bug in assignment of particle ID values when using Halton sequences in the \verb|bunched_beam| command.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The program \verb|abrat| (``Asymmetric Bend RAy tracing'') was added. It allows tracking electrons through 2- and 3-D magnetic field maps.
  It is a commandline version of the \verb|BRAT| element.
\item The script \verb|ionTrapping| was added, providing simple ion trapping calculations for uniform bunch trains. J. Calvey (APS) helped with
  debugging.
\item The script \verb|computeSCTuneSpread| was added to allow computation of space-charge tune spread.
\item The script \verb|radiationEnvelope| now computes envelopes for central cone flux.
\end{itemize}

\subsection{Highlights of What's New in Version 29.1, 3 March 2016}

Here is a summary of what's changed since release 29.0:

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item Fixed bugs in \verb|RECORD| output from \verb|TRFMODE| element for multi-step, single-pass runs.
  This was fixed by A. Xiao (APS).
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|replace_elements| command now respects quoted sequences in the new element definition.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item \verb|LRWAKE| now supports long-range quadrupole wakes. R. Lindberg (APS) provided helpful
  discussion in this implementation.
\item \verb|ILMATRIX| now supports second-order tune shift with amplitude as well as path-length dependence
  on amplitude.
\item \verb|TFBPICKUP| now supports horizontal and vertical offsets.
\item Added logging of photon coordinates and angles to the \verb|CSBEND| element. Works in serial mode only.
\item \verb|TRFMODE| now supports interpolation within bins, giving smoother results.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item \verb|alter_elements| now has a occurrence-skip parameter, which would allow for example changing every other
  member of a group of elements.
\item \verb|momentum_aperture| now allows specifying that \verb|WATCH| elements remain active during momentum aperture
  determination.
\item \verb|frequency_map| was modified to include the path-length in the output file, which can be used to determine
  the dependence of the path length of the betatron amplitude.
\end{itemize}

\subsubsection{Changes Specific to Parallel Version}

\begin{itemize}
\item None.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The script \verb|prepareTAPAs| was added, which allows processing files from \verb|twiss_output| into a form
  that is accepted by the Android App TAPAs \cite{TAPAs}.
\item The script \verb|makeSummedCsrWake| was added, which allows making a CSR wake that sums up contributions from
  dipoles with various lengths and bending radii. 
\item The script \verb|TFBFirSetup| was added, which allows generating FIR filters for turn-by-turn feedback using 
  \verb|TFBDRIVER| and \verb|TFBPICKUP| elements.
\item \verb|ibsEmittance| can now perform intrabeam scattering calculations for non-gaussian longitudinal distributions.
\item \verb|computeCoherentFraction| now uses $\lambda/4\pi$ for the radiation emittance to be consistent with 
  \verb|sddsbrightness|.
\item \verb|longitCalcs| now computes the bucket-half-height even when a harmonic cavity is powered.
\end{itemize}

\subsection{Highlights of What's New in Version 29.0, 15 Jan. 2016}

Here is a summary of what's changed since release 28.1:

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item Fixed a bug in the \verb|MATR| element that would crop up in multi-step runs, causing a crash or lock-up.
  This was reported by P. Emma (SLAC).
\item Fixed a bug in the \verb|RFMODE| element that resulted in a few percent error between the voltage seen by the beam and
  the feedback-regulated voltage. T. Berenc (ANL) helped resolve this.
\item The output file feature was restored for the \verb|FTRFMODE| element.
\item The \verb|TFBDRIVER| and \verb|TFBPICKUP| feedback elements can now handle changes in the number of bunches.
\item The drive limit for \verb|TFBDRIVER| is now imposed after application of the filter, rather than before.
\item The \verb|KQUAD| element now has a valid associated transfer matrix for \verb|RADIAL=1|. This bug was reported
  by forum user \verb|libov|.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item The \verb|touschek_scatter| command now behaves as a regular major action command, meaning that error generation, scanning,
  parameter loading, etc.  behave as expected.
\item Fixed a bug in the \verb|correct_tunes| command that resulted in a crash when \verb|n_iterations=0| and would also have
  resulted in invalid data in the log file for mixed element types. This was reported by V. Sajaev (ANL).
\item Fixed a bug in the \verb|chromaticity| command that resulted in a crash when \verb|n_iterations=0| and would also have
  resulted in invalid data in the log file for mixed element types.
\item Fixed a bug related to optimization of the chromatic derivative of \verb|alpha_x|. The value provided was actually the
  chromatic derivative of \verb|betax|. A related error gave incorrect results for the \verb|use_linear_chromatic_matrix| mode of 
  the \verb|track| command.
\item Previous versions of this manual indicated that the \verb|find_aperture| command provided a quantity \verb|Area| giving
  the dynamic aperture area for optimization. The quantity is in fact called \verb|DaArea|. This was reported by S. Hilbrich (TU Dortmund).
\item Fixed a bug in the optimization feature that resulted in the user's weighting factors being ignored. This was pointed out
  by A. Zholents (ANL).
\item Fixed a bug in the \verb|alter_elements| command that caused string values not to be reflected in the output file created
  with \verb|save_lattice|. This was reported by T. Pulampong (SLRI/DLS).
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item Added nonlinear symplectic fringe field model to CSBEND and CSRCSBEND, based on theoretical work of K. Hwang (IU) \cite{KHwang}. The implementation was
  performed by Y. Sun (APS) with assistance from K. Hwang and M. Borland.
\item Added \verb|EKICKER|, \verb|EHKICK|, and \verb|EVKICK|, which provide various flavors of steering correctors using an Exact 
  model. These may be used in place of the existing \verb|KICKER|, \verb|HKICK|, and \verb|VKICK| elements.
  The need for this was pointed out by L. Yang (BNL).
\item The \verb|MATTER| element now supports arrays of slits. This can be used, for example, to model a double-slit spoiler for
  producing two pulses in an FEL.
\item The \verb|ECOL| and \verb|RCOL| collimator elements now support an \verb|INVERT| parameter to allow simulation of an
  obstruction instead of an opening.
\item The output files from the \verb|WATCH| element in centroid and parameter mode now contain the beam charge, provided that
  a \verb|CHARGE| element is in the beamline.
\item Elements that read multipole error files (e.g., \verb|KQUAD| and \verb|KSEXT|) now share data internally rather than each
  reading the data files separately. This provides a significant speed improvement for massively parallel execution in particular.
\item The \verb|MALIGN| element was improved to allow optionally applying misalignments to only part of the beam, based on 
  the particle ID.
\item The \verb|RFMODE| element now has a feature that allows ``muting'' the rf generator on a specified pass, to simulate
  a trip of the rf source. 
\item The voltage ``preloading'' feature of the \verb|RFMODE| element now works even when rf feedback is used.
\item In order to eliminate problems with the parallel version, the \verb|IBSCATTER| element no longer has a separate \verb|CHARGE| parameter. 
  Instead, the \verb|CHARGE| element should be used.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|analyze_map| command can now determine the nonlinear transport matrix up to third order based on tracking data,
  using the method described in \cite{Borland_thesis}. Parallel tracking is used for this command in {\tt Pelegant}.
  Previously, the analysis was limited to the linear matrix. Also, the terminal lattice functions and their chromatic derivatives
  are determined from the map for both transport lines and rings. This was requested by Y. Hao (BNL) and L. Yang (BNL).
\item The \verb|correct_tunes| and \verb|chromaticity| commands now include a weighting factor that results in minimization of
  the strength changes in the event that more than two familes are provided for correction. (In the future this will be replaced
  with an SVD-based implemenetation.)
\item Added to \verb|closed_orbit| and \verb|correct| commands the ability to use multi-turn tracking to determine the approximate orbit.
  This was suggested by V. Sajaev (ANL), and is helpful when the orbit convergence is poor.
\item The output in the \verb|run_setup| \verb|centroid| file now contains the beam charge, provided that
  a \verb|CHARGE| element is in the beamline.
\item The \verb|run_control| command now includes a variable, \verb|n_passes_fiducial|, that allows specifying a different number of
  tracking passes for fiducialization than for tracking. For ring fiducialization, this should probably always be 1.
\item Most output files from {\tt elegant} now include a parameter giving the SVN revision number of
  the version used to create the output.
\end{itemize}

\subsubsection{Changes Specific to Parallel Version}

\begin{itemize}
\item The \verb|analyze_map| command, which was improved as described above, can now use parallel resources.
\item A bug was fixed in the \verb|center_on_orbit| feature of the \verb|track| command. The bug caused the
  particles on each processor to be offset by different amounts related to the centroid of the local particles
  only. This was reported by M. Furseman (DLS).
\item Fixed a bug in \verb|FTABLE| introduced in version 26.0. The bug would cause the program to crash.
\item Memory management was improved in the \verb|touschek_scatter| command, allowing a larger number of particles
  to be utilized.
\item The \verb|SCRIPT| element would cause a crash when \verb|twiss_output|, \verb|matrix_output|, or
  similar commands were included but when tracking was required to determine the transfer matrix of the element.
  This was fixed.
\item Tracking instigated via the \verb|track| command is now more forgiving of uneven particle losses among 
  cores. In particular, the program should no longer crash if one core has lost all of its particles or
  all of the particles in a particular bunch.
\item The \verb|stop_tracking_particle_limit| feature of the \verb|track| command now works in the parallel version.
\item Instead of exiting, the parallel version now simply ignores the \verb|slice_anlysis| command.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The script \verb|reorganizeMmap| was added to convert momentum aperture data from \verb|Pelegant| in \verb|output_mode=1| 
  into the same form as produced by \verb|elegant|. This was a result of correspondence with S. Tian (IHEP).
\item A bug was fixed in \verb|elegant2astra| that resulting in slightly erroneous values for the longitudinal coordinate.
\item The \verb|beamLifetimeCalc| can now perform approximate Touschek lifetime calculations for polarized beams.
  This was added by A. Xiao (ANL) following an inquiry from forum user \verb|marlibgin|.
\end{itemize}

\subsection{Highlights of What's New in Version 28.1.0, 23 July 2015}

Here is a summary of what's changed since release 28.0:

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The ROTATE element was not affecting the floor coordinates. This was found and fixed by A. Xiao (APS).
\item The \verb|END_PASS| parameter on \verb|SCATTER| now works as expect, after removal of a one-pass offset.
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item A bug was fixed that caused a crash when a 1-line aperture search was performed. This was reported by Guohui Wei (JLab).
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|TFBDRIVER| element now has the ability to measure the beam phase for use in longitudinal feedback.
  Previously, only momentum-based input was available for longitudinal feedback.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|ramp_elements| and \verb|modulate_elements| commands now have the ability to write a record of their
  output values.
\item The \verb|run_setup| command now has options, intended primarily for developers, to turn on memory usage and executing time monitoring during tracking.
\item The units given for loss rate the output files from \verb|touschek_scatter| were incorrect and were fixed. Results were not affected. (A. Xiao, ANL)
\item The \verb|tune_footprint| command was improved in several ways. It is now possible to ignore half-integer resonances.
  The upper and lower bounds of the chromatic tune footprints are now available for optimization.
  It's now possible to turn off either chromatic or amplitude tune footprint deterimination.
\item The \verb|optimization_setup| command allows suppressing particle tracking in order to improve performance in some unusual cases.
\item The \verb|correct_tunes| command can now utilize any element that has the \verb|K1| parameter.
\item The \verb|chromaticity| command can now utilize any element that has the \verb|K2| parameter.
\end{itemize}

\subsubsection{Changes for Parallel Version Only}

\begin{itemize}
\item Fixed a bug that affected tracking when orbit correction was used, \verb|start_from_centroid=1|, and particle distribution
  was not random across processors.
\item Warnings about $\rho>10^{6}$ m are now issued by the parallel version, as for the serial version.
\item Memory usage logging to \verb|WATCH| output files now sums the memory across all cores, rather than just the master core.
\item A memory leak was fixed in the \verb|ZTRANSVERSE| element that sometimes caused the program to crash. This was reported by
  R. Lindberg (ANL).
\item The output of the beam charge in the \verb|ZLONGIT| wake output file was corrected; previously, it only showed the charge on 
  one core.
\item The \verb|frequency_map| command now provides an estimate of the time needed to complete.
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item The program \verb|sddsbunchingfactor| is now part of the distribution.
\end{itemize}

\subsection{Highlights of What's New in Version 28.0.0, 18 June 2015}

Here is a summary of what's changed since release 27.1.0:

\subsubsection{Bug Fixes for Elements}

\begin{itemize}
\item The \verb|WATCH| element was improved so that the \verb|dCt| column (in parameter or coordinate mode) and \verb|dt| column (in coordinate mode)
  no longer exhibit fictitious drift due to precision limitations in simulations of rings with many turns.
\item For numerical reasons, any \verb|CSBEND| with $\rho>10^6$ m is replaced with another element. In the past, an \verb|EDRIFT| was used,
  which would produce incorrect results if the element had non-zero $K_1$ or $K_2$. This was fixed. 
\end{itemize}

\subsubsection{Bug Fixes for Commands}
\begin{itemize}
\item None.
\end{itemize}

\subsubsection{New and Modified Elements}
\begin{itemize}
\item The \verb|TFBPICKUP| and \verb|TFBDRIVER| elements, which provide a turn-by-turn feedback capability, now support multi-bunch feedback.
  In addition, support was added for longitudinal feedback as well as sample/update intervals greater than one turn.
\item The \verb|CSRDRIFT| element can now also include longitudinal space charge, using the algorithm from the \verb|LSCDRIFT| element.
\item The \verb|CSBEND| element has a new feature that allows suppression of spurious trajectory offsets that result from limitations
  of the symplectic integration routine. This feature is controlled using the \verb|REFERENCE_CORRECTION| parameter. 
\item The input of multipole errors for \verb|KQUAD| and \verb|KSEXT| elements was modified so that the input columns have more transparent
  names. Previously, the names caused some confusion. Files that worked with previous versions are still accepted.
\item The \verb|MARK| element with \verb|FITPOINT=1| now stores the emittances of the three modes as \verb|e1m|, 
  \verb|e2m|, and \verb|e3m| for optimization if \verb|moments_output| is invoked. This deficiency was pointed out
  by forum user marlibgin.
\end{itemize}

\subsubsection{New and Modified Commands}
\begin{itemize}
\item The \verb|transmute_elements| command now does a better job of copying common parameters between the old and new element types.
  In the past, only the length was preserved. A. Zholents (ANL) reported this issue.
\item The \verb|floor_coordinates| command has a new parameter, \verb|store_vertices|, which allows requesting that dipole vertex points
  be stored for use in optimization.
\item The \verb|twiss_output| command now stores the acceptances \verb|Ax| and \verb|Ay| for use in optimization.
\end{itemize}

\subsubsection{Changes for Parallel Version Only}

\begin{itemize}
\item None
\end{itemize}

\subsubsection{Changes to Related Programs and Files}

\begin{itemize}
\item None.
\end{itemize}

\newpage

\begin{thebibliography}{99}

\bibitem{Kernighan}
    B. W. Kernighan and D. M. Ritchie, {\em The C Programming Language},
    Prentice-Hall, Englewood Cliffs, N.J., second edition, 1988.

\bibitem{MAD}
    H. Grote, F. C. Iselin, ``The MAD Program--Version 8.1,'' CERN/SL/90-13(AP), June 1991.

\bibitem{KLBrown}
    K. L. Brown, R. V. Servranckx, ``First- and Second-Order Charged Particle Optics,'' 
    SLAC-PUB-3381, July 1984.

\bibitem{Borland_thesis}
    M. Borland, ``A High-Brightness Thermionic Microwave Electron Gun,'' SLAC-Report-402,
    February 1991, Stanford University Ph.D. Thesis.

\bibitem{Enge}
    H. A. Enge, ``Achromatic Mirror for Ion Beams,'' Rev. Sci. Inst., 34(4), 1963.

\bibitem{Borland_PC}
    M. Borland, private communication.

\bibitem{Numerical_Recipes}
    W. H. Press, {\em et al}, {\em Numerical Recipes in C}, Cambridge University
    Press, Cambridge, 1988.

\bibitem{SDDS1}
M. Borland, ``A Self-Describing File Protocol for Simulation
Integration and Shared Postprocessors,'' Proc. 1995 PAC, May 1-5,
1995, Dallas, Texas, pp. 2184-2186 (1996).

\bibitem{SDDS2}
M. Borland, ``A Universal Postprocessing Toolkit for Accelerator 
Simulation and Data Analysis,'' Proc. 1998 ICAP Conference, 
Sept. 14-18, 1998, Monterey, California, to be published.

\bibitem{DQS} T. P. Green, ``Research Toward a Heterogeneous Networked
Computer Cluster: The Distributed Queuing System Version 3.0,'' SCRI
Technical Publication, 1994.

\bibitem{S2EJitter} M. Borland {\em et al}, ``Start-to-End Jitter Simulation
of the LCLS,'' Proceedings of the 2001 Particle Accelerator Conference,
Chicago, 2001.

\bibitem{TopUpTracking} M. Borland and L. Emery, ``Tracking Studies of
Top-Up Safety for the Advanced Photon Source,'', Proceedings of the
1999 Particle Accelerator Conference, New York, 1999, pg 2319-2321.

\bibitem{MingXie} M. Xie, ``Free Electron Laser Driven by SLAC
LINAC''.

\bibitem{GENESIS} S. Reiche, {\em NIM} A 429 (1999) 242.

\bibitem{BM}
  J.D. Bjorken, S.K. Mtingwa, ``Intrabeam Scattering,'' Part. Acc. Vol. 13, 
  1983, 115-143.

\bibitem{Halbach_69a}
    K. Halbach, ``First Order Perturbation Effects in Iron-Dominated Two-Dimensional Symmetrial Multipoles'',
    NIM {\bf 74-1}, 1969, 147-164.

\bibitem{Jackson}
  J. D. Jackson, {\em Clasical Electrodynamics}, second edition.

\bibitem{Ripken}
 G. Ripken, DESY Report No. R1-70/04, 1970 (unpublished).

\bibitem{HAPE}
  {\em Handbook of Accelerator Physics and Engineering}, A. Chao and M. Tigner eds., 1998.

\bibitem{Derbenev}
  Ya. S. Derbenev, J. Rossbach, E. L. Saldin, V. D. Shiltsev, ``Microbunch Radiative Tail-Head
  Interaction,'' September 1995, TESLA-FEL 95-05.

\bibitem{Xiao2007A}
  A. Xiao {\em et al.}, ``Direct Space-Charge Calculation in {\tt elegant} and its Application to the
 ILC Damping Ring,'' Proc. PAC2007, 3456-3458.

\bibitem{Huang2004}
  Z. Huang {\em et al.}, Phys. Rev. ST Accel. Beams {\bf 7} 074401 (2004).

\bibitem{Piwinski}
  A. Piwinski, `` The Touschek effect in strong focusing storage rings,'' DESY-98-179, Nov 1998.

\bibitem{Xiao2007a}
  A. Xiao {\em et al.}, ``Touschek Effect Calculation and its Application to a Transport Line,''
  Proc. PAC07, 3453-3455 (2007).

\bibitem{Warnock}
  W. Warnock, ``Shielded Coherent Synchrotron Radiation and Its Effect on Very Short Bunches,'' SLAC-PUB-5375, 1990.

\bibitem{Agoh}
  T. Agoh and K. Yokoya, ``Calculation of coherent synchrotron radiation using mesh,'' Phys. Rev. ST Accel. Beams 7,
  054403 (2004).

\bibitem{Elleaume1992}
  P. Elleaume, ``A New Approach to Electron Beam Dynamics in Undulators and Wigglers,'' Proc. EPAC 1992, 661-663.

\bibitem{radia}
  http://www.esrf.eu/Accelerators/Groups/InsertionDevices/Software/Radia

\bibitem{Bengtsson}
 J. Bengtsson, "The Sextupole Scheme for the Swiss Light Source (SLS): An Analytic Approach," SLS Note 9/97,
 March 7, 1997. (Corrections to several typos were supplied by W. Guo, NSLS.)

\bibitem{ASTRA}
  K. Fl\"{o}ttmann, Astra User Manual, http://www.desy.de/~mpyflo/Astra\_dokumentation/

\bibitem{IMPACT}
J. Qiang {\em et al.},  J.~Comp.~Phys. 163, 434 (2000).

\bibitem{TRACK}
  V. N. Aseev {\em et al.}, Proc. PAC05, 2053-2055 (2005); ASCII version 39 from B. Mustapha.

\bibitem{Chi2005}
  H. Chi {\em et al.}, Mathematics and Computers in Simulation {\bf 70} (2005) 9-21.

\bibitem{Zhou-IPAC10}
  D. Zhou {\em et al.}, ``Explicit maps for the fringe field of a quadrupole,'' Proc. IPAC10.

\bibitem{Irwin-PAC95}
  J. Irwin {\em et al.}, ``Explicit soft fringe maps of a quadrupole,'' Proc. PAC95.

\bibitem{WangCXDrivingTerms}
  C. X. Wang, ``Explicit Formulas for 2nd-order Driving Terms due to Sextupoles and Chromatic Effects of Quadrupoles,''
  ANL/APS/LS-330, March 10, 2012.

\bibitem{Bengtsson-SSC232}
  J. Bengtsson and J. Irwin, ``Analytical Calculations of Smear and Tune Shift,'' SSC-232, Feb. 1990.

\bibitem{Bane-SLAC14925}
 K. Bane, ``Corrugated Pipe as a Beam Dechirper,'' SLAC-PUB-14925, April 2012.

\bibitem{Tsai-RMP46}
 Y.S. Tsai, Rev. Mod. Phys. 46, 815 (1974)
\bibitem{Wrulich-CAS94}
 A. Wrulich, CERN Accelerator School 94-01, Vol. 1, 409 (1994).
\bibitem{LeDuff-NIM239}
 J. LeDuff, NIM A 239 (1985) 83-101.

\bibitem{sRDT}
 A. Franchi {\em et al.}, Phys. Rev. ST Accel. Beams 17, 074001 (2014).

\bibitem{Floettmann-PRSTAB6-034202}.
 K. Floettmann, Phys. Rev. ST Accel. Beams 6, 034202 (2003).

\bibitem{Berenc-IPAC15-MOPMA006}
 T. Berenc, M. Borland, and R. R. Lindberg, ``Modeling RF Feedback in Elegant for Bunch-Lengthening Studies for the Advanced Photon Source Upgrade,''
 Proc. of IPAC15, MOPMA006 (2015).

\bibitem{KHwang}
  K. Hwang and S. Y. Lee, ``Dipole fringe field thin map for compact synchrotrons'', Phys. Rev. ST Accel. Beams {\bf 18}, 122401, 2015; K. Hwang, ``On intrinsic nonlinear particle 
  motion in compact synchrotrons,'' Indiana University Ph. D. Thesis, 2015.

\bibitem{TAPAs}
  M. Borland, ``Android application for accelerator physics and engineering calculations,'' Proc. of PAC 2013, 1364-1366.

\bibitem{Nakamura2004}
  T. Nakamura {\em et al.}, ``Transverse bunch-by-bunch feedback system for the SPRing-8 Storage Ring,'' Proc. of EPAC 2004, 2649.

\bibitem{Chao-PRSTAB-111001}
  A. Chao {\em et al.}, ``Tune shifts of bunch trains due to resistive vacuum chambers without circular symmetry,''
  Phys. Rev. ST Accel. Beams, {\bf 5}, 111001 (2002).

\bibitem{Bacconier-SPS80-2}
Y. Bacconier and G. Brianti, CERN/SPS/80-2 (1980).

\bibitem{Venturini-NIMA427-387}
M. Venturini and A. Dragt, ``Accurate computation of transfer maps from magnetic field data,'' 
NIM A 427 (1999) 387-392.

\bibitem{GPU1}
J. R. King, I. V. Pogorelov, M. Borland, R. Soliday, K. Amyx,
``Current status of the GPU-Accelerated version of elegant,''
Proc. IPAC15, 623 (2015).

\bibitem{Bassetti}
M. Bassetti, G. Erskine, CERN ISR TH/80-06 (1980).

\bibitem{BuesingPC}
B. Buesing, private communication, 2018.

\bibitem{RLindbergPC}
R. Lindberg, private communication, 2018.

\bibitem{Sun-NAPAC19}
Y.-P. Sun and C.-Y. Yao, ``Tracking With Space Harmonics in ELEGANT Code,'' Proc. NAPAC19.

\bibitem{Li-arxiv-1912.00121}
  Y. Li {\em et al.}, ``Fast dynamic aperture optimization with reversal integration,''
  arXiv:1912.00121, 30 November 2019.

\bibitem{Mitchell-2007}
  C. E. Mitchell, ``Calculation of Realistic charged-particle transfer maps.'' Ph.D. thesis, University of Maryland, College Park, 2007. http://www.physics.umd.edu/dsat/

\bibitem{Venturini2021}
 M. Venturini, ``Particle dynamics and misaligned lattice elements,'' ALS Technical Note ALSU-AP-2021-001, Feb. 2021.

\end{thebibliography}

\end{document}
