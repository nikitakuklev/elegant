NB: This element is new and considered experimental. Please report issues back to the developers.

This element provides serial or parallel simulation of the interaction of residual gas ions
with the electron beam.
It must be used in concert with the \verb|ion_effects| command, described in \ref{subsec:ioneffects}.

Modeling of residual ions has these features:
\begin{itemize}
\item s-dependent gas pressure profiles for any number of species.
\item Arbitrary ion species, specified by a user-provided file that includes the cross sections.
\item User-defined locations for ion generation. Each \verb|IONEFFECTS| element represents the
      ions present in a segment of the accelerator. The segments start and end half way between
      successive \verb|IONEFFECTS| elements.
\item Arbitrary fill patterns. Uniform fills can be set up using the \verb|bunched_beam| command,
      while custom fills can be set up by generating the beam externally and using the \verb|sdds_beam| command.
\end{itemize}

Some limitations of the model include:
\begin{itemize}
\item Fields from electron bunches and ions are computed based on gaussian parameters. 
      This is a good approximation for the former, but not terribly good for the latter.
\item Ions move only transversely and exist only outside of magnets.
\item No multiple ionization. This will be added in the future.
\end{itemize}

Performing ion simulations involves the following steps
\begin{enumerate}
\item Prepare file describing the ion properties, as described in \ref{subsec:ioneffects}.
  Each ion is generated by a source gas.
\item Prepare file giving gas pressure vs s for the source gases described in the ion 
  properties file.
\item Insert \verb|IONEFFECTS| elements in the lattice. This can be performed using the
  \verb|insert_elements| command (described in \ref{subsec:insertelements}), or
  manually by editing the lattice file.
\item Insert \verb|ion_effects| command after the \verb|run_setup| command. See
  \ref{subsec:ioneffects} for syntax.
  Note that certain properties of the individual \verb|IONEFFECTS| elements can override the
  global settings given by in the \verb|ion_effects| command.
\item Generate a bunched beam, using either the \verb|bunched_beam| command or providing
  an externally-generated beam to the \verb|sdds_beam| command. Section \ref{sect:bunchedBeams}
  gives more information about bunched beams in \verb|elegant|.
\end{enumerate}


%For every turn, for every ion element, and for every bunch, the \verb|IONEFFECTS| element does the following:

For each bunch passage, the \verb|IONEFFECTS| element does the following:

\begin{enumerate}
\item Advance existing ions during bunch gap
\item Eliminate ions that are outside of given boundaries
\item Generate ions 
\item Apply kick from beam to ions 
\item Apply kick from ions to beam
\end{enumerate}

%\paragraph{Ion generation}

The line density of ions generated by a single bunch in a single pass is:
\begin{equation}
\lambda_{ion} = \sigma_{ion} \frac{P}{k_B T} N_b
\end{equation}
where $\sigma_{ion}$ is the ionization cross section, $P$ is the pressure, $k_B$ is the Boltzmann constant, $T$ is the temperature, and $N_b$ is the bunch population.

The resulting macroparticle charge is:
\begin{equation}
%Q_{macro} = 3.21 \sigma_{ion} P Q_{bunch} L_{eff} / n_{macro}
Q_{macro} = \frac{10^{-22} e}{7.5\times10^{-3} k_B} \frac{\sigma_{ion} P N_b L_{eff}}{n_{macro} T}
\end{equation}
Here $\sigma_{ion}$ has units of Mb, $P$ has units of Torr, $k_B = 1.38\times10^{-23}$ J/K, $e$ is the electron charge, $L_{eff}$ is the effective length of the ion element (in m), and $n_{macro}$ is the number of macroparticles generated.
%, and we have assumed $T=300K$.
The initial ion distribution follows the bunch distribution (assumed to be Gaussian).

%\paragraph{Beam-ion interactions}

The kick on the ions from the beam is calculated using the
Basetti-Erskine formula~\cite{Bassetti}, which assumes the beam is
Gaussian in both transverse dimensions.  The change in momentum of an
ion due to the bunch passage is:
\begin{equation}
%\begin{split}
\Delta p_y + i \Delta p_x  = \frac{c N_b r_e m_e }{\gamma} \sqrt{\frac{2 \pi}{\sigma_x^2 - \sigma_y^2}} \left[ w\left(\frac{x + i y}{\sqrt{2 (\sigma_x^2 - \sigma_y^2)}}\right) 
   - exp\left(\frac{-x^2}{2 \sigma_x^2} - \frac{y^2}{2 \sigma_y^2}\right)  w\left(\frac{\frac{\sigma_y}{\sigma_x} x + i \frac{\sigma_x}{\sigma_y} y}{\sqrt{2 (\sigma_x^2 - \sigma_y^2)}}\right) \right]
%\end{split}
\end{equation}
where $c$ is the speed of light, $N_b$ is the bunch population, $r_e$
is the classical electron radius ($2.82 \times 10^{-15}$ m), $m_e$ is
the electron mass, $\gamma$ is the relativistic factor ($\sim$ 1 for
the ions), $\sigma_{x,y}$ are the horizontal and vertical beam sizes,
$w$ is the complex error function, and $x$ and $y$ are the distance
from the ion to the bunch center.

At the moment, the same formula is used to calculate the kick that the
ion cloud gives to electrons in the bunch (where $\sigma_x$ and
$\sigma_y$ are the standard deviations of the ion positions).  This is
not a very good assumption, since the ion distribution is not in
general Gaussian.  In the future this calculation will be replaced by
a Poisson solver.
